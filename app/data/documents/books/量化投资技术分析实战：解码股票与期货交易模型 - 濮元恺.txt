作者简介


濮元恺

从2009年开始研究并撰写技术指标分析资料，拥有十年的A股投资经历和程序化交易模型开发经历。

2016年加入中国量化投资学会专家委员会，目前在励京投资管理（北京）有限公司任研究总监、基金经理。

作者创立的“量化投资训练营”微信公众号，聚集了一批活跃且热心交流分享的投资业内人士，储备了大量知识类文章。





量化交易丛书


量化投资技术分析实战——解码股票期货交易模型

濮元恺　编著





电子工业出版社

Publishing House of Electronics Industry

北京·BEIJING





内容简介

将数量化工具引入投资分析，需要结合中国股票、期货市场实际情况，为投资者开发并讲解含金量高、长期有效、逻辑清晰的量化投资模型，在量化投资领域才能快速普及开来。本书在模型开发过程讲解的基础上，给出建模思路和绩效评估理论，并公开部分机构模型，指导投资者进一步钻研。本书为每个模型展示迭代过程中的绩效，并通过让读者扫描二维码，下载模型，构建纸媒和互联网的连接机制。

未经许可，不得以任何方式复制或抄袭本书之部分或全部内容。

版权所有，侵权必究。

图书在版编目（CIP）数据

量化投资技术分析实战：解码股票与期货交易模型/濮元恺著.—北京：电子工业出版社，2018.8

（量化交易丛书）

ISBN　978-7-121-34561-6

Ⅰ.①量…　Ⅱ.①濮…　Ⅲ.①股票交易②期货交易　Ⅳ.①F830.91②F830.93

中国版本图书馆CIP数据核字（2018）第135163号

责任编辑：黄爱萍

印刷：三河市华成印务有限公司

装订：三河市华成印务有限公司

出版发行：电子工业出版社　北京市海淀区万寿路173信箱

邮编：100036

开本：787×980　1/16

印张：24.75

字数：436千字

版次：2018年8月第1版

印次：2018年8月第1次印刷

定价：99.00元

凡所购买电子工业出版社图书有缺损问题，请向购买书店调换。若书店售缺，请与本社发行部联系，联系及邮购电话：（010）88254888，88258888。

质量投诉请发邮件至zlts@phei.com.cn，盗版侵权举报请发邮件至dbqq@phei.com.cn。

本书咨询联系方式：（010）51260888-819，faq@phei.com.cn。





推荐序


第一次知道濮元恺先生是因为他的公共号“量化投资训练营”，里面提供了众多原创性的量化策略源码，这对业内的发展，特别是刚入行的新手来说，无疑是一个重要的助力。2018年年初，他将自己多年的从业经验整理成一本新书，并邀请我写序，欣然同意。

本书的重要特点是从学习者的经验出发，对章节内容进行了有针对性的安排，例如将择时策略放在最前面讲解，这点我觉得非常有价值，因为大多数交易员一开始就是通过高抛低吸来获得收益的，对于资产配置、组合投资、收益风险的调整等复杂的概念，只有等到真正管理大资金的时候才会有更加深入的体会。由于本书是一个以策略编写为核心导向的教材，所以循序渐进地安排了相关的内容。

第1章和第2章重点介绍了几个重要的编程语言和编程系统，包括聚宽、米狗、Python、TB等。目前业内的量化策略环境已经有了很大的改观，这有赖于众多第三方系统提供商的努力，特别对于初级用户来说，如果不是对交易速度有要求的策略，利用第三方平台快速验证策略模型，是一个不错的选择。

在第3章的择时章节中，作者选择是以技术分析为主的几个择时指标，特别是通道、自适应均线和海龟系统，这是在传统的技术分析中得到广泛应用的择时模型，作为趋势跟随策略，往往并不需要复杂的模型，简单的指标反而更有效。

在股票基本面量化的章节中，本书选取的几个指标，也是业内同行公认的长期有效的几个因子，包括小市值因子、PEG指标、反转因子、资金流和筹码模型。虽然2017年A股市场大白马暴涨，使得众多因子失去了效果，但从一个较长的周期来看，前述的几个因子长期一定会有超额收益，从2018年年初开始，市场又进入正常规律，这些长期有效的因子也一定会在未来的市场中贡献价值。同时在第6章的股票多因子中，对于多因子模型的基础方法做了更加深入的探讨，介绍了多个统计学的模型，特别是对机器学习如何用于股票多因子做了一定程度的普及。机器学习作为人工智能的重要分支，有着普通投资人不具备的广数据的覆盖能力，从而可以根据市场规律尽快找到市场风格特征，从而获得风格收益。

CTA也是量化投资一个重要领域，虽然商品期货和期权的交易量目前还不是很大，但是从国际的发展来看，CTA已经是资本配置中一个重要的选择，在国际上很多资产管理机构也采用量化的方法实行CTA策略交易，本书的第5章和第7章对此进行了实战层面的探讨。

毫无疑问，本书是一个以实战为导向的工具书，濮元恺先生也将自己的策略和模型应用于实战中，且取得了不错的收益，在业内颇有知名度，同时获得了众多投资人的认可。这本书内容翔实、案例众多，特别是提供了可以共享的策略代码，对于作者的分享精神，是比盈利更加重要的价值，特此推荐此书。

中国量化投资学会（CQIA）理事长 丁鹏

2018/5/1





通向量化投资之路并不平坦


每一位读者翻开这本书都不是巧合，虽然“量化投资”这一概念已经被反复提起，但是量化投资领域的关注者和试图通过学习来搭建模型的交易者，依然是投资圈的少数派。由于政策限制和市场发展不成熟，虽然量化投资基金在中国市场取得了良好且稳定的业绩，但是个人投资者想要通过量化的方式完成下单交易，依然存在很多障碍。

量化交易股票期货优势所在

量化投资没有确切的定义，它泛指通过数学分析、挖掘价格波动规律，或者通过对相关宏观经济、财务数据、量价关系、资金交易等数据进行建模，寻找数据之间的关系，以获得稳定利润为目标，持续计算生成定量化的投资信号，并通过计算机严格执行。

在我看来，量化投资方式和传统的“主观分析+手工下单交易”相比有以下显著区别。

（1）业绩稳定：目前大部分量化产品长期跑赢基准指数，虽然有时也经历震荡回撤，但是只要核心策略不变、逻辑清晰稳健，其投资风格就都是稳定的并且可回测的。

（2）概率取胜可精确回测：量化分析方法一定在寻找大概率事件，这样的投资方式相对于传统投资者一定是大概率获利的，因为量化投资在数据的获取方面领先主观投资太多，且数据加工效率也领先很多。量化投资方式的不足之处是信息加工深度还不及主观投资者在少数个股上深刻。

（3）严谨且执行力强：每一次决策，都有周密的数学模型发出信号，模型的搭建者深刻地知晓为什么会在这一时刻做出这一选择。完全定量化，毫不含糊的分析方式和客观的决策方式，保证了量化投资业绩，杜绝了主观投资中人性贪婪和恐惧的弊病。

如此看来，量化投资作为一种工具或者一种方法，应该被广泛普及，并让掌握它的交易者稳定获利。但实际上并非如此，通向量化投资的路途充满坎坷，一道道知识和经验门槛在阻拦投资者做出合格的模型，而且很容易造成知识误用和滥用，带来非常危险的投资亏损后果。

我个人从2007年开始进入股票市场，当时作为一名大学生受到大牛市的鼓舞，本着“配置股票跑赢通胀”的想法开始自己的投资实践，仅2008年一年就亏损资金过半。整个过程中最大的感触除亏损带来的痛心外，还有对于个人投资者信息不对称的深恶痛绝，这恰巧也成为我最初转向量价分析的主要原因。后来我在量化领域做了一些实践，看到了投资的转机。十几年时间过去了，电子工业出版社的黄爱萍编辑和我沟通时，突然觉得有必要将自己的学习和从业过程中经历的量化投资类知识做一个整理，并尽我所能公开一些机构投资者的模型框架和投资建模方法。这就是本书的由来。

在总结的过程中，也回忆了这些年得到的帮助和公司和客户的支持，以及市场的恩惠，这些力量汇合起来，让一个交易者逐步转变为私募基金管理人，并得以在高烈度的竞争中生存下来。此时我意识到对于交易者而言“长期健康的生存”比短期获利更为重要，因为投资不是短期行为，而是伴随着我们的投资生命周期的一个过程。量化投资的思路和我们所搭建的模型，能够显著改善投资者的投资决策能力，延长大部分交易者的生存时间，为交易者通过“积小胜为大胜”的路径，赢得宝贵的资金筹码和时间筹码。

正因如此，学习和探索的路途虽然不平坦，但是我对量化投资方式充满信心。

在这几年的投资历程中，以私募产品方式为客户服务，我们运用多资产搭配和完全的计算机量化决策方式，发行了励京投资-稳利一号、稳利二号、励京私募学院菁英335号等几个产品，目前均取得了非常好的正回报。虽然基金产品收益率和我之前的个人账户投资收益率相比略低，但是夏普比率远高于之前投资思路的，回撤控制严格，这也是量化的魅力所在。

量化与传统交易模式融会贯通

用科学解释市场变化，用数据推导答案，这与部分交易者缺乏原则的人为主观决策，用感性面对市场波动，然后为答案寻找原因（特别是不总结失败教训，仅用少数成功案例构建起摇摇欲坠的投资逻辑）相比，显然数学的定量分析方法更值得信任。

并不是随着计算机的普及量化投资才得以实现，早在20世纪初，《股票大作手回忆录》的主角杰西·利弗莫尔（Jesse Lauriston Livermore,1877—1940年），从报纸刊登的个股开盘与收盘的高低数据、交易量等数据预测第二天的交易价格，这实际上就是最原始的量化投资。而更早的还有道氏理论的提出者查尔斯·亨利·道（Charles Henry Dow,1851—1902年），已经使用了移动平均线来表达趋势。而现代的科学家詹姆斯·西蒙斯（James Simons），在1989年到2009年间，他设计并主导的大奖章基金平均年回报率高达35%，较同期标普500指数年均回报率高20多个百分点。

我们反复强调量化投资的优势，但并不意味着这和非量化模式是冲突的，不仅不冲突，我们经常向采用非量化模式的投资者学习，他们也在分析过程中更大比例地引入量化方式加速数据的获取和对其的分析。毫无疑问，量化和主观的融合与渗透越来越明显，两种投资方法的边界反而越来越模糊。我非常钦佩基本面分析者对于好公司的判断，以及交易员对于好价格点位的判断。在本书中也试图重现投资大师彼得·林奇的PEG选股方法，重现主力资金和散户资金博弈的资金流入占比，以及经典技术指标双均线在期货和股票系统中的应用效果，毫无疑问，这些知识都来自对投资者行为的学习。

本书将着力公布一批基于动量效应的期货CTA模型，以及股票基本面和量价关系投资模型，进而到更加复杂的CTA模型和股票多因子模型，最后讲解机器学习方法在多因子建模中的实战。本书的特色之一是每个模型都公布源码，公布我们的思考假设和路径，并考虑到读者的编程门槛，从基本的语言结构讲起，并对模型做充分注释。

关于为什么要涉及机器学习的问题，首先是因为这种算法有绝对的数据挖掘优势，对于数据的拟合度非传统模型能比，其次是因为在我们严格进行因子筛选，且逻辑清晰的情况下，机器学习算法可以完全保证模型的稳健性，或者叫鲁棒性（Robustness）。最后感谢所有机器学习的开发者所编写的可调用程序，这让普通金融建模者几乎只用一两行代码，即可完成对于机器学习的初级使用。

本书面向有一定金融学知识的交易者，或者在校学生，或者具备部分编程知识的IT从业人士，你们可以结合自身的知识结构放大自己的长项，补充自己在量化投资领域所缺乏的知识，最终构建出可以实盘交易的稳健的模型。我不希望本书像教科书式的学术论文那样晦涩难懂，对于在量化行业从业的基金经理和研究者，以及资金曲线异常完美的资深交易者，可能仅能从本书中得到一些灵感启示，但我相信这些模型都是他们成长道路上已经走过的路。

向付出者致敬

量化行业的付出者不仅有前线作战的交易者和基金经理，还有中间战场的模型构建、因子分析人员，以及后台的数据加工人员和数据收集人员，这是一个团队作战的成果，技术的成熟会替换其中一些环节，为一些环节加速，但是无法彻底取代一个角色。在量化学习的道路上，一次次尝试失败或者偶尔收获成功喜悦的学徒们，以及为他们指导方向的老师们，也同样是付出者，如果有幸遇到好老师或找到好方法，则学习者的收获感是非常高的；如果自己闭门造车且长时间没有收获，那么收获感将持续降低。

作为本书作者，我能够体会探索过程中的各种艰辛，以及付出的不必要的成本，特别是时间成本。所以我一直在构思如何设计内容、布局章节关系，给各位读者一个尽可能低的学习本书内容的门槛，而在读者踏入门槛后，又要尽可能快地取得进步，感知A股市场和期货市场的波动特性。本书最终内容构成如下。

（1）将择时类模型内容放在本书靠前的章节，通过体会动量效应在期货多品种和股票中的运行效果，达成初步的稳健模型。

（2）紧接着讲解股票市场的基本面和技术面模型构建，熟悉ETF择时交易、风格选股模型、技术指标选股模型和动量选股模型。

（3）了解较为复杂的期货模型，并观察其实战效果和缺陷。

（4）掌握基本的数学，特别是统计学知识后，开始涉及部分股票因子的测试和绩效分析。

（5）在股票多因子模型阶段，讲解简单易懂的机器学习模型框架。

（6）回顾模型搭建过程中的各种问题，然后讲解绩效评估和避免幸存者偏差的一些建议。

感谢

本书在撰写过程中得到了同事和朋友们的支持，更重要的是，在量化投资的研究历程中，有诸多朋友搀扶帮助，因此才有了今天的成果，我将这些逻辑整理成书，在这条路上他们都有付出，这是我们共同的作品。非常感谢经常帮助我校对代码的王远洪先生，身在国外仍帮助我昼夜迭代程序的何文硕先生（我们的作息时间刚好适合这样连续工作），给我最初始程序化交易思路的石咏老师，让我意识到“模型不完美和自己能力不完整”的葛老师，以及家人的关心与理解。

我在每个模型下方都放置了二维码，读者通过手机扫描，打开链接，即可获得该模型的完整源码，而不用从书本上誊抄一遍。

我希望不断认识新朋友，认识有意向在市场中大展身手的交易者，我们可以通过本书对应的公众号“量化投资训练营”或对应的 QQ 群“量化投资-学习园地（474952692）”进行交流沟通。

濮元恺

2018年6月





其他


轻松注册成为博文视点社区用户（www.broadview.com.cn），扫码直达本书页面。

◎ 提交勘误： 您对书中内容的修改意见可在 提交勘误 处提交，若被采纳，将获赠博文视点社区积分（在您购买电子书时，积分可用来抵扣相应金额）。

◎ 交流互动： 在页面下方 读者评论 处留下您的疑问或观点，与我们和其他读者一同学习交流。

页面入口：http://www.broadview.com.cn/34561





目录





封面


作者简介

扉页

版权信息

推荐序

通向量化投资之路并不平坦

其他

第1章 量化投资入门建议与行业概况

1.1 学习路线图与重要知识节点

1.2 稳步上升的资金曲线是否存在

1.3 有保留地相信回测结果

1.4 绩效评估常见指标和方法

1.5 部分可视化免编程量化分析平台

第2章 快速驾驭编程语言知识

2.1 TB基本编程——基础知识

2.2 TB基本编程——条件循环语句

2.3 Python语言比你想象中更简单

2.4 Python Numpy库常用操作解读

2.5 Python Pandas库常用操作解读

2.6 实战开始：在股票平台进行数据查询

第3章 股票期货择时交易模型

3.1 ETF二八择时法则，跑赢基础股票指数

3.2 Aberration系统，长期活跃于期货市场

3.3 低价股+逆向双均线模型，初步探索个股特征

3.4 CCI通道+自适应系统，驯服商品期货波动

3.5 AMA自适应均线系统捕捉价格启动机会

3.6 “海龟交易法则”辉煌战绩与实践

第4章 基本面和技术面交易模型

4.1 股票模型思路形成与常见问题

4.2 小市值二八过滤止损模型，A股明星以小为美

4.3 PEG价值选股模型，复制彼得·林奇投资路径

4.4 技术指标测试平台

4.5 动量效应和反转效应

4.6 换手率和资金流模型，主力和筹码盘根错节

4.7个股CTA策略尝试

4.8 高频因子低频交易，“聪明钱”因子模型

4.9 股息率高分红模型，与参数优化实践

第5章 更有效的期货交易模型构建

5.1 万变不离其宗，均线类模型本质剖析

5.2 逆势交易在期货市场的初步实践

5.3 大小周期双频率模型CTA实战

5.4 OpenRangeBreaker短线突破交易系统

第6章 股票多因子模型实战

6.1 理解回归问题的原理

6.2 基本的统计学知识补充

6.3 股票多因子模型的实质

6.4 股票收益50年探索历程

6.5 单因子分析方法

6.6 多因子选股模型：多元线性回归法

6.7 SVR机器学习多因子建模

第7章 模型与实盘投资难点

7.1 参与CTA市场的必要性和必然性

7.2 止损模块的重要意义与取舍

7.3 我们更加侧重的绩效评估理论

7.4 警惕隐藏的回撤幅度和回撤时间

结束语 不断失败和不断迭代





第1章 量化投资入门建议与行业概况



1.1 学习路线图与重要知识节点


2016年我被一个问题困扰了很久，一位读者朋友请我提供量化投资学习的“路线图”，或者说进入这个行业的学习路径。我从来没有思考过这个问题，自己和身边从事量化工作的同事都没有想过知识图谱是如何构建的，又是以哪里作为突破口构建的。后来我意识到问题的严重性，如果路线图制定得当，学习效率将会得以提高；如果制定不妥甚至错误，则可能会使学习者几年时间毫无进展。

在调研了多位量化交易者之后，我总结出量化投资学习方面的路线图，如图1-1所示。

（1）体会各类资产的择时建模，激发学习兴趣。

各类资产的择时问题较难且有深度，但是也相对简单，因为门槛低，“低买高卖”思路非常清晰。在单一时间序列模型上，动量容易被均线类、突破类模型捕捉，典型应用是股票指数择时。相信很多读者最初也是被一条能够跑赢大盘指数的资金曲线所吸引的。

图1-1 量化投资学习路线图



在个股上择时较为困难，除了少数大盘股有较为持续的动量之外，大部分中小盘股票不容易做择时，很容易追高买入，并在不利点位卖出。择时的工具简单多样，比如移动平均线、布林通道，各类技术指标如MACD、RSI之类基本上就是因为能择时才拥有广泛的“群众基础”。

将这些指标加工处理后，配上止损、止盈条件，即可直接应用于商品期货市场，该市场的中低频交易策略大部分以动量类技术指标为主，原理并不难理解，也有部分技术指标可以反向使用，作为“超买超卖”类指标来表示过度乖离。择时在外汇类资产上也能大量使用，基本上也是将商品期货的模型搬运过去，然后做适当修改。在进行大类资产配置时，由于择时工具面对更低的数据噪声，往往效果更好，使用一个逻辑简单的模型去应对债市或者房地产市场相关数据，能带来令人惊讶的效果。

这个阶段的研究进度因人而异，有一定基础的研究者可能几周即可找到能赚钱的择时模型，而大部分交易者可能需要数月甚至数年时间来培养对动量的把握能力，或者因为基本的编程语言关口无法通过而停留在这一阶段。

（2）编程语言障碍要在模型开发中逐一克服，否则会陷入对程序的恐慌和无助。

编程语言对大部分交易者来说是量化学习的拦路虎（对于少部分程序员而言，金融市场知识和分析经验可能更复杂），建议积累必要的语法知识后，直接从模型搭建开始学习。比如我们能够调用系统自定义函数，获取按规则选取的股票池，就走出了策略撰写的第一步，然后尝试构建最基本的交易策略、买卖条件，这时就需要嵌套、循环、逻辑判断等知识。再向复杂的领域推进，可能要涉及对个股表格做筛选、计算等“增删改查”的处理，需要接触Python语言的list、dict、dataframe等数据格式。

如果一个缺乏编程知识的人为了学习量化投资而学习MATLAB或Python，可能需要至少一个月甚至数月的时间。而且在面对实际的股票问题时会再度陷入僵局，因为需要从脑中将抽象的代码规则转化成实际问题，以看懂某个语句；或者需要一定时间将股票、期货数据格式，抽象成一行代码，这一过程来回消耗精力，很多人在这一过程中会忘记学习量化的初衷。

我们在面对海量的新知识时都会产生敬畏和莫名的恐慌情绪，不过在代码学习过程中不用担心，毕竟它是辅助我们更好地进行投资决策的工具，它要简化模型构建过程，而非让问题复杂化。学习复杂的程序开发有一个好办法——写注释，阅读大量投资模型，为它们逐行添加注释，有必要时再对照敲击一遍代码，你的代码能力会得到快速提升。如图1-2所示。

图1-2 量化投资是金融知识用编程表达后的结果，两种能力都要具备



（3）探索股票和期货波动特征，尝试较为复杂的股票和期货模型。

具体到可以被量化交易的各类交易资产方面，建议大家在股票和期货上重点研究，而不要轻易涉及外汇资产和数字货币，因为股票和期货这两类市场都有足够的容量可以交易，且杠杆率可控，资金安全有保障。

首先股票是没有杠杆的，而且市场上有很多只股票可以选择，每只股票又带有大量财务因子信息、量价和资金因子信息、舆情信息，这促使股票类资产可以调换标的操作，并且调仓是以日期为横截面的。我们不必抓住几只股票反复操作，因为在固定标的上，只有择时收益，可以反复调仓换股，获得多只股票的收益。

事实上你会发现：如果你不换股，在单独股票上使用择时模型，则难以跑赢静态持有个股，而到了期货市场上，积极主动的择时交易、突破类交易，都可以获得良好收效。用几个看似简单的逻辑构建模型，在期货市场波动率充足的情况下，可以始终保持盈利，所以大部分交易者入行量化领域，真正实盘程序化交易模型并不是从股票开始的，而是从期货开始的，特别是资金需求量较低的商品期货。如图1-3所示。

图1-3 遗传算法（Genetic Algorithm）作用于股指期货，分为训练集（左侧）和测试集（右侧）



在这个阶段，你会遇到很多听起来黑科技感十足的模型，比如低通滤波器、隐马尔可夫链、模式识别等，要学习的知识会多到“爆炸”，但是如果本着技不压身的初衷将它们都学完并做成模型，或许你依然难以盈利，这是很令人烦恼的问题，因为择时问题的深度会限制你的眼界和看市场的广度，所以先给自己打造出能用的工具，然后再去追求“高精尖”的知识也不迟。

建议大家给自己半年到一年时间，为了加速进度、督促自律，可以列一个任务清单和时间表，定期学习、总结经验。

（4）做足单因子分析功课，然后切换到多因子学习。

在过渡到本阶段之前，你需要补充一些数学知识，比如线性回归、数据清洗等，因为在股票市场上，要面对的不仅是期货时间序列，还有每只股票时间序列背后的多维度信息。初学者可以想象，在大智慧或同花顺软件上看到上市公司 F10资料里有多少信息，在因子分析阶段就要涉及多少信息（甚至远比这更多），可谓任务繁重。如图1-4所示。

图1-4 样本内与样本外因子选择的比较



建议读者按照科学的评估方法，观察因子值对于个股收益率的描述能力，重点分析IC和因子收益率单调性，以便发现高质量的Alpha收益（超额收益）因子。做好数据清洗和数据表格的基本操作，才能到达多因子建模阶段。

在多因子阶段需要注意一点：做好数据处理工作，让你的模型更加简单有效和安全、易解释，对算法知识可以浅尝辄止，因为可供调用的算法包很多，这部分知识的深度也难以理解，消耗的学习成本过大。而且这样能让你更加集中精力做出能够实战的多因子模型，而不是沉浸在算法的知识中无法看清股票市场现状。





1.2 稳步上升的资金曲线是否存在


资金曲线在行业交流中不仅是模型盈利能力的体现，也是建模者实力的体现。我们被行业高手的资金曲线所吸引的同时，也会产生类似以下疑问：回测规则是否合理？是否有虚假成分？在实际投资中，该业绩能否保证？我们甚至会认为这种资金曲线是完全不存在的。

而实际上这种资金曲线不仅存在，而且可以被复制。

特别是在本书开头部分，希望给予读者信心，我们以量化为工具进行投资，目标就是面向这样的资金曲线开发模型，这深藏于我们内心，不敢表达或者怕被同行耻笑的目标，也是我们投身于此行业最原始的驱动力，本书将以数量化模型投资的方式向你解读如何靠近这一目标。

为达成稳步上升的资金曲线，本节简单表达我们的观点。

1.基于强壮稳健的投资逻辑

确保自己的模型拥有清晰的逻辑是立于市场不被轻易击败的重要保证。我们看到业界和学界大部分知名投资模型或者投资方法，都有可以解释的、非常贴合市场（模型所针对的各类资产）的逻辑。

比如沃伦·巴菲特的选股逻辑，程序化交易行业最坚定执行模型，创造可观回报的理查德·丹尼斯，以及已经被反复举例、名扬海外的詹姆斯·西蒙斯博士。他们分别以基本面价值选股、程序化多品种趋势追踪交易、市场多维度信息量化分析作为自己的投资逻辑，通过选取合理的数据、精细加工、科学建模计算，得到了稳健的、可被验证有效的，特别是可被证伪的投资模型。

所以通过阅读书本知识了解金融市场规则，然后通过实践了解股票、期货、外汇、数字货币等市场的不同波动特性，或者通过数学工具，抽取市场价量信息分析这些特性，是量化投资的第一步。我们要敏感地看待测试结果，发掘市场到底是偏向趋势还是反转趋势，是偏向价值投资还是价格投机，才能初步形成下一步的模型构建方向。

在此过程中你要做的是不断产生假设，反复提出各种投资逻辑，并设定严格的回测条件，证实和证伪你的假设。同时，阅读大量金融服务行业研究报告也是必须的，他们是策略开发的思路来源。但是也要清醒地、有针对性地看待这些报告，其中混杂着很多逻辑错误，市场解释力度弱，没有持续性支撑的投资逻辑，仅靠特定的数据样本和规则回测得到的资金曲线，可能在实盘阶段面临巨大风险。

刚才我们谈到了经济学逻辑方面的稳健，在量化模型的构建过程中，还要保证另一层面的稳健，这就是模型对于不同样本有盈利的共性，且模型参数有限、有效、有合理参数解释，或者你拿出先进的工具保障模型构建过程中能够驾驭多种市场变量。

比如参数的稳健，参数最好能够确定固化（或者使其自适应），最好降低对于性能的影响，比如针对商品期货类模型，尽管各类资产波动特征不同，但是如果能找到尽可能通用的参数，回测出一条平稳上升的资金曲线（而不是靠多参数拟合），则实盘赢面会大幅度上升。

再比如股票量化建模，机器学习理论认为：如果不考虑除金融市场行情历史数据外的其他数据，只考虑行情股票价格内部数据，投资公式可以简化为Yt+1 =F（Pt-s ,…Pt-1 ,Pt ）。如图1-5所示。

量化建模的实质是通过现有训练数据，以适当的方法模拟人脑分析学习的神经网络，模仿大脑解决问题的机制来解决数据问题，无限逼近金融市场的真实函数。看似黑箱的机器学习，在此解释和训练方法的约束下，以及通过后文要讲解的套利定价理论APT产生的多因子模型框架，也具有稳健的投资逻辑。

图1-5 机器学习类模型净值曲线，固定资金单利，利润不再投



2.基于“时间的玫瑰”

《时间的玫瑰》原是一本诗集，在投资领域这本书知名度不高，但另一本书《时间的玫瑰：但斌投资札记》成为很多基本面投资者的信仰，作者是知名投资人、私募基金管理人但斌先生，其穿越历史、穿越牛熊表达出自己的观点：投资像孤独的乌龟与时间竞赛。

我们从原理方面不切分量化与非量化投资，因为基本面分析者目前也大量借助量化工具辅助决策，而且我们要学习基本面投资者和知名投资公司的发展历程，特别是投资产品历程，他们都经过漫长的坚守，才最终打磨出一条可以被投资人接受的资金曲线。

如图1-6所示是一段CTA商品期货量化投资模型资金曲线，如果我们缩短时间范围，会发现看似光滑平整的曲线充满坎坷，如果精确到更短时间段内，表现会更差，但是从长时间范围内观察，它又令人满意。原因在于，不同市场阶段的波动率和波动特征不同，只有水平极高的投资模型才能做到在每个阶段（比如每季度、甚至每月）都有较好的上升和低回撤表现，而大部分模型需要靠时间来弥合各种回撤，形成一条效果较好的资金曲线。

图1-6 一段资金曲线的某两个时间段，表现不令人满意



所以时间的重要性，在这里更加被强调。尤其是针对个人投资者和量化投资爱好者，投资研发能力和信息获取能力不比机构投资者，但是我们能忍受的回撤期较长，没有固定开发成本（如高额的公司运营成本），资金属性也决定了个人的可承受回撤风险大于机构投资者（机构投资者多接受实业资本、保险资本等刚性兑付资本的资金，因此小幅度亏损也无法接受），所以我们可以用时间作为工具，通过时间长出投资的玫瑰。也同样借助此观点和读者共勉，坚守自己的模型，保持强大的连续性和投资定力，这在一定程度上比开发更先进的模型更重要。

3.基于多资产多策略配置

我们应该了解国家的货币供应总量是逐步递增的，这是经济正常上行的必然结果，其反应在日常生活中的表现是资产价格上涨和货币购买力缓慢降低（温和通胀），很多人因为自己没能抓住房地产上涨、股票牛市而自责，认为自己没能跑赢通胀或者没能跑赢国家货币供应量，因为这些大类金融资产都是货币体系的最终流向和流动性储藏容器。如图1-7所示。

图1-7 央行统计的货币供应量数据



试问我们在不掌握货币发行权的情况下，能否稳健跑赢货币供应的增长速度？答案是我们可以通过配置多种资产，从流动性容器终端拦截，以达到资产升值方式，进而逼近货币供应增长，获得较为长期稳健的资产增长，这就是资产配置的魅力。在本书发行之前，电子工业出版社于2017年发行了王前锋所著的《量化大类资产配置》一书，书中描述了大量的资产配置案例和量化处理方法。

如图1-8所示是我们基于保险资管行业资产配置要求所做的简单模拟，首先确定产品投资期限，并给出一个固定收益率，如年化6.5%。其次我们精选股票和债券的投资策略。举例来说，股票指数相比于沪深300指数，选取中证高红利低波动指数（历史上该指数显著跑赢沪深300指数）；债券指数选择上证企债指数（长期来看企债指数的收益率高于国债）并放两倍杠杆，且根据风险平价策略配置股票和债券的比例。由于需要进行比较，我们将中证风险平价指数和两倍企业债杠杆加入进来。

修改后的风险平价策略收益率更加可观，最大回撤大幅下降，同时收益率更高；同中证风险平价相比，主要是收益率大幅增加，同时波动率和最大回撤在可控范围之内。行业内还有知名度更高的耶鲁基金，其通过最优化资产配置，完全资产配置式满仓持有不同市场（本国股票、全球股票、固定收益债券、大宗商品、私募股权、房地产等）权益，打造出一个高回报基金会，以实际投资回报说明了资产配置是最赚钱的方式。

图1-8 股票+债券风险平价配置方法



将资产配置下降一个层级，我们在一个市场内，比如商品期货市场（可以理解为一个迷你版本的多资产配置市场），也可以做类似操作。首先我们主张一定要进行多品种模型覆盖，其次就是在每个品种上，部署多套不同源模型，以获取该资产不同波动情况下的不同收益来源。如图1-9所示。

比如某类商品或股票价格长期以趋势波动为主，但是短期经常产生均值回复，又有相当长一段时间，该商品或股票定价并非受自身因素影响，而是受到其他上下游或者行业影响，这就产生了趋势交易、均值回复交易、套利交易。它们的利润来源不同，出现时机不同，建议对其进行并行部署，不要错过机会。

多品种配置原因还在于货币流动性游走于不同资产（品种）上。比如美国大选驱动的工业复苏和大宗商品价格上涨，2018年美中贸易战驱动的工业品价格快速下跌，历史上还有经济危机和自然灾害驱动的农产品价格异常波动，所以当我们不知道波动即将在什么时候、什么市场发生时，选择并行持有各市场头寸，等待模型将波动转化成利润，是最稳妥的方案。如果这些头寸之间还带有必然的对冲性质，比如股票多头和股指期货空头，再上一个层面到股票多头和期权，他们会形成更稳健的对冲结构。

图1-9 将三类商品期货策略等资金量部署之后的资金曲线更加平滑





1.3 有保留地相信回测结果


我们拥有历史数据，可以用于回测建模，然后将其用于目前的新市场环境交易，我们给这种行为起了一个听起来“高大上”的名字：量化投资。似乎一切波动都可以用定量方法完全解读，可以封杀一切风险暴露，只取得利润，其实不然。

早在1900年以前，查尔斯·亨利·道（Charles Henry Dow）就已经创立了股票市场平均指数——“道琼斯工业指数”。他们引入了移动平均线这种分析方法。当时的历史价格数据质量很差，只能通过纸质出版物印刷保存。但是基本的指数编订、权重规则、移动平均动量分析方法，已经被引入了，这就是典型地想通过定量化分析来预测市场和战胜市场的表现。

所以通过回测构建模型是一门古老的融合学科，甚至包括很多对于市场运行规律的不尊重（金融数据研究属于非实践性科学）。回到本章节主体，我们为什么要相信回测结果，能否相信回测结果，甚至将其应用到未来的实际投资中？

主要原因是，模型运行在样本数据（历史数据，in-sample部分），我们相信样本数据能够在一定程度上反应总体数据，特别是真实数据（样本外实盘数据，out-of-sample部分）。样本容量过小，则样本对总体缺乏足够的代表性，从而难以保证推算结果的精确度和可靠性，所以历史数据不足的问题不容忽视。训练模型首先要获取尽可能多的历史数据，然后假设历史数据能够尽可能推断未来走势，这是我们做量化投资相信回测结果的基本假设。

可以阅读一下技术分析理论的三大假设（市场行为包容消化一切信息、市场运行以趋势方式演变、历史会重演），或者道氏理论的三大假设，从这里寻找一些可以轻松理解的答案。实际上我初入这个行业时，心中也是抱定信念，坚信这些假设成立。虽然后来随着研究发现某些假设并不十分稳固，但是这些假设还是很有市场的，并且交易者愿意按照其指导自己的操作。

回到刚才所说样本和总体的关系，我们将此问题转到统计学角度来分析，既然手中的数据是样本，那么我们要分析研究对象（股票和期货价格）的变化程度和所要求或允许的误差大小，在不同的模型中这两点要求不一样，但是总体来看，样本永远无法满足要求，且现实数据变化较大，所以我们仅能获取到粗略统计结论。

因此一定要有保留地相信回测结果，而不是按照回测结果达到多少年化收益率和胜率等绩效指标，就认为实盘中也能达到如此结果，实盘和回测一定是有偏差的（当然我们都希望实盘比回测绩效更好，但是很遗憾这种情况很少出现）。

所以需要注意：我们是用模型效果在样本数据上推测真实数据也按照此规则运行，一切前提都在数据端，如果数据一旦不按照此规则运行，则模型随数据变化程度而衰减甚至失效。如图1-10所示。

图1-10 矩阵推进（walk-forward）建模方法适用于数据量巨大的高频领域



在承认衰减是必然的之后，模型开发者希望绩效尽可能少地衰减，但是无论使用什么数据切分方法、矩阵推进（walk-forward），都只是在样本内部说明你的模型对于数据有较好的适应能力，此时我们希望得到的结果是，在训练和测试部分，资金曲线都有较好的上升斜率，并保证了相似的交易次数（交易密度验证）。如图1-11所示。

图1-11 随着样本量增加，样本特征趋近于总体，所以我们永远面临样本不足



当我们站在更远的时间点看现在（手中的回测数据）时，会认识到再长时间的测试样本，依然只是样本而不是总体。高盛公司数量策略部门的董事总经理 Emanuel Derman认为：样本和总体相似，但这种相似性也是有限的。仅以回测数据建模，导致模型缺少深刻的结构和坚实的原理。大部分传统的权益模型专注于数据之上，这是一个危险的现象。

我们的回测报告只是逼近模型在实盘阶段的表现，或者说近似说明该模型有哪些风险收益特征。相信回测并不等于死板地恪守，要看清回测的实质。

除了认识到样本仅是总体的一部分概率表示之外，还要考虑以下这样几个问题：

（1）样本内数据的交易规则、交易成本、市场参与主体是否和目前的实盘一致？

（2）在样本内数据上，单笔交易的利润贡献是否平稳，还是说来自于少数高盈利的交易？

（3）样本内数据的不同周期波动率，是否和目前的市场波动率相似？

（4）样本内数据是否质量低下，以及政策过度干预？

以上几个问题如果出现了和目前市场不符的情况，则要人工地过滤掉一些和目前不符的模型或参数配置或品种配置。如果你是一个资深交易者，则可以通过对市场规则的熟悉来完成过滤，如果你是一个细心的数据分析师，则可以将数据对应到基本面在历史上发生的变化来实现过滤。

如图1-12所示，实盘绩效可以看作是预测数据，这部分数据随时间运行偏差越来越大，这是接下来我们要通过模型对抗的核心问题。它严重干扰着量化投资行业，使得我们即使做出可以回测盈利的模型，在实盘也实盘无法跑赢市场，甚至出现较大绩效衰减。我们在本书中的不同地方会提到解决方案，也会给出我们的建议。

以上问题都是说起来容易，做起来需要高度专注和长时间付出才可以完成。我尽可能说出这些内容，希望缩短投资者建立长期盈利模型的时间，各位读者要在数据分析方面下功夫。也只有尽量避免各种不利的数据影响，我们才能在更大程度上相信回测结果。

图1-12 用时间序列预测误差理解回测和实盘绩效



量化投资的危险之处在于，目标函数在推动你从数据里挖出黄金，也在放大噪声的影响力，所以到了某个奇怪的交易规则设置临界点下，模型由噪声主导，得到的完全都是幸存者偏差。事实上定量管理的核心问题和导致模型奔溃的主要原因，正是在于对历史数据的过度依赖，市场环境的变化可能导致股票、期货市场运行模式的改变，所以我们要相信回测结果，在一定程度上也要尝试走在市场前面，预判性地应对风险。





1.4 绩效评估常见指标和方法


考虑到大部分读者都具备相关绩效评估知识基础和敏感度，本节仅做简单铺垫，但是在叙述这些绩效指标公式过程中，会融入一些实际评价策略模型的案例，以及我们推荐的方法。

1.Sharpe Ratio夏普比率

绩效指标也被称为风险指标，它们也是量化投资的基石，正因为有这些指标我们可以横向对比不同模型。首先以被模型开发者熟知的夏普比率开始介绍，Sharpe Ratio（夏普比率）目的是计算投资组合每承受一单位总风险，会产生多少的超额报酬。它的优点是不仅考虑收益，还考虑每次的波动率（回撤幅度），可以同时对策略的收益与风险进行综合考虑。

夏普比率的计算公式是：夏普比率=策略年化收益率-无风险回报率 /策略回报率标准差。如果某股票型基金，过去一年上涨15%,1年期国债或者1年期定存的无风险回报是3%，基金净值的标准差是6%，那么用15%-3%，可以得出12%（这个12%是超出无风险投资的回报），再用12%÷6%=2，就是夏普比率。

2.Alpha阿尔法

投资中面临着系统性风险（即Beta）和非系统性风险（即Alpha）,Alpha是投资者获得与市场波动无关的回报。比如投资者获得了10%的回报，其基准获得了5%的回报，那么Alpha或者价值增值的部分就是5%。

阿尔法计算公式是：Alpha=Rp-[Rf+βp（Rm-Rf）]，含义是策略年化收益率-[无风险利率+β×（基准或市场年化收益率-无风险利率）]。我们看到这里需要先计算β，才能计算出Alpha。

3.Beta贝塔

贝塔表示投资的系统性风险，反映了策略对大盘变化的敏感性。具体计算方法为：策略每日收益与基准或市场每日收益协方差 /基准或市场每日收益方差。

例如一个策略的Beta为1.5，则大盘涨1%的时候，策略可能涨1.5%，反之亦然。我们大多数情况下希望自己搭建的股票模型是低Beta的，因为股票市场的波动太过于剧烈，我们如果能找到互相对冲的资产，那么在获取正收益的同时，也能降低持仓波动。

4.Annualized Returns策略年化收益率

表示投资期限为一年的预期收益率。具体计算方式为（策略最终价值 /策略初始价值-1）/回测交易日数量×250。自然地，Benchmark Annualized Returns（基准年化收益）是将策略收益换成市场收益。

5.Max Drawdown最大回撤比率

描述策略可能出现的最糟糕的情况。具体计算方法为max（1-策略当日价值 /当日之前资金最高价值）。最大回撤通常以比率作为计算，比如我们的净值从1开始运行，或者投资从10万元开始运行，经过一个月亏损1万元，则本阶段回撤比率是10%。最大回撤就是在投资全程，寻找到亏损最严重的这一次。

还有一个潜在的风险指标一般各大软件或模型开发平台都没有列出，就是最大回撤持续时间。该指标决定了模型能够在多短的时间内重新回到一个净值高点（超越之前的高点），或者换一种理解方式：净值创新高时间间隔，也是对于该指标的描述。我们做投资非常在乎资金曲线多长时间内没有创新高，一般夏普比率较高的策略这一时间会越短。

6.Sortino索提诺比率

表示策略每承担一单位的下行风险，将会获得多少超额回报。其公式是：索提诺比率=策略年化收益率-无风险回报率 /策略下行波动率。索提诺比率越高，表明基金承担相同单位下行风险能获得的超额回报率越高。索提诺比率可以看作是夏普比率在衡量对冲基金/私募基金时的一种修正方式。

相应地给出下行波动率（Downside Risk）计算指标，它等于当（今日或本阶段策略收益率–平均收益率）为负时的波动率，你可以理解为它在波动率计算公式后加入一个信号函数f（t）。

如果近期策略收益相比平均收益为负数，则f（t）=1，下行波动率=波动率，如果近期策略收益相比平均收益为负数，则f（t）=0，不计算此波动率。相应地，波动率计算公式=（收益率–平均收益率）平方和×250/当前策略运行天数-1，对以上结果开平方。

7.Information Ratio信息比率

信息比率简称IR，用于衡量单位超额风险带来的超额收益。信息比率越大，说明该策略单位跟踪误差所获得的超额收益越高，因此，信息比率较大的策略的表现要优于信息比率较低的基准。

信息比率的计算公式是：（策略年化收益率-基准年化收益率）/策略与基准每日收益差值的年化标准差，由此可以看出它高度依赖基准或者说市场收益来衡量一个策略的质量，IR指标认为合理的投资目标，应该是在承担适度风险下，尽可能追求高信息比率。相对而言，夏普比率从绝对收益和总风险角度来描述策略表现能力，所以IR更适合评估单一股票市场内的每一个交易策略。

在期货量化交易方面，比较常见且市场占有率较高的软件如交易开拓者，也提供了一些绩效分析指标，如图1-13所示，这里抽取几个最重要的做讲解。

图1-13 7个模型组合成的绩效报告表格



（1）收益风险比

其公式为：年度收益/全段最大资产回撤。收益风险比表示了一个策略的风险控制和收益平衡能力，类似夏普比率，但是它仅考察最大一次的资产回撤和年度收益的比值。比如同样达到100万元年度利润，A策略最大回撤达到50万元，收益风险比=2。B策略最大回撤为25万元，收益风险比=4。显然B策略在实盘情况下的风险要低很多。

（2）R平方值

R平方值含义是根据交易盈亏曲线拟合的趋势线与收益曲线之间相关系数的平方。如果总趋势是上升的资金曲线，且波动极小，理论上用一条直线可以回归解释其收益，则R平方值无限趋近等于1。当然这是理论情况，但是实际上随着我们的不同源策略的添加，以及模型回撤下降，当很多模型堆叠在一起运行时，R平方值确实趋近于1。

（3）平均资产回撤

计算公式为：资产回撤总金额/资产回撤计数（都是以超过最大回撤基准线以上的回撤来计算的前N个最大回撤），这里的N可以在软件中设定，一般我们设定为5，这样就不是只考虑最大的那次回撤，而是考虑亏损最严重的5次的平均回撤，更有参考价值。

（4）调整收益风险比

调整收益风险比对应刚才所说的平均资产回撤，调整收益风险比=年度收益/平均资产回撤。该指标在建模过程中也被经常参考，其可信度强于收益风险比。

（5）TB系数

TB系数计算公式为：（平均利润×平均利润×交易手数）/（平均盈利×平均亏损）。该指标是TB自定义的一个绩效评价指标，有一定的参考价值。特别是考虑到交易手数，让绩效的可信度提升。

（6）头寸系数

头寸系数计算公式为：收益风险比×R平方值×置信度/最大资产回撤。该指标考虑了收益风险比（间接考虑了最大回撤）、R平方值（间接考虑了平均回撤）、置信度（间接考虑了交易次数）。除以最大回撤是为了通过极端情况下的亏损来确定系统的稳定性，是一个可以参考的TB自定义的绩效评价标准。

（7）置信度

在TB软件中，“置信度”这一绩效并未在回测报告中显示，但它是推导出“头寸系数”的重要过程，在这里简单做描述：该指标根据测试的交易次数计算的置信水平，计算公式为： 。在同等利润或者夏普比率下，越高的绩效置信度说明实盘阶段该绩效保持不变的可能性越高。

我们需要牢记一点，绩效永远不仅只评估收益，而且还评估风险情况。所以大部分个人交易者往往只看收益率、年化收益率，忽视了最大回撤和夏普比率。殊不知能推动我们在这个行业走多远的正是风险控制能力，且部分资产可以通过保证金模式做杠杆交易，一旦回撤无法控制，会造成资金曲线大幅度波动和衰减，更坏的结果是人为干预模型导致资金曲线失去一致性，一般此方式带来的都是负面影响。





1.5 部分可视化免编程量化分析平台


虽然编程实现了自由打造交易策略，并通过程序化下单的方式完成量化交易，但是不得不承认因为需要学习代码的门槛，使得量化投资的用户群受到严重制约。目前国内有上亿名股民，上千万名的活跃交易者，其中一部分可以通过数量化统计方式获得选股信息，而绝大部分投资者是通过大智慧、文华财经等软件，或者东方财富、新浪财经等网站获得并不透彻且信息量有局限的静态统计数据。

如何全市场回测我们的一个想法，一个完整严谨的投资思路，甚至获得专业的资金曲线和绩效评估？除了使用编程开发模型之外，国内出现了一些可视化免编程量化分析平台，为更广大的用户提供了解决方案。本节我们介绍其中4个平台，他们分别具备优势和特色，也试图成为证券行业的互联网流量入口。

1.同花顺i问财模型工具

同花顺的i问财平台上线较早，知名度高，用户量庞大，其以独有的文本化“策略问句”形式（意味着向平台发问），放低了量化投资的门槛，甚至都不需要借助太多财务方面的基本知识，即可实现回测，这与其背靠同花顺金融数据库是有很大关系的。其量化频道地址：https://www.iwencai.com/traceback。如图1-14所示。

比如它会引导用户输入类似这样的“策略问句”：前两天涨跌幅小于-2%；跳空高开；振幅小于2%；缩量；今日收盘价大于前两日最高价。然后点击“回测一下”，即可生成对于该选股规则的统计数据。这里的绩效和我们看到的长期绩效不同，以股票上涨为核心目标，分析“最优平均涨跌幅”和“最大上涨概率”，并通过“历史发生次数”告知用户该统计绩效的可信度。如图1-15所示。

持股周期是重要参数，平台默认测试1、2、3、4、5、10天的绩效。按照3.5%、7.5%两个分位数，平台生成了持股涨幅饼图供用户参考。由于整个回测过程完全基于数据支撑，所以底部“历史明细查询”栏，可以提供“股票简称”“起始时间”“终止时间”“起始价”“终止价”“区间涨跌幅”细节数据。参考我们订立的规则复杂程度，以及回测时间，我们认为i问财的回测效率是非常快的，适合普通投资者以极快的速度生成自己的交易策略，并验证效果。

该产品设计以“股票上涨”为核心目标，紧盯涨幅、上涨概率等关键绩效，可以说透彻地把握了自己的目标客户心态。平台搜索框甚至提供了免打字的功能，可以用鼠标勾选策略关键字。如图1-16所示。

图1-14 i问财首页入口，通过“策略问句”引导用户



图1-15 以上涨为核心分析点的绩效结果



图1-16 “策略广场”中较为高质量的策略模型



“创建策略”频道设计方式类似，但是绩效输出更为详细，由之前的仅以上涨为分析目标，转变成“单次收益平均值、预期年化收益率、盈亏比、最大回撤率、夏普比率、交易次数”等接近量化投资的绩效。资金曲线固定以沪深300为基准，按照回测时间绘制。

“策略广场”展示了在全部策略中表现较好的一些策略，相信投资者看到资金曲线都会动心。我们仔细分析了几个策略，发现条件设置较为周密，但是信号数量可能偏少，或者持股没有构成一个组合，所以在未来实盘的稳定性方面显得略有疑问。但是总体上它们都真实呈现了市场风险和收益来源结构，系统本身的回测平台效率也较高。

特点如下：

（1）基本面数据充实准确、维度多。

（2）量价关系表述简单，策略语句易掌握。

（3）回测速度快，图表呈现简洁易懂。

2.果仁网可视化策略平台

果仁网在专业程度方面略高于i问财，其创始人从曾担任通联数据CTO和研发总监，所以第一次登录该平台时会发现它更接近一个量化策略开发网站，而且是标准的多因子模型开发网站。

但是果仁网缺乏类似“策略问句”这样语言的识别能力（在一定程度上它不是非常入门的平台），所以该网站任何选项，都要通过鼠标点选或者输入值，一步步按规则完成。通过查阅资料我们注意到果仁网官方的观点，果仁认为量化可以不编程，但不能没有数学做基础。自然语言的不精确性，很难满足严肃的量化研究的需求。如图1-17所示。

在其核心频道“股票策略研究”，果仁网推荐用户按照“择股设置→交易模型→大盘择时→股指对冲”的顺序，依次搭建模型。第一个选项卡“择股设置”可通过设置“行情、技术指标、财务指标、财报条目、公司、大盘指标”选择到需要的股票。这就是我们常说的因子，你可以通过选择“财务指标”，然后选择“估值→市盈率、市净率”等，最后在右侧输入需要的值。

图1-17 果仁网严谨详细的选股界面



这样就可以实现静态的财务因子选股，比如低PB、高ROE等因子组合，都可以通过这个界面组合出来。当然如果读者们有一定的因子模型知识，还可以组织低动量因子、高成长因子、低估值因子，做出一个更加高性能的多因子模型。

“交易模型”选项也是本书后文要讲的调仓规则，可以选择模型I，这是大多数多因子模型的调仓模式，通过定期轮动的方式调整当前持仓股，使之符合模型要求，非调仓日不调整，以免产生过度频繁的交易。模型II增加了卖出条件的限制，我们可以设置止盈、止损、追踪止损等一些列条件。

“大盘择时”选项可以不使用，该模块作为一个附加模块来增强收益，在股灾或者大面积下跌时清仓股票降低损失。如果开启，大盘的动量效应充足则可以使用择时类技术指标交易，一旦确认选择的条件由熊变牛，或者由牛变熊，则可以调整仓位到空仓或仓位降低30%、50%、70%来降低风险。

“股指对冲”选项也是可选项，通过该方式可以做空一定比例的股指期货，几乎完全对冲掉Beta风险，保留Alpha收益，形成中性产品。为了回测尽可能详细，对冲比例、保证金比例都可以调整。如图1-18所示。

图1-18 较为专业的绩效展示和资金曲线图



果仁网也提供了策略商城和共享策略频道，可以在这里购买更专业的用户开发的交易策略，或者交流自编策略。总体来看，该网站更适合进行多因子模型开发，而且是严谨的定量模型开发。我们可以在这里看到更多有价值的、股票数量组合更合理的交易策略，还能看到部分股市内资产配置策略，带来更稳定的年度收益率。

3.聚宽向导式因子策略生成器

聚宽JoinQuant并非是可视化免编程平台，而是国内较大的量化研究平台，面向成熟的交易者使用Python为基础开发语言。但是为了扩大用户群，聚宽使用自己的数据储备和因子储备，开发了向导式策略生成器这个频道。向导式策略生成器的访问地址是：https://www.joinquant.com/algorithm/index/generateStock。如图1-19所示。

图1-19 聚宽平台因子选股界面



该频道和果仁网有一定类似之处，首先是“选股”规则建立，这里的因子选股有财务因子、行情因子、技术指标、资金流和其他条件，读者们可以详细体验两个网站的不同之处。

然后是买卖条件频道，这里有轮动和择时两个选择方式，如果选择轮动则略微简单，如果选择择时，将更多的是按照技术指标进行动量交易，这里需要单独设置买入和卖出条件，同时需要设置交易周期、持股比例等。

对于量化初学者可能会造成一定程度的选择性障碍，因为我们大多数时间没有准确描述自己的交易持股方法，甚至选股方法也没有系统地回忆和总结过，但是作为量化开发的规则，它们都是必须存在的。而且我们在模型开发后期能体会到，聚宽通过该频道大量鼠标点选的功能，将复杂的代码开发完全屏蔽掉。而如果交易者自己开发这些选股持股规则代码，仅熟悉代码、阅读API文档和准确完成交易模型代码构建，就需要数月时间。

“风险控制”多是对止损、止盈的设置，如果是多因子模型特别是中性Alpha模型，则可以放弃择时模块的构建。如图1-20所示。

图1-20 向导式策略开发工具拥有和编程开发同样的绩效界面



“其他参数”可以认为是回测环境。向导式策略开发工具的回测条件和聚宽的策略开发平台完全吻合，可以设置时间、资金量、频率（数据推送或者说模型运行频率），还有资金曲线图的对比基准。在“我的策略”频道，该策略会和Python开发编写的策略一样，在该频道被保存，以便后期回测和修改。

聚宽也在策略实盘方面做了很多探索工作，这保证了策略能够被有效使用，也降低了模型和交易之间的差距。

4.米狗K线模式识别量化平台

作为新晋免编程平台产品，米狗量化比起前面三个平台关注者较少。但是它有自己独特的工具与巨头竞争，这就是K线形态模型和图形组合模型。米狗最大的不同之处在于可以通过鼠标点选或圈选一段时间内的K线数据，或者调用系统内置的形态如“弧形底”“纺锤型K线”等形态，然后系统通过智能匹配后台历史数据，找到类似形态出现后的各项绩效，完成这种另类的模型搭建。米狗量化的访问地址是：http://www.migou360.cn/。

最初我们也考虑过这种K线形态建模方式作为量化模型是否稳健，但是经过回测和基于交易者行为的分析，这种模式通过数学和编程代码撰写也被认为是可行的，而且A股大部分投资者对于K线形态印象深刻，也在日常交易中反复使用类似经验，所以以此方法构建模型有用户认知基础，也有内在逻辑。

进入米狗平台“模型列表”频道，首先设置初始资金，每次开仓使用权益的百分比和交易成本。米狗没有严格规定持仓股数量，可以大致认为每次使用10%资金，就是买入10只股票，实际上会有上下浮动，以保证资金能被高效利用。如图1-21所示。

图1-21 米狗K线形态识别和技术指标结合模型搭建工具



在策略构建的因子方面，第一个选项框“数据”还是老一套的行情数据、财务面数据，和其他平台没有区别。

第二个选项框“模型”是很独特的模块，可以选择K线形态模型，调用系统数据库K线形态，也可以选择图形模型，这里存储了一些K线组合形态，估计会非常消耗平台计算资源，所以暂时数量不多，还可以调用已经成型的选股模型，包括连续涨跌停和基本面有一定特色的个股。

第三个选项框“指标”主要以技术指标为核心，覆盖较为全面，每个技术指标的周期可以单独定义。比较、逻辑模块，完成了较为复杂的策略所必须的判断工作，比如我们选择3个K线形态，要求只出现1个即可执行选股买入，在逻辑模块选择“或者”即可达到目的。表达式模块可以构造新的因子，对于专业水平较高的用户可能比较实际。如图1-22所示为绩效展示界面。

图1-22 米狗平台的绩效展示界面



在回测速度方面，米狗依然无法和i问财相比，可能是因为策略逻辑更为复杂，而不仅是简单的限定性条件选股模型，但是我们测试同样复杂度的策略，米狗的速度比聚宽等平台快很多。回测界面详细程度类似专业量化平台，对于夏普比率、信息比率、胜率、年化收益等都有描述。资金曲线的对比基准可选，且标注出了最大回撤阶段。





第2章 快速驾驭编程语言知识



2.1 TB基本编程——基础知识


我们将这部分知识放在模型讲解之前，是因为交易开拓者TradeBlazer使用的Easy Language编程语言简单易懂，掌握这种语言也是进入量化研究领域的敲门砖。很多量化交易初学者都是通过期货CTA开始的，一方面是国家政策允许对期货进行程序化交易，另一方面更核心的因素是编程门槛低，各大商业软件公司开发了自己的交易平台和交易语言，内置了大量方便的函数可供调用。

考虑到交易开拓者TradeBlazer的语言不可能完全没有门槛，所以新进入量化领域的读者，需要付出一定的时间和精力来记忆理解这套系统的编程语言。

首先要肯定的是，在期货可编程量化软件里，交易开拓者TradeBlazer（以下简称TB）开发的语言系统是接近于理想编程环境的，它将大量的底层控制封装起来。用户只关心交易的逻辑，将精力集中在交易方面即可，并且它的代码格式和结构类似C语言一般工整。这类软件的数据质量和程序准确度很高，部分机构也使用它作为开发平台，尽管实盘可能有自己的IT系统，但是在开发策略阶段为保证效率和精力分配的侧重点，自有IT平台往往不如TB和MC之类的平台方便。具体代码如下。

//定义参数

Params

Numeric FastLength（5）;

Numeric SlowLength（20）;

//定义变量

Vars

NumericSeries AvgValue1;

NumericSeries AvgValue2;

//模型语句开始

Begin

//定义两条均线，并通过AverageFC求出均线值

AvgValue1=AverageFC（Close,FastLength）;

AvgValue2=AverageFC（Close,SlowLength）;

//绘制两条均线

PlotNumeric（"MA1",AvgValue1）;

PlotNumeric（"MA2",AvgValue2）;

//集合竞价和小节休息过滤

If（!CallAuctionFilter（））Return;

//当目前模型没有持有多仓且短期均线上穿长期均线

If（MarketPosition <>1 && AvgValue1[1]> AvgValue2[1]）

{

//买入开仓1手，在open价格

Buy（1,Open）;

}

//当目前模型没有持有空仓且短期均线下穿长期均线

If（MarketPosition <>-1 && AvgValue1[1]< AvgValue2[1]）

{

//卖出（做空）开仓1手，在open价格

SellShort（1,Open）;

}

END

普通用户搞清楚数据定义、函数调用、条件、循环等语句控制，基本上可以编写自己的交易程序，几乎没有障碍，遇到不懂的函数随时启动帮助系统查询，有详细的定义、参数说明和使用案例。

交易模型运行在TB软件所说的Bar数据上。每一个Bar数据，就是我们所说的一根K线，它可以是各种周期的K线。公式代码从上至下运行，在每个K线图表上，从左到右执行，判断每一根Bar是否满足开仓或平仓条件，这就是历史数据的回测逻辑。如图2-1所示。

图2-1 公式执行按照代码从上至下，Bar数据（K线）从左到右的顺序



在实盘交易中，如果接收到新的Tick数据，则每个Tick会驱动程序在最后一根Bar上运行一次，而最新接收到的这个价格值就是Close（如果这个Tick是本Bar的最高价或最低价，那么这个Tick值同时还是High和Low），所以在编程时一定不要直接使用Close，也不要在Close上发出交易指令，这是典型的引用当前信息，会造成TB用户常说的“信号闪烁”问题。

Tick是交易所传来的每个时间单位数据，一般是每秒两Tick，国内商品期货最细粒度就是每秒两Tick（即每500毫秒一个Tick），股指期货每秒四Tick（即每250毫秒一个Tick），时间以毫秒计算。所以这决定了，我们的开平仓交易指令最好以上一个Bar的信息作为计算基础。但是突破类模型，可以用当前的High和Low，然后在回测时，也对比本Bar的Open和High谁最高（或Open和Low谁最低）来发交易单，回测就不会产生偏差（后文会有大量类似代码）。

信号会显示在K线图表上，这是这类软件比起股票程序化在线式平台更好的地方，只要你调用了这个模型到K线上，买卖开平等信息都会直接显示在K线上。

一个模型，具体分为声明参数、声明变量、程序脚本正文（也就是调用函数计算，并发交易单）。如图2-2所示。在正文最后部分，一般是开多、开空、平多、平空这4个指令。然后是止损或者追踪止损指令。TB软件除用户函数以外，内建了400多个系统函数，均可在软件帮助文档（F1键）的索引里找到具体的说明以及使用方法。各位读者要付出大量时间阅读资料，理解记忆，才能提升自己的投资能力，真正驾驭期货CTA量化投资，开始自己的程序化模型开发。

图2-2 模型（或函数）有3部分组成——参数、变量、正文



系统函数分类如下。

◎ 数学函数Abs

◎ 字符串函数Text

◎ 时间函数Time、CurrentTime

◎ 数据函数Barcount、High

◎ 属性函数BarType、MinMove最小变动量

◎ 行情函数Q函数

◎ 账户函数A函数

◎ 枚举函数Enum_Buy

◎ 交易函数EntryPrice

我们必须记忆的常用交易函数如下。

◎ Buy（多头开仓）

◎ Sell（多头平仓）

◎ Sellshort（空头开仓）

◎ BuyToCover（空头平仓）

◎ A_SendOrder［Buy Or Sell（买入/卖出）,Entry（开仓）/Exit（平仓）/ExitToday（平今）,fLot（发送委托单量）,fPrice（交易价格）］

常用数据函数如下。

◎ BarStatus：当前Bar的状态值。

◎ Close或C：当前Bar的收盘价。

◎ Open或O：当前Bar的开盘价。

◎ High或H：当前Bar的最高价。

◎ Low或L：当前Bar的最低价。

◎ Vol或V：当前Bar的成交量。

◎ Time或T：当前Bar的时间。

常用数学函数如下。

◎ Waverage：求加权平均。

◎ Xaverage：求指数平均。

◎ AvgPrice：求平均价格。

◎ CrossOver：求是否上穿。

◎ CrossUnder：求是否下穿。

◎ Highest：求最高。

◎ Lowest：求最低。

◎ Summation：求和。

其他常用语法如下。

◎ MarketPosition：获得当前持仓状态。

◎ BarStatu：当前Bar位置状态。

◎ SetStopLoss：在亏损达到设定条件时产生平仓。

◎ ExitPosition:True所有仓位平仓 False单独对每个建仓位置进行平仓。

◎ Numeric：表达单个变量。

◎ NumericSeries：表达与Bar数量等长的数组变量。

我们现在看到的是所有必须记忆的函数，因为它们太常见于每一个交易模型的代码，如果这些函数看不懂，未来自己读代码、写代码都无法顺利进行。主要有4类函数，第一类是交易函数，就是4个交易信号+1个A——SendOrder（这个函数可以先略过），先用4个简单的交易信号指令来编写代码。第二类是数据函数，比如开盘价、收盘价、成交量和时间。第三类是常用数学函数，比如均线。第四类是其他常见语法，比如下单时要看目前的持仓状态、止损和平仓、变量的声明和数组变量声明。

关系运算符是计算过程中所需要的符号，即大于、小于、等于这样的关系如何编写，大家对算数运算符应该更加了解，它类似于Excel的单元格操作语言。如表2-1和表2-2所示。

表2-1 关系运算符



表2-2 算术运算符



这是一个引用参数的案例，名称是定义了一个用户函数MyFunc，该函数首先定义3个参数Price、mHigher和mLower，初始值都是0，然后定义了一个变量Tmp，初始值也是0。程序开始，Tmp值是以10为周期的Price的移动平均价格，mHigher是先比较Tmp和当前Bar最高价谁更高，就等于谁，mLower同理。

用户函数MyFunc，如图2-3所示，代码如下。

Params

NumericSeries Price（0）;

NumericRef mHigher（0）;

NumericRef mLower（0）;

Vars

Numeric Tmp（0）;

Begin

Tmp=Average（Price,10）;

mHigher=IIf（Tmp > High,Tmp,High）;

mLower=IIf（Tmp < Low,Tmp,Low）;

Return Tmp;

End

用户函数可以通过参数传入，返回函数的计算结果。我们可以在自己的模型中不仅调用TB官方封装好和写好的函数，也可以自定义很多常用函数。在股票模型中，类似Ta-Lab的库也完成了这项工作，大部分技术指标都已经被编写好，不用开发者自己撰写一行行晦涩的数学公式。

TB系统提供的交易指令是开多、平多、开空、平空，即Buy（多头开仓）、Sell（多头平仓）、Sellshort（空头开仓）、BuyToCover（空头平仓）。以Buy函数为例，常规使用方法有3个控制因子在括号里，分别是买入数量、买入价格、是否有买入延迟和延迟多久。

图2-3 在TB“公式管理器”中，可看到自己编写的公式，其他模型都可调用



TB系统还支持全局变量功能，可以标记不同的模型逻辑和开平仓方式，这部分知识大家可以在其官方网站下载更详细的教程了解。





2.2 TB基本编程——条件循环语句


控制语句让模型可以在不同的情况下执行不同的操作，这是编程所必须的。其中算法中的条件结构是由条件语句来表达的，它是处理条件分支逻辑结构的算法语句，其一般的构成形式是If-Else-Elseif格式，具体如下。

If（Condition）

{

TradeBlazer公式语句1;

}Else

{

TradeBlazer公式语句2;

}

Else包含了除了If之外的所有可能性。比如if A>B其他的所有可能性就是A<B 和A=B。

If语句表示，达到If括号里要求的条件后，执行大括号里的语句。If-Else语句，是表示一个两分支，如果达到If描述的条件，就执行大括号里的语句。除此之外，这里的“此”就是针对If所描述的情况，全部用Else涵盖，并且执行Else里面的语句。具体如下。

If（Condition1）

{

TradeBlazer公式语句1;

}Else If（Condition2）

{

TradeBlazer公式语句2;

}Else

{

TradeBlazer公式语句3;

}

If-Elseif-If语句，则是可以持续性地扩展下去的多分支。可以在最后的Else之后不断添加新的分支。If-Else的嵌套表示多层次的分支，比如程序先分为Condition1和除了Condition1之外的两只，然后，在Condition1内部，又分为多种情况，但是它们总体上都是在Condition1这个条件之内的。这样我们就可以控制略微复杂一些的交易程序发出指令的规则。

这里举了一个例子，以对If-Else嵌套做简单解读。

If（Open > High[1]）　//如果当前Bar的开盘价>上一根Bar的收盘价，执行下面的分支

{

If（Close>Open）

{

Buy（1,close）;

}Else

{

Buy（1,open）;

}

}Else　//当前Bar的开盘价≤上一根Bar的收盘价，执行下面的分支

{

If（Close > Open）

{

Sell（1,close）;

}Else

{

Sell（1,open）;

}

}

第一层是当前Bar的开盘价>上一根Bar的收盘价，则执行分支，里面包括了“收盘价>开盘价”和“收盘价≥开盘价”也就是针对上一个If，用Else条件描述的情况。第二层是当前Bar的“开盘价≤上一根Bar的收盘价”，也就是针对第一层的If，用Else条件描述的情况。

IF是一个表达非常简单的语句，可以通过简明的语言，把两种不同的情况，返回条件所要求的值。如以下代码所示，第一个逗号后面的值，是满足条件时返回的值。第二个逗号后面的值，是不满足条件时返回的值。

Numeric IIF（Bool Conditon,Numeric TrueValue,Numeric FalseValue）

IF语句的作用是根据表达式的值，来返回两部分中的一个。

◎ TrueValue条件为Conditon为True（真）时的返回值；

◎ FalseValue条件为Conditon为False（假）时的返回值。

myValue=IIF（Close>Open,Close,Open）;

如果当前Bar的Close>Open（收盘价>开盘价，即为阳线），则myValue=Close（收盘价），否则myValue=Open（开盘价）

for语句是一个条件循环语句，按照循环变量以1为步长递增，重复执行语句，直到达到条件，常用于递增某个变量这样的案例。如果需要从大到小执行，则可以把To改为Down to。

for循环变量=初始值 To 结束值，代码如下：

{

TradeBlazer公式语句；

}

for 循环的执行从循环变量的初始值到结束值，按照步长为1递增，依次执行TradeBlazer公式语句，结束值必须大于或等于初始值才有意义。

这里的例子表达的是，计算Price值所有周期的和。首先定义两个参数 Price和Length，然后定义两个变量SumValue就是求和值，i是递增值。

Params

NumericSeries Price（1）;

Numeric Length（10）;

Vars

Numeric SumValue（0）;

Numeric i;

Begin

for i=0 to Length-1

{

SumValue=SumValue+Price[i];

}

Return SumValue;

End

上述案例中，程序从i=0到lenght-1进行历遍，重复执行花括号{}内部的条件。执行的语句是：SumValue在每个周期进行累计叠加。最后达到lenght-1条件的时候，计算结束，返回这个值给SumValue。程序结束。

While循环语句在条件为真的时候，执行大括号里的语句，具体如下。

While（Condition）

{

TradeBlazer公式语句；

}

需要说明的是：交易开拓者允许一个K线图表里插入不同的数据，比如Data0：原图表Bar数据，可以插入螺纹钢指数合约RB000;Data1：第二个数据源，插入焦炭指数合约J9000……。

FileAppend函数也很实用，可以输出数值到电脑硬盘上，比如留下交易日志，或者输出数据做分析。语句格式是：

FileAppend（"c:\\Formula.txt","hello world"）;

还可以用这种形式输出重要数据，导出成TXT或CSV文件，放入其他的数据分析软件中。

FileAppend（"c:\\test.txt",

Text（Date）+","+

Text（Time）+","+

Text（Data0.Close））;





2.3 Python语言比你想象中更简单


本小节作为股票模型开发的前置部分，为大家快速讲解Python编程语法，这样就可以做到快速理解书中代码的含义，并撰写一些代码，按模板修改代码，这对于基本的模型开发已经足够了。前面已经讲解了TradeBlazer这种Easy Language语言，相信大家对于参数、变量数据类型、条件和循环语句已经基本掌握。

我们依然坚持程序化交易的核心问题在于策略思路，而不在编程能力。对于本书中没有讲解到的程序开发知识点，读者们可以通过其他渠道的学习资源自行补充，更重要的是大量开发自己的交易模型，在此过程中，逐步对Python达到真正熟悉。

1.Python基本语法描述

在编程学习与查询网站www.runoob.con上，有一句话给人印象深刻：Python是初学者的语言，对初级程序员而言，是一种伟大的语言，它支持广泛的应用程序开发，从简单的文字处理到WWW浏览器再到游戏。本章也部分引用了该网站案例来讲述Python基本语法。

IEEE发布2017年编程语言排行榜：Python高居首位。Python具有丰富和强大的库，常被称为胶水语言，能够把用其他语言制作的各种模块（尤其是C/C++）很轻松地连结在一起。它已被逐渐广泛应用于Web编程，以及金融分析领域。

Python有相对较少的关键字，结构简单，还有一个明确定义的语法，学习起来更加简单。

本书中的股票程序开发案例大部分在聚宽网站上完成，在优矿、米矿等网站上，只要符合基本语法（或者稍加改动符合其数据调用接口），都可以运行。

在https://www.joinquant.com/research投资研究界面，右上角点击【新建】按钮，会出现一个下拉菜单，选择 Python 2版本研究界面，即可调试书中的案例。如图2-4所示。

图2-4 Python 2版本研究界面



我们这样开始：在Python提示符中输入以下文本信息，然后按Enter键查看运行效果：

print "Hello,Python!";

再输入这样的语句：

print'stocks';print'futures';

可以看到程序显示了引号内的内容，这就是一段最简单的Python程序语言。

学习Python与其他语言最大的区别就是，Python的代码块不使用大括号{}来控制类、函数以及其他逻辑判断。Python最具特色的就是用缩进来写模块，缩进的空白数量是可变的，但是所有代码块语句必须包含相同的缩进空白数量。

if True:

print "True"　# 注意，每一级4个空格缩进

else:

print "False"　# 注意，每一级4个空格缩进

可以使用斜杠（\）将一行的语句分为多行显示，具体如下所示。

# 买入印花税=0，卖出印花税=千分之1，买入佣金=万3，卖出佣金=万3，最低佣金5元

if dt>datetime.datetime（2013,1,1）:

set_order_cost（OrderCost（open_tax=0,　　　　　　　close_tax=0.001,open_commission=0.0003,\

close_commission=0.0003,　　　　　　　　 close_today_commission=0,min_commission=5）,type='stock'）

上面的代码语句，实现了换行效果。

2.Python基本变量描述

Python中的变量不需要声明，变量的赋值操作即是变量声明和定义的过程。换句话说，在使用变量的时候，必须要给这个变量赋值；如果只写一个变量而没有赋值，那么Python认为这个变量没有定义。

变量的命名由字母、数字、下画线组成，但不能以数字开头。

输入：

stocks_num=100　　 # 整型变量

stocks_price=172.48 # 浮点型变量

name="APPL"　　　 # 字符串型变量

print stocks_num

print stocks_price

print name

通过print指令我们看到相关的变量名称。

Python有以下5个标准数据类型。

◎ Numbers（数字）：用于存储数值，它们是不可改变的数据类型。

◎ String（字符串）：字符串或串（String）是由数字、字母、下画线组成的一串字符。

◎ List（列表）：用[]标识，是Python最常用的复合数据类型，可以完成大多数集合类的数据结构实现。

◎ Tuple（元组）：类似列表，元组用“（）”标识，内部元素用逗号隔开，但是元组相当于只读列表。

◎ Dictionary（字典）：字典用“{}”标识。字典由索引（也称为键名（key））和它对应的键值value组成。

接下来我们列出5个股票模型的常见案例，演示这5种数据类型。

（1）Numbers（数字）：

lag=20　　# 回溯期

hour=14　 # 小时（每天交易时间：具体哪个小时bar）

minute=53　# 分钟（每天交易时间：具体哪个分钟bar）

这里给3个变量赋值，作为模型初期的参数。在使用聚宽等网站开发的股票模型头部，经常需要定义参数，为了让参数在各个函数中都可以被识别传递，这种变量一般都会加上g作为开头，成为全局对象g。

（2）String（字符串）：

signal=='sell_the_stocks':

if signal=='ETF500' or signal=='ETF50' or signal=='ETF300':

第一行代码给signal字符串赋值，第二行代码判断signal的具体值，看它具体是等于’ETF500’还是’ETF50’还是’ETF300'。

（3）List（列表）：

buyStockCount=3

stocks=[0,1,2,3,4,5,6,7,8,9]

stocks=stocks[:buyStockCount]

stocks

这里首先定义了一个变量 buyStockCount（买入股票数量=3），然后创建了一个stocks列表，最后取该列表的前3个值，运行得到结果：[0,1,2]。

（4）Tuple（元组）：

stock_list=（'601857','601628','601318','601601'）

print stock_list[1:3]

这里输出第二个和第三个元素，运行得到结果：（'601628','601318'）。

（5）Dictionary（字典）：

security_fields={'open': 9.12,'close':9.20,'volume':153647,'money':1413552,'paused':'false'}

print security_fields.keys（）

这里定义了一个 security_fields 字典数据类型，然后输出了该字典所有的键名keys。

print security_fields.values（）

这里输出了security_fields所有的键值values。

print security_fields['volume']

这里输出了print security_fields的键名volume的键值。

在具体的股票模型中，对于字典数据类型的适用情况非常多而且容易理解，比如：

# 全部卖出

for stock in context.portfolio.positions.keys（）:

order_target_value（stock,0）

在这段程序里，context.portfolio.positions 是一个字典数据类型，里面存放了security标的代码、price最新行情价格、avg_cost开仓均价等一系列信息，通过.keys（）将其输出，然后通过for循环逐一取出，输送给order_target_value函数做相关操作。只要stock还没有从context.portfolio.positions里取完，该循环就始终执行。

3.Python算术运算符

基本上略有程序开发经历的人，都能看懂算数运算符。在Python中常见的运算符有：+、–、*、/、**/<、>、!=、//、%、&、|、^、~、>>、<<、≤、≥、==、Not、And、Or。

以下案例假设变量：a=10,b=20。

◎+——a+b：输出结果30。

◎ –——a–b：输出结果–10。

◎ *——a*b：输出结果200。

◎ /——b/a：输出结果2。

◎ %——b%a：输出结果0。

◎ **——a**b：为10的20次方，输出结果100000000000000000000。

◎ //——9//2：输出结果4。

◎ 9.0//2.0：输出结果4.0。

4.Python比较运算符

比较运算符通常执行逻辑判断，以达成分析一个语句是否是真或者假。

依然假设以下案例中的变量a为10，变量b为20。

◎==——（a==b）：返回False。

◎!=——（a!=b）：返回True。

◎ <>——（a<>b）：返回True。这个运算符类似！=。

◎ >——（a>b）：返回False。

◎ <——（a<b）：返回True。

◎ >=——（a>=b）：返回False。

◎ <=——（a<=b）：返回True。

◎ And——（a and b）：返回20。

◎ Or——（a or b）：返回10。

◎ Not——not（a and b）：返回False。

需要注意的是，除了True和False以外，所有比较运算符还可以返回1表示真，返回0表示假。这与特殊的变量True和False等价。

会使用到的运算符有：

◎=——c=a+b：将 a+b 的运算结果赋值为c。

◎+=——c+=a：等效于 c=c+a。

◎ –=——c–=a：等效于 c=c–a。

◎ ~——按位取反运算符：对数据的每个二进制位取反，即把1变为0，把0变为1。

◎ In——在指定的序列中找到值返回True，否则返回False。

◎ Not in——如果在指定的序列中没有找到值返回True，否则返回False。

5.Python条件与循环

Python编程中If语句用于控制程序的执行，基本形式为If-Else，具体如下。

If判断条件：

执行语句

Else：

执行语句

判断条件为多个值时，可以使用以下形式If-Elif-Else。

If判断条件1：

执行语句1……

Elif判断条件2：

执行语句2……

Else：

执行语句3……

案例：

#去除ST、*ST等股票

current_data=get_current_data（）

for stock in buylist:

if current_data[stock].is_st==True:

buylist.remove（stock）

else

pass

首先通过聚宽内置的get_current_data（）函数取到股票的is_st停牌属性。然后逐一判断，如果[stock]这只股票的is_st停牌属性==True，就通过.remove函数将它从buylist列表中删除。如果没有停牌，则什么也不做（pass）。

在循环语句方面，Python提供了for循环和while循环。以下案例帮助大家理解其使用方式：

count=0

while（count < 9）:

print'The count is:',count

count=count+1

print "game over"



通过运行该案例，可以看到程序循环地在count<9时输出目前的count。在count逐渐递增1，且大于等于9的时候，输出"game over"。

关于for循环，几乎每个程序都会用到，我们用下面这个案例来帮助大家理解：

# 打印1-9三角形阵列：

for i in range（1,11）:

for k in range（1,i）:

print k,

print "\n"



最后放上一个循环嵌套的语句，相信大家看到这里，已经能够理解：



这段代码首先定义了一个函数remove_new_stocks，有def就有相应的return。然后通过for循环，依次判断股票。内部通过判断days_public 是否小于365，来分类股票是次新股还是老股票。如果是，则通过security_list.remove（stock）移除该股票元素，然后返回一次ecurity_list列表。

6.list集合的简单操作

a=[1,2,3,4,5,6]

b=[0,2,3,4]

# 求a-b差集，方法1

Inter=[]

for i in a:

if i not in b:

Inter.append（i）

Inter

# 求a-b差集，方法2

Inter=[i for i in a if i not in b]

Inter

# 求a-b差集，方法3

diffset=list（set（a）.difference（set（b）））# b中有而a中没有的元素

diffset



# 求交集1

Inter=[i for i in a if i in b]

Inter

# 求交集2

Inter=[]

for i in a:

if i in b:

Inter.append（i）

Inter



# 求并集（a和b的元素合并去重）

unionset=list（set（a）.union（set（b）））

unionset



考虑到在股票模型中会涉及大量对于股票名单集合的操作，比如用两种思路选到了两份名单，求其中的交集买入。或者得到一份买入名单，首先要判断里面的股票是否已经在持仓中，求差集，然后买入差集中不存在的股票，这些股票才是待买入股票。

7.尝试阅读简单模型





将这个模型复制到聚宽网站“我的策略”:https://www.joinquant.com/algorithm/index/list页面，新建一个策略，粘贴完即可进行编译（回测）。

如果在较长的考察期内回测，大家可以看到基于个股的动量模型难以跑赢指数。替换比较热门的大小盘股票代码也会发现类似的情况，除非这只股票的上涨幅度很大，才能抵消简单的主动择时带来的性能损耗。

这个策略能否赚钱的意义不大，目前仅仅是熟悉代码，还不涉及具体策略的开发，股票领域的策略模型和期货有较大差别。

之所以引入一个简单完整的模型在这里，是希望读者们感受到，学习进度其实很快，已经可以阅读基本的时间序列模型。但是要驾驭一个有实质内容的股票模型，离不开表格处理、数组、字典等操作。所以接下来我们需要了解两个来源的第三方库，它们可以免费调用，简化模型开发，甚至部分功能必须依靠它们实现。

对于新手用户，网站提供的API文档是必读的，在这里可以随时查询系统函数。API中会给出用法、案例，这些函数由网站开发编译，方便用户完成获取数据、下单等一些列操作。





2.4 Python Numpy库常用操作解读


Numpy可以被理解为是一个以矩阵为基础的数学计算模块，是纯数学库。它的部分功能已经和Python其他库开始融合，比较常用，也比较容易理解。Python的Math数学库对于矩阵支持不太好，所以Numpy被更广泛地使用。

Python自身虽然支持整型、浮点型和复数型数据类型，但现实中我们仍然需要更多的数据类型来满足在精度和储存大小方面的各种不同的要求。Numpy这个模块对于量化模型的开发也能提供帮助，它丰富的数据类型会让模型语句更加简洁。

array数组

创建数组的方法有很多，比如可以使用array函数从常规的Python列表和元组创造数组，所创建的数组类型由原序列中的元素类型推导而来。

NumPy的主要对象是同种元素的多维数组，NumPy提供的array（）函数可以直接将Python数组转换为ndarray数组，array（）函数接受一切序列类型的对象。这是一个所有的元素都是一种类型、通过一个正整数元组索引的元素表格（通常元素是数字）。

创建array数组如这样：

import numpy as np

a=np.zeros（（2,2））

重要的ndarray对象属性如下。

◎ ndarray.ndim：数组轴的个数，在Python的世界中，轴的个数被称作秩。

◎ ndarray.shape：数组的维度。这是一个指示数组在每个维度上大小的整数元组，例如一个n排m列的矩阵，它的shape属性将是（2,3），这个元组的长度显然是秩，即维度或者ndim属性。

◎ ndarray.size：数组元素的总个数，等于shape属性中元组元素的乘积。

NumPy提供一个类似arange的函数返回一个数列形式的数组。

输入：

d=np.arange（0,2,0.5）

print（d）

# 得到从0开始，差值为0.5的等差数列

由于浮点数精度有限，通常无法预测获得的元素个数。因此，最好使用函数linspace去接收我们想要的元素个数，来代替用range指定步长。

参数1：起始数值，参数2：结束数值，参数3：结果个数。

a=numpy.linspace（0,10,5）

print（a）



常用的函数如下。

◎ Np.log（）：取对数。

◎ Np.max（）/min（）：最大值/最小值。

◎ Np.median（）：中位数。

◎ Np.sum（）：求和。

◎ Np.var（）：方差。

◎ Np.diff（）：相邻数据差。

◎ Np.std（）：标准差。

◎ Np.mean（）：平均值。

◎ Np.dot（）：点积。

◎ Np.cov（）：协方差。

◎ Np.inv（）：求矩阵的逆。

◎ Np.corrcoef（）：求相关系数。

◎ a.T：矩阵求转置。

◎ a.I：矩阵求逆。

下面看一个Numpy实用案例，取出该list的第一列，也就是股票代码列。定义一个list数据类型，该数据有两列组成，分别是股票代码和其对应的指标值：

momentum=[（'000669.XSHE',1.0467775467775469）,（'002057.XSHE',0.99301310043668123）,（'600455.XSHG',0.96930632289748309）,（'002058.XSHE',1.0279220779220779）,（'000803.XSHE',0.90300230946882221）,（'600647.XSHG',1.0174880763116056）,（'600634.XSHG',0.95668986852281512）,（'000711.XSHE',0.8947833775419981）]

momentum

要直接取出list数据类型的指定列数据并不好操作，但是一旦转化成 Numpy的array结构，就可以很方便地取出。

np_momentuma=np.array（momentum）

stocks_to_buy=np_momentuma[:,0].tolist（）

stocks_to_buy



通过此方法，即可实现对于np_momentuma[:,0]的取出，也就是第1列数据的取出，并转化成list数据格式。自然地，取出np_momentuma[:,1]就是取出第二列数据，也就是指标值，在程序中偶尔也需要调用。





2.5 Python Pandas库常用操作解读


Pandas主要作为金融数据分析工具而被开发，也可以理解为主要为了表格而生，其在很多量化投资模型中都被大量使用，特别是在股票模型的头部，你可以经常看到“import pandas as pd”语句，调用了Pandas库。下面我们进行简单讲解，在实战中大家可以多打印出模型的数据类型观察，即可理解我们创建的表格到底存储了哪些内容，体会这种库工具的便利性。

Pandas常被使用的数据结构有以下两种。

（1）Series：一维数组，与Numpy中的一维array类似。二者与Python基本的数据结构list也很相近，在读写语法上也基本一致。需要注意的是：list中的元素可以是不同的数据类型，而array和Series中则只允许存储相同的数据类型，这样可以更有效地使用内存，提高运算效率。

（2）DataFrame：二维的表格型数据结构。很多功能与R中的data.frame类似。可以将DataFrame理解为Series的容器。

1.Series数据类型

创建Series：

pd.Series（[list],index=[list]）

以list为参数，list;index为可选参数，若不填则默认index从0开始；若填写，则index长度与value长度相等，在股票模型中，index有时被填写为股票代码。

案例：

import pandas as pd

x=pd.Series（['a','s','d','f','g','h','j'],index=[1,2,3,4,5,6,7]）

print x

上面的案例中添加了一个index，如果不添加index，也可以直接创建Series，系统会自动添加从0开始的索引值，效果如下：

x=pd.Series（['a','s','d','f','g','h','j']）

print x



读取Series:x[index]or x[[index的list]]，该取值操作类似数组，当取不连续的多个值时能够以 list为参数或者部分读取：.index;.values，取出 index索引列与 values值列，返回list。如果数据量过大，还可以读取头尾：.head（n）;.tail（n），取出头n行或尾n行。

2.DataFrame数据类型

DataFrame是表格型数据，在模型中被大量使用，可以存储个股的各字段信息。它有行索引也有列索引，每列数据可以为不同的类型数据（数值、字符串、布尔型值），如图2-5所示。

图2-5 一个DataFrame数据结构



DataFrame提供的是一个类似表的结构，由多个Series组成，Series在DataFrame中叫columns。DataFrame可以认为是共享同一个index的Series集合。

将Series转化成DataFrame：

import pandas as pd

x=pd.Series（['a','s','d','f','g','h','j'],index=[1,2,3,4,5,6,7]）

df_test=pd.DataFrame（）

df_test['munbers']=x.index

df_test['values']=x.values

这里我们先创建了一个有值和索引的 Series 数据类型，然后创建了一个空DataFrame数据类型，名为df_test，创建语句为：df_test=pd.DataFrame（）。然后分别给它写入索引x.index和值x.values，转化过程完成。大家要熟练掌握DataFrame数据结构，因为在股票模型中会出现大量针对DataFrame的操作，比如你读取出的数据结构是一个DataFrame，然后要求从DataFrame中取出一列或者一行数据。

跟随刚才创建的名为df_test的DataFrame数据结构，进行下面的操作尝试：

df_test.index # 观察其索引的开始值、结束值、步进值

df_test.columns # 观察其列名

df_test.values # 观察其内部值



3.深入分析DataFrame数据类型

本节带大家逐一执行一些简单的语句，通过分析语法和运行前后的区别，可以预想到之后我们的模型将围绕这里做大量工作。其实任何一个数据类型的学习过程，都是了解如何对其做增删改查以及部分常见操作，下面我们逐一开始运行，依然是在聚宽的研究平台上，新建一个研究项目来调试。

# 创建一个Dataframe数据类型

import pandas as pd

# 这里的index表示索引行名称，columns表示列名称

# 我们在实战中创建Dataframe的时候，用股票代码作为index

data　=　 pd.DataFrame（np.arange（15）.reshape（（3,5））,index=['a','b','c'],columns=['1','2','3','4','5']）

data

# 取出第一列

# 两种方法皆可取第一列，但是.loc是更好的方法，它适用于根据具体标签选取列

data_1=data['1']

data_1=data.loc[:,'1']

data_1

# 取出第一行

data_a=data.loc[:'a',:]

data_a

# 取出全表中大于5的元素

data_select=data[data >=5]

data_select





# 修改一列数据

data_find=data

data_find['4']=100

data_find

# 修改一个数据

data_find['4'][2]=999

data_find



# 通过for循环依次给一行数据做一项运算

data_a_square=[]

for i in data_a.values:

data_a_square=i ** 2

data_a_square.tolist（）

# 通过map方法给一行数据做一项运算

array（map（lambda i: i**2 ,data_a.values））.tolist（）[0]

# 对矩阵行列转置

data_T=data.T

data_T





2.6 实战开始：在股票平台进行数据查询


很多开放式Python量化网站都可以进行模型开发，这里以国内使用人数较多，积累代码资源和教学资源较多的聚宽网站为例，演示一些数据查询的基本代码，这些代码在后期模型讲解中会大量出现，大家要做好准备。

各种量化开发网站都提供了完善的 API 文档供阅读：https://www.joinquant.com/api，任何不懂的系统函数、数据规则都可以通过查询API文档得到解决。这里仅介绍几个我们常用的数据查询函数：

常用函数一：get_index_stocks（获取某个指数的成分股名单数据）

该函数获取一个指数给定日期在平台可交易的成分股列表。

案例：

stocks_pool=get_index_stocks（'000300.XSHG'）

stocks_pool

设置沪深300为初始股票池，查询到该股票池的基本数据。键入 stocks，并打印出这个数据，目前它是沪深300成分股代码。我们经常通过该函数，获取一个基本的股票池，然后在池子里做相关交易操作。

常用函数二：get_fundamentals（获取基本面财务数据）

该函数可以查询财务数据，详细的数据字段描述在“财务数据文档”中。

案例：

# 选出所有的市净率PB小于2，营业总收入大于200亿元的股票

fundamentals_df=get_fundamentals（query（

valuation.code,valuation.pb_ratio,income.total_operating_revenue

）.filter（

valuation.pb_ratio < 2,

income.total_operating_revenue > 2e10

）.order_by（valuation.market_cap.desc（）

# 按市值降序排列，total_operating_revenue的字段单位为元，所以2e10代表大于200亿元

）.limit（100

# 最多返回100个

）,date='2015-10-15'）



我们经常通过该函数，获取到我们想要过滤的、符合基本面条件的安全股票池，比如机构交易者要过滤掉换手率过高和过低的股票，或者过滤掉PE过高或者PE为负的亏损企业。

研究界面也能通过绘图实现数据可视化，可以用这样一段函数完成绘图工作，以total_operating_revenue字段为例绘图，代码如下。

pb_ratio=fundamentals_df['pb_ratio']　# 首先提取pb_ratio一列为一个list数据类型

plt.title（'pb_ratio'）　　　　　　　　 # 设定图片标题

plt.bar（range（len（pb_ratio））,pb_ratio）　 # 设定图片元素数量，按照pb_ratio所含元素数量

plt.show（）　　　　　　　　　　　 # 绘图



提示一下，因为get_fundamentals函数查询到的结果为pandas.DataFrame数据结构，该语句大部分出现在代码前半部分，以定义股票范围，而后半部分的具体操作都是对股票代码的操作，所以通常要加上这样的语句：

stock_list=list（fundamentals_df['code']）

# 获取到代码，转化成list数据类型

因为获取基本面数据非常重要，所以这里还要增加一个 API 接口的说明：get_fundamentals_continuously，获取阶段内基本面数据。和查询点数据不同的是它查询的是阶段内数据，返回一个pandas.Panel数据类型。该函数能够获得一段时间内的序列值，而get_fundamentals函数仅能获得一个单点值。比如换手率因子数据，我们需要获得连续5日或20日的数据，然后通过求和、求标准差等方式，可以更好地以低噪声方式，最终得到稳健的因子值。

以下是提取阶段内基本面数据的案例。





常用函数三：attribute_history（获取历史数据）

该函数可以查看某一只股票的历史数据，可以选择这只股票的多个属性，默认跳过停牌日期。一般调取历史数据，都依靠这个函数。

案例：

close_data=attribute_history（security,20,'1d',['close']）

# 取得security过去20天，以1d日线为频率，收盘价格

h=attribute_history（stock,interval,unit='1d',fields=（'close'）,skip_paused=True）

# 取得security过去interval周期的收盘价格，跳过停牌日期

print h['close']

# 打印出 h 的收盘价序列，打印后可看到，该函数的参数 df：默认是 True，返回pandas.DataFrame数据类型。所以自带一个索引为股票代码。

常用函数四：get_current_data（获取当前时间的个股信息）

获取当前单位时间（当天/当前分钟）的涨跌停价、是否停牌、当天的开盘价等。该函数不用传入参数。

案例：

# 过滤停牌、退市、ST、开盘涨跌停自定义函数

def filter_specials（stock_list）:

curr_data=get_current_data（）

stock_list=[stock for stock in stock_list if \

（not curr_data[stock].paused）　 # 未停牌

and（not curr_data[stock].is_st）　# 非ST

and（'ST' not in curr_data[stock].name）　 # 非ST

and（'*' not in curr_data[stock].name）　# 非*特殊处理

and（’退’not in curr_data[stock].name）# 非退市

# 开盘未涨跌停（跌停板价小于开盘价小于涨停板价）

and（curr_data[stock].low_limit < curr_data[stock].day_open < curr_data[stock].high_limit）]

return stock_list

需要注意的是，get_current_data函数只能取到开盘价，来判断开盘是否涨跌停，所以如果用了这样的代码，你的模型必须在开盘价下单成交（买入或者卖出）才可以。

如果不是在每天9点30分开盘价交易的模型（使用分钟线盘中成交模型），都需要这样写：

def filter_specials（stock_list）:

curr_data=get_current_data（）

stocklist=[]

for stock in stock_list:

price=attribute_history（stock,1,'1m','close'）

price=price.values[0][0]

if（not curr_data[stock].paused）

and（not curr_data[stock].is_st）

and（'ST' not in curr_data[stock].name）\

and（'*' not in curr_data[stock].name）\

and（’退’not in curr_data[stock].name）\

and　（curr_data[stock].low_limit　<　price　<　curr_data[stock].high_limit）:

stocklist.append（stock）

return stock_list

因为如果想在任意分钟线上去交易，只有attribute_history函数能够取到当前的价格信息，参考 low_limit和 high_limit做判断，看价格是否在涨跌停板。所以要引入attribute_history函数替换get_current_data函数取价格的字段，但是其他信息依然可以通过get_current_data函数取到。

常用函数五：get_security_info（获取单个标的基本信息）

这里所说的基本信息和get_current_data函数拿到的详细信息不同，这个函数只能拿到名称、上市退市日期等信息。但是该函数也能帮助我们做一些有意义的工作。

在研究模块中可以键入：get_security_info（'000300.XSHG'）.start_date。

运行得到：atetime.date（2005,4,8）。

这是沪深300指数的上市日期。

键入：get_security_info（'601336.XSHG'）.display_name。

运行得到：u'XHBX'。

这是新华保险的中文简称。

案例：

# 过滤新股和上市365日内的次新股

def filter_new_and_sub_new（stocklist,days=365）:

stock_list=[]

for i in stocklist:

start_date=get_security_info（i）.start_date

if（datetime.date.today（）-start_date）> timedelta（days）:

stock_list.append（i）

return stock_list





第3章 股票期货择时交易模型



3.1 ETF二八择时法则，跑赢基础股票指数


由于有了第2章对于Python基础编程知识的熟悉，本章将逐步提升代码复杂度，有任何不理解的变量等数据类型，都可以通过print代码输出查看，或者通过log文件打印出日志进行核对，核心的问题是观察其格式是否正确，以及行列值是否是我们需要的数据。

在聚宽平台上，股票交易模型可以被认为在之前的研究模块内容基础上，加入了买入、卖出交易指令，以及更加复杂的数据查询，然后按时（按每日频度、每分钟频度）运行，最终构成连续交易的资金曲线和绩效报告。

1.为何选择ETF基金作为交易对象

本节介绍的模型是“二八ETF基金轮动改版模型”，其核心思路来源于雪球“蛋卷斗牛二八轮动基金”。

ETF基金在股票市场中生命力持久，甚至成为部分投资者的唯一选择，本质原因是它剥离了个股（及其背后的上市公司）特质风险，通过获得市场系统性风险反而降低了个股选择的难度，同时ETF基金和市场指数波动的吻合度在98%以上，追踪误差极小，这意味着我们基本上能够保证通过被动持有跑平市场。个股投资虽然有大幅度获利机会，但也非常容易被基准指数甩出很远跑输市场。ETF基金还有交易手续费低、交易规则多样、交易频率低等优势。

从时间序列量价分析的角度看，个股的时间序列噪声高、随机性强，不容易获得主趋势（信号），反而容易被次级趋势和微弱趋势（噪声）所困扰，通过择时等方法跑赢持有个股实属不易，而持有个股又带来过大的波动性（特别是下波动，也就是回撤风险）。ETF基金所追踪的股票指数是几百甚至几千只个股的集合，板块的轮动和个股的波动互相抵消了很多噪声。

从长期周期来分析，股价是围绕其基本面价值上下波动的，研究表明市场上存在单一股票价格噪声，而基本面的变化取决于经济环境特别是经济结构调整与经济周期轮动，所以个股代表了经济的各个领域，互相叠加后最终波动主趋势得以呈现。基于同样的均值回复理论，指数所代表的全市场（或部分市场），可以看作是整体股市受到货币政策影响展开的基于GDP总量的均值回复。

大部分指数投资者都有一定的交易经验和金融知识，也都认同一些基本理论，比如个股Alpha（上市公司特质带来的阿尔法收益）难以寻找，且非常不稳定。所以转而做有把握的指数，获得长期的低风险，通过谨慎操作跑赢市场，积累相对收益和复利，可以认为ETF基金的投资者本质上偏向低风险偏好。再加上对于股票指数叠加噪声呈现出主趋势的特点，ETF所追踪的股票指数较为容易把握动量。

选择ETF的持有标的，要注重差异性，比如做两个标的轮动，一定要在基本面或者逻辑方面形成显著差异。Fama和French在1993年指出可以建立一个三因子模型来解释股票回报率（后文将详细描述），按照此思路，三因子分别是市场资产组合（Rm-Rf）、市值因子（SMB）、账面市值比因子（HML），其中又以市值因子对股票价格定价影响最为显著，所以我们做ETF轮动，也不能偏离这个思路，需要选择在市值方面有显著差异的ETF标的来投资，这样能够充分解释不同规模上市公司的价格波动，如果我们的规则设置合理，则存在一定机会获得轮动收益。

在国内最为常见的三个板块是上证50、沪深300、中证500，分别代表了“上海证券市场规模大、流动性好的最具代表性的50只股票”,“以规模和流动性作为选样的两个根本标准，并赋予流动性更大的权重沪深两市300只股票”和“剔除沪深300指数成份股及总市值排名前300名的股票后，总市值排名靠前的500只股票组成，综合反映中国A股市场中一批中小市值公司的股票”，这三个板块中的股票最显著的差异就在市值方面，当然潜在的差异还有估值方面。

2.三大指数数据初探

我们以上证50为例，在聚宽的研究平台上分析其成分股基本面概况，取总市值（亿元）和pe_ratio市盈率（PE,TTM）两列数据，代码如下。

q=query（

valuation.code,valuation.market_cap,valuation.pe_ratio

）.filter（

valuation.code.in_（get_index_stocks（'000016.XSHG'））

）

df=get_fundamentals（q,'2018-03-07'）



以下还有40行内容，不再展示。

再键入df，运行后可以看到该数据结构的内容，它包含1个索引列（从0开始的排序）和3列数据，分别是valuation.code,valuation.market_cap,valuation.pe_ratio。代码中的get_index_stocks（'000016.XSHG'）获取到了上证50成分股，截止时间为基本面函数参数’2018-03-07'。

market_cap=df['market_cap'].mean（）

market_cap



可以看到对df数据结构’market_cap’一列数据求均值的情况。上证50的平均市值=3571.13亿元，以同样的方式求出pe_ratio=27.03倍。

修改 get_index_stocks（'000016.XSHG'）为get_index_stocks（'000300.XSHG'），获得沪深300的平均市值=1164.47亿元，pe_ratio=31.57倍。

修改get_index_stocks（'000016.XSHG'）为get_index_stocks（'000905.XSHG'）再获得中证500的平均市值=163.57亿元，pe_ratio=47.15倍。

3个ETF指数市值分布情况如下，如图3-1所示。

图3-1 三大指数2018年2月所包含个股平均总市值



import matplotlib.pyplot as plt

plt.title（'market_cap'）

name_list=['000016','000300','000905']

num_list=[3585.56,1164.47,163.57]

plt.bar（range（len（num_list））,num_list,fc='r',tick_label=name_list）

plt.show（）

pe_ratio市盈率分布情况如下，如图3-2所示。

import matplotlib.pyplot as plt

plt.title（'pe_ratio'）

name_list=['000016','000300','000905']

num_list=[27.19,31.57,47.15]

plt.bar（range（len（num_list））,num_list,fc='r',tick_label=name_list）

plt.show（）

图3-2 三大指数2018年2月所包含个股平均市盈率



现在进入绘图过程，我们需要观察上证50、沪深300、中证500的历史价格，并将其绘制在一个坐标轴下。

首先取出数据进行观察，我们取2010年1月1日开始的日频数据，仅取close列，并赋值给3个dataframe，代码如下。

df_ZS50=get_price（'000016.XSHG',start_date='2010-01-01',end_date='2018-03-07',frequency='daily',fields=['close']）

df_HS300=get_price（'000300.XSHG',start_date='2010-01-01',end_date='2018-03-07',frequency='daily',fields=['close']）

df_ZZ500=get_price（'000905.XSHG',start_date='2010-01-01',end_date='2018-03-07',frequency='daily',fields=['close']）

然后依次将3个dataframe的close列，放入df_ALL这个新的dataframe，并给予不同列名称。

import pandas as pd

df_ALL=pd.DataFrame（）

df_ALL['ZS50']=df_ZS50['close']

df_ALL['HS300']=df_HS300['close']

df_ALL['ZZ500']=df_ZZ500['close']

df_ALL

运行后可以观察到数据类型。

最后绘制图表，通过.plot（）函数完成，如图3-3所示。

df_ALL.plot（）;

plt.title（'3 indexes'）

plt.legend（loc='best'）

图3-3 三大指数2010年以来运行情况



3.二八轮动策略思路介绍

“蛋卷斗牛二八轮动”基金原始思路是：成分标的为沪深300指数、中证500指数和国债指数，本指数对比当前交易日收盘数据与20个交易日前的收盘数据，选择沪深300指数和中证500指数中涨幅较大的一个，于下一个交易日收盘时切换为持有该指数；若两个指数均为下跌，则于下一个交易日收盘时切换为持有国债指数。

根据该思路计算模型中的动量。

我们定义函数getStockPrice，它可以取得股票某个区间内的所有收盘价（用于取前20日动量和当前收盘价），代码如下。

# 输入：stock（股票或指数代码）,interval（滞后期或理解为阶段内）

# 输出：h['close'].values[0],h['close'].values[-1]

def getStockPrice（stock,interval）: # 输入stock证券名，interval期

h=attribute_history \

（stock,interval,unit='1d',fields=（'close'）,skip_paused=True）

return（h['close'].values[0],h['close'].values[-1]）

# 0是序列中的第一个值，-1是序列中最近的一个值（也就是昨天收盘价）

然后定义3个变量，代表3大指数：

sz='000016.XSHG' # 计算标的——上证50指数（超级大盘股）

hs='000300.XSHG' # 计算标的——沪深300指数（价值股）

zz='000905.XSHG' # 计算标的——中证500指数（成长股）

最后运行函数取出价格，并通过简单的公式计算动量值，如图3-4所示。

# 取出价格

interval50,Yesterday50=getStockPrice（sz,20）

interval300,Yesterday300=getStockPrice（hs,20）

interval500,Yesterday500=getStockPrice（zz,20）

# 计算前20日动量

sz50increase=（Yesterday50-interval50）/interval50

hs300increase=（Yesterday300-interval300）/interval300

zz500increase=（Yesterday500-interval500）/interval500

# 绘制出今日的3个指数动量值

import matplotlib.pyplot as plt

plt.title（'momentum of 3 indexes'）

name_list=['sz50increase','hs300increase','zz500increase']

num_list=[sz50increase,hs300increase,zz500increase]

plt.bar（range（len（num_list））,num_list,fc='r',tick_label=name_list）

plt.show（）

图3-4 三大指数（2018年2月～3月）动量



这就是模型的核心计算逻辑，研究平台上的预处理，是为了在模型中能够对这些数据应对自如。从以上描述我们可以看出，二八轮动策略基于以下两个最主要的思想。

（1）动量跌破0止损，买入更安全的投资标的。

（2）指数强者恒强，不要基于均值回复等反转理论构造基于指数的择时模型，指数择时需要使用动量方式。

该指数起始时间2006月1月1日，起始点100点。历史回测10年切换240次；10年中，3年涨幅大于100%,2年涨幅大于50%,4年涨幅小于3%,1年跌幅接近20%；年最大涨幅出现在2007年，为168%；年最大跌幅出现在2008年，为-18%;2015年涨幅为61%；峰值出现在2015年11月，为41倍；单次切换最大涨幅为75%；单次切换最大跌幅为-10.5%。10年34倍总回报，年化收益率约为43%。可以说该指数大幅度跑赢了持有指数基金，也跑赢了市场上几乎所有公募基金。

它严格执行交易策略，买入涨幅最强的指数，并在指数双双下跌时止损，这样做的好处是既能快速跟上牛市，又能在股市下跌时有效止损。

从2006年1月1日至今，二八轮动历经三轮主要牛市、两次熊市，可以得出结论，二八轮动策略在牛市中的表现只能算是跟得上指数，大部分时候的收益要相比最强势指数弱一些，然而在熊市中二八轮动策略却大幅跑赢对标指数，仍然能发生20%～33%的最大回撤。

鉴于过早的历史数据对现在的影响已经很小，A股再出现类似2006—2007年长期大牛市的概率也已经很小，所以我们仅回测2010年以来的数据，分析其能够产生多大程度的有效收益。如图3-5所示。

图3-5 改版二八轮动模型2010年以来资金曲线



该模型的源码由聚宽网站编写，我们做了以下改动。

（1）加入上证50指数：000016.XSHG，及其对应的ETF基金：510050.XSHG。

（2）要求指数之间的动量差异幅度达到0.01，也就是1%，才进行指数切换（形成一定幅度噪声容错区间）。

做这两点微调之后，模型获得一些性能改进。作为本书收录的第一个模型，我们添加了详细注解，帮助大家理解模型中出现的自定义函数，以及大部分模型都会使用到的一些通用代码段。

在本策略中，我们加入了一个参考标的：g.sz='000016.XSHG'，上证50指数，它对应的ETF是：g.ETF50='510050.XSHG'。

我们设定起始时间为2010年1月1日，结束时间为2018年2月14日，100000元资金，点击“编译运行”。可以观察到，该策略能够跑赢基准沪深300指数没有疑问。特别是在一些连续下跌阶段，策略可以通过空仓来避免被动持有指数的亏损。而在2014年年底牛市来临之时，也可以获取到追踪指数的收益。

但是在2017年上半年，随着市场结构的变化，策略产生了一些不适应，显著跑输基准，不过后半年通过持有50ETF，重新获得了较好收益。2018年年初股灾，因为缺乏止损机制，净值回撤幅度和基准类似。

初步改进之后，总体收益达到227.25%，而基准收益只有10.94%，夏普为0.66。最大回撤达到25.761%。策略在股票市场震荡时期，缺乏盈利能力，毕竟ETF代表指数走势，无法体现个股的独特收益能力。

具体源码如下，也可以通过扫描以下二维码获得。





3.2 Aberration系统，长期活跃于期货市场


Aberration可以被翻译为“失常、离开正路、越轨”等含义，是一套古老而简单的趋势类突破系统，在众多交易者看来它已经失去盈利空间，但实际上它可以用最简单的方式反馈市场波动，且经过改进之后依然可以作为极好的入门模型。如图3-6所示。在是否加入这套模型进入本书的问题上，我反复思考，最终还是接受并撰写了这部分内容，也许在你阅读本节的过程中，就可以体会到我的思考过程。

这个曾经创下100%以上年收益率的交易系统由Keith Fitschen于1986年发明。1993年发布在美国Future Truth杂志上，自策略发布之日起，其绩效一直排名靠前，而其框架实际上就是布林带系统的突破式应用，并且不是中高频交易系统，而是中低频中长线持仓的一套模型。这也符合本书介绍的模型的分类，对于这样的模型，我们拥有较多的IT平台来支持（意味着不需要在复杂的IT交易系统上做过多开发），以获取市场最原始朴素的动量效应，将其转化成我们的账户利润。

图3-6 Aberration模型绘制在时间序列上的效果



既然是基于布林带的突破模型，则一定是一个低胜率的模型，而且它又能赚钱，那么就一定是一个高盈亏比的模型，以此来对冲低胜率带来的反复亏损。

Aberration的核心构成是一条均线，加上、下两个轨道，轨道宽度，是 N倍标准差。用最容易理解、又非常工整的交易开拓者系统TB代码表示如下。

//中轨AverageMA，此处的Length是计算均线的窗口期

AverageMA=Average（Close[1],Length）;

//价格序列的标准差

StdValue=StandardDev（Close[1],Length）;

//上轨和下轨，此处的StdDev是标准差倍数

UpperBand=Avema+StdDev * StdValue;

LowerBand=Avema-StdDev * StdValue;

Aberration的交易规则是：当价格突破上轨时做多，当价格回到中轨时平仓；反之，当价格突破下轨时做空，当价格回到中轨时平仓。

1.通过Aberration系统原理窥探价格概率

这里加入一些内容，是为了向读者们解释，为什么使用趋势突破类模型后可以获得收益，但是只能获得一个较低的胜率。核心原因是因为价格收益率的波动情况是类似于正态分布的，或者说是在正态分布的基础上的，偏峰肥尾。如图3-7所示。为了进一步说明偏峰肥尾，这里要引入“概率密度函数PDF（Probability Density Function）”的概念，其可以查阅到的定义很简明：描述随机变量的输出值，在某个确定的取值点附近的可能性的函数。PDF的函数值的高低，描述数据在某个区域分布的高低。

图3-7 标准正态分布图（均值=0，方差=1）



刚才所说的偏峰肥尾需要两个附加的概念来解释，即峰度和偏度，具体如下。

（1）峰度（Kurtosis）又称峰态系数。表征概率密度分布曲线在平均值处峰值高低的特征数。直观看，峰度反映了峰部的尖度。样本的峰度是和正态分布相比较而言统计量，如果峰度大于3，则峰的形状比较尖，比正态分布峰要陡峭。肥尾说明了数据的分布在概率密度函数图像上的左右两侧较远的地方更多，肥尾分布大部分对应尖峰，也就是峰态系数较高。

（2）偏峰意味着这个山峰不仅是高耸的，而且是有偏向的，其均值并不等于0。偏度（Skewness）也称为偏态、偏态系数，是统计数据分布偏斜方向和程度的度量，这个概念用来表征概率分布密度曲线相对于平均值不对称程度的特征数。正态分布的偏度为0，两侧尾部长度对称。

对峰度和偏度的描述，用正态分布最容易理解：比如正态分布，在μ处数据分布最多（我们描述为概率密度值越高），所以函数值最高。在左右两侧，概率密度值降低，说明数据点分布变得稀少。这个函数图像上，f（x）是指随机变量X（大写X，变量集合）在观察值为x（小写x，某个数值）时的概率密度值，而不是概率值。PDF函数曲线与X轴所围成的面积表示概率，该面积等于1，因为随机变量的所有可能取值（即100%）都在X轴上。

μ是变量X的均值，如果是标准正态分布，则μ=0。

对于服从正态分布的变量，其观测值如下。如图3-8所示。

◎ 落在距均值的距离（xi-μ），为1倍标准差范围内的概率为0.68。

◎ 落在距均值的距离（xi-μ），为2倍标准差范围内的概率为0.95。

◎ 落在距均值的距离（xi-μ），为3倍标准差范围内的概率为0.9973。

图3-8 正态分布图不同倍数标准差占据的概率范围



但是价格收益率分布和正态分布略有不同，以中证500指数为例，历史每日涨跌幅（百分比）分布情况，左侧明显肥尾，整体峰度偏向右侧。偏峰意味着，其价格的总体趋势还是向上运行的，也就是说多年来积累的上涨因素更多，或者说在你的考察区间内，大部分情况价格有上涨（右偏）或者下跌（左偏），是有方向性的。而大部分价格收益率的波动，集中在一个较小的区域，比如正负0.02范围内，期货领域的螺纹钢指数合约，则集中在0.01范围内（波动率比股票指数低，因为自带10倍杠杆），所以峰度总体上是较高的。

关于尾部的肥尾特性，为了弥补峰部较低的离散程度（较高的集中程度），尾部的数值需要多一些，来拉高整体的离散程度，以使其与正态分布相等。若一个分布是尖峰（均值附近的样本数比正态分布的多），则必然尾部比正态的厚（远离均值的样本数比正态分布的多）。肥尾意味着价格出现极端行情发生的机率增加，可能因为发生了一些不寻常的事件造成了市场震荡，且交易者经常过度反应市场信息，加之由于信息不对称而滞后的入场者也做同样方向的交易，叠加了价格向单一方向的运行强度（时间和空间），因此我们的趋势交易在这些时间点上有利可图。

所以通过Aberration系统，我们常用布林带设置上下轨=2倍标准差，然后做突破交易，其数学含义为：当前价格值与均值的距离，突破2倍标准差（之前统计量只有5%的数据是这样分布的），即做趋势追踪交易。虽然这样做胜率较低，但是价格显然是肥尾分布的，价格波动不回复（形成趋势）的概率比正态分布更大，且任意一次肥尾，都能够带来较大的利润。

2.Aberration系统交易逻辑解读

如果价格没有趋势，而做高度回复性的运动（比如在0轴上下反复运动，典型特征是白噪声），或者价格在一个区间内反复震荡，没有形成有效的向上或向下突破，那么此时应该使用布林带回复性交易规则，也就是在价格突破上轨后做空，在价格突破下轨后做多。如图3-9所示。

图3-9 主要商品期货品种2014—2016年阶段内波动显著（先跌再涨）



显然大部分股票价格、股票指数价格、商品期货价格都是呈现趋势性运动的，比如2014—2015年的A股大牛市，再比如商品期货焦炭从2016年供给侧改革以来的两轮上涨等，都是方向性显著的运动。此时如果继续使用布林带回复性交易规则，则会因为价格的肥尾效应带来较大亏损。

所以对于这些运动，应该有效地进行趋势追踪，特别是中长线趋势追踪。Aberration交易系统的特点是被动地趋势跟随，采用长期信号，如果运行在日频K线续航，其在一个品种上每年交易3～4次，持有时间超过总交易时间的60%，并且可以根据不同的资金规模，分配不同的品种数目。它通过长线交易捕捉趋势来获取巨额利润，同时交易在多个不相关的市场，当某一品种回撤时，另一品种可能获利。它本质上倾向于波动率出现机会对冲，所以要求必须配置多品种，这样才有更大把握在更多品种上盈利，否则系统发生年度亏损将是很正常的情况。如图3-10所示。

图3-10 主要商品期货品种2016年相关性系数，构成较为显著的互相对冲



Aberration系统如果配置得当，可以在农产品谷物、油脂类、有色金属、工业材料、能源化工、外汇、股指期货等各类品种之间灵活运转，通过长线地追踪趋势来获得盈利。

但是在具体的交易指令发出点位，我们不仅应该遵照原系统设计的“突破上轨时做多，突破下轨做空”，而且应该考虑，在价格突破上轨入场后，因为节假日，或者添加了其他出场逻辑，而打断了本次交易后价格依然在上轨之上时，我们是否要做多（重新入场）。

我的建议是如果是中长线趋势系统，应该坚持被打断后再寻找合适机会入场，因为放弃再次入场机会，可能会错过一次巨大的持续数月的上涨行情。如果是短线系统，交易被打断后造成出场，则可以放弃再入场，因为价格会快速再回到布林带上下轨之内，带来一次新的开仓机会。所以两种情况对应的交易代码，应该分别被撰写为：

//向上突破布尔条件，以均线大于上轨作为开仓条件，被打断后容易再次入场

CrossOverFlag=Close[1]> UpperBand ;

//多头开仓条件

If（MarketPosition==0 && CrossOverFlag）

{

Buy（Lots,Open）;

}

//向上突破布尔条件，以CrossOver突破动作为开仓条件，被打断后必须再出现突破动作，才可以再次入场。

CrossOverFlag=CrossOver（Close[1],UpperBand）;

//多头开仓条件

If（MarketPosition==0 && CrossOverFlag）

{

Buy（Lots,Open）;

}

我们继续分析该系统会发现“当价格回到中轨时平仓”，这个平仓条件并非完全合理。因为仅从原意上看，价格回到中轨意味着价格均值回复，但是从一个较高或较低的位置回到中轨的过程中，价格已经释放了动能。按照动能也在均值回复的一般常识，此时经过休息后的价格有较大概率继续上升。同时价格往往在高位或者低位呈现出快速波动的特性，也就是到达阶段性高低点时，价格会快速反转。

此时我们需要比“当价格回到中轨时平仓”更快的速度离场，如何构建这个逻辑？其实Aberration系统、双均线系统等各类趋势追踪类系统，都没有有效的应对方案，你会发现那些被描述成“印钞机”的经典交易系统，大部分都只是提供了入场逻辑，也就是说在价格出现符合其入场标准的时候，给予买入多头或者卖出空头的开仓信号，尚未考虑出场（离场）逻辑。

3.Aberration系统改进

我们按照经验，对Aberration系统加入一个追踪止损（TrailingStop，也被称为“吊灯止损”）模块，该模块的设计逻辑是识别开仓后的最高点/最低点，然后当价格出现反向运动时，测试价格和这个最高点/最低点的运行空间，当达到一定幅度时平仓离场，该模块的离场速度，显然比价格回落到均线再离场要快很多，其代码设计如下：



因为我们开发的模型都是分多空单独运行的，所以这里仅写出多头的离场逻辑。在漫长的开发和交易过程中，大家可以体会到将模型分为多空运行的优势。我们还应该留意到，如果价格在入场后，发生了大幅度快速反向运行，此时不用考虑从HighestAfterEntry或者LowestAfterEntry的价格运行幅度，而是直接考虑最新价格和入场点的幅度（亏损程度），即可设计出一个止损逻辑：

//以下是硬止损执行

If（low <=AvgEntryPrice *（1-HardStop/100））

//盘中最低价<入场均价 *（1-回落百分比参数）

{

Sell（0,Min（Open,AvgEntryPrice *（1-HardStop/100）））; //在此点位平多仓

}

上段代码帮助系统构建了一个辅助的出场逻辑，但较为可惜的是增加了参数TrailingStophe和HardStop，这在一定程度上增加了系统的不稳定性，也增加了使用者的参数判断困难。TrailingStop是常见于1～10的一个参数，代表TrailingStop的价格下落（上升）幅度。

在商品期货中，高波动率的品种设置要偏大，低波动率品种设置要偏小。并且在多头和空头模型中，此参数设置也不能通用，因为价格的波动并非是对称的，多头模型从 HighestAfterEntry 到目标出场点的距离一般并不是很大，而空头模型从LowestAfterEntry到目标出场点的距离可能反倒更大一些，因为价格下跌经常呈现抵抗式下跌，如果我们轻易因为追踪止损离场，可能找不到更好的入场点，或者找到了更迟、更加不利于获取利润的入场点。

但是无论如何，都可以看到它是和波动率紧密相关的。并且波动率是时常变化的，比如在股票市场2012—2014年，是低波动率区间，而随后的大牛市或者特别是股灾，则变成了高波动率区间。商品期货时常也经常因为价格走入了震荡区间，而波动率显著降低。所以我们应该尝试将HighestAfterEntry到目标出场点的距离，设计成一个和波动率相关的变量，并且是正相关。

也就是说止损比率必须是时常变化的，是波动率自适应的，所以这里要引入ATR自适应追踪止损，它将TrailingStop改进成为一个系数乘以ATR（平均真实波动）。

追踪止损的引入是带有门槛的，因为如果没有门槛，该模块会和硬止损同时起效，而且当价格运行高度非常有限时，也没有必要进行追踪止损，所以要带上一定的最高运行幅度门槛，也就是让HighestAfterEntry-AvgEntryPrice>在一定区间时，止损模块才起效，该区间也可以用百分比表示。

4.通过ATR适应波动率止损

我们再用一点篇幅来介绍ATR这个概念。ATR可以说构建出了我们的程序化交易系统和市场波动的沟通桥梁，让系统能够感知市场波动幅度，以此方式实现大部分参数的调整，甚至是消除了大部分参数。

ATR 概念由威尔德（J.Welles Wilder）在 1978 年于 New Concepts in Technical Trading Systems一书中提出，它取一定时间周期内的价格波动幅度的移动平均值，它并不是主要用于研判买卖时机，也不是做什么反趋势指标，它只能感知到波动率，仅此而已。但是正是这种简单的感知方法，让ATR能够运用到各类交易系统中，它自己不发出交易信号，却可以改善其他系统的信号发出时机，成为影响系统收益率的核心因素。甚至有人做过测试，通过ATR调整出场点，入场点随机设置（Random Entry，即入场点位和方向都是随机的），系统依然能够保持盈利，可见ATR的作用之大。

计算ATR首先要计算出TR值，也就是单个K线上的真实波动量：TR等于“最高价-最低价”和“最高价-昨收”和“昨收-最低价”，这3个值的最大值。

然后将N个周期的TR值做移动平均即可。这里如果数据量N较小，则ATR反应敏锐，但是也意味着噪声较高；如果数据量N较大，则ATR反应较慢，但是也意味着噪声低，更加稳定。所以我们处理较小样本的TR值构成ATR的时候，可以采用EXPMA指数加权移动平均法，这种方法能够一定程度上降低ATR值的波动。不过用等权的移动平均依然是更加稳妥的方案。ATR系统自己的参数N一般不倾向于反复优化，设定为一个固定的值即可。

利用ATR设定止损和追踪止损很简单，其逻辑是选择一个基准价位，然后减去一个系数调整后的ATR值。ATR值会根据投资品种的波动率自动调整实际的百分比止损值，这就比固定使用百分比值作为止损更具灵活性了。

用ATR止损和用固定价格跳数止损都有道理，ATR评估了最近的波动率，而固定跳数是将止损量和金额紧密挂钩，ATR止损和固定价格跳数止损不好下结论哪个是最正确的，但是固定百分比止损一定是不科学的，因为价格在不同区间时，其固定百分比值代表的价格区间差异很大。

If（MarketPosition==1 && BarsSinceEntry > 0

&& HighestAfterEntry-AvgEntryPrice > NATRstop*atr[1]）//有多仓

{

If（low <=HighestAfterEntry-NATRstop*atr[1]）

{

Sell（0,Min（Open,HighestAfterEntry-NATRstop*atr[1]））;

Normal_Trailing_long=True ;

PlotString（"TrailingStop","TrailingStop",high*1.01,White）;

}

}

以下是部分ATR适应波动率止损模块的测试数据，如图3-11～图3-14所示。

因为一手橡胶的价值远高于一手螺纹钢，所以这类高价值品种在止损时，需要的ATR比率较小，橡胶的测试是从0.5倍ATR值开始到4倍ATR值结束。

图3-11 螺纹钢指数合约资金曲线（多头，1ATR～8ATR止损参数组）



图3-12 螺纹钢指数合约夏普比率（多头，1ATR～8ATR止损参数组）



图3-13 橡胶指数合约资金曲线（多头，0.5ATR～4ATR止损参数组）



图3-14 橡胶指数合约夏普比率（多头，0.5ATR～4ATR止损参数组）



因为已经添加了追踪止损，所以硬止损是非必需的，而且追踪止损同样代表了价格从入场后的最高点回落到目标点位（“HighestAfterEntry”在入场时等于硬止损的“AvgEntryPrice”），它已经包含了硬止损的逻辑在其中，如果两种模块同时存在，则会损伤性能，在表格里不再呈现，读者们可以实践测试得到。所以我们从这里开始，在模型中仅保留追踪止损模块。

5.尝试改进波动率的描述

有些波动率指标会随时间变化而发生剧烈变动，而另一些则相对较为平稳；有些波动率指标的计算包含了过去时间窗口的所有数据点，而另一些则只包含了一些极端的点。我们研究中还发现，有的指标数据信息提取不足，适合通用的统计领域，但在金融市场上还有改造空间。如图3-15所示。

图3-15 ATR和SD（标准差）在面对波动率不变，仅方向变化的情况下，标准差发生指示偏差



传统的Aberration系统采用标准差作为波动率描述工具，所以价格突破的上下轨宽度为N倍标准差，实际上很多交易者熟知的ATR指标也有很强的波动率描述能力，甚至比标准差更好，它使用了历史最高最低价，和收盘价，而标准差仅使用了收盘价。所以ATR的信息含量较大。

从我们的测试结果来看，两者皆可作为系统中的波动率指示工具。商品期货上两者性能差异不明显，但是到了股指方面，ATR的优势进一步显现。这其中最核心的因素恰巧是交易次数，带来的绩效IR（绩效IR=绩效×sqrt（交易次数，或者说信号数量））提升，这里我们定义的IR和信息广度有关，我们认为信号数量是对于绩效可信度的考察方式。

其实Aberration系统或者说布林带还隐藏了一个更容易影响性能的细节，远比选择ATR作为替换工具更重要，那就是标准差的计算周期length参数。在日线周期上，由于我们惯用20或者40周期，所以均线的length参数和标准差的length参数可以统一。如图3-16所示。

图3-16 标准差周期参数应当敏锐（上半部分）不能设置过大（下半部分），以防过于平滑



但是到了小时线上，我们需要注意均线length参数可能需要80～100周期，而标准差length参数如果依然设置80～100周期，则无法及时反馈近期波动（可以想象当新的数据点加入到模型时，即使它是一个剧烈的波动，也因为权重过小无法及时反馈当前的波动率变化）。所以建议给予标准差独立的length参数。我们建议设置为5天～10天的窗口期（如某期货品种每天有4个小时线，则5天有20个样本）作为标准差length参数，Aberration系统中轨的均值参数则可以设置略大一些。

认为布林带仅有两个参数，是大多数交易者容易忽略的问题，所以提示读者们如果在较细致的时间周期上，标准差的周期一定不能设置过大，依然是以20～40周期为宜。

Aberration系统交易开拓者源码（仅多头部分）如下，也可以通过扫描以下二维码形式获得多空部分。





至此，我们对于Aberration系统的迭代暂时告一段落，比较遗憾的是我们没有修改Aberration系统主逻辑，特别是入场逻辑，而是以出场为核心改进点，同时做了一些低风险加仓动作。需要说明的是，这应该是一个程序化交易者在1年内应该达到的开发水平，如果你的时间有限，进步速度较慢，也一定要尽快达到此门槛，因为这样的系统才勉强能够用于实盘交易。当然它比起大部分手工交易者的绩效仍然好太多了，这就是我们为什么要做量化的一个实际表现。

如图3-17所示是我们将Aberration系统加载在28个主要期货品种上的测试结果，模型将length参数固定为80，标准差倍数固定为1，仅留下一个参数——ATR追踪止损系数，可供各品种调整，这样保证了模型尽可能低程度地拟合历史数据，让绩效得到真实性保证。

在商品期货测试中，分配给每个品种20000元等额资金，交易手续费5%%（万分之5，显著高于市场平均手续费5倍以上），滑点开平仓各1跳，得到如图3-18所示的绩效。测试全程夏普比率1.46，收益风险比1.55，胜率39.86%。

图3-17 Aberration系统在商品期货多品种运行环境下的资金曲线



图3-18 Aberration系统在商品期货多品种运行环境下的月度收益



在股票测试环境中，交易手续费设置为买卖双边各收20%%（千分之2，以适应市场较高的冲击成本），每一只个股等额分配10万元，可复利开仓（使用之前积累的利润作为本金）。可以看出该结果属于典型的动量模型，从2010年开始捕捉趋势并不顺利，但是在2014年年底—2015年牛市积累了大量超额收益，经过三轮股灾和2016—2017年市场缺乏趋势性行情，该系统依然能够带来较好回报，但是在震荡市中，这种动量模型虽然可以避免暴跌的大幅度回撤，但是也显著跑输股票指数。





3.3 低价股+逆向双均线模型，初步探索个股特征


在测试了ETF基金的基本特性后，本节我们将测试范围放大到全市场个股中，再次使用Python语言开发一个股票模型，并通过开发过程探索一个最简单的问题：双均线交易模型如果作用于随机的个股上，能否带来可观的性能增长，进而大幅度跑赢基准？如果能，则说明在个股上存在显著的动量特征，因为双均线交易系统中的短期均线用来描述短期趋势（或者说降噪），长期均线用来描述中长期趋势。如果动量足够强，则在趋势形成过程中，我们还有机会介入，并在合理点位退出获利。如果动量不够充足，我们的入场点基本上就是动量的最高峰值点，那么入场后即面对市场下跌。

最初本套系统我们以MACD为基础开发，对于大部分交易者而言MACD是一套容易理解的模型，但MACD的本质是两条EXPMA均线通过二次平滑得到，即由快的指数移动平均线（EMA12）减去慢的指数移动平均线（EMA26）得到快线DIF，再用2乘以（快线DIF减去DIF的9日加权移动均线DEA）得到MACD，所以MACD可以理解为一个双均线系统。这套指标之所以能够风靡交易行业，核心原因是因为它的可视化效果好。

由此我们进一步简化问题为双均线系统，通过双均线表达动量。模型交易的逻辑设计如下。

（1）通过短期均线上穿上期均线（金叉），视为买入股票信号，全市场扫描符合该条件的股票买入。

（2）在买入时做一些过滤，选择低价股买入，原因是这类股票多集中在大盘股，或者市净率、市盈率估值较低的股票，“低价”二字在A股本来就是一个有效因子，我们不好为该因子做出权重判断，但是可以简单通过因子排序将符合条件的个股优先买入。

（3）双均线仅提供入场点，不提供出场点，出场由硬止损和追踪止损完成。

模型逻辑的第一部分（双均线买入逻辑）用代码表述如下：

# 在可用现金cash大于0的情况下，执行买入逻辑

cash=context.portfolio.available_cash

if context.portfolio.available_cash > 0:

log.info（"Today's Cash %s" %（cash））

# 记录出现买入信号的股票名单optional_list

optional_list=[]

# 对应股票买入

for security in g.stocklist:

# 历史价格

close_data　=　attribute_history（security,　g.slow+2,　'1d',　['close','volume'],df=False）

# 短期和长期均线金叉买入（也即是上周期小于，但本周期大于）

if（ma_fast_2 < ma_slow_2 and ma_fast_1 >=ma_slow_1）:

# 为optional_list 名单使用 append 方法添加一个元素，该元素由股票代码security，和收盘价['close']构成

optional_list.append（（security,close_data['close'][-1]））

模型逻辑的第二部分（优先买入低价股）反而非常简单：

# 按照收盘价进行排序，优先买入便宜的股票

optional_list.sort（key=lambda l: l[1]）

首先.sort是排序函数，之前有介绍过，其对列表进行原址排序。然后这里用到了lambda函数，是一个匿名函数。调用 lambda函数，返回的结果是对表达式计算产生的结果。如果我们不使用lambda方法，则需要定义一个排序函数，lambda写法实际上更易读，因为映射到列表上的函数具体要做什么，非常一目了然。这行代码实现了对于optional_list表格的排序，按照第二列（l[1]），进行默认为升序的排序，因为.sort方法的默认排序方式为：reverse=True升序。

模型逻辑的第三部分（追踪止损和硬止损）逻辑：





随后我们启动回测，得到了基本上令人失望的结果，如图3-19所示。

图3-19 12-26正向双均线参数+止损模块择时绩效



资金曲线非常难看，8年收益仅为20%，夏普比率也是负值。我们反思此结果，发现除牛市阶段系统基本上能够捕捉到收益之外，其他时间段几乎是和基准跑平，没有超额收益，也无法在长期震荡中领先基准，而A股投资者要面对的恰巧是“扭断熊长”的市场。我们随后测试了调整参数回测，依然不理想，显然个股上的动量因子并不强烈，这个市场充满了对于趋势交易者特别是按照均线类模型入场的交易者的绞杀。

逆趋势入场交易思路

此时我们调整方法，将开仓逻辑倒置：

if（ma_fast_2 > ma_slow_2 and ma_fast_1 <=ma_slow_1）:

让昨日先大于，今日再小于，也就是构成死叉开仓，将动量系统改为反转系统，然后启动回测。当然你也可以修改全局参数g.slow和g.fast，使其倒置之后测试绩效。如图3-20所示。

图3-20 12-26逆向双均线参数+止损模块择时绩效



结果依然不是非常好，但是显然绩效获得提升，测试告诉我们在类似这样的动量系统中，什么样的参数设置并不重要，参数本质上是动量强度和进场时间的变化，重要的是交易思路要发生转变，只要设置好止损，交易系统完全可以接受这种彻底逆向的入场方式。

所以本节的测试实际上带着很多无奈，那就是A股中大部分传统的交易思路，特别是散户交易者中大量存在的迷信指标（均线类动量指标）和市场实际情况发生了较为严重的偏差。想要生存下来，必须仔细检测你的交易思路是否正确，而不是看少数样本，或用肉眼大致回测指标的有效性。

接下来加入一个特殊模块：二八指数止损（之后章节会详细讲解），来检测这套系统能否使用该模块获取进一步绩效提升。该模块帮助小市值选股系统获得了较为理想的回撤控制，也使得夏普比率提升，在这套逆向均线系统中，我们看到在2015年的股灾阶段，性能损失惨重，在2012年的系统震荡盘整下跌阶段，同样发生了较大回撤，我们在系统的这个位置增加止损模块，具体代码如下。

def handle_data（context,data）:

# 计算300和500指数的增长率，用于快速清仓

interval300,Yesterday300=getStockPrice（'000300.XSHG',g.lag）

interval500,Yesterday500=getStockPrice（'000905.XSHG',g.lag）

hs300increase=（Yesterday300-interval300）/interval300

zz500increase=（Yesterday500-interval500）/interval500

if（hs300increase <=0 and zz500increase <=0）:

sell_all_stocks（context）

# 卖出所有股票

else:

# 执行买入逻辑

使用handle_data函数意味着每日（或每分钟）系统运行回测，我们在正常的双均线交易逻辑上层构建了这个指数动量判断逻辑。如图3-21所示。

图3-21 12-26逆向双均线参数+二八指数止损



结果初步令人满意，我们获得了309%累计收益，在“股灾”后的一段时间也获得了较为理想的回撤控制。虽然该模型只能谈得上战胜了指数，但是以如此简单的逻辑能够获得明显领先指数的绩效，就应该意识到A股的反转特征已经是非常强烈了。同时二八止损模块的加入不仅是在“股灾”期间抗击回撤，在“股灾”之前，它也让系统最高达到了400%的收益率，并在2010—2014年逐步和基准指数拉开差距。

关于模型中对于低价股的筛选，建议读者将optional_list.sort（key=lambda l:l[1]）代码注释掉，然后再观察性能，你会看到性能降低，说明低价是一个有效因子，或者说它是模型的一个安全垫。

低价因子（不复权的股价绝对值相对于全市场均价较低的特征）收益率在2017年等价值投资时段绝是表现突出的，其次是低市盈率因子和低市净率因子，因为低价股包含了很多能够过滤高估值和小盘股的“一刀切”方法。A股投资者一直以来都认为股票价格不可能低于过低水平（虽然这是一个误区），通常小于5元的股票，就意味着跌到了无法再跌的空间，且低价股中含有很多银行股和传统行业股票，这些都是净资产较厚的公司。

以下是低价股+逆向双均线模型源码，也可以通过扫描二维码获得。





3.4 CCI通道+自适应系统，驯服商品期货波动


获得第3.3节期货CTA策略源码的读者可以发现：模型还有一个止损后防重入模块，该模块可以防止系统在不利于自己的位置再度入场，它是和ATR追踪止损紧密相连的，之后会详细介绍该模块。在计算头寸的时候，我们先求保证金率MarginRatio（），然后用今日的open价格和相关品种信息，计算一个在money范围内能够开仓的头寸，这也是为了各品种等资金量分配头寸而设定的。

本节我们通过另一个不同的入场思路CCI系统作为模型主体，讲解两个自适应模块的植入方式。

1.CCI指标基本思路解析

CCI（Commodity Channel lndex，可译为商品通道指数）顺势指标本体结构非常简单，它是由唐纳德·R·兰伯特DonaldLambert所创，原意是用指标值+阈值线的方法，表示股价是否已超出常态分布范围，这个阈值线一般是正负100。它属于超买、超卖类指标中较特殊的一种，波动于正无限大和负无限小之间。但实际上我们可以将它作为一个趋势突破类系统，因为在中长期市场上，动量效应比反转效应更加明显（特指期货市场），所以如果能够识别到一个显著的上升/下跌趋势开始，然后介入，还是有较为可观的收益的。

CCI指标在这里可以起到一些作用，我们计算出CCI值之后，再结合两个阈值线，即可得到做空信号。

TmpValue=Close+Close+Close;

Mean=Average（TmpValue,Length）;

AvgDev=0;

for Counter=0 to Length-1

{

AvgDev=AvgDev+Abs（TmpValue[Counter]-Mean）;

}

AvgDev=AvgDev /Length ;

CCI_Value=（TmpValue-Mean）/（0.015 * AvgDev）;

CCI原来的公式第一步是计算TP（Typical Price）价格，这里需要计算“最高价+最低价+收盘价”，意义是考虑到了最高价和最低价，而实际上这完全是在引入噪声，没有任何实际意义。要知道任何价格都不可能比close有效，其次是open价格包含的信息有一定含金量，可以作为一个日内基准价格，除此之外随意引入high和low价格，然后加以处理大都属于画蛇添足。所以我们改为引用close，在不改动模型公式的情况下，以最简单的方法修改TP的计算方式。如图3-22所示。

图3-22 CCI系统和价格关系



紧接着就是用公式计算其他变量，你可以理解为，通过计算得到价格length周期均值，再计算价格和均值的累计离差值绝对值Abs（TmpValue[Counter]–Mean），然后再获得每周期离差值，AvgDev=AvgDev/Length；最后得到一个以0轴为中心，大致在正负100，有时在正负200波动的指标值。这就是按窗口期归一化的效果，可以方便我们使用阈值线构成交易条件。CCI本身并不神秘，我们对它做的改进有一定创新意义。

2.ATR风险头寸自适应调整

ATR=Average（TrueRange,20）;

ATR_short=Average（TrueRange,5）;

ATR_long=Average（TrueRange,60）;

ATR_Ratio=ATR_short /ATR_long;

第三行代码中的ATR是用来计算止损量的，而第一行和第二行完成了长短期波动率的计算工作。ATR_Ratio是一个在1附近波动的变量，如图3-23所示。

Margin=MarginRatio（）;

Lots_temp=Floor（money/（Margin*open*ContractUnit（）*BigPointValue（））,1）;

lots=Lots_temp /ATR_Ratio[1];

图3-23 ATR_Ratio和收盘价对比效果（以沪深300指数为例）



在本案例中，我们规定各品种拥有等资金量分配，得到 Lots_temp仅仅是和价格相关的一个值，然后通过构建短期 ATR指标来表示短期波动率，构建长期ATR指标表示长期波动率，用短期除以长期，获得短期的相对波动强度 ATR_Ratio。这个相对强度是高度回复性的变量，所以它应该和交易头寸呈反比（负相关）。

用这种简单的方式即可实现对于波动率的捕捉，并构建波动率和开仓头寸的负相关。有很多交易者认为，通过ATR调节头寸是至关重要的，而且几乎是程序化交易系统的灵魂所在，这决定了我们无论在什么时候出入场，都可以获得一个适合该点的风险头寸，让交易头寸再也不是冷冰冰的固定值，而是一个风险调节值。

我们通过一个固定参数面（追踪止损参数是1～10的范围，0.5为步进）测试了该模块是否存在，对于单品种的意义如表3-1所示。

我们同样也在商品期货多品种上进行了全品种组合测试，这个组合包括28个品种，得到效果如表3-2所示。

表3-1 对于单品种的意义



表3-2 商品期货全品种组合测试效果



可以看到，ATR调整头寸牺牲了一些净利润，但是换来了夏普比率提升和平均回撤下降，考虑到该模块如此有效且简单，建议投资者在资金足够切分不同份额的情况下，保留模型中的该模块。

3.ER效率系数自适应调整突破阈值

ER效率系数Efficiency_Ratio是方向性和波动率的比值。ER较高时意味着趋势较为显著，它不仅考虑方向，还考虑波动，当波动率过大时，ER系数相应降低，对于趋势的强度描述性也随之下降。





我们的设计思路是：在ER系数过大的时候对系统预警，让突破阈值线变得更加困难，降低开仓的可能性，当ER系数较小的时候，让突破变得更加容易。需要注意的是ER系数调节仅在做多和平空时起效，经过初步测试确认了这种特性，这说明上波动和下波动不同，上波动在过于流畅的时候，往往就是一轮升势结束的时候，下波动在ER效率系数这套系统中未见这样的显著调节效果，所以它在空头模型中，只能用于平空仓，而不能调节开仓，但平仓有时候比开仓更加有效。如图3-24所示。

图3-24 ER效率系数和收盘价对比效果（以螺纹钢指数合约为例）



我们仅仅做了这样简单的分段调整，并不十分精确，但是在多头和空头都起到了显著作用。我们可以这样理解该模块的作用：既然ER效率系数表示上涨强度的数据，过大的ER系数必然意味着风险，特别是在商品期货领域这一现象更加显著。因为ER效率系数也和ATR_Ratio一样是一个回复性的值，所以我们可以赌其突破失败，随着ER系数的上升给CCI值的突破设定更加困难的障碍。

在初次向大家介绍该模块的调节部分时，大家对于多头部分普遍能够理解，但是对于空头部分的性能改进存在疑问，我做了一些测试来证明空头部分有显著的性能改善，而这个测试的方法不是针对改进前和改进后，而是针对 ER效率系数和平空条件Condition_buytocover是正相关还是负相关，得到结论如图3-25所示。

图3-25 模块调节结论



图3-25 模块调节结论（续）



参考股票多因子模型的对比方法，如果要证明一个因子是否有显著收益，应该对其进行分组，然后观察分组后收益率或夏普比率是否呈现单调性（分组资金曲线分层效果）。为了证明A方法有效，可以证明与A方向相反的方法会产生负面效果，以证明A方法有显著作用。

与ER正相关的是Condition_buytocover随着ER增加而设置阈值线为20、30、40的效果，负相关相反阈值线为40、30、20,ER不启用为：30、30、30（即在任何情况下都以30作为平空仓的阈值线）。

出场点和入场点一样重要，在商品期货市场上，因为入场点的争夺导致同质化，而出场点的自适应调节此时甚至可以发挥出更大效用。

总体来看，以动量方式应用CCI系统比Aberration系统效果略好一些，主要体现在收益风险比方面，该系统值得读者们关注，并加以正确的迭代方式。

以下是CCI+ER自适应系统模型源码（仅多头），还可以通过扫描以下二维码获得多空部分。





经过开平仓改造的CCI系统，在28个商品期货品种上，获得了较好绩效，收益风险比2.32，夏普比率1.60，胜率达到45.83，其资金曲线保持能力胜于Aberration系统，夏普比率也更高。我们认为自适应调节在该模型中主要起到性能改进的作用。

从模型源码可以看出，该模型依然只留下一个参数NATRstop，其他参数固定为变量，以降低对于各品种的拟合度。如果读者熟悉CCI系统的更多知识，还可以将其改造为逆势交易系统，那将有可能打造出一套震荡交易系统。但是这类系统要记得设置好硬止损条件，否则容易产生价格不回复而带来巨大亏损。





3.5 AMA自适应均线系统捕捉价格启动机会


传统均线模型的问题相信各位读者都了解，在震荡阶段价格反复向上、向下触碰均值，所以造成单均线交易法反复发出信号，亏损较为严重，双均线交易法在一定程度上有所改进，但是依然在此阶段有较大的亏损。那么是否存在一种均线系统，能够尽可能识别震荡行情，在此阶段屏蔽无效交易，而在趋势来临之时迅速追上价格变化趋势？

答案在《精明交易者——系统交易指南（Smarter Trading）》中可以找到，这本书由佩里·J·考夫曼（Perry.J.Kaufman）（以下简称为考夫曼）原著，可以肯定地说：考夫曼自适应移动平均线KAMA基本上是大家认为比较理想的均线系统。

1.AMA深度改进均线原理

除了常规的等权移动平均线Moving Average以外，移动平均还有以下几种变种。EXPMA（指数加权移动平均）的权重因子sFcactor=2/（Length+1）,Length是周期。随着Length的放大，sFcactor呈现指数速度递减，在Length较小区间内递减很快，到了Length后期，递减的量会降低。sFcactor的值域范围是（0,1），无限趋近于0。

XAvgValue=XAvgValue[1]+sFcactor*（Price-XAvgValue[1]）；这行代码告诉我们，XAvgValue值等于上期AvgValue值+sFcactor倍的价格和AvgValue差值。可以理解为，在Length较小区间内，sFcactor较大，离差值的重要性明显，到后期，XAvgValue[1]成为指标值的主要影响因素。

在价格模型中，首次上期EXPMA值为上一期收盘价，N为天数（这里注意：不要随意使用开盘价或者噪声更高的最高价/最低价，它们的信噪比远没有使用收盘价好）。这种均线在各种资料中被解读为：着重考虑了当期价格对于均线值的影响，实际上绘制出来观察就知道了，它的功效是降低了噪声，但是不能准确反应过去样本的平均值。

还有一种线性加权移动平均线，常翻译为Weight Average，简写是WMA。计算时每个价格都乘以一个权值，这个权值刚好是它的编号。权重累加值“WtdSum=WtdSum+（Length-i）*Price[i]”这行代码中的i是编号，i越大，Length-i线性越小，Price[i]对应的那个周期的价格值，其影响力线性降低。这种均线的特点是反应敏锐，但是噪声较高。如图3-26所示。

图3-26 时间序列噪声不同，需要的均线周期不同



还有EWMA等其他类型均线，以及VWAP成交量加权价格等特殊处理方式，也可以算作是一种平均。需要大家多探索测试，以大样本的测试数据来判定和选择工具。

自适应移动平均AdaptiveMovingAverage，通过思路非常清晰的构造，计算方向性和波动性，完成了类似调节均线参数的效果。

◎ 方向性direction=price-price[n]

◎ 波动性volatility=Summation（Abs（price-price[1]）,n）

◎ ER效率系数Efficiency_Ratio=direction/volatility

方向性direction被表示为整个时间段中的净价格变化，它构造了一个基本的价格动量情况。

波动性volatility是市场噪声的在n周期内的总数量，你还可以尝试用其他方法构造波动性总和指标。

ER效率系数Efficiency_Ratio的构造是AMA均线核心思想，ER值域[0,1）。效率系数评估了目前价格的运行状况，一般认为在ER系数小于0.5时，市场呈现方向性不明确的态势，在ER系数显著大于0.5时，市场已经出现了价格突破趋势。在ER系数过大时，市场处于过热状态。大部分情况ER效率系数是在0.5以下波动的。

根据作者后期的著作，我们可以发现，考夫曼始终在研究 ER效率系数对于交易标的活跃度的表达方法，比如有同事发现：20日ER均值和20日均线总盈利/总亏损的关系如图3-27所示。ER效率系数可以帮助选择市场和品种，对于ER强的，主要做趋势，对于ER弱的，主要做均值回复。

图3-27 ER效率系数和均线模型盈亏比的关系（中国商品期货指数合约日线数据）



均线设计者考夫曼针对美国股票市场，设定了两个周期参数2日和30日，他希望均线值在这两个值之间变化。或者说让交易者通过参数设置更加容易地规定自己的系统在什么区间内进行参数调节。以下是ER的计算公式。

◎ fastest系数=2/（N+1）=2/（2+1）=0.6667

◎ slowest系数=2/（N+1）=2/（30+1）=0.0645

◎ smooth系数=ER×（fastest–slowest）+slowest=ER×0.6022+0.0645

◎ c=smooth×smooth

通过对ER的计算我们可知：如果最近走势更趋近于单边趋势，则ER系数会趋近于1，如果最近行情没有明显趋势，且震荡，则ER系数会趋近于0。

那么，在趋势明显时（更准确的说法是波动惯性增强时）,smooth系数会放大，smooth系数的平方作为c系数会更大。

“AMA=AMA[1]+c*（price-AMA[1]）;c”作为一个权重因子调节 price-AMA[1]部分的权重，在价格波动惯性增强时，AMA起到了调节均线周期值更快的作用，如同无极变速箱，让你的均线保持敏锐，同理价格波动缓慢且缺乏方向时，price-AMA[1]部分影响力变小，如同均线的Length值被调节放大，此时不要轻易做出任何交易。

如图3-28所示AMA的优点是具有自适应性，当趋势明显时，AMA紧随价格而变动，类似于短周期均线；当价格横向摆动时，AMA走平，类似于长周期均线。AMA更好地根据价格走势降低噪声，相对于常规均线，往往能够提升交易胜率，避免一部分错误信号的发出，降低交易次数。

图3-28 AMA均线（紧贴价格）和普通20周期均线（始终较为平滑）对比



2.标准差开仓过滤器

到此AMA均线的逻辑就设计完毕了，为了方便交易，并且与系统的自适应特性相一致，考夫曼设计了一个波动率过滤器：当价格波动变得更多或更少时，过滤器也要相应取较大或较小值。过滤器被定义为AMA变化（而非价格变化）的一个百分数：

过滤器=percentage参数×StandardDev（AMA-AMA[1],n周期）

其中，StandardDev（series,n）是价格系列n个周期的标准差。最小的过滤器百分数0.1可被用于较快的交易，而较大的百分数1.0将可以选择出更有意义的价格移动的交易。典型例证是：外汇和期货市场交易较快，股票和利率市场交易较慢。通常，过滤器的大小依据20天周期的数据来计算。

在对该模型的改进中，我们还会引入另一种过滤器设计：

过滤器=percentage参数×StandardDev（AMA,n周期）

我们发现，直接使用AMA值的标准差可以产生略高的性能，而不用使用AMA值一阶差分的标准差。另外此处的n周期和效率系数构建部分的n周期都考察了一段时间的波动性或动量，是一个窗口期，但并不意味着两者可以被合并成一个参数。我们倾向于这个n周期被设置为固定值，是和时间序列频率相关的值，比如在日线上可以固定为20，在小时线可以固定在50。相反我们认为ER效率系数中的n周期，在不同的股票和商品期货品种上，是需要微调（优化）的。

交易规则相对简单：

AMA-lowest（AMA,n）>过滤器，买入；highest（AMA,n）-AMA>过滤器，卖出。

也可以改进为：

AMA-上周期AMA>过滤器，买入；上周期AMA-AMA>过滤器，卖出。

实际上使用改进后的这种交易方式更加稳妥，因为它再次去除了一个参数 n，而将其转化为AMA值的一阶差分和过滤器的大小做比较。但是这并非绩效最高的方式，我们可以选择将n和“更大一个频率包含本频率Bar数量”挂钩，比如按照目前规则，在1小时线上，螺纹钢每天有7个Bar。股票如果运行在小时线上，每天有4个1小时Bar，如果是运行在日线上，则每周有5个日线Bar，但是这增加了系统的复杂度，需要谨慎考虑。

3.跨周期日线ATR止损模块（自定义函数）设计

AMA系统在实际使用中可以作为交易系统的主体，但是它还是缺乏了一些应对极端情况的能力，比如价格的快速下跌。所以需要加入之前我们提过的ATR追踪止损模块，我们在这里引入更加细致的 ATR处理方式，取跨越到日线级别的 ATR值，作为更稳健的波动评估量。

因为大部分作用于期货的交易系统运行在小时线，甚至是分钟线上，日内价格波动分布向来不均匀，早盘价格波动强烈，下午盘和夜盘波动较弱，如果再遇到涨跌停等情况，则ATR值发生剧烈变化（先增大再缩小趋近于0），所以止损位一旦和本周期ATR相关，就会变得非常紧密，导致在本来价格剧烈变化的时间点，应该正相关的止损位出现负相关缩小。

以下是在交易开拓者平台下，我们自定义的用户函数，它可以在日线级别计算ATR值。这是一个数值型的用户函数，它有一个传入参数：Length（10），来传入过去几天之内的ATR值。该函数能够获取到日线频率的ATR值，也可以通过扫描二维码获得。





在交易中设置止损量的时候，大部分期货交易品种以1倍日线ATR即可。保证金占用大，且波动量高的品种（比如焦炭、橡胶、镍等品种），以0.5倍日线ATR设置即可。甚至可以观察到，一个严格的止损可以增加交易次数，带来更为积极主动的出场，其出场点往往走在系统平仓点之前。你甚至可以关掉系统自己的平仓条件，当然这在极端情况下还是有风险的，且经过参数分析后发现系统自己的平仓逻辑也没有损害性能，所以需要保留，以便应对价格缓慢下跌引发的追踪止损不能应对的走势（我们应该牢记：止损和追踪止损仅在价格反向快速变化时起效）。

4.止损后防重入模块和关闭止损模块

我们观察到，系统在进行了ATR止损特别是追踪止损出场后，容易因为模型主逻辑依然是做多或做空状态而再次入场。

//TS止损后，止损平仓30个Bar之内，不允许入场条件，之外条件失效（多）

TS_Reentry_long=

Normal_Trailing_long==True　　　//追踪止损平仓

&& close[1]< Highest_high_2_30　　//价格没有创30周期新高，没有有效突破

&& BarsSinceExit < 30 ;　　　　　　//止损平仓30个Bar之内

所以应该设计一个防止重入的模块。该模块的设计思路和之前的趋势系统防止重入相同，不再展开讲解，仅测试该模块在开启和屏蔽状态下，对于 AMA系统的性能影响。

从字面意义上看，在特殊情况下关闭ATR止损模块，会让人感觉到难以理解如何界定特殊情况。实际上针对价格高度回复性（期货市场价格如果短期剧烈波动，则存在马上修正的动能）的期货市场和股票市场（反转效应是股票市场的超越趋势效应的主要特征），价格剧烈波动导致的ATR出场往往是得不偿失的，所以可以加入一个非常简单的设计逻辑，来避免不必要的平仓。

//向下跳空（或大幅度加空），多头止损不启动

gap_long=open-close[1]<-1*atr[1]

&&（time==0.090000 || time==0.210000）;

//向上跳空，空头止损不启动

gap_short=open-close[1]> 1*atr[1]

&&（time==0.090000 || time==0.210000）;

我们设计该逻辑的思想比较简单，通过特定时刻大幅度的价格跳空来识别特殊情况。考虑到夜盘影响，我们将每日9点和21点纳入计算范围，如果价格出现了向反方向的1倍日线ATR跳空，则在本Bar上暂停止损模块运行，下一个Bar再恢复，因为通过统计发现，价格遇到较大的跳空后，已经释放了动能，接下来反转因素将占到主要作用。

5.防止小幅度区间波动硬止损模块

同样，定义小幅度波动或者区间波动也是较为困难的。在没有加入此模块前，我们观察错误交易时常能够看到不必要的硬止损，它们严重干扰了系统正常运行，在价格低波动区间带来反复的止损出场。而次日有可能一个快速的价格反转，就证明了这个出场是完全不必要的，但是显然按照ATR正相关的出场条件来看，这个出场点位的计算没错。

//确认非常需要止损的时候，再止损

lowD1=lowD（1）;　　　　　 //定义lowD1是昨日低点，lowD（1）是系统内置变量

downto30bars=low < lowD1 ;　//定义一个bool条件downto30bars,low < lowD1时为真

特别是在期货领域，我们引入了一个简单的过滤条件，规定当价格必须跌破（突破）昨日低点（高点）时，才是必要的止损位，此方法降低了交易次数，避免了一些不必要的低波动率区间硬止损，带来了性能提升。这是应对ATR过小造成非必要出场的有效模块，它仅有一行代码，是一个布尔条件。我们接下来会测试该条件对于性能的单独影响。

我们依然在上证50、沪深300、中证500指数上，分别测试了AMA纯做多系统，观察其性能表现。测试时间段从2010年1月1日开始，2017年12月31日结束，30分钟K线频率，交易成本设置为双边各0.2%。本测试不允许开启复利模式，也就是说盈利不加仓，仅为观察AMA系统的稳健性。如图3-29所示。

图3-29 将改进版AMA系统运用于股票指数，映射到3只ETF基金交易（只做多）



我们搭建了两个工作区，分别是以黑色系和化工为主的高波动品种，以有色金属和农产品为主的低波动品种，部分交投不活跃的品种没有纳入测试。测试时间段从2010年1月1日开始，2017年12月31日结束，30分钟、60分钟、2小时K线频率，交易成本设置为双边各5%%+开平仓各1跳滑点。如图3-30所示。

图3-30 将改进版AMA系统运用于商品期货资金曲线



我们注意到，这套多空择时系统在商品期货上表现非常好，不但超越大部分CTA基金难以超越的2016年11月11日高点，而且全阶段内回撤小，回撤时间和幅度可控。在测试期内，这套系统达到2.70收益风险比和2.43夏普比率，在42.24%的胜率环境下，盈亏比高达2.24。可以认为这种结构非常适合趋势追踪类商品期货布局。如图3-31所示。

图3-31 将改进版AMA系统运用于商品期货月度盈亏



为了尽可能降低回测中的幸存者偏差，我们做了长假平仓的模块，查找日历寻找到股票和期货市场的法定节假日前一天，然后在最后一个K线上做了平仓处理，最后在长假后第3个K线上做了保持原信号建仓处理，这是完全为了考虑到实际交易情况而撰写的。

因为在持有方向性较强的头寸时，我们一般难以做出在长假持仓的决定，这意味着将承担较大风险，毕竟长假期间的货币政策调整和境外股票期货市场走势都完全不在我们控制范围内。也许你认为长假前最后几天的走势已经反映了这些市场信息，事实证明交易者并没有这么理性，而我们要更加理性处理此问题，宁可牺牲一部分利润也要尽可能符合现状（事实证明，长假平仓后再建仓，在大部分情况下会有损系统净利润，但是我们也不得不这样做）。

AMA系统商品期货版本模型源码如下（多头部分），也可以通过扫描二维码获得。





3.6 “海龟交易法则”辉煌战绩与实践


我曾经说过“程序化交易者如果错过海龟交易法则，那将是一个不小的遗憾”。因为海龟交易法则不仅从模型原理上容易理解，而且提供了一套完整的模型+风险控制+资金管理思路，这套思路在现在看来也绝对受用，甚至可以被融入每个人的交易系统里，所以本书也要再次讲解海龟交易系统。

在1983年年中，著名的商品投机家理查德·丹尼斯与他的老友比尔·埃克哈特，进行了一场辩论，这场辩论是关于伟大的交易员是天生造就的还是后天培养的。根据资料描述，在此之前理查德·丹尼斯将400美元用几年时间奇迹般变成了两亿多美元，平均每年都从市场赚取5000万美元以上的利润。同时他本人95%的利润来自5%的交易（体现了趋势交易较低的胜率和较高的盈亏比），他深信斩断亏损、让利润充分奔跑的道理。如图3-32所示。

图3-32 可以与杰西·利福莫尔、彼得·林奇并称投资天才的理查德·丹尼斯



理查德相信，他可以教会人们成为伟大的交易员，比尔则认为遗传和天性才是决定性因素。随后他们招募了大量的交易学员，而这些交易者很多人并不是专业的股票/期货交易者，甚至缺乏一些交易经验和业绩积累，所以这个测试格外引人关注。他们在1983年年底和1984年年初在《华尔街日报》上登寻人广告，寻找一些愿意接受训练并成为期货交易者的人。工作条件是：交易者必须搬到芝加哥，接受微薄的底薪，如果交易赚钱则可以有20%的分红。

该计划被称为“海龟计划”，最终从上千人中选到80人，进一步筛选到23人，再筛选到13人，学员们被称为“海龟”。这成为交易史上最著名的实验，因为学员们在经过短期培训（更多地是规则灌输）后，在随后四年中取得了年均复利80%的收益。这个实验证明了交易方法可以被传授，一套好的交易逻辑，可以使仅有很少或根本没有交易经验的人成为优秀的交易员。也将这句话送给本书的读者们，你们持之以恒地研究量化模型的开发，并在科学的道路上不断获得统计结论，肯定能够做出并驾驭好自己的模型。

1.借助唐奇安通道入场和出场

海龟交易法则公开的版本使用唐奇安通道作为买卖开平依据。唐奇安通道是由Richard Donchian发明的一个机械的突破系统，最早的单参数唐奇安通道是一个机械交易系统：若突破20日最高价，则做多；若跌破20日最低价，则做空。

1970年美国有公司对当时最流行的机械交易系统进行了模拟测试和比较研究，其研究结果表明，在所有测试对象中唐奇安通道规则最为成功。1983年Richard Donchian被推举为首届“最佳获利奖”得主，并将此奖项改为唐奇安奖。

该交易系统分为两个子系统：系统1是以20日突破为基础的短期系统。系统2是以55日突破为基础的长期系统，如图3-33所示。

DonchianHi=HighestFC（High[1],boLength）;

DonchianLo=LowestFC（Low[1],boLength）;

fsDonchianHi=HighestFC（High[1],fsLength）;

fsDonchianLo=LowestFC（Low[1],fsLength）;

（1）入场策略：系统1的原则是在向上突破进20日最高点的第一刻开多单，在向下突破20日最高点的第一刻开空单。

（2）出场策略：如果持有多单，则在价格向下运行突破TeLength周期低点连线平仓，作为一个自然的价格下落出场点。如果持有空单相反，则在TeLength周期高点连线平仓。

图3-33 短期唐奇安通道（20日）和长期唐奇安通道（55日）加载后效果



ExitLowestPrice=LowestFC（Low[1],teLength）;

ExitHighestPrice=HighestFC（High[1],teLength）;

（3）止损策略：在设置止损方面，这套系统以20日ATR作为一个幅度，在后文统一用N。

N=AvgTR[1];

AvgTR=XAverage（TrueRange,ATRLength）;

海龟的止损保证每笔亏损在账户净值的2×N以下。

//止损指令

If（Low <=preEntryPrice-2 * N && SendOrderThisBar==false）//加仓Bar不止损

{

myExitPrice=preEntryPrice-2 * N;

Sell（0,myExitPrice）; //数量用0的情况下将全部平仓

PreBreakoutFailure=True;

}

（4）加仓策略：海龟交易系统的加仓策略是以1/2N来加仓的，还以20日的ATR为20个minpoint（价格点数）为例，那么加仓就以入市价格每10点加仓一次，海龟交易系统的满仓是只加仓加到第5个单位为满，也就是加仓4次为满仓（这一点可以通过模型限制，或者在交易系统的“全局交易设置”中进行设置），如图3-34所示。

图3-34 海龟交易系统加仓后（5次建仓）效果



while（High >=preEntryPrice+0.5*N）//以最高价为标准，判断能进行几次增仓

{

myEntryPrice=preEntryPrice+0.5 * N;

preEntryPrice=myEntryPrice;

Buy（TurtleUnits,myEntryPrice）;

SendOrderThisBar=True;

}

通过很短的篇幅就讲解完了海龟交易系统的核心规则唐奇安通道，事实上海龟们还使用了其他交易法则，比如双均线、RSI、以及唐奇安通道加定时出场等，我们之前讲解的部分系统，也可以被作为入场、出场的原型。

2.单品种风险控制和资金分配问题

之前读者们初步了解了ATR的使用方法，除了能够自适应价格波动幅度之外，ATR还可以感知到价格波动的风险，然后让每次的开仓头寸和风险呈现负相关，这是一个听起来非常简单的逻辑，实现它也不难，关键在于，你能够意识到波动率升高往往意味着价格将向反方向波动，或者说反转的概率大于低波动率时刻。

海龟交易法则就提到了关于ATR的应用，它建议开1个头寸的大小，应该使1ATR=总资产1%的波动。假设手头有100万元资金，有三只股票要分配仓位，我们就可以设定让三只股票ATR的波动等价于总资金1%的波动，那么100万元的1%为10000元。

股票1的ATR为0.70元，股价11.00元，获得10000÷0.70=14285份，持仓价值=14285×11=157142元。

股票2的ATR为1.62元，股价22.68元，获得10000÷1.62=6172份，持仓价值=6172×22.68=139980元。

股票3的ATR为2.48元，股价29.76元，获得10000÷2.48=4032份，持仓价值=4032×29.76=119992元。

通过计算可以发现，股票1的 ATR除以股价=0.0636，股票2的 ATR除以股价=0.0714，股票3的ATR除以股价=0.0833，股票3最活跃，其平均每日振幅达到8.33%，表明此刻它正处于一个高波动区间，所以被给予较小的资金分配是理所当然的。所以海龟系统没有再去像我们之前计算一个短期ATR和长期ATR的比率，构建一个ATR倒数关系，而是采用等分风险资金（1个ATR对应总资产1%比率），然后按照投资标的ATR计算得到其所能够拥有的购买份数，在期货交易系统中这也是开仓手数。

而如果用等分方法，则股票1、2、3应该获得等量资金分配，显然股票3是一只活跃的股票，如果给它分配同等资金，会造成它整个账户受波动影响较为显著，不利于风险控制。

使用ATR，或者价格归一化标准差（标准差除以均价），有一个关于计量角度的优势是，这类指标都可以不同程度地去量纲。ATR虽然不能在不同价格的品种上直接对比，但是ATR除以均价后，也能完成去彻底量纲的任务。在海龟交易系统中，我们不用对ATR除以均价，因为我们计算的是不同品种购买的份数，而不是直接划分金额，这一点要想明白。

3.选择品种和账户风险控制

海龟交易法则对于交易对象有严格的要求，要求如下。

（1）需要进行多品种组合交易。

（2）首选流动性最强的品种。

（3）不选容量小、波动趋势不强的品种。

（4）不选有价格操作隐患的小品种。

（5）一经不选，就不再选取。

由此我们可以看出，海龟交易法则拥有比较好的普适性，同时它倾向于长期与市场风险进行博弈，通过多品种同时运行，在总体资金量动态变化的时候，如果有部分品种呈现震荡没有趋势性行情，那么要针对另外一些活跃的品种进行加大头寸。

海龟原版系统建议：同一个市场（可理解为交易所）最多4个头寸，在高度相关的多个市场（这里建议理解为属性类似的板块）不超过6个头寸，在任何一个方向上（多头或者空头）的总交易量不超过10个头寸。在没有相关性的市场，可以放宽到12个头寸。

在这一点上，我们在实盘交易中，经常也可以发现自己的持仓和市场风险的关系。比如我们持有90%价值的空单，此时无论你的策略如何分散，或者你有任何持有这样头寸的充分理由，账户都已经站在了风险边缘线上，因为一旦市场整体转多，你将有90%的头寸受到影响，所以当持仓过于集中的时候，要平掉部分最早开设的仓位，或者禁止再开新仓。

还有一个经验也能够从海龟交易法则中找到答案，就是在高度相关的多个市场，比如我们在黑色工业品上（螺纹钢、铁矿石、焦炭、焦煤、热卷、动力煤、硅铁、锰硅）持有的全部是多单，且保证金占用量超过60%，那么风险是较大的，因为此板块是高波动板块，且过于集中的同向持仓意味着受损伤的可能性较大。

总而言之，海龟交易法则的核心在于资金管理模块，它回答了如何根据波动率分配资金这个关键难题，用低噪声的长期趋势追踪交易方法，为投资者带来长期的正期望收益。即使在目前的中国期货市场上，掌握好加仓量和出场点，在品种配置较为齐全的情况下，海龟交易系统获得超过1的夏普比率是可以期待的，这意味着年度正收益不成问题。很难想象这是一个已经有30多年历史，且完全公开的交易系统绩效。

海龟交易系统的源代码在“交易开拓者软件”中内置，还有配置好的工作区，建议大家增加更多周期的趋势追踪，并改进系统出场规则，以达到平滑曲线的效果。

4.尝试迭代海龟交易系统

在本书截稿之前，我们通过电子化内容微信公众号“量化投资训练营”创作了一期针对海龟交易法则的迭代，主要进行了以下几个方面。

◎ 改进点1：复利改为单利

◎ 改进点2：关闭离市周期条件

◎ 改进点3：改变日线ATR计算周期和长期入市周期

我们在这篇文章中详细记录了迭代方法，针对海龟系统中困扰投资者实盘的难题“是否加仓”也做了测试和分析，考虑到回撤的过度扩大，我们不建议开启加仓模块，请大家参考：



改进之前，海龟交易系统在中国期货市场多品种的交易绩效为：收益风险比0.64，夏普比率0.81，最大回撤比率72.35%。经过迭代升级后性能上升显著，如图3-35所示：收益风险比达到1.25，夏普比率达到1.12，最大回撤比率降低到46.40%。此时净利润也比原版海龟系统上升25.32%。并且在2018年5月中旬，这套系统创下运行后净值新高，由于积极配置了苹果期货，海龟系统为中长期趋势追踪者带来了理想的回报。

但是我们也应该注意到，如果交易者忽略了近几年新上市的热门期货品种，没有及时将模型和资金部署在新品种上，动量类交易模型都难以获得可观收益，所以品种选择和资金分配在某些时刻比研发出一个精致的模型更为重要。

图3-35 改进后的海龟交易系统多品种绩效





第4章 基本面和技术面交易模型



4.1 股票模型思路形成与常见问题


模型开发的核心问题在于开拓思路。一个策略开发者，首先应该通过长时间在A股市场的交易行为，逐步感知市场参与者的风险偏好、资金流动规律。然后建立基本假设，比如假设市场偏好高业绩的股票，或者价格波动的规律偏向趋势性或者反转性。最后通过撰写模型，逐一验证自己的假设。在测试模型的过程中，还要再度观察自己的假设是否合理，模型收益来源是否获得合理解释。如图4-1所示。

以上是我开发模型的一般步骤，现在有很多量化交易网站、论坛和机构研报也可以提供辅助思路，这都扩展了我们的眼界，增加了策略的多源性，为可能验证的策略池里注入新的思路。近几年一些网站销售策略源码，在一定程度上也丰富了大家的模型库，但是某些源码存在未来数据引用、资金承载量差和绩效回测偏差大等问题，难以使用并且有误导开发者的问题存在。

图4-1 以PDCA为思考逻辑建立投资模型



此外，很多国外的杂志和机构研报都有整合版本的电子书，也可以借鉴其思路，但是国内外市场因为交易制度、上市公司结构、IPO规则等方面的诸多差异，导致了很多使用于国外市场中的方法或者因子在国内无法使用，这一点必须注意，要有甄别地吸收其知识。

在构成思路并且回测的过程中，我们必须反复拷问自己这个策略的交易逻辑是否清晰，交易规则是否合理，交易冲击成本是否是市场或者自己的资金规模能够接受的（这将影响到模型实盘的资金承载量和绩效），策略的参数敏感性是否存在问题（若性能对于参数过度敏感，则存在极大的过度拟合（Over Fitting）问题）。

如果成功越过了策略开发这道门槛，自己也能够撰写策略模型并实现程序化下单，那么接下来大部分工作就可以交由IT平台专业人员完成了。这部分工作我借助了聚宽JoinQuant、交易开拓者TradeBlazer、MultiCharts等软件实现。在公司内部，偶尔一些复杂的交易策略会由专业IT工程师帮助我们撰写，并在数据和挂单方式方面做优化处理，但是由于我们没有涉及高频交易，所以这些细节处理没有对模型绩效产生本质影响，甚至在中低频量化领域，没有感觉到依赖IT资源的交易策略有优势。

最后的股票交易还牵扯到交易所，证券公司、期货公司提供程序化交易接口，国内股票程序化接口在2015年有一段黄金期，但是随着“股灾”的到来黄金期戛然而止，目前都是一些第三方机构提供部分接口。在期货方面相反，程序化交易发展非常顺利，CTP等接口的快速发展和官方的支持态度（程序化在一定程度上提供了活跃的交易资金，但只有挂单方式才称得上提供流动性，这是官方允许程序化交易的核心原因），使得期货程序化下单几乎没有障碍。

模型开发的常见问题或者说最影响模型实盘发挥的问题，就是开发过程中伴随着大量的幸存者偏差，造成绩效失真。广义上的过度拟合也可以认为是模型拟合到了过多的幸存者偏差数据，造成外推实盘绩效较差。

如图4-2所示是德意志银行量化投资部门的一张分析结论（针对罗素3000指数和MSCI欧洲指数）。

图4-2 德意志银行对于幸存者偏差的说明



在图4-2所示的具体的因子分析方面，德意志银行发现，幸存者偏差可以导致性能差异很大的结论，在将所有股票分为Q1～Q5这样5组的测试中，比如：净利润、ROE、每股收益增长率、3个月反转、1个月动量等因子的测试中，因子暴露（多元线性回归公式因子值前的系数）差异较大，有些因子的作用被过度放大，有些因子甚至被错误给予因子暴露值，也就是说幸存者偏差完全可以指导我们构建出错误的模型。

类似的文章有很多，类似的问题也有很多，但是这个问题似乎是量化投资的命门，模型开发者久久难以突破，最终选择妥协（认为绩效衰减没有办法解决，甚至根本看不到幸存者偏差）的人更多。

我总结了以下几个可能会导致幸存者偏差的问题，请各位读者思考并小心回避。

1.经济结构或市场结构过度调整

在股票市场上，我们能够明显感受到2017年的股票市场大小市值风格切换。在多因子Alpha模型中，最受关注和创造辉煌的“小市值”因子表现不佳（或者说得直白一些：表现很差，负面回报显著）。

传统意义上，我们通过简单的截面回归可以直观地发现，本期市值升序排名靠前的小市值股票，在下一考核期内的涨幅较高，我们将此作为该因子的收益率解释能力。然后我们横向考察了小市值因子相对其他财务因子或动量因子的收益率标准差、回撤表现和夏普比率，认为这是一个优秀的因子。这一挖掘过程表面上看完全没错。

但是经济结构在这两年发生了很大变化，我们知道企业融资是扩大再生产的必然环节，发行股票融资、银行贷款融资，还有其他众多资金获取方式都是融资渠道。在银行贷款融资方面，这些年反复强调解决民营企业困难，在融资环节予以倾斜，实际上结果并不好。货币增速进入边际回落，人口红利高点过去，宏观经济进入收缩周期，资产价格和企业扩张能力可能也进入了低增长期。此时银行更加警惕不良资产，令中小市值企业融资雪上加霜。

同时受益于供给侧改革，煤炭、钢铁、电力、冶金、化工、重装备制造等传统行业盈利能力迅速提升，资产质量得到显著改善，这种效应反而带来了中小企业的成本提升，相对竞争力也降低。银行大量资产实际上集中在国有资产企业中，这些资产的价值重估，带来了银行和非银金融行业的价值重估。有限的资金被抽离到银行股、保险股等金融板块，散户交易者直观的感觉是小盘股越来越没底了，而大盘股出现了显著的连续上涨。

在发行股票融资制度方面，在中国，受益于股票IPO发审制度红利，小市值因子有了核心支撑力。大量上市公司排队等待上市，实在等不及就借壳上市，“壳资源”优势在过去被不断演绎。很多企业业绩做不好，濒临退市，但再不济也还是上市公司，有一串可以融资的股票代码，我们称之为“壳资源”。而现在IPO加速发审，再融资收紧，这种制度红利逐渐不再，小市值公司一半的光辉瞬间被抹去。这是小市值因子短期遭受的最大的杀伤力。

这告诉我们类似“小市值”这样的表象因子需要慎重思考，因为这个因子的有效和失效，都伴随着市场结构和监管方式的随时变化。

2.建模数据不足，或模型错误处理数据

我们在构建程序化交易模型时，很多参数和交易规则的确定，都是根据历史数据上运行的结果而定的。在《海龟交易法则》这本书中，也讲到了“确定一个较好的交易系统要参考历史走势（回测）”。在统计学中，回溯检测历史样本也是非常方便的且低成本的方案。

但是获得的历史数据全集是否意味着有稳定的特征可以挖掘，并在未来继续保持这种特征？我们只能在大概率情况下相信统计结果，这恰巧在量化投资的基本假设（用历史指导未来）中隐藏的危险，因为数据永远不足，且不足量的数据很容易得到错误的统计结论，模型性能衰退也就成为必然。

对抗这类幸存者偏差的第一个方式是：更多地依照经济学原理和行为金融学原理，检验模型的各项假设是否成立。举一个典型例子，如果我们给予不同的股票、期货品种以不同的模型参数是比较危险的行为，因为参数的意义难以找到强有力的解释，特别是均线类模型的周期参数，如果你只是使用历史样本拟合得到参数，任何目标函数都难以对抗过拟合。最佳的方案是降低参数对于模型的性能影响，或者为你的参数找到充足的解释。

第二个方式是：使用尽可能大的样本，比如针对全市场3000多只股票，20多个主流期货品种，构建相同规则的模型基础框架。大样本最大的好处就是避免了单品种的过拟合的可能性，虽然无法预测未来，但是增加了数据的群体特征，在一定程度上降低了个体特征。

区分训练集和测试集也是必须要做的，可以按照时间顺序划分：70%的数据训练，30%的数据测试。也可以将第N、N+2、N+4年数据划分为训练集，第N+1、N+3、N+5年数据划分为测试集，也就是交叉分配数据，这适合于数据量极大的情况，特别是机器学习多维度数据建模。

3.因子超额收益不纯净

我们将影响股票价格的因素常称为因子（Factor），常见的多因子模型就是回归多个因子得到的面（一次）或曲面（高次），再得到股价公式，并以此来解释股票收益。所以在因子建模环节，得到高质量的单因子最重要，甚至比模型使用什么样的回归方法更重要。

在单因子测试阶段，要注意测试方法是否合理，也就是说尽可能提取到因子纯净真实的超额收益。所以有几个流程是必不可少的：数据清洗（数据去异常离群点）、因子中性化（尤其以市值中性化为核心）、截面高相关性（共线性）因子剔除。

IC作为因子值对于股票价格的解释工具，不同因子的IC不仅在绝对值上有差异，而且在稳定性、换手率、衰减程度上也有差异。如果我们确定要做一个基本面选股模型，且适合大资金交易的模型，要使用月度IC显著、换手率低、IC半衰期长的因子。如果我们确定要做一个短期价量交易模型，要使用周度 IC显著、换手率中高、IC半衰期不是核心考虑因素的因子，这类因子往往在3～5日其IC就已经大幅度衰减，但是我们的调仓周期设定为周度调仓即可驾驭它。

多因子模型也并非因子越多越好，如果很多超额收益同源的因子在一起，即使改变参数或者计算方法，只要其体现的都是一类信息，也容易造成多重共线性（Multicollinearity），这对于回归问题干扰较大。此时我们要分析彼此高相关性的因子，直接删除。剔除因子可以通过主成分分析提取主要的特征，从而忽略次要的成分，得到相关性很低的特征，或者将其和另外一个相关因子做正交回归，得到残差是回归剩下的超额信息因子。

最后提醒读者们，回测结果需要人工复盘观察，以股票模型为例：某些时段投资组合中的某个股票上涨原因并不是某因子能够解释的，也许是资产重组或者消息刺激等巧合导致的，这种情况要逐一排除。期货时间序列中也存在大量低质量的历史数据，如隔日跳空、成交量过小导致的价格操纵，或者交易制度干预下的价格异变，或者基本面突变导致的价格不稳定，也要尽可能排除这些偏差，才能得到稳健的模型和参数。





4.2 小市值二八过滤止损模型，A股明星以小为美


如果要问一个做股票多因子模型的人，小市值因子意味着什么，他可能会告诉你惊人的答案，意味着在历史上几乎不败地跑赢指数，而且是大幅度跑赢指数。可以说小市值因子是所有因子中最容易理解，也最有效产生Alpha超额收益的因子。

1.市值因子：超额收益重要来源

经过大量数据回测比对，小市值组的股票明显会强很多。尽管在2017年该因子受到明显打压，但是仅从回测结果观察，并参考国外情况，小市值公司在成长为大市值公司的路上市值不断增加，而且都伴随着超量的Alpha释放，这些超额收益是有理由存在的。即使是经历了2016年的熔断情况，市值因子平均每年也能带来15%的超额回报，其中最有效的策略就是买入小盘市值因子，而且是用量化的方法，定期地进行小市值股票筛选和调仓。

如图4-3所示，在2008年之后，小市值带来了很高的收益，尤其是相对于中等市值和大市值股票而言。也有大量分析数据显示，在中国A股市场，按市值对股票进行划分，最小市值的那些股票，除了获取超额收益率不是很稳定以外，种种表现均强于市值较大的股票。

图4-3 市值因子收益率远超基准指数，且对于股票的区分能力强



2017年虽然这类因子表现不佳，但是在“白马股”异常表现过去之后，我们看到A股大部分公司市值依然并不十分庞大，且分散在各领域，特别是新经济领域的公司，这类公司的成长率和决策执行效率，都要比大市值公司更强。2018年券商也认为，市场资金转向成长股的热情已经被点燃，短期100亿元以下的小市值细分龙头迎来重新定价机会，重点关注工业互联网、独角兽回归概念、内容付费板块等，这些显然不是传统行业公司，但基本面研究人员乐此不疲地持续挖掘业绩和估值相匹配的中小市值成长股，这个研究路径在国内外市场，几十年没有发生过变化。

尤金·玛法根据1941—1990年的美股数据指出：除了衡量波动风险的Beta值之外，股票的市值和估值（用账面市值比和市盈率两个因子来解释）同样也会影响回报——更直接地说，小盘股、低估值的价值股会有更好的回报。后来用公司的市值、账面市值比、市盈率预测股票回报的模型就被称为Fama-French三因子模型，该模型几乎在全世界股票市场都有用武之地。

除去低估值的两个因子不考虑，只考虑小盘因子，很自然地，我们生成一个机械式地买入/卖出调仓规则：在固定时间截面上，选择市值最小的股票买入，卖出市值较大的股票。这里不仅有市值的因素，也蕴含着均值回复（反动量）的因素，因为股票之间相对的市值增加在股票数量不变的情况下，要通过股票价格上涨得到，所以市值因子也是一个典型的均值回复因子，不断地挑选动量较低的股票买入，而卖出市值相对较高的股票。

2.过滤回测中的数据漏洞和偏差

本节引入一个典型的小市值个股轮动模型，模型里部分代码大家可以作为通用的回测框架在自己的模型中使用。本程序也提供了5段用于过滤特殊股票的代码（过滤停牌股、退市股、ST股、次新股、涨停板股），也同样可以在不同的模型中插入并调用，这些必要的过滤将帮助我们最大可能地避免幸存者偏差。

其中过滤涨停板股要通过运行history函数，取到1分钟数据，所以该模型要运行在分钟线上，if not prices[stock][-1]==current_data[stock].high_limit含义是取到的第stock只股票的上一分钟prices不等于current_data[stock].high_limit，也就意味着有机会在这1分钟内买入。如果涨停了，则在股票过滤阶段就将这只股票剔除到可能交易的名单之外。

该模型通过get_fundamentals函数获取基本面（市值因子）数据，并做过滤和排序。

# 选出在过滤停牌、退市和ST后的股票代码，并按照当前时间市值从小到大排序

df=get_fundamentals（query（

valuation.code,valuation.market_cap

）.filter（

valuation.code.in_（filter5）

）.order_by（

valuation.market_cap.asc（）

）.limit（

# 最多取前stockCount只

g.stockCount

）,date=date）

为了让用户使用方便，聚宽设计该函数时，允许加入.order_by参数，可以以一定规则排序，本例中我们以valuation.market_cap.asc排序，也就是市值升序排序。并且为了防止输出股票数量过多造成资源占用过大，.limit字段可以完成数量控制。这里以全局参数 g.stockCount 控制每次查询的总数量。该参数的设置只要大于g.buyStockCount（买入的股票数量）参数即可，偶尔我们会设置再大一些，以便再做一些筛选过滤，保证最终的股票数充足，满足g.buyStockCoun最小持股数量要求。如图4-4所示。

图4-4 小市值二八过滤止损模型逻辑



3.加入大盘指数二八择时模块

在查询到基本面信息，并过滤特殊股票后，我们要重点介绍该模型的性能增强逻辑：二八指数开关。该模块首先测试沪深300（二类大盘股）指数和中证500（八类小盘股）指数当前是否处于动量下跌期，如果处于，则hs300increase为负，zz500increase为负。执行sell_all_stocks（context）函数。如果有一个指数的动量是向上的，则即可购买股票执行原有逻辑。

从它在模型中的位置可以看到，只有当两个指数的动量不是都为负时，才执行buy_min_market_stocks，所以它是全模型最上层判断逻辑。



我们以2010年1月1日2018年2月14日为时间段，测试了原始小市值轮动调仓和加入二八指数择时过滤之后的绩效如上，可以看到：总收益率从2643%降低到1941%，但是夏普比率从1.47提升到1.80，最大回撤也得到有效控制，Beta系数的降低意味着它和指数的相关性得到进一步控制。我们的二八轮动大盘择时模块是有价值的，但是它牺牲了较多的性能，换取了较低的回撤，这可以作为一个简单的风控模块框架，之后不断迭代。如图4-5和图4-6所示。

图4-5 仅小市值轮动测试绩效



图4-6 小市值轮动+二八择时测试绩效



本节源码如下，也可以通过扫描二维码获得。提示：该模型需要调用分钟线回测，因为每次调仓时机在14点53分。





4.3 PEG价值选股模型，复制彼得·林奇投资路径


投资大师彼得·林奇（Peter Lynch）说：“任何一家公司股票如果定价合理的话，市盈率就会与收益增长率相等”。他是一位卓越的股票投资家和证券投资基金经理，其价值投资的精髓在于，质好价低的个股的内在价值在足够长的时间内总会体现在股价上，利用这种特性，使本金稳定地复利增长。低PEG价值选股模型就是他的思想，被后人总结出的一个重要选股因子。如图4-7所示。

图4-7 彼得·林奇



1.初步量化基本面投资

我们熟悉的巴菲特的投资理念，概括起来主要有以下三点：

（1）安全边际理论

（2）集中投资理论

（3）市场先生理论

这些理论理解起来非常容易，但做起来却很难，原因如下：

（1）如何定量一只股票的价格是否被低估？

（2）什么样的股票才能够长期重仓持有？

（3）当你买入这只股票的时候，市场是否真的处于失效状态？

对于这三个问题的定量分析，几乎难以确定，因为定量即意味着“精确的错误”，这是巴菲特很厌恶的一个问题，也是他提醒投资者们需要注意的不能犯的错误。我们在进行模型开发时也注意不要通过优化或者过滤来获得“精确的错误”，但是在量化模型构建本身，几乎所有环节都要定量分析，必须要有一个评判基准。所以不能曲解“精确的错误”就是完全依靠主观经验和小样本观察，而是要思考如何进行数据分析，如何在噪声中提取主要信息。

这个时候，彼得·林奇的PEG方法，在一定程度上比较容易通过量化方法实现。PE的中文意思是“市盈率”,PEG的中文意思是“市盈率相对利润增长的比率”。

PE单独使用有很多问题和冲突（或者说有考虑不周全之处），单纯的运用低PE标准在选择被低估的股票时可能会有误导作用。因为很多不被关注的股票，特别是“夕阳行业”的低增长股票和净资产过于庞大的重资产传统行业大盘股票，往往拥有更低的PE为标准如果仅以低PE选股容易选到这类公司。

有高成长潜力的公司，通常有较高的PE，而低PE的股票，不是成长预期较低就是风险较高（股价低）。单纯考察PE指标，挑出来的股票可能包含成长前景不佳或具有极大不确定性。仅单纯地寻找PE低的股票而不加任何附加条件显然难以构成对价值投资者的选股解释能力。

PEG指标解决了市盈率面临的一个问题，那就是对于价值评估标准的选择，这也是PEG指标选股法最大的优势所在。PEG是综合考察价值和成长性的方法之一，用它可以找出相对于盈利增长率来说市盈率较低的股票。总而言之，PEG侧重于公司的成长性，适用于寻找相对于高增长率来说PE较低的股票，即PEG用于寻找真正被低估的股票。

计算公式如下：

静态PE=股价/年报每股收益（EPS）

动态PE=股价×总股本/下一年净利润（需要预测）

PEG=PE/净利润增长率×100

2.观察市场基本面数据特征

我们尝试着获取000300.XSHG沪深300指数中的个股pe_ratio和inc_net_profit_year_on_year净利润同比增长率（%），代码如下。

q=query（

valuation.code,　 valuation.pe_ratio,　 indicator.inc_net_profit_year_on_year

）.filter（

valuation.code.in_（get_index_stocks（'000300.XSHG'））

）

df=get_fundamentals（q,'2018-03-07'）

然后绘制出pe_ratio和inc_net_profit_year_on_year两列数据。如图4-8所示。

import matplotlib.pyplot as plt

plt.title（'pe_ratio get_index_stocks of 000300'）

df.pe_ratio.plot（）;

import matplotlib.pyplot as plt

plt.title（'inc_net_profit_year_on_year get_index_stocks of 000300'）

df.inc_net_profit_year_on_year.plot（）;

图4-8 沪深300指数pe_ratio和inc_net_profit_year_on_year



我们可以很明显地看到数据噪声点（也被称为离群点），在两列数据中都有，而且异常明显，在实际建模中，这类数据点将对模型造成破坏性影响，所以必须要剔除。我们定义一个这样的函数，在后文几个模型特别是到因子部分都要用到：

# 去MAD在上下3倍标准差之外的极值，返回给myData.input必须是list类型

def fun_normalizeData（myData）:

mad=np.mean（np.absolute（myData-np.mean（myData）））

MA=np.mean（myData）

for i in range（len（myData））:

if myData[i]> MA+3*mad:

myData[i]=MA+3*mad

elif myData[i]< MA-3*mad:

myData[i]=MA-3*mad

return myData

因为输入要求为list类型，所以要转换两列数据，然后送入fun_normalizeData函数：

# 转换数据类型到list,.tolist（）这个函数之后会常用

list_pe_ratio=df.pe_ratio.tolist（）

list_inc_net_profit_year_on_year=df.inc_net_profit_year_on_year.tolist（）

# 送入过滤函数

list_pe_ratio_normal=fun_normalizeData（list_pe_ratio）

list_inc_net_profit_year_on_year_normal=fun_normalizeData（list_inc_net_profit_year_on_year）

# 分别绘图观察去异常值情况

import matplotlib.pyplot as plt

num_list=list_pe_ratio_normal

plt.title（'pe_ratio get_index_stocks of 000300'）

plt.bar（range（len（num_list））,num_list）

plt.show（）

num_list=list_inc_net_profit_year_on_year_normal

plt.title（'list_inc_net_profit_year_on_year_normal get_index_stocks of 000300'）

plt.bar（range（len（num_list））,num_list）

plt.show（）

如果PEG>1，股价则被高估，如果PEG<1（越小越好），则说明此股票股价被低估可以买入。本节我们引入这个模型，试图提醒各位读者在A股或者其他市场投资时，价值投资永远是首选，尽管小市值个股能够带来显著受益，但是也能带来显著回撤，并降低模型的安全性和流动性保障。股票毕竟是企业价值在资本市场的体现，长期看股票价格必回归市场估值中轨，特别是注册制逐渐放开，“壳资源”不再“物以稀为贵”，捕捉价值股显得异常重要。

PEG估值的重点在于计算股票现价的安全性和预测公司未来盈利的确定性，PEG始终是主导股票运行的重要因素，所以寻找并持有低PEG的优质股票是获利的重要手段。

我们可以观察一批经过模型低PEG条件选择到的个股名单，相信诸位读者对这类上市公司基本面有一定了解：

2018-01-19 09:30:00-INFO-['600111.XSHG','000402.XSHE','601155.XSHG','002601.XSHE','000627.XSHE','000959.XSHE','600031.XSHG','600208.XSHG','601225.XSHG','603799.XSHG','000983.XSHE','000338.XSHE','600188.XSHG','600177.XSHG','603993.XSHG','601006.XSHG','601012.XSHG','300122.XSHE','601628.XSHG','601991.XSHG']

北方稀土、金融街、新城控股、龙蟒佰利、天茂集团、首钢股份、三一重工、新湖中宝、陕西煤业、华友钴业……显然该模型选到的都是估值较低、行业净资产较厚、业绩较好的上市公司，且集中在能源、房地产、制造业领域，很少有互联网和IT行业公司。

低PEG价值选股模型以“复合增长率”来衡量，因为这是通过长期计算得到的数据，所以更能够说明产业或产品增长或变迁的潜力和预期。另外一个概念是年度平均增长率，它是项目期内的每年增长率的简单平均数。这对于评价投资项目的增长率有一定的指导意义，但没有复合增长率真实。复合增长率在社会经济生活中得到了广泛的应用。彼得·林奇坚信：决定个股市盈率合理水平的只有一个指标，那就是公司的增长率。所以低PEG模型就是围绕此观点展开的。

该策略核心逻辑如下。

第一步：

设置沪深300为初始股票池，实际上，当天停牌的股票是无法进行买卖操作的，所以在整体回测前，将当日停牌的股票剔除，得到可行股票池。

第二步：

前面已说明，本策略仅对成长股有效，所以仅仅过滤掉当日停牌的股票是不完善的。仍需过滤掉市盈率（PE）为负值或收益增长率（G）为负值的股票。聚宽平台的取数据函数get_fundamentals可以直接取PE、G值。get_fundamentals函数的默认日期是context.current_dt的前一天，因为当天是无法知道当日的某些数据的。本策略使用默认值（缺省）。

第三步：

整体思路是非常简洁的，下面对股票的 PEG进行排序，取出PEG最小（且全都小于0.5）的前n只股票，作为调仓时待买入的股票列表。

第四步：

在每次调仓时，先卖后买，腾出资金，这也是后期我们撰写模型的通用方法。对不在待买入列表的股票执行卖出操作。对在待买入列表的股票分配资金，执行买入操作。

3.加入基于大盘的追踪止损模块

我们设计了一个基于沪深300指数的追踪止损模块。我们设定最近20日内最高值到当前收盘价如果回落超过2个ATR，则清仓所持有的股票。该模块return 1或者0，意味着需要或者不需要清仓个股，且该模块在每个调仓周期时也发挥一次判断作用，如果当前处于危险时刻（大盘快速下跌），就不进行调仓换股，同时清仓已有股票。

经过长时间测试，从2006年1月1日至2018年2月14日，这套低估值模型获得了可观的收益，特别是在股票池为沪深300的情况，基本上无法通过小市值因子获取收益，但它依然能够大幅度超越沪深300基准，夏普比率超过1。该模型最初版本由聚宽量化课堂提供，我们增加了调仓频率为每10日一次调仓，以便更加细致和严格地考察模型性能，并将持有股票数量调整到20只，让组合性能更加稳健，少受某些个股的影响。

改进后该模型源码如下，也可以通过扫描二维码获得：





4.4 技术指标测试平台


1.技术指标分析法的重要价值

技术指标分析法（Technical Indicator）是证券投资中一种重要的操作方法，从传统交易方法来看，这是技术分析法的一个重要分支，但是学习量化的投资者要意识到，这些技术指标本质上都是量价关系的数学表达，只不过公式不同，侧重点不同。技术分析法的重要理论奠基——道氏理论（Dow Theory）自20世纪初提出至今，已经走过了一百多年，这种分析方法认为市场行为包容消化一切，能走到今天而依然被大部分交易者认同，一定有它充分道理和坚实基础。如图4-9所示。

图4-9 诞生100多年的道氏理论对于趋势的分类



“市场行为包容消化一切”的含义是：所有的基础事件、经济事件、社会事件、战争、自然灾害等作用于市场的因素都会反映到价格和成交量变化中来。所以我们看到无论是MA价格均线值还是VMACD成交量指标等一系列技术指标，都离不开量价关系。这种分析法不建议再针对基本面做任何建模，更不用采集舆情信息，因为除了量化分析之外的工作都被认为是无效的。我个人也是逐步了解和使用技术指标的，在市场上进行投资实践，并以此方式发现了量化投资的特点，后来确认了量化投资的优势。

很多成熟的量化投资者和模型开发者，以及行业更广大的从业人员，最初也是被这些指标深深吸引进入该行业的，所以本节提供一个模板，用于测试大部分常见的技术指标，并给出一些统一的验证思路。

在代码头部有这样一行：import talib，这里调用了TA-Lib库，它被称作技术分析库，是一种广泛用在程序化交易中进行金融市场数据技术分析的函数库。它提供了多种技术分析的函数，方便我们进行量化投资中的编程工作。建议大家阅读使用官网说明文件，网址是http://www.ta-lib.org/。如图4-10所示。

TA-Lib主要函数库分为以下几类。

（1）均线类：指数移动平均线EXPMA、三角形加权移动平均线TMA、考夫曼自适应移动平均线AMA等。

图4-10 TA-Lib官方网站技术分析库



（2）动量反转指标：它们并不叠加在K线走势上，而是将量价关系变成一个区间的数值，或者方便用某阈值衡量的数值，这类指标包括大家熟悉的MACD、MTM、ROC、RSI等。

（3）统计函数：这类函数不是技术指标，而是较为有效的统计工具，不能直接构成交易信号，但是可以指导交易行为，或者构成有效的因子值，如线性回归、Beta、相关系数等。

TA-Lib的调用方法很简单，本书已经将常用指标值写入模型并计算出来，语法如下。

# 循环股票列表，计算指标值

for stock in sample:

# 获取第stock只股票的历史数据

# 这里要注意语法问题，涉及取多列数据，要加入['close','high','low']

close_data　　=　　 attribute_history（stock,　　 60,　　 '1d',['close','high','low','volume']）

close_data.fillna（0,inplace=True）

# 导入收盘价和参数fastperiod=12,slowperiod=26,signalperiod=9，计算出macd,macdsignal,macdhist

# 因为默认返回pandas.DataFrame，所以表示每一列，要加入[列名].values

macd_DIF,　　　　　　macd_DEA,　　　　　　macd_macd　　　　　　=talib.MACD（close_data['close'].values,　　 fastperiod=12,　　 slowperiod=26,signalperiod=9）

这样几行代码，就完成了对于TA-Lib一个函数的调用。刚才MACD这个案例，实现了对DIF、EDA、MACD柱三个变量的计算。

关键之处在于交易规则部分，我们可以用金叉、死叉方法买入，因为很多知名的技术指标都支持这种长短期指标值交叉的方法。但是为了得到指标值对于股票涨跌力度的解释，我更倾向于得到指标值之后，直接以此对股票进行排序（升序或者降序），然后买卖股票。指标买入逻辑代码如下。

#=====================指标买入逻辑=====================

# MACD买入逻辑

# if（macd_macd[-2]> 0 and macd_macd[-1]< 0）: # 动量

# if（macd_macd[-2]> 0 and macd_macd[-1]< 0）: # 反转

# 如果按照金叉、死叉交易，要启用上述if条件，注意代码缩进

# optional_list.append（stock）

# 如果启用指标值排序交易，不需要启用上述if条件

optional_list.append（（stock,RSI_line[-1]））

# 以指标值强度做【升序排名】，指标值小排名靠前，优先买入（反转模式）

# optional_list.sort（key=lambda l: l[1],reverse=False）

# 以指标值强度做【降序排名】，指标值大排名靠前，优先买入（动量模式）

optional_list.sort（key=lambda l: l[1],reverse=True）

# 转化成np.array结构，方便取出第一列数据（股票代码），然后再转回list

optional_list=np.array（optional_list）

optional_list=optional_list[:,0].tolist（）

# 限定买入名单数量

optional_list=optional_list[:g.buyStockCount]

# 执行买入函数

buy_Stocks（optional_list,context）

针对指标值买入方法，在设定固定调仓周期后，我们会对股票池内的个股进行打分筛选，定期地寻找符合指标值条件的股票更新持仓池 optional_list=optional_list[:g.buyStockCount]。这种方式改善了死板的金叉、死叉模式，更为科学地以日截面为衡量标准，体现指标值优势和劣势。此方式测试技术指标在A股的表现可能更为清晰，结果更接近真实情况。

本书将两种交易规则代码都呈现出来，读者可以按需注释相关代码，使用自己熟悉的规则，或者创建全新的规则（特别是多指标值组合）进行测试。

2.部分技术指标使用方法说明

MACD是利用收盘价的短期（常用为12日）指数移动平均线与长期（常用为26日）指数移动平均线之间的聚合与分离状况，对买进、卖出时机做出研判的技术指标。其买卖原则为DIF、DEA均为正，DIF向上突破DEA。我们建议读者按照金叉方式买入，或者按照死叉方式反转买入，因为该指标没有去掉价格量纲，所以不同股票指标值不同，无法对比。

布林带（Bollinger Band）利用“股价通道”来显示股价的各种价位，当股价波动很小（标准差也会降低），处于盘整时，股价通道就会变窄，这可能预示着股价的波动处于暂时的平静期；当股价波动超出狭窄的股价通道的上轨时，预示着股价异常激烈的向上波动即将开始（或者波动已经释放，要收缩）；当股价波动超出狭窄的股价通道的下轨时，则预示着股价异常激烈的向下波动将开始（或者下波动已经结束，要反弹）。读者可以按照突破上轨的方式买入，也可以按照突破下轨的买入，但是不同规则对应的止损点显然是不一样的。

RSI的原理简单来说是以数字计算的方法求出买卖双方的力量对比，绝大多数时间里RSI值介入在30～70之间。RSI强弱指标理论认为应该进行反转逆势交易，该指标最初被提出时就是这样设计的，RSI值多在30～70之间变动，通常在值为80以上时被认为市场已到达超买状态，至此市场价格自然会回落调整。当RSI值跌至30以下时，即被认为是超卖状态，市价将出现反弹回升。我们建议读者按照反转方式买入，买入RSI值向下突破的股票，其效果可能比向上突破的绩效更好。如图4-11所示。

CCI属于超买、超卖类指标中较特殊的一种。常见的方法是设置一个相对的技术参照区域：+100和-100。按照指标分析的常用思路，CCI指标的运行区间也分为三类：+100以上为超买区，-100以下为超卖区，+100到-100之间为震荡区。我们在之前的章节中已经介绍了CCI系统在商品期货市场的应用，它在期货中用于捕捉动量，而非反转。如图4-12所示。

图4-11 RSI指标动量测试结果，沪深300股票池，5日调仓



图4-12 CCI指标动量测试结果，沪深300股票池，5日调仓



MTM指标全称是“Momentum Index（股价动量线）”，是一种专门研究股价波动的中短期技术分析工具，公式简单清晰：close-close[timeperiod]，含义是：收盘价与N日前收盘价的差。股价的动量线是通过每个交易日动量点的连线，股价在波动中的变化可以通过动量线反映出来。为了使动量指标更直观并降低噪声，偶尔辅助以另外一条线——MTMMA，即MTM的移动平均线。可以将MTM和MTMMA形成交叉关系来买卖股票。

KDJ随机指标通过在特定的周期（常为9日）内出现过的最高价、最低价及最后一个计算周期的收盘价及这三者之间的比例关系，来计算最后一个计算周期的归一化到一个区间内的随机值RSV，然后根据平滑移动平均线的方法来计算K值、D值与J值，并绘成曲线图来研判股票走势。交易方法可以用KD金叉、死叉，也可以用KD位置区间，或者用J值位置区间。一般倾向于将KDJ用作一个超买、超卖类指标，也就是进行反转交易。

CMO钱德动量摆动指标（Chande Momentum Osciliator）在技术指标体系中有一定价值，它通过归一化计算，把超买水平定量在+50以上，把超卖水平定量在-50以下，建议读者也这样设定交易规则。CMO=（Su-Sd）×100/（Su+Sd）,Su是今日收盘价与昨日收盘价（上涨日）的差值加总。若当日下跌，则增加值为0;Sd是今日收盘价与做日收盘价（下跌日）差值的绝对值加总。若当日上涨，则增加值为0。

OBV指标核心工作是分类计算累积成交量，通过累计每日的需求量和供给量并予以数字化，其计算公式为：当日OBV=前一日OBV＋今日成交量。如果当日收盘价高于前日收盘价取正值，反之取负值，平盘取零。OBV把股价上升时的成交量视为人气积聚，做相应的加法处理，而把股价下跌日的成交量视为人气离散，并做减法运算。这个指标不容易直接订立交易规则，但是如果与价格进行线性回归，那么出现斜率大于0则说明量价同步，或许可以作为交易规则使用。

CORREL是皮尔逊相关系数，它度量两个变量之间的相关程度，其值介于-1与1之间。数学意义定义为两个变量之间的协方差和标准差的商。比如我们可以寻找单只股票的量价相关性，也可以寻找多只股票之间的相关性，以及多个板块之间的相关性。皮尔逊相关系数的值为-1意味着X和Y可以很好地由直线方程来描述，所有的数据点都很好地落在一条直线上，如果是1意味着且Y随着X增加而减少，呈现完全的负相关，也是非常好的一种数据关系体现。如果值=0，则意味着两个变量之间没有线性关系。我们在取值的时候，CORR=talib.CORREL（close_data['close'].values,close_data['volume'].values,timeperiod=20）就是为了体现20周期的量价关系回归，看是否得到大于0的正相关性。

LINEARREG_SLOPE是线性回归斜率，它确定两种或两种以上变量之间相互依赖的定量关系，一般来说，线性回归都可以通过最小二乘法求出其方程，可以计算出对于y=b×x+a的直线。这里的a是拟合直线的斜率，b是截距。还有一个残差扰动项，在公式里没有体现，残差值=实际值-回归值。我们通过下面的代码引用该函数：price_SLOPE=talib.LINEARREG_SLOPE（close_data['close'].values,timeperiod=20），重点分析价格和时间回归，得到20周期内的主趋势是上升的还是下降的。

TA-Lib库还包括时间序列预测、三角函数、希尔伯特变换等函数可以直接调用，统计类函数和数学计算才是该库的应用重点，技术指标只是一个开始。

3.量价分析存在极大的可挖掘空间

总体来说，虽然量价分析存在局限，很多指标存在高度同质化的问题，且部分指标除了在可视化方面有一定优势外还经不住模型回测，使用指标交易在A股市场的效果较差，指标必须和止损、大盘判断、个股特指等因子完整地结合，才能具备一定的生命力。但是回头看我们走过的研究路线（在我看来从技术指标开始是必然环节）以及技术指标量价研究的公平性（所有交易者面对的数据完全一致，指标公式透明且结果唯一），这条道路值得继续探究。

2015 年年底著名的量化研究投资机构 World Quant 发表了论文 101 Formulaic Alpha，论文中给出了研究人员挖掘的101个带有公式的因子，意外的是这些全部都是量价因子，而不是复杂的自然语言处理，也不是和经济学意义紧密挂钩的基本面分析。

我们可能认为这样的一个因子并不具有足够的说服力，但是它能够对股票进行符合某一项特征的打分，当101个因子从各个角度提取各项股价变动的特征值，对每一只个股进行打分时，再结合多因子模型给予每个因子线性或非线性的不同权重，选股效果就会呈现叠加。由于在每个日频截面上影响股价的因子权重不同，所以多因子叠加一定会增强夏普比率，降低回撤。

本节代码如下，也可以通过扫描二维码获得。





4.5 动量效应和反转效应


动量效应是指股票的收益率有延续原来的运动方向的趋势。即在过去一段时间内收益率较高的股票，在未来获得的收益率仍会较高。而反转效应与此是相反的，它表示在过去一段时间内收益率较高的股票，接下来收益率会降低，所以我们应该寻找在过去一段时间收益率较低的股票买入。

判定使用动量效应或反转效应谁更能赚钱，可以看作是一个研究者是否做量化研究，以及是否研究出一些基本结论的分水岭，也是在投资业界（特指主观投资的高手们）和量化学界（模型开发工程师）争论得最激烈的话题，因为靠强势股赚钱是投资高手深信不疑的，而量化分析经常得到相反的结论。

1.动量形成原因初探

动量效应在股票市场上有很长的历史，并且普遍存在于世界各地的股票市场上，甚至一些研究发现动量效应也存在于其他类型的交易市场上（期货、外汇、数字货币等），因此越来越多的学者开始探寻动量效应的成因以及它是否有违有效市场假说。在我们的分析中发现，在市场形成的早期阶段，动量效应明显较强，或者在投资者的预期形成一致的过程中，动量效应会因为新的投资者的加入，而价格运行方向不变，动量效应继续加强。

在较为成熟的市场上，反转效应较强，或者说换手率过高的、投资标的选择自由的市场（特别是A股市场），反转效应显得更有优势。因为股票模型不像期货、外汇等针对单一时间序列的模型，股票模型大部分都是建立一个评价标准，然后横向扫描全市场股票，这类模型可以通过调仓换股得到更高的收益。动量过高的股票下阶段，即面临动量衰减，而动量较低的股票下阶段大概率会赢得动量回升。

我们还可以套用平衡状态来解释动量效应与反转效应：理学中定义了三种平衡状态，即稳定平衡、非稳定平衡和随遇平衡。

对于处于稳定平衡的物体，稍微偏离当前稳定状态，就会恢复稳定平衡；而对于非稳定平衡，当物体稍微偏离稳定状态时，会出现相互作用使其进一步偏离之前的平衡，进入非平衡状态。

对于资产价格来说，也存在类似的效应。当资产价格严重偏离其价值时，也会进入非稳定平衡状态或者直接进入非平衡状态。

中国股市的动量策略利润，只存在于形成期和持有期在4周以内的周期策略中，是非常稀少的；而西方国家股市的动量策略利润一般存在于形成期和持有期（3～12个月）的策略中。

在通过代码进行实证之前，我本人希望动量效应是显著存在的，因为一旦存在可观测的动量，自然可以更简单地用模型捕捉，以此完成买入和卖出。我们需要想想为什么动量能够存在，又是存在到什么程度，我们可以在动量被观测到之后入场，并在稳妥的点位出场获利。

从影响股票价格的因素考虑，超额回报背后必定有超额信息，信息的传播是驱动股票价格运动的首要因素。而在信息传播过程中，最显著的特征是信息不对称。对信息不对称这一问题的研究，着重于研究市场中的人因获得信息渠道之不同、信息量的多寡不同而承担不同的风险和收益。拥有对于上市公司的不同信息量，决定了部分投资者可以先做出买入或卖出决策，这可能会微弱地影响股价；随着利好或者利空信息的传播，逐步会引来更多人做出和最初得到信息的人一致的操作，此时主动买入/卖出造成盘面筹码不足，价格被抬高或者被降低，我们认为动量在信息传播过程中出现，并由于信息不对称逐渐出现，而不是爆发性出现。如图4-13所示。

实践告诉我们，虽然市场存在信息不对称，但是信息传导的速度过快，经常导致套利空间被压缩，也就是价格在快速向某个方向运行后，又多会反向运行，难以继续支撑原有方向，在动量能够被观测到的时候，已经变成了反转。

图4-13 以微博为例，信息源传播路径和信息获取者渠道不同，导致信息传播不对称



大部分A股投资者不关心公司的基本面，其核心原因是A股定价和基本面关系较弱，而和资金推动力关系较强，且行业未形成垄断格局。这样我们不用始终将资金集中在已经上涨的高动量股票上，而是在同行业、同概念板块中寻找滞涨股，反而能够获得类似收益，此时先涨的股票被资金抛弃，资金涌入类似的“短期估值洼地”，造成了实际观测到的动量缺失，而低动量股票在第二次观测时启动。

当然我们的资金敢于这样操作的核心原因是价值投资风气尚未形成，概念容易制造、容易快速切换炒作，但是价值投资需要对少数行业龙头股票长期追踪甚至持有，此时市场才能切换到动量效应的控制下。

动量效应存在的空间较为有限，要么是在市场极不理性时，动量显著，千股齐涨或齐跌；要么是在市场非常成熟、价值投资确立地位时，通过炒作和切换无法获得有效的资金跟随，所以投资者不得不持有质地较好的股票获得收益，大部分股票呈现负动量，少部分股票呈现正动量，且它们都原意维持现有方向继续运行。

而在市场大部分正常运转时间，反转效应成立，且该效应促进了市场活跃，促进了二级市场的交投竞争激烈，要想获得更多收益，就必须在不同股票上轮动持有，获取下一个“短期估值洼地”带来的红利。

2.动量计算和初步测试

接下里我们用一段程序讲解如何获得全市场个股动量，并设置形成期和持有期，通过回测绩效验证我们的结论。我们使用简单的动量构造方式，即全市场A股本周期除以上周期，作为动量的表达因子。如图4-14所示。

# 通过循环，逐一求出个股的动量（本周期除以上周期），形成一个momentum列表

stock_momentum=[]

momentum=[]

for security in stocks_to_buy:

interval,Yesterday=getStockPrice（security,g.lag）

stock_momentum=Yesterday /interval

momentum.append（（security,stock_momentum））

#momentum.sort（key=lambda l: l[1]）　　　　　 # 升序（反转模式）

momentum.sort（key=lambda l: l[1],reverse=True）# 降序（动量模式）

# 转化成np.array结构，方便取出第一列数据（股票代码）

np_momentuma=np.array（momentum）

stocks_to_buy=np_momentuma[:,0]

# 取出前stocksnum个股票买入

stocks_to_buy=stocks_to_buy[:g.stocksnum]

测试结果证明，在两个动量形成周期和持有周期的组合中，反转效应都获得了正收益，且收益远高于动量效应。动量调仓换股除了在牛市期间能够取得一定收益外，在震荡市期间亏损严重。而反转表现优秀，特别是在熊市期间，反转效应能够有效对抗震荡市。

实际上在全世界各国动量与反转效应都存在不同结论，但是更多周期组合测试显示反转呈主流，这可能是股票受到其上市公司长期业绩影响比较显著，价格围绕价值循环运动，且股票无杠杆，所以很多持有者可以长时间持有而不惧极端亏损风险。

图4-14 两组不同的动量生成期、持有期，得到的动量和反转模式资金曲线



3.剥离Beta风险（中性化后）动量策略与应用

需要提醒大家，本书中描述的传统的动量反转策略是直接基于总收益率计算动量的，并不需要求残差。还有一种基于残差分析的动量反转策略，利用多个风控因子做多元回归后的标准化残差收益率来计算动量，这种模型认为动量是一种Alpha收益，挑选出的股票组合风险暴露较小，更有利于考察动量和反转效应，该策略被称为Alpha动量策略。该策略首先要过滤掉Beta因子，因为Beta因子只能放大股票波动率，带来系统性风险，过滤它之后，要找到有效的Alpha因子。这种方式是对动量因子的一次提纯，类似的方法还有剥离市值风险、剥离行业风险等。

该策略使用收益率数据和风险因子数据做截面回归，用动量序列作为被解释变量（回归函数的应变量Y），风险因子作为解释变量（输入回归函数的自变量X）。该模型回归出的残差是和风险因子无关的动量收益，也被称为“风险矫正收益”，这一过程实际上是对动量因子进行了Beta中性化处理。

在实际操作中，将30日的风险矫正动量收益加总生成动量指标，每个调仓周期对个股进行排名，以升序排列，排名靠前的10%因子值较高的股票做多，排名靠后的10%做空。

策略认为只有在去除风控因子风险暴露之后的残差收益（Beta中性化后的动量），才能真正反应股票的公司特有收益水平。

反转策略除了能带来比动量策略更高的收益之外，还能和动量一起决策判断目前的大盘情况。

该模型在返回股票名单时结合了一些小市值因子特征，而且并不作为交易模型，而是作为对市场特征的探索模型提供给读者们，通过 momentum.sort排序方式切换动量策略和反转策略，更多动量形成期和持有期特征可以通过全局参数g.lag和g.period调整，源码如下（需要在分钟线回测），也可以通过扫描二维码获得：





4.6 换手率和资金流模型，主力和筹码盘根错节


筹码一直都是资本市场津津乐道的话题。我们如何能从交易对手手中获得尽可能多的相对低价格的筹码，市场大部分交易者在哪些位置、在哪些时间进行了大比例筹码交换，主力资金是否优先于散户资金进行大比例买入/卖出，筹码的聚集度呈现集中还是分散，这些现象产生的后续变化都是股票模型的研究重点。

这里有几个概念需要预先明确，我们常说的筹码分布，学术名称是“流通股票持仓成本分布”，其原理来源于在不同价格区间的成交量，以及在不同价格最终所形成的分布情况，用于股票在反映不同价位上的整体持仓数量。筹码从集中到发散，再从发散到集中，这就是股价波动的必然循环，筹码作为交易标的供需决定了股票价格波动，筹码的背后是心理战。无论流通筹码在盘中如何分布，累计量必然都等于总流通盘，变的是持有筹码的人数。

1.筹码数据的可视化预览

为了预览筹码概况，我们做一些数据可视化分析。全市场不同个股的股东数量是不同的，该字段信息可以在国泰安提供的数据中得到，调取函数是在模型头部加载from jqdata import gta，函数名为gta.run_query（query_object）。如图4-15所示，代码如下。

# 加载gta数据

from jqdata import gta

# 返回所有股票STK_HOLDER_NUMBER（公司股东户数（季））表格，最多1000个

df=gta.run_query（query（

gta.STK_HOLDER_NUMBER

）.limit（1000））

df_SHAREHOLDERS=df['SHAREHOLDERS']

df_SHAREHOLDERS

运行后可以看到SHAREHOLDERS表格详细情况。

# 然后观察其股东数量分布

num_list=df_SHAREHOLDERS

plt.title（'SHAREHOLDERS'）

plt.bar（range（len（num_list））,num_list）

plt.show（）

有兴趣的读者还可以计算“户均持股额”，用总市值除以持股户数可以得此数据，这也是筹码分布的重要表现方式。如图4-16所示。

在行业内有这样一个说法：对筹码分布的判断是进行股市操作的基本前提，如果判断准确，则离成功就不远了。传统的“半量化”存在较多的主观成分，但是也得到了大致的结论：筹码研究能有效地判断股票的行情性质和行情趋势，能有效地识别庄家建仓和派发的全过程，甚至能够看到筹码堆积价格区域，作为关键的支撑位和阻力位。筹码研究对于做量化的研究者也有很大启示，不论传统观点正确与否，如果你错过了这一话题，都将会失去很多研究因子，这样看来我们有必要对以下几个问题进行考虑。

图4-15 随机选择1000只股票股东数量分布情况



图4-16 某时间截面上，A股所有个股户均持股数量



（1）换手率对于股票价格的影响。换手率能否对股票进行强弱区分，以及高换手率是否意味着充分洗牌（筹码交换），为接下来的股价上升打开空间？

（2）主力净占比能否有效提升股票的筹码质量？因为主力资金有着比散户资金更加集中的目的性和意志，能够长期忍受较大回撤来战略性建仓某些股票，以换取之后的巨大涨幅，所以主力净占比是不是一个有效的因子？

（3）筹码分散度大致可以通过“自由流通市值”除以“股东总数”计算得到（得到户均持股市值），这个值涉及股票之间的价格量纲还没有去除，不好横向截面对比，能否对这个变量做窗口期内动量计算，以实现对于筹码趋向于分散还是集中的判断？

这就衍生出本节要介绍的两个筹码相关模型：

（1）换手率模型，我们假设高换手率代表活跃的强势股，后续有超额回报。

（2）主力占比模型，我们假设主力占比高代表个股受到大资金重视，后续有超额回报。

2.换手率模型

换手率在聚宽API因子库中，名称是turnover_ratio，它指在一定时间内市场中股票转手买卖的频率，是反映股票流通性强弱的指标之一。它的含义是[指定交易日成交量（手）×100/截至该日股票的自由流通股本（股）]×100%。需要注意的是这是一个点数据，也就是当日的换手率数据，如果我们要进行分析需要对它做处理，因为当日换手率的隔日变化率较大，我们的模型有固定间隔的调仓周期，刚好调整到该周期可能取到并不是很活跃的股票。外换手率的标准差也需要加入研究，以辅助均值一起观察该因子的影响力。如图4-17所示。

我们用这段程序完成了对于换手率高和换手率低的股票的筛选，为了防止单点换手率数据的不稳定性，我们对该值做了20日移动平均处理。模型和之前的逻辑类似，有一个简单的定期调仓逻辑，来取得买卖信号，得到出乎意料的结果。最小换手率组获得78%总收益，虽然跑赢指数，但看起来并不是一个理想值。最大换手率组则得到-86%总收益，全过程大幅度跑输指数。

几乎可以说，高换手率买到了每个时间点最差的股票，因为高换手往往表现在股票的大幅度拉升期间，而不在底部平稳期间，A股的个股波动率总是循着一个“波动→平稳→再波动”的过程发展，股价跟随着出现“上涨→调整→再上涨”过程，高换手率选到的股票都是高波动期间的，接下来大概率会进入低波动区间（股价调整）。

图4-17 高换手组（上图）和低换手组（下图）测试结果



低动量是一个较好的过滤方式，我们将使用换手率选到的股票数量调整到40只，然后从其中购买低动量和高动量的两组股票观察收益情况，

在具体下单买卖的时候，维持账户内有20只股票，结论基本稳定不变：低动量个股超越了高动量个股，虽然领先幅度不多，但是低动量也超越了原始的不加动量过滤的模式。

我们构造了一种新的逻辑，两个因子值对应相乘（换手率因子和动量因子），然后用创造出的这个新因子去给股票打分排名，具体代码如下。





这段代码的倒数第2、3、4行被注释掉，暂时保留倒数第5行，两因子对应元素相乘：（old_value[i]*momentum_values[i]），然后添加到new_valve这个list中，其含义是将换手率因子值通过动量因子做一次线性放大，构成新因子。如果某只股票在某天换手率正常，但是动量较高，则该股票将获得本项较高得分，按照升序排名，它将被排在靠后位置而没有机会被买入。如图4-18所示。

图4-18 对因子融合改造的绩效（以（math.sqrt（old_value[i]）*np.square（momentum_values[i]））为绩效示意）



倒数第4行new_valve.append（old_value[i]*math.sqrt（momentum_values[i]）），加强了old_value（换手率因子）权重。

倒数第3行new_valve.append（math.sqrt（old_value[i]）*momentum_values[i]），加强了momentum_values（动量因子）权重。

倒数第2行 new_valve.append（math.sqrt（old_value[i]）* np.square（momentum_values[i]）），通过平方计算加强了 momentum_values[i]（动量因子）权重，降低了old_value（换手率因子）权重，从测试看，取得了最好成绩，阶段内收益率达到143.86%，夏普比率为0.32。而在进行因子组合之前，最小换手率作为一个较好的选股因子，只有78.51%收益率和0.15夏普比率。

该模型源码如下，同上一节所讲的动量反转模型一样，它不能用来直接交易，而是用作特征（因子）研究模型，也可以通过扫描二维码获得：





3.主力和散户资金占比模型

主力占比严格意义上讲属于资金流分析模型，需要分析盘面上的下单数据。需要明确我们取到的因子含义：主力净占比=主力净额÷成交额，主力净额=超大单净额+大单净额。在聚宽平台上，超大单是大于等于50万股或者100万元的成交单，大单是大于等于10万股或20万元且小于50万股或者100万元的成交单。所以主力净额是市场中较大规模的投资者下单时留下的踪迹，虽然目前有很多拆单工具，但是依然有很多投资者，特别是机构投资者和大户游资直接下较大头寸的交易单。如图4-19所示。

图4-19 每一只股票都可以通过软件和网站查询到资金流数据



我们假设net_pct_main主力净占比因子是主力开始建仓的表现，是一个正向因子，应该以因子值降序排名ascending=False，买入因子值较大的股票。

和主力相对应的就是小单，我们假设小单流入多的股票是散户行为驱动的，而流入意味着追涨，且假设该行为的因子（net_pct_s小单净占比）意味着股票上涨已经十分显著，升势到了尾声，所以这是个反向因子，应该以因子值升序排名 ascending=True，买入因子值较小的股票。小单净占比=小单净额÷成交额，小单被定义为小于2万股或者4万元的成交单。

取资金流数据接口代码如下：



当日资金流和换手率同样存在数据噪声的问题，可以通过平均值降噪，获取到阶段内主力净占比等数据。当然如果你要做很高频的每日调仓交易模型，且资金流又是因子之一，那就需要直接引用当日数据，不要再处理为均值数据，甚至要引用到更高频率的分钟线资金流数据。本例我们使用 jqdata.get_money_flow 函数，调取net_pct_main主力净占比（%）和net_pct_s小单净占比（%）字段数据，分析最近20日内的资金流动数据，然后进行日截面排名分析，试图寻找到对于股价有显著影响力的因子。

如图4-20所示，从第一个结果来看，主力的行踪是非常难以追踪的，对net_pct_main 主力净占比的分析几乎没有超额收益，而且当我们用升序排列，找到主力介入最少的股票时，也没有看到显著的性能反转，说明这个数据对于市场的区分能力较弱。这充分说明“主力有能力并且也有意图隐藏自己的踪迹”，这一隐藏方式主要是通过拆分大单为小单下单买入实现的。

图4-20 net_pct_main 主力净占比 ascending=False（高值在前）20日累计流量



转而分析net_pct_s小单净占比，如图4-21所示，总结刚才的教训：主力难以追踪。小单容易追踪，在这里我们看到，如果小单在20日内持续净流入，并且流入速度超过中单、大单和超大单等机构流入，这样的股票一般是没有前途的，有显著负收益。相反，如果对ascending=True的方式进行测试，寻找小单流入占比较低的股票，循环买入，则是有超额收益的，这说明当散户对于一只股票已经无力再流入资金的时候，机构投资者开始收割筹码，或者说开始拉升个股。

图4-21 net_pct_s小单净占比ascending=True（低值在前）20日累计流量



还有一种模型是筹码变动率模型，我们假设筹码集中是主力的吸筹过程，之后即将展开升势，筹码分散是主力在派发筹码，主力撤退即将展开跌势。这种模型需要高频的股东户数变动数据，最好是日频数据。但是目前能找到的数据都集中在季度更新财报时公布的股东户数，所以信息严重迟滞，不利于计算筹码的运动情况。

最后需要提醒大家注意，证券市场规则复杂，交易漏洞和账户开设漏洞较多，监管无法渗透到主力交易者的行为。执法漏洞将会导致模型接受到错误数据而建模不准，或者未来接受到错误实盘数据而发生决策偏差。

此外主力净额受到机构拆单、下单和高净值散户的行为影响，在判断方面也存在不准确性，所以实盘使用类似模型和因子，需要拿到更加精密的数据，或者对数据做精密清洗加工，方可看到市场交易行为驱动价格的踪迹。这也是为什么我们无法通过net_pct_main主力净占比得到有效结论，反而可以通过net_pct_s小单净占比得到有效结论的原因。

该模型代码如下，该模型仅用作特征（因子）研究模型，也可以通过扫描二维码获得：





4.7个股CTA策略尝试


从几年前在阶段性完成对商品期货的模型覆盖后，我们产生一个想法，将开发在CTA领域的模型搬运到股票指数或者个股上交易。我们可以预料，在指数上可以产生较为理想的收益，因为指数噪声低，但在个股上会困难一些，但是又考虑到之前征服了期货时间序列到分钟线级别，所以个股应该也不是问题。团队内也产生一个观点：让精通CTA高杠杆择时的模型开发者去做个股择时，这显然是降维打击。

而困难恰巧在个股上出现了，我们在之前的章节也介绍了个股主要的波动特征是反转大于动量，而期货的波动特征是动量大于反转，所以期货中的动量类模型在个股上表现出强烈的不适应，也只有到了股票指数层面，动量交易系统才有一定表现。所以我们当初显然乐观估计了难度，以为期货交易系统可以通用，实际上很难。读者们也可以使用常用的均线系统在股票市场，测试它是否能跑赢个股，或者跑输静态持有个股的收益，但是要至少带来更高的夏普比率（意味着更低回撤），这个绩效才说得过去。

1.个股CTA策略

个股CTA策略有两种主要思路：一种是直接将模型加载到个股时间序列上，不考虑横截面选股因子的影响，将个股看作是商品期货品种进行做多交易。另一种是将择时模型加载到股票模型上，产生信号，然后将信号映射到个股上产生交易，以此获得强于指数择时的收益。

方法1：个股时间序列直接择时

第一种思路较为简单，在检测了几个商品期货模型后，我们选择了其中一个容易理解，且降噪能力较长的中长线模型，AMA自适应移动平均线交易系统，搭配标准差过滤器和ATR追踪止损，在个股上展开测试。考虑到时间因素，我们没有测试全市场股票，而是测试了50只随机选择的样本股，它们有50%来自上证50指数，50%来自中证500指数，含创业板股票，不含 ST股，我们试图构造一个普适性较强的测试样本集合。

为了让模型尽可能稳健，不要产生对少数股票的拟合，我们将模型做如下简化：

（1）所有个股统一参数，不为某些个股优化参数。

（2）合并EffRatioLength效率系数周期参数和FilterLength过滤器周期参数。

（3）删除硬止损，所有止损均从一个最高点回落到当前位置。

（4）使用类似海龟交易系统中的头寸控制，让ATR决定当前买卖股票数，降低风险。

为了避免春节持仓风险，依然在关键时间点做了平仓，并在节后重新恢复开仓，且模型中依然针对止损后的高位重入问题，保留了防重入过滤器。

模型中几个关键模块用交易开拓者撰写如下：

//ATR计算和头寸分配

ATR=Average（TrueRange,ATRlength）;

TotalEquity=Portfolio_UsedMargin（）+Portfolio_CurrentCapital（）;

lots=TotalEquity*0.01/（ATR[1]* ContractUnit（）*BigPointValue（））;

//引用系统函数计算AMA

AMAValue　　=　　 AdaptiveMovAvg（close[1],EffRatioLength,FastAvgLength,SlowAvgLength）;

PlotNumeric（"AMAValue",AMAValue,0,yellow）;

//标准差过滤器

filter=StandardDev（AMAValue,EffRatioLength ,1）*FilterSet2;

//开平仓条件

if（（AMAValue-AMAValue[1]）>=filter）　　//AMA减去上周期AMA，和过滤器做比较

LongEntryCon=true;　　　　　　　　//大于过滤器，做多

if（（AMAValue[1]-AMAValue）>=filter）　 //相反情况下平仓卖出

ShortEntryCon=true;

由于使用了ATR风险和资金量对等，比如TotalEquity*0.01/ATR[1]，实质含义是用每1%的资金量，和ATR负相关计算一个开仓头寸，严格限制住我们能够承受的损失量，以此方式虽然不能满仓使用资金，但是带来了较为显著的收益风险比增长，回撤自然也大幅度下降。

AMA模型是一个动量模型，是目前能够在股票个股择时方面还有一定效果的动量模型，其他大部分模型的绩效都难以说服我们使用它，甚至不想再对其做任何迭代，但是AMA生命力较为长久，通过两处自适应设计（均线周期和过滤器）实现了较好的噪声过滤。从2010年1月1日开始，在千分之2的双边交易手续费下，经过1944天时间，模型取得了超越1的夏普比率（1.0143）和0.59的收益风险比，净利润1636201元，最大回撤34万元，最大资金使用量在300万元之内（实盘可随投入资金进一步控制）。

静态持有这50只股票的收益如何？按照和模型交易类似的最大使用资金量限制（400万元以内），我们不得不设置了2万元的单个股票初始买入量，50只股票最初使用100万元，到后期使用资金略微超过300万元（这个时刻发生在2015年5～6月“股灾”之前），这样同标准比较才有意义，毕竟最大资金使用量代表了最大承受的风险价值。

通过如图4-22所示的资金曲线可以看到，同样在最大消耗不超过400万元的情况下，显然持有个股的风险太大，虽然产生了1892917元收益，但是收益风险比仅有0.11，夏普比率0.3769，回撤值超过218万元，资产回撤比率超过50%。

图4-22 静态持有个股和AMA择时绩效（按最大资金消耗400万元）



该模型达到了我们初期的预估：净利润无法超越静态持有，但是回撤得到有效控制。事实上在实盘交易中，影响我们决策的往往不是净利润的收益率情况，而是回撤率，当达到一定回撤时，我们都会做出有损于模型一致性的决策，当我们不幸在高位入场时，情况变得更糟。而一个低回撤的模型在这方面有绝对优势，这也是主动管理基金的优势所在。

随后我们将一些简单类型的模型搬运到股票市场上，对个股直接择时，依然使用完全统一的参数，暂时尚未找到绩效超越AMA的动量模型。这初步验证了AMA模型在股票市场的有效性。

这套模型后期的迭代空间在于如下几个方面。

（1）ER效率系数的周期参数EffRatioLength，尝试按照成交量走完一定时间的成交量所用时间来做自适应。这种方式从另一个角度接近了构造等量K线的目标，一定程度上有助于系统性能的发挥，也可以应对不同个股的特征。

（2）上证50和中证500类个股，到底哪些股票更适合与AMA类似的动量系统直接择时完成收益增强，需要进一步分析。如果我们找到特征，比如低估值、低市净率的股票表现更好，则应该在这些股票上进行择时收益增强。通过此方式，模型将拥有两层逻辑：以月度（或其他低频周期）为调仓依据的基本面过滤逻辑和以日频为择时依据的交易逻辑。

方法2：指数择时映射到个股交易

在本书中ETF动量模型部分，我们谈到过为什么将模型加载到ETF上运行，而不是加载在个股上。这里在前文内容的基础上，再扩展一种收益增强的方法——在指数上完成信号生成后，将交易单统一下在个股上成交，以观察绩效。

初期产生这个思路，也是通过观察不同股票的Beta值，我们想通过持有个股来放大指数的Beta，获取更多收益。我们需要寻找和指数有较高相关性的个股，这样将指数信号映射过去才能准确，如果交易的都是能走出“独立行情”的个股，情况也不会很好，绩效会偏低。

进一步设想可能发生的异常情况：一些个股虽然具备较高的指数相关性，但是突然短期出现剧烈下跌，此时我们需要对个股进行单独止损，防止亏损无限制放大。所以需要一套针对个股的单独止损模块。

2.RSRS指数择时方法

在该模型的实践过程中，我们挑选了指数择时能力较强的 RSRS（阻力支撑相对强度，全称是ResistanceSupport Relative Strength）指标，光大证券最早提出这一择时方法，并认为阻力和支撑位是变化（动态）的，而不是固定的。首先支撑和阻力有强度，如果强度太弱则极易发生变化，带来择时系统的不稳定。如果交易者预期一致性强，则阻力支撑位有效性也相对强。

其次阻力和支撑位之间也有你强我弱的关系，如果阻力位强于支撑位，则市场倾向于下跌，如果支撑位强于阻力位，则市场倾向于上涨。在震荡时期，阻力和支撑体现不出显著强弱关系，则采用位置突破的方法，向上突破则做多，向下突破则做空或空仓。

目前量化技术分析方式多是引用到收盘价计算均线、布林带、RSI等指标，偶尔有指标引用到开盘价。这里存在一定程度的信息丢失。光大证券从最高价与最低价的形成机制出发，每日的最高价与最低价就是一种阻力位与支撑位，它是当日全体市场参与者的交易行为所认可的阻力与支撑。当日最高价与最低价能迅速反应近期市场对于阻力位与支撑位态度的性质，是使用最高价与最低价的最重要原因。

但是最高价和最低价包含更多噪声，这也是无法避免的，如果直接使用它们构建相对强弱指标delta（high）/delta（low）容易产生不稳定因素，所以考虑通过最近N个（low,high）数据点来得到信噪比较高的最高价/最低价相对变化程度，即使用线性回归来降低噪声。

线性回归后的Beta值可以理解为斜率，我们再将Beta值做一次Z-score处理，将其规整到一个区间内（0均值），即可构建一个简单的通道规则来进行择时。一般我们设定以下两个参数：

◎ Zscore_beta>g.buy（如设置为0.7）买入（式一）

◎ Zscore_beta<g.sell（如设置为-0.7）卖出（式二）

就这样，一个简单的高低点线性回归强度指标构建完成。具体构建方式如下。

当日斜率指标的计算方式：

（1）取前N日的最高价序列与最低价序列。

（2）将两列数据按式一的模型进行OLS线性回归。

（3）将拟合后的Beta值作为当日RSRS（斜率）指标值。

将斜率Z标准化，取其标准分作为改进后指标值。当日标准分指标的计算方式：

（1）取前M日的斜率序列。

（2）以此样本计算当日斜率的标准分。

经过初步测试我们发现，该指标有以下几个特性：

（1）稳步跑赢其择时的基准指数。

（2）在震荡市期间回撤幅度较小，相对于我们熟知的均线系统表现较好。

（3）对于阶段性牛熊拐点判断及时，在关键“股灾”时刻回撤较小。

（4）交易次数不多，在可控范围内，但在一定程度上有过拟合嫌疑。

RSRS指标存在的N参数、M参数分别默认为18和600，经过券商研报的参数稳健型分析基本在附近区间内表现均可。买入/卖出参数可以对称设置，也可以不对称设置，我们建议对称设置为0.7左右，针对不同标的略微调整。

指数由成分股加权后计算得到，但是在实际操作中，由于部分股票在资金量有限情况下无法拆分太细（买入的股数不准），且个股权重定期调整，所以我们一般等权买入个股。如果直接将指数信号映射到个股交易，我们发现结果并不理想，因为个股中很多股票有独立走势，无法呈现和指数一致的走势，而且此方法无法体现我们通过指数信号准确映射到个股交易，以带来增强收益的初衷。这部分有独立走势的股票难以整体择时，往往会出现指数大涨，股票不涨的情况，最不利的走势是指数择时发出买入信号，而这类个股大幅度下跌，带来择时信号浪费和追踪失败。

仿照银河证券思路，我们加入一个个股和指数相关性分析模块，取一定周期内和指数相关性较高的个股（以20只为标准），作为指数的主要构成部分，将信号映射到这类个股上交易，试图增强收益，并降低买入门槛。

该模块逻辑如下：

# 求阶段性高相关个股

def corr_security（security_list,index,n）:

corr_list=[]

# 获取两个数据：个股序列security_price，指数序列index_price

for i in security_list:

security_price=attribute_history（i,30,'1d',['close']）.close

index_price=attribute_history（index,30,'1d',['close']）.close

corr_prine=pd.Series（security_price）.corr（pd.Series（index_price））

corr_list.append（（i,corr_prine））

# 降序排列

corr_list.sort（key=lambda l: l[1],reverse=True）

# 转化成np.array结构，方便取出第一列数据（股票代码）

np_corr_list=np.array（corr_list）[:,0]

# 取出前stocksnum个股票买入，（买入名单stock_list）的前n名

np_corr_list=list（np_corr_list[:n]）

# print np_corr_list

return np_corr_list

代码security_price=attribute_history（i,30,'1d',['close']）.close部分存在回溯参数30，我们对不同的相关性回溯期做了参数测试（机构推荐的180周期和我们向下测试更短期的相关性30、60周期），初步结果如图4-23所示。

图4-23 不同相关性回溯周期对于性能的影响（±0.8阈值）



结果显示，过长的相关性周期择时效果反而不好，可能由于相关性长期较高，在接下来的窗口期会出现衰退，具体表现是震荡市回撤较大，所以短期相关性高反而更利于股票筛选。

为了进一步增强性能，我们加入了低动量过滤模块，扩大相关性筛选范围为20×2=40只股票，然后选择其中动量最低的20只买入。效果变化如图4-24所示。

图4-24 相关性基础上加入低动量过滤



测试结果显示性能没有上升反而下降。但是这种过滤思路值得继续挖掘，建议可以替换的模块有：小市值过滤、高业绩过滤、低价股过滤、下波动过滤（短期下跌更多的个股）、ATR个股风险仓位变化。但是建议第一级过滤，依然是相关性过滤，因为这是择时信号映射有效性的基本保证。

本节我们提供“方法2：指数择时映射到个股交易”部分的模型源码如下，也可以通过扫描二维码获得：





4.8 高频因子低频交易，“聪明钱”因子模型


经验告诉我们，在较大的时间序列周期运行模型效果更好（实盘衰退较小），模型也更容易开发，这个结论对于股票和期货都适用。如果我们将日频K线称作低频K线，将小于60分钟的K线称作中低频K线，将15分钟，5分钟等周期称作中频，将1分钟及tick周期称作高频，那么模型核心的入场逻辑一定是中低频或低频K线发出的。

或许你可以选择在更小的周期入场出场，但是计算模型的核心出入逻辑时，最好采用信噪比较高的数据。因为频率越低，信号比率越高，频率越高，噪声比率越高。

1.低频交易引用高频因子

但是频率也并非越高越好，因为在高频数据中，还有一些特别的声音。在股票模型中，我们计算某些因子时，会在低频为主的时间序列上，提取一些高频数据，比如提取开盘前30分钟的1分钟线数据，做一些因子值。或者提取一些交易量数据，与价格混合起来得到一些结论。这也是非常可取的，往往在这里能够听到一些不一样的声音。不过核心依然是通过高频数据计算出能够在低频时间序列上使用的因子，本节介绍的“聪明钱”因子模型，就是这样一种因子，这是一种混频模型。

方正金工提出了一个叫作“聪明钱”的因子，该因子试图从更加细致的分钟线数据中，挖掘出一个情绪因子Q，然后将该因子值，用于在股票日线上交易。通过横向评估A股所有股票的情绪因子Q，找到需要买卖的股票。

“聪明钱”的因子是一个典型的“低频交易+高频因子”。因为A股不支持日内T+0交易，所以所有交易必须建立在隔日调仓的基础上，但是这并不意味着我们只能使用日频数据。

该因子基于1分钟线数据计算得到的情绪因子Q，反映了聪明钱参与交易的相对价位。因子Q的值越大，表明聪明钱的交易越倾向于出现在价格较高处，这是逢高出货的表现，反映其悲观态度；因子Q的值越小，则表明聪明钱的交易越多地出现在价格较低处，这是逢低吸筹的表现，反映其乐观情绪。

股票的分钟行情数据，通常包含开盘价、最高价、最低价、收盘价和成交量等信息。我们面临的第一个难题是，在这么多的分钟行情数据中，如何区别哪些分钟属于聪明钱的交易？方正金工采用指标S来衡量每一个分钟交易的“聪明”程度：



其中，Rt 为第t分钟的涨跌幅，Vt 为第t分钟的成交量。指标St 的值越大，则表示该分钟的交易越“聪明”。

借助于指标S，我们可以通过以下方法筛选聪明钱的交易：对于特定股票、特定时段的所有分钟行情数据，将其按照指标S从大到小的顺序进行排序，将成交量累计占比前20%视为聪明钱的交易。为了更加形象地展示这一划分过程，以下给出了简单的示例，代码参考来自：https://uqer.io/community/share/578f04e0228e5b3b9b5f1ab7

# 获取数据，以中国平安（601318）2018年3月23日1分钟线为例

sample_data　　=　　attribute_history（'601318.XSHG',　　30,　　unit='1m',fields=（'close','volume'）,skip_paused=True）

sample_data['return']=sample_data['close'].pct_change（）

sample_data['smartS']　　　　　　　　　　　　　　　　　　　　　　　　　　=np.abs（sample_data['return']）/np.sqrt（sample_data['volume']）*100000

# 计算每分钟成交量的聪明度 S 指标值

sample_data['volume']=sample_data['volume']/10000.0

# 成交量除以10000，方便画图

sample_data['barNo']=np.arange（1,len（sample_data）+1）

# 分钟线序号

sample_data.index=np.arange（len（sample_data））

fig=plt.figure（figsize=（14,10））

ax1=fig.add_subplot（211）

ax1.bar（sample_data.index,sample_data.volume,align='center',width=0.4）

ax2=ax1.twinx（）

ax2.plot（sample_data.index,sample_data.smartS,'o',color='r'）

ax1.set_ylabel（u"成交量（万）",fontsize=16）

ax2.set_ylabel（u"S 因子值",　fontsize=16）

ax1.set_title（u"蓝色柱子（左轴）为成交量，红色圆点（右轴）为S因子",　fontsize=16）

plt.xticks（sample_data.index.values,sample_data.barNo.values）

ax1.set_xlabel（u"样本分钟线序号",fontsize=16）

ax1.set_xlim（left=-1,right=len（sample_data））

ax1.grid（）

如图4-25所示是中国平安（601318）一段长度为半小时的分钟行情数据，按照时间顺序排列，时间标签依次为1至30，柱子代表每分钟的成交量，圆点代表每分钟的S值。

图4-25 股票成交量和S指标值



# 升序排列S值

sample_data=sample_data.sort（'smartS',ascending=False）

sample_data.index=np.arange（len（sample_data））

sample_data['accumVolPct']=sample_data['volume'].cumsum（）*1.0/sample_data['volume'].sum（）

fig=plt.figure（figsize=（14,10））

ax1=fig.add_subplot（211）

ax1.bar（sample_data.index,sample_data.volume,align='center',width=0.4）

ax2=ax1.twinx（）

ax2.plot（sample_data.index,sample_data.accumVolPct,'-o',color='g'）

ax1.set_ylabel（u"成交量（万）",fontsize=16）

ax2.set_ylabel（u"成交量累积占比",fontsize=16）

ax1.set_title（u"蓝色柱子（左轴）为成交量，绿色曲线（右轴）为累计成交量占比",fontsize=16）

plt.xticks（sample_data.index.values,sample_data.barNo.values）

ax1.set_xlabel（u"样本分钟线序号",fontsize=16）

ax1.set_xlim（left=-1,right=len（sample_data））

ax1.grid（）

如图4-26所示是我们按照S值从大到小的顺序对行情数据进行重新排序的，柱子代表每分钟的成交量，曲线代表成交量从左到右的累计占比（相对于总成交量）。以成交量累计占比20%作为划分的界线，将最左侧的6个分钟数据划归为聪明钱的交易。剩余的分钟数据则被划为普通资金的交易。

图4-26 按照S值排序的成交量



根据公式：Q=VWAPsmart/VWAPall

其中，VWAPsmart是聪明钱的成交量加权平均价，VWAPall是所有交易的成交量加权平均价。Q值体现了在该时间段中聪明钱参与交易的相对价位。

在机构测试中，根据情绪因子Q对所有A股进行排序并等分为5组，多空对冲的年化收益率为26.0%，最大回撤7.97%，该因子显示出较高的股票区分能力且第一组收益高。我们今天演示的交易模型仅买入 Q因子最小的20只个股，测试它作为股票模型的绩效情况。如图4-27所示。

2.改进聪明钱因子

通过绘图部分代码，我们看到因子计算公式中计算了1分钟线的回报率：sample_data['return']=sample_data['close'].pct_change（），在模型中这段代码被这样撰写：

# Bar_Return列是Bar内回报绝对值

df['Bar_Return']=abs（df['close']/df['open']-1）

图4-27 原版聪明钱因子在中证500股票池测试结果



下面试图分析每一个分钟线内资金对于股价的影响程度，而以60秒为颗粒度强行划分每个时间段，然后定出open和close等价格，然后计算pct_change（）回报率=（当前分钟收盘价–前1分钟收盘价）/前1分钟收盘价，并不是最合理的计算方法。

我们认为计算high和low的最高最低价格比率替代.pct_change（）会带来更好的效果，因为如果不以分钟线K线分析，而是以更细致的秒K线分析，会发现部分阶段性高低点被分钟线每60秒一次的切分为“当前分钟收盘价”和“前1分钟收盘价”忽略了（采样漏检），而high和low价格不会被漏检，它们可以表示价格在本分钟内的波动情况。

所以将S指标值公式改为：

# Bar_Return列是bar内价格振幅

df['Bar_Return']=abs（df['high']/df['low']-1）

# SS列是bar内回报绝对值，除以成交量开平方

df['SS']=df['Bar_Return']/（df['volume'].apply（math.sqrt））*10000

紧接着我们看到原模型中，有对于成交量动量的计算：

# 计算轴向元素累加，计算【累计成交量】

df['cum_vol']=df['volume'].cumsum（）

# 计算【计算1分钟内K线的成交量变动率】

df['cum_vol']=df['cum_vol']/df.ix[-1,'cum_vol']

考虑到成交量在某些情况下会失真，计算动量更好的方式是针对价格处理，所以我们将此部分 df['cum_vol']=df['volume'].cumsum（）改为：df['cum_vol']=df['close'].cumsum（）。相应地，原版模型计算成交量累计占比前20%的分钟线，在这里含义变为价格动量累计占比前20%的分钟线。

改进这两点后发现，收益率和夏普比率有上升，最大回撤有下降。在不同的股票池比如沪深300，收益率也从42%提升到54%，夏普比率从0.18提升到0.26。这两点微弱改进是有一定效果的。如图4-28所示。

图4-28 改进后的测试结果



此时单只股票Q因子值的计算代码如下：





3.因子值中性化处理

中性化的含义是去除某个因子对于原因子的影响力，使原因子的信息含量更加纯粹。比如我们知道换手率高的股票大部分都是小市值股票，但是我们试图去除市值的干扰因素，寻找单纯的换手率对于股票的区分能力，就需要做市值中性化处理。

同理，如果我们发现不同行业的股票存在换手率差异问题，我们担心一旦选择换手率选股会造成集中选择到某行业股票，也可以做中性化处理，这种方法叫作行业中性化。

中性化的本质都是去除风险因子对于原因子的影响，你可以理解为一次对于因子的提纯。其中风险最大的是市值因子，因为我们已知的大部分高质量选股因子，都包含了市值因素，这些因子在2014年年末、2017年下半年都出现了明显失效，造成模型净值大幅度回撤，所以本节以市值中性化做示意。

市值中性化最易于理解的方法是线性回归法（正交化），它可以很好地处理线性相关带来的影响，我们一般将原因子值作为被解释变量Y（或应变量），用市值因子作为X去解释它，线性回归后的残差就是X所不能解释的成分，自然就是提纯之后的因子值了。

方正证券研报《规矩：方正单因子测试之评价体系》中通过“非流动因子”对市值中性为例对中性化的效果做了说明：中性前，非流动性因子与市值高度相关，相关性达到-0.7679，而中性后相关性大幅下降至-0.008（几乎已经去除了市值的影响）。从各组分位数来看，中性前多头在小市值上有暴露，中性后大幅改善。

如图4-29所示，可以看到原始的ILLIQ由于有较大的小盘股风险暴露，导致其对冲后的回撤仍然较大（黑框中是回撤最大的阶段，也是大小盘风格发生显著反转的阶段），中性化之后的ILLIQ的多头组合回测，显著改善的地方在于对冲后最大回撤和对冲后收益波动率均有大幅下降。线性回归法（正交化）因子中性化的代码也在本模型中提供。

股票类模型都要注意其他风险因子的影响问题，原因子在做完因子中性化，如果仍具有选股能力，这才是我们真正期待的结果，如果要一次去除市值影响、Beta动量影响、换手率影响等多个风险因子的干扰，就要用多元线性回归方法，输入多个自变量X，对原因子值进行中性化处理。可以看到聪明钱因子市值中性化之后绩效差异并不显著，或许在进行第一组（Q因子值最低）和最后一组（Q因子值最高）对冲后，该差异能够进一步显现。

4.ATR风险控制仓位管理

下面我们依然对ATR风险控制模式进行介绍，并通过它来试图降低交易风险。

该模块首先定义了一个变量positionAdjustValue：最大损失的资金量，该资金是总资金的一定百分比，一般我们选择0.05～0.1，实际上从后文可看到，该资金按照个股数量等分后，再乘以股价，除以ATR值。

图4-29 市值中性化及其效果检验



举例说明：假如个股股价=40元，平均波动幅度=±5%,ATR=2。在100万元总资金情况下：g.risk_ratio=0.05，总风险资金=5万元，每只股票风险资金=2500元。

此时：risk_value[stock]=hStocks[stock]*Adjustvalue_per_stock/curATR=40*2500/2=50000元。如果使用等资金量开仓，总资金为100万元，每股分到的资金也是50000元。所以，设置g.risk_ratio=0.05，使用资金大概率不会超过账户可用总资金。

如图4-30所示，设置g.risk_ratio到更高值，比如到0.3，我们通过回测详情发现，系统没有足够资金开仓买入20只股票。而设置g.risk_ratio=0.05即可买入每一只股票，但是g.risk_ratio=0.05经常会造成资金使用量不足的情况，所以我们可将其设定为0.1。

图4-30 g.risk_ratio设置到0.3之后，系统无法正常买足额定股票数量（额定20只）



该模块符合我们之前所描述的“风险加大，降低开仓资金量”，所以最直接的体现就是在股灾时期，由于个股震荡幅度加大，ATR加大，获得的资金量降低，所以有效抑制回撤。在其他漫长的交易阶段，高波动通常伴随着高风险和高不确定性，价格发生反转的可能性提升，所以同样给予降低仓位处理。

不仅ATR风险平价头寸的原理如此，低动量这个因子在A股甚至各国股票期货市场有效也是因为这个原因。加入该模块后，绩效提升到148.27%的收益率，0.88的夏普比率和35.69%的最大回撤，而之前的绩效仅有112.49%的收益率，0.55的夏普比率，最大回撤达到45.84%。

以下给出该模型源码，读者们可以进一步添加模块，使之逐渐成为可实盘交易的模型，也可以通过扫描二维码获得：





4.9 股息率高分红模型，与参数优化实践


我们在开发股票交易模型时，也不能忽略了股票作为有价证券的本质，也就是说除了主动交易带来收益，通过持有上市公司股票获取分红或者以分红为研究目标分析交易者定价行为，也是另一个有效的分析角度。股息率就是这样一个因子，它在投资实践中，股息率是衡量企业是否具有投资价值的重要标尺之一。

1.股息率定义与数据提取

股息率的计算公式是：

公式中D代表股息；Po 代表股票买入价。一般我们选择股息率（TTM）指标=近12个月内公司的累计分红总额/公司总市值。或者获取到上市公司发布的每股分红数量，除以当前股价，也可以得到股息率，因为股价有高低变化，所以股息率随股价波动而动态变动。

美国基金经理大咖迈克尔·奥希金斯（Michael O‘Higgins）于1991年提出过“狗股”投资策略（Dogs of the Dow Theory）作为长线交易典型案例，其主要依据就是高股息率。他通过测算发现，投资者年底从道琼斯指数中找出10只股息率最高的股票，新年买入，一年后再找出10只股息率最高的成分股，卖出手中不在名单中的股票，买入新上榜单的股票，如此重复便可获取超大盘的回报。高股息率一般对应的就是分母股价要低，也就是说企业没被高估，所以我们可以轻松的买到好价格。如图4-31所示。

图4-31 股息率最高的时段，基本上可以认为是该股票被低谷的时间点



但是股息率无法帮助我们选到高成长的企业，因为从企业分析角度看，一般认为高速成长的公司不喜欢发放股息，向股东派发股息意味着失去大量现金，成长型公司首选用这些钱再次投资。对于成熟期的企业，尤其是现金丰沛的业务稳定的上市公司，选择向股东分红是维持公司市值，获取长期价值投资者的有效方法。所以股息率也可以被认为是潜在地回避高资产负债率、高股权质押率上市公司的有效指标，这一点在2017年的中国资本市场尤其显得重要。

客观上分析目前国内股票市场，在证监会的引导下，以及MSCI等外资对于上市公司长期价值的评定标准影响下，截止2018年5月证监会最新数据显示，去年我国2754家上市公司披露了现金分红事项，分红金额合计约10705.72亿元，同比增长21.88%，首次突破万亿元大关。同时A股市场流行多年的“高送转”大幅缩减，类似“高送转”这种缺乏实质的分红行为开始被真正的现金红利所替代。

根据股息率公式可看到，股价不变的情况下，分红比上年高；或者分红不变的情况下，股价比上一年低；这两种情况都会导致导致股息率上升。所以读者们可以理解，本节的策略并非是一个博取高收益的策略，而是在A股市场上，通过实践股息率变化筛选来完成寻找成熟稳定的上市公司，并且是在价格低谷区间持有这类上市公司，寻找价值轮动的超额收益机会。

通过聚宽网站提取股息率需要使用聚源数据库，以聚源数据库为例，首先转换股票代码，然后查询相关字段，提取方法是：





得到分红数据后，使用分红数据除以20日股价均值，即可得到股息率，然后按照股息率排名个股，就得到了买入名单。

2.更好的大盘风控止损方法

如果单纯买入持有股票，而不在股灾、长期大幅度震荡下跌等情况下卖出股票清仓，可能会造成阶段性绩效回撤过大。这种模型我们称为纯多模型，或者通过某因子完成精选个股跑赢指数的模型，一般在模型开发初期，计算某因子超额收益时，常采用这种方法。

但是为了确保模型能够放心实盘交易，针对过大的回撤需要考虑采用大盘指数风控的方法进行回避，比如2012—2013年长期下跌，或者2015年下半年两次股灾，这种个股普跌的贝塔风险其实是有方法过滤回避的。但是过滤严格容易造成收益严重降低，或者建仓机会较少，错过收益机会，过滤太少又看不到显著成效，所以我们在这里引入依据大盘追踪止损的条件，然后再加入二八指数动量同时为负的限制，以避免不必要的止损。如图4-32所示。

图4-32 不进行大盘风控，月度调仓买入并持有高股息率个股



通过聚宽“绩效归因”界面，我们看到如果不进行大盘风控择时，策略回撤较大（超过31%），且单月出现大幅度回撤的幅度较为明显，月度收益热力图分布差异也比较显著。



在简单的风控条件下，股息率策略作为简单验证单因子的策略框架，取得了较为有效的结果。最大回撤控制到15.35%，累计收益也从242%提升到337.50%。总体来看，指数择时带来了显著有效的结果，但并非所有策略都需要此择时框架，而且由于我们使用的数据维度依然较为单一（追踪止损和二八指数动量都源于指数时间序列动量），所以在更复杂的机构模型开发中，这方面还有非常大的空间可以挖掘。同时针对个股在买入后发生上市公司风险导致的大幅度回撤，指数择时也无能为力，显然个股风险也需要单独控制。如图4-33所示。

以下给出该模型源码，也可以通过扫描二维码获得：



图4-33 大盘风控后，绩效获得全面提升





3.通过参数优化选择最佳止损位置

通过在线式平台如聚宽、优矿等编写策略，在参数回测方面需要消耗大量的网络资源，一般平台提供者无法给予研究者足够的线程数量，也不推荐大规模参数回测历遍。但是聚宽平台依然为我们提供了一种解决方案，在该平台中通过【投资研究】调用【我的策略】中的某个模型，然后配置模型需要优化的参数名、参数范围，即可开始回测。

完成参数优化需要多个步骤：

（1）在投资研究中新建一个Python 2研究界面，如图4-34所示。

（2）复制以下代码进入研究界面。

（3）指向需要优化的模型ID，并配置优化参数名和参数范围。

（4）回测完成后，绘图观察多组参数绩效。

图4-34 新建一个Python 2格式投资研究界面



代码内容较多，请大家通过扫描二维码获得，也可以访问聚宽“量化课堂”的链接阅读：https://www.joinquant.com/post/4351。



复制完毕后，运行第一段代码，然后在研究的第二个单元格内，复制本行代码并运行：

pa=parameter_analysis（'3ebf21f770961143194ebf9491f57196'）

引号内的部分’3ebf21f770961143194ebf9491f57196'，就是策略模型ID，它在策略模型的浏览器地址栏algorithmId=，等号后的部分，需要从策略模型中复制填入（虽然每次刷新网页策略ID都会变化，但是填入该策略HTML页面的任意一个ID即可）。

运行完毕后，在研究的第三个单元格内，复制本段代码并运行：

pa.get_backtest_data（file_name='results_days.pkl',

running_max=10,

start_date='2012-01-01',

end_date='2018-04-18',

frequency='day',

initial_cash='1000000',

param_names=['tralling_stop_X_ATR','div'],

param_values=[[1,1.5,2,2.5,3,3.5,4,4.5],[0.2]]

）

我们看到本段代码配置了优化并行数量（不允许超过10个）、优化起止时间、模型运行周期、模型初始资金和模型参数param_names=['tralling_stop_X_ATR','div']。提示一下，全局参数的g.前缀不用在研究平台打出，否则会造成程序执行异常。

在本书中展示的优化案例中，'div’参数不变，只变化’tralling_stop_X_ATR'，历遍范围是1到4.5，间隔0.5。该参数是ATR追踪止损的倍数，它表示价格从阶段高点回落多少个ATR需要启动追踪止损模块。

通过第二段代码，我们为parameter_analysis传入了模型ID,【投资研究】和【我的策略】两个原本分离的频道就被联系起来，可以用前者控制后者，一次执行多个参数的并行回测。

回测完成后，可以运行绩效分析函数，如pa.plot_returns（）能绘制出多组资金曲线，或者pa.get_eval4_bar（）能够绘制出多组收益、波动率、夏普比率、最大回撤，如图4-35所示。

通过图4-35看到，第四组参数性能最好，也就是原模型中对应的3个日线ATR回落幅度，它的净利润、夏普比率均领先于其他组。波动率和回撤幅度最小的是第0组，也就是1个日线ATR回落幅度，但是它显然带来了收益率的大幅度降低，不是我们需要的理想风控条件。

图4-35 运行pa.plot_returns（）函数和运行pa.get_eval4_bar（）函数后的效果





第5章 更有效的期货交易模型构建



5.1 万变不离其宗，均线类模型本质剖析


我们大部分交易者在学习初期开发的模型，都离不开动量效应，具体来说是离不开均线。我想起和同事交流的时候（我们都是由5～10年的市场交易者，转化成为量化模型开发者的），我们初期接触到的这个行业的大部分技术指标、K线分析方法等现在看起来并不严谨的交易思路，很多也是基于均线。

1.均线的本质——数学推导

这并不是说均线不科学，而是说在此之上衍生出的模型数量越庞大，质量就越经不住推敲。均线本身很科学，也很稳健，动量效应最容易解释，有很强的行为金融学解读能力，但如果我们搭建大量的技术指标、均线衍生模型，就会造成很严重的同质化现实。实盘中如果都是这样的模型，那么就谈不上什么风险分散和对冲，反而会加剧风险在短期内释放。

这到底是为什么？

在阅读海通证券的同事推荐的一篇国外研报——Market Timing with Moving Averages:Anatomy and Performance of Trading Rules之后，我们终于找到了自己一直想说，但是不知如何表达的内容——移动平均线本质上都是价差的加权指标。这篇研报由海通证券分析师宋家骥翻译。

技术分析是一种通过研究历史价格数据发现价格变化的一些周期性规律或趋势，从而对未来价格走势进行预测的方法。而在技术分析中，移动平均线则是很流行的寻找趋势的方法。当前有许多基于移动平均线的交易规则，比如动量规则、价格减去移动平均线规则、移动平均线转向规则及双均线交叉规则等。此外，还有许多移动平均线的计算方法，比如简单移动平均线、线性加权移动平均线、指数加权移动平均线和逆指数加权移动平均线等。因此，基于不同的移动平均线的计算方法和交易规则，可以得到多种择时组合，如图5-1所示。

图5-1 不同的移动平均线计算规则



令很多投资者纠结的是，到底使用哪种交易规则及移动平均线计算方法会有更好的择时效果？

大家对此问题展开了一系列的分析，既有大规模的测试，也有对数学原理的分析，也都得到了结论。两年前，我也做过系统性的分析，结论是：在不同情况下，各类均线的使用场景不同。但这个结论的假设过多，显得非常脆弱。

后来在实盘交易中，当数据量较大时，我倾向于选择等权的MA均线；当数据量较小时，为了降低噪声，我倾向于选择使用指数加权移动平均线，但依然存在很多模糊地带不知道该用什么，于是索性就都用等权移动平均线MA，因为它们的性能差异很小。

除本书中分析过的短期移动平均线AMA具有非常特殊的设计思路外，目前投资者的争论普遍集中在等权移动平均线MA、线性加权移动平均线LMA和指数加权移动平均线EMA。

应用最普遍的移动平均线是简单移动平均线SMA，其本质是给予每个历史价格相等的权重，这是我们使用最普遍的均线，但很多交易者认为它存在改进空间，特别是在股票、期货市场上，我们总认为直接使用MA并不是最佳选择。

有些人认为最近的股票价格比过去的股票价格能反映出更多信息，更能引导股票未来的走势，因此，在计算平均线的过程中应该给最近的股价更高的权重。于是，在此基础上就产生了线性加权移动平均线LMA（Linear Weighted Moving Average），也被称作WMA平均线，很多股票、期货客户端软件中都有类似的指标可以调出。

在LMA中，股价的权重是由近至远呈线性下降的，但是它的缺点是加权方法过于刻板，因此有人提出了指数移动平均线EMA。在MACD指标和大部分资料中，EMA也被翻译为EXPMA（EXPonential Moving Average）。

另外，还有一种并不是很普及的移动平均线REMA（五指数移动平均线），其将更大的权重赋予了过去的股价，而不是最近的股价，因其不符合人脑关于记忆和遗忘的时间曲线，所以这类均线几乎没被使用过。

以上几种均线本质上的数学逻辑如图5-2所示。

图5-2 几种均线本质上的数学逻辑



除这几种均线外，还有各类交易规则。比如，对于最简单的动量规则（MOM）来说，其技术指标值为本周期值减去之前某周期值。

交易者熟悉的交易规则还包括：

◎ 价格减去均线规则（P-MA），也被称为单均线规则，价格在均线之上买入，在均线之下卖出，反应较快，但是噪声较高。

◎ 均线转向规则（△MA），也被称为拐头规则，因为均线比价格噪声低，所以均线一旦向上或者向下拐头，就买入或者卖出。

◎ 双均线交叉规则（DCM），这是很简单、很常见的均线交易规则，大部分交易者都采用这种规则。其第一条均线主要用于描述短期趋势，或者说给价格进行降噪，得到主趋势；第二条均线一般被设定为周期大于第一条均线，用于描述长期趋势。

下面以第一种单均线规则，即价格减去均线规则（P-MA）为例，其交易指标值的分解如图5-3所示。

图5-3 动量规则（Momentum Rule）和价格减去均线规则（P-MA）的交易指标值分解



按照此路径，经推导发现，本文所讨论的所有均线交易指标在本质上都是一样的，都基于动量原则，只不过是在不同的回溯周期下应用不同的加权组合构建的。

因此，动量原则是最基础的一种交易原则，在此之上可以建立一系列更加复杂的交易原则。此外，由于动量原则等同于价差的等权组合，因此，各种交易原则也可以化作价差的加权组合，其本质上是相同的，区别就在于加权方式的不同。

图5-4展示了6种不同的交易规则实际上就是在价差加权方式上有所不同。左侧Y轴是夏普比率，底部是各种组合，右侧标签是不同的滞后期。由于作者是用月度 K线做测试的，所以数据噪声量足够低，而且用了1860年1月至2014年12月标准普尔综合股指的月度数据，该回测时间显然大于A股建立的周期。

总而言之，有分析师认为，市场交易者并不真正理解他们所使用的交易指标的反应特征。我们也非常认同这个观点，甚至可以说，部分量化模型开发者也不知道真正的动量模型特性，为什么自己做出的模型高度同源，以及自己的策略思路应该从哪里去寻找。

图5-4 移动平均线的差异体现为价差加权方式的不同



2.均线的最佳窗口期

对于参数优化这个历史性难题，很多交易者认为存在最佳参数（甚至具体到某个值），而部分模型开发者也认为，即使不存在最佳参数，也可以通过矩阵推进（Walk-forward）这种方法，划分时间阶段，寻找每个阶段的最佳参数。但实际上并没有最佳参数，通过对月度数据分析，得到了一个粗略的结论，即较短周期的均线可以带来较多的交易次数，在性能相近的情况下，优先选择短周期参数。每个策略都没有完美的回溯时间窗口，窗口期是随着时间和市场环境不断变化的，如图5-5所示。矩阵推进在中低频时间序列建模方面最大的问题是数据样本不足，而在机器学习领域，面对高维数据该方法是有效的。

通过回测数据可以看到，均线择时或者说基于指数的动量模型是有一定意义的，能够战胜静态持有。但是它们的同源性太强了，每一种均线指标都可以用月度价差（作者是在月K线上进行测试的）的加权移动平均值来计算，唯一的区别在于不同的指标使用的加权方式不同。

图5-5 不同均线都没有完美的回溯时间窗口



我们测试了A股沪深300指数30分钟K线在三种均线上的绩效，测试默认不带杠杆，以全仓买入、卖出ETF的形式模拟交易沪深300指数，分别是MA单均线、MA双均线、EMA单均线、EMA双均线、WMA单均线、WMA双均线这6种情况，发现了同样的问题：当指数动量不足时（震荡时），改变均线算法或者优化参数也难以带来盈利。

相比于测试优化后的最佳性能，我们再次重申观点：应该更加关注全参数面的平均性能，或者夏普比率在某个阈值线上的平均性能，或者交易次数在某个阈值线上的平均性能。





5.2 逆势交易在期货市场的初步实践


1.马丁格尔类系统的参考价值

提到逆势交易系统，相信参与过外汇市场的交易者都耳熟能详，因为在外汇程序化交易领域非常流行一种逆势加仓创造长期稳健收益的“马丁格尔”（Martegal）系统。马丁格尔策略即在每次输钱后，赌博者都会将其赌注翻倍，只要赢一次，就可以将之前亏损的全部金额赢回来，还会赢得等同于初始本金的金额。

该策略资金曲线呈现长期向上趋势，胜率高，盈亏比较低，在每次亏损时，随亏损程度或亏损时间，等差或等比加仓。

马丁格尔策略看起来是一种完美的交易策略，但在实盘交易过程中往往会引发投资者巨亏甚至爆仓，原因在于它的假设前提是价格始终呈现均值回复震荡形态（反转），不会出现较大的单边趋势（动量）。这个假设在一定范围内的外汇市场是行得通的，因为国家汇率，特别是主要发达国家的汇率，长期呈现稳定的区间波动格局，除非有巨大的货币政策调整或者战争等因素干预。但一旦出现较大幅度的变化，该策略就会亏损（因为马丁格尔策略很少止损）。而且按照马丁格尔理论，随着亏损时间的增加，筹码会越押越大，所以后期非常有可能将资金全部亏光。

执行逆势交易系统，最重要的问题在于根据资金量选取适当的起始仓位和加仓倍数。如果起始仓位过高，则会导致每次翻倍加仓投入的资金过于巨大，从而可能导致无法坚持到价格往回波动的时刻；加仓倍数过高也会导致同样的问题。此外，还要考虑加仓的距离，按照价格运行的分布情况设定加仓时机，比如每间隔1%加仓或者每间隔固定ATR加仓。

但使用马丁格尔策略的大部分交易者的生存情况并不理想，外汇价格偶尔的剧烈变动会让交易者大幅度亏损。股票和期货市场也是如此，动量增强，回复性反而不好把握，特别是商品期货市场，以动量为主，在趋势不显著的震荡阶段，缺乏较好的交易模型。而传统趋势模型也缺乏较好的入场点和离场点（两个点位都延迟于价格波动），所以行业内不少开发者还在构思较好的交易系统，从而能够反向入场，获利主动离场。在理想状况下，它是一套震荡交易系统，或者被称为动量反转交易系统。

2.识别局部高低点

下面介绍一种识别局部高低点的思路，参考马丁格尔系统，在一定程度上达到了震荡系统的设计目标。而且我们的价格判定思路非常别致，通过将时间序列上过去一段时间的价格和其均值进行线性回归，得到残差。在某个阶段，价格快速下落而均线上升，会呈现出残差快速扩大的特点，此时开仓做多；相反情况下做空。也就是说，在入场点方面，以残差作为信号，逆向交易，如图5-6所示。

图5-6 基于线性回归残差识别局部高低点（1为低点，2为高点）



在离场点方面，按照和开仓对应的设计思路，该系统在价格连续乖离均线过远时入场建仓。由于价格波动后，均线开始趋近于价格（基于移动平均线的基本特性，快速运行的行情往往会使得均线也开始贴近行情），此时残差降低，向0轴运动，说明价格已经趋于平稳，系统平仓条件达成。

该系统并非找到入场点和离场点就能盈利，如果没有设置止损，那么和原版马丁格尔系统一样，可能会产生巨大亏损，甚至亏光所有本金。解决这一问题的方法很简单，即构建基于价格点位或者ATR的硬止损条件，达到条件后平仓亏损的交易单。但其也借鉴马丁格尔交易系统的构造经验，不要立刻离场，而是在达到第一个止损位后，等仓位加仓1次，如果加仓后价格依然向不利方向运行，再平仓离场。

如果你在K线上叠加一个趋势模型，就会发现显著特点：逆势系统的入场要早于趋势系统，且先获得利润，或者先失败出局。逆势系统的出场也要早于趋势系统。逆势系统在大幅度上升阶段如果持有空单，那么此时趋势系统会大概率持有多单，两者形成盈亏对冲；在大幅度下跌阶段也是同样的道理。所以，我们认为这是一个不可多得的能够和趋势系统起到对冲作用的交易方法，其核心特色就在于对高低点的识别。

3.线性回归应用初探

本书在股票多因子部分，会详细介绍线性回归工具，所以这里涉及此内容，只做简单说明。

我们先做一个简单粗暴且明显存在逻辑错误的假设：期货或股票时间序列价格和自己的均线始终一一对应，完全重合。显然，均线是滞后的，当价格出现波动时，均线必然滞后反映价格波动，且因为存在移动平均线的因素，均线无法触及价格最高峰和最低谷。但在交易者心理层面，对均线是存在敬畏和戒备的，当价格偏离均线太远时，说明市场已经付出了非常大的一致动量去推动价格运行，接下来可能会衰竭，也就是均值回复。

所以这个假设是不成立的，只有静止的价格才能被均线完全解释；同理，均线也无法被价格完全解释。由此描述你是否能够想到线性回归和残差等诸多概念？股票因子模型，就是通过每个截面上的所有股票的某项特征和价格线性回归，看这项特征有多强的解释力度。

回归分析（Regression Analysis）是确定两种或两种以上变量间相互依赖的定量关系的一种统计分析方法。在回归分析中，只包括一个自变量和一个因变量，且两者的关系可用一条直线近似表示，这种回归分析称为一元线性回归分析。

线性回归主要有两个使用方向：①通过回归历史价格Y，构成回归方程，预测未来变化方向，得到预测值Y1 。②通过回归某个变量X和价格Y的关系，判定该变量对价格有多大影响力（通常看回归后的R-square拟合度）。

按照第一种用途，产生了回归残差的概念：误差（回归残差），指分析结果的运算值Y和实际值Y1 之间的差。残差越大，说明此时回归越失效。

那么在本模型中，什么情况下残差会回归均值？①价格发生反转运行，趋近于均线，也就是葛兰碧均线法则中的均值回归（从上向下和从下向上回归到均值）。②均线随着价格变化，也开始加速贴近价格。此时我们认为一次动量释放完毕。

残差较大导致价格反转和残差较小导致价格回归的过程，就是我们这套逆势开仓系统的利润获得过程。但考虑到残差有可能一直增加，而短期内不回归，所以我们必须要设置好止损，而不是始终加仓扛单。

下面将介绍一个函数并在交易开拓者中完成此功能，我们建议向大部分交易者都认可的20周期（或10周期）日均线回归，在第5.3节“大小周期双频率模型CTA实战”中我们将会介绍如何求出日线级别的均线值。

以下是交易开拓者格式的自编函数线性回归函数 LinearReg2seqs，该函数在编译时要编译为布尔型。然后在交易模型中调用该函数的格式是：

//将价格和均线值，送入线性回归函数（X和Y）

LinearReg2seqs（Close,　 DayMADD,　 LRLength,　 0,　 LRSlope,　 LRAngle,LRIntercept,LRValue）;

//以LRlength周期，对价格和均线两序列求线性回归

//0为当前Bar线性回归值，1是下一个Bar回归数据；

//LRSlope 返回线性回归的斜率值、对冲比例；

//LRAngle 返回线性回归的角度；

//LRIntercept 返回线性回归的Y轴截距；

//LRValue 返回线性回归的值。

两序列线性回归函数源码如下，也可以扫描二维码获取：





4.做一次加仓而非立刻止损

考虑到我们的系统是一套逆势入场系统，而其判定阶段性高低点肯定存在偏差，所以要做一个看似危险，但风险完全可控的操作，也就是在亏损一定程度时加仓一次。

这里可以直接告诉读者结果，一个较为理想的加仓位置是亏损到距离止损线还有50%时。比如你设定的止损线是4个ATR，那么在2个ATR时加仓一次效果最好。在本模型中，我们设定的止损线是2个日线级别的 ATR，所以我们的加仓位置是0.5*NATRstop*atr[1]，代码如下：

//多头加仓

if（marketposition==1

&& Date[barssinceentry]<> date && Efficiency_Ratio <=0.5

&& close[1]<=EntryPrice-0.5*NATRstop*atr[1]）

{

Buy（lots,open）;

}

//空头加仓

if（marketposition==-1

&& Date[barssinceentry]<> date && Efficiency_Ratio <=0.5

&& close[1]>=EntryPrice+0.5*NATRstop*atr[1]）

{

SellShort（lots,open）;

}

这里的Date[barssinceentry]表示加仓不能在本日进行，也就是说，如果本日开仓后就下跌到0.5个日线ATR，则假设本次交易已经缺乏挽回局面的可能性。在具备完整开仓、平仓逻辑的模型上，进行完加仓后，我们测试了几个品种，其性能发生了如下变化，如图5-7所示。

图5-7 是否加仓对模型性能的影响



这里需要注意的是，我们的考核标准是夏普比率，这和投入多大资金量进行交易没有关系，所以加仓是否能够带来性能提升在这里获得了较好的量化表达。显然，加仓有利于系统寻找到更合适的入场点，这借鉴了马丁格尔系统的亏损加仓，而不是海龟系统的盈利加仓。盈利加仓无论是金字塔还是倒金字塔模式，都放大了利润，而未见对真正的性能（也就是收益风险比或夏普比率）有所改善。

但是也有特例，比如铁矿石这个品种，加仓后会使绩效劣化，还有一些高单值的品种，如橡胶、焦炭等，也建议不开启加仓设置。在 TB软件中，关闭加仓方案最简单的方法是在“全局交易设置”对话框中取消连续建仓选项，如图5-8所示。

图5-8 通过交易单元设置取消加仓方案



5.进一步保护系统降低消耗

作为一套纯正的逆势交易系统，在充满动量的商品期货市场上想要盈利，需要进一步降低错误开仓消耗。我们发现，动量在早盘通过开盘突破产生后，还会继续延续一段时间，比如向上高开后，此时开空单逆势入场是有一定风险的，不妨进行开仓限制；向下也是同理。

//早上9:00点，第一条Bar，记录一些重要数据

if（Time==0.090000）

{

yclose=close[1];　　　 //昨日收盘=昨日最后一个Bar收盘价

topen=open;　　　　　　//今日开盘价

PlotString（"open","◆",high*1.01,White）;

}

//日线向上跳空0.5个ATR，本日不开空

DayGap_UP=topen-yclose > 0.5*atr[1];

//日线向下跳空0.5个ATR，本日不开多

DayGap_DOWN=topen-yclose <-0.5*atr[1];

我们撰写了两个布尔条件，将其放在模型中，取反之后放入开仓逻辑中形成过滤。

再如，我们测试发现一些止损是非必要的，特别是开盘已经过度跳空，通常会出现反转的回复性运动，所以我们撰写了和 AMA模型中一样的防止止损模块放在本模型中，对硬止损进行限制。同样对这个布尔条件取反之后，过滤止损逻辑。

//向下跳空严重，多头止损不启动

gap_long=open-close[1]<-0.5*atr[1]

&&（time==0.090000 || time==0.210000）;

//向上跳空严重，空头止损不启动

gap_short=open-close[1]> 0.5*atr[1]

&&（time==0.090000 || time==0.210000）;

该模型的加仓产生在亏损时刻，而当价格趋势已经形成较为强势的突破格局时，再亏损加仓几乎等于飞蛾扑火。所以，我们挖掘出之前使用过的 ER效率系数模块进行干预，干预方式很简单，当ER系数绝对值大于0.5时，禁止加仓。

//通过ER效率系数绝对值过滤加仓

direction=close-close[20];

volatility=Summation（Abs（Close-close[1]）,20）;

Efficiency_Ratio=Abs（direction /volatility）;

如果想要进一步降低模型的风险，那么可以用该模块控制开仓，在开仓条件中也加入同样的限制。此时该系统虽然被严格束缚住手脚，交易次数不断降低，但也不失为一种风控较为严格、对行情筛选能力较强的逆势系统。

作为一套逆势系统，其表现相对可以接受，但其在30分钟线上交易次数较少，对交易环境较为挑剔（因非线性过滤严格导致）。所以并不能说我们的过滤非常有效，这种强行过滤的方式反而有可能会导致对样本内拟合，使样本外表现不能保持。这是需要格外警惕的。

同时，这类系统在遇到连续性趋势行情时不能有效应对，一旦开错方向，只能用硬止损的方法应对，所以建议在配置这类系统时，一定要有趋势系统作为辅助。提示一点：该系统由于运行周期依然在30～60分钟的范围内，且部分品种硬止损参数NATRstop需要设置为2个日线ATR止损，所以属于中长期系统。就运行周期而言，也需要小周期或短线系统共同运行，才可以保证实盘绩效稳定输出。

另外，我们反复使用过滤模块导致交易次数较少，有经验的读者应该意识到实盘风险度在提升，因为绩效的置信度出现了下降。一般对此解决方案是降低MADD函数的周期参数，比如让各品种向更短的大周期均线进行线性回归，以追求更高交易次数（潜在地得到更高的绩效置信度）。

该系统源码如下，需要先编译线性回归函数 LinearReg2seqs和取日线均线函数MADD（在双频率CTA相关章节中会进行讲解并给出模型），然后编译主模型，也可以通过扫描二维码获得：





5.3 大小周期双频率模型CTA实战


我们知道日线和分钟线的择时效果不同，分钟线反应更加迅速，日线择时能够去除噪声的干扰，从而择时更加准确。在不同框架和周期的数据上，切换择时信号和操作频率，往往能达到较好的择时效果。

长江证券研报《择时视角：多周期与多维度》依据这个理论，做了一个混频的模型实验：在小时线产生信号的时候利用日线来交易，在日线产生信号的时候利用下一期的小时线来交易，相对于日均线择时和小时均线择时，年化收益和夏普比率均得到较大的提升。也就是说，使用日线发出信号，而在小时线上寻找更加细腻的交易点位，这是一种跨频率引用方法，也被称作混频模型。

1.低频和高频各有优劣

日线产生信号、日线交易的弊端在于操作过于滞后，在检验小时线产生信号、日线操作的有效性之后，日线产生信号、小时线交易的择时的含义是：在当天20日均线产生信号之后，利用第二天第一个一小时线进行交易。从择时效果来看，日线产生信号、用小时线操作的年化收益率高达37.24%，相对于原有的日线择时、日线交易来说，其操作更为提前，这也预示着利用择时在做仓位的增减时，在第二天9:30—10:30交易会比当日收盘价交易要好。

下面我们向大家介绍一种跨频率引用方法，依然主要在商品期货市场上实践其效果，如图5-9所示，因为对于股票市场我们将专门构建适应股票市场的模型，以及更加注重全市场的科学研究方法。大部分读者可能认为周期和频率在某种程度上是等价的，比如有读者会认为12周（每周5日）均线和60日均线的择时效果相同。

图5-9 跨频率引用方法效果



但实际上二者并非一致，主要区别在于信息量和反应时间不一样。60日均线序列包括12周均线的信息，信息量更大，一旦发出买卖信号，小级别数据更容易产生反应，能及时利用信号进行操作。但信息量大就意味着干扰信息也多，所以在某种程度上，大级别数据相对于小级别数据来说，往往起到了一定的过滤作用。

我们认为判断失误和判断滞后是制约交易策略的两个核心问题。小周期更容易引发判断失误，大周期更容易引发判断滞后。但使用大级别K线数据（中低频）做模型的主逻辑，误检率可能会大幅减少，而漏检率只会略微增加。我们显然倾向于混频建模这种方式，尽可能地获取低频数据的信噪比，而在细致的相对高频数据上下单交易。

所以这里要明确一个概念，低频率K线并非是对高频率K线的抽样。比如每天15:00的收盘价，在小时线上仅是每天4个1小时收盘价之一，但在日线上它是唯一一个，也是最准确、信息量最大的一个。我们可以每天抽取第一个（10:30）、第二个（11:30）、第三个（14:00）收盘价，每隔4个1小时K线抽取一次，获得一组替代日线收盘价的时间序列做测试，你会发现性能一定不如15:00的那个真实收盘价，因为很多交易筹码要为了收盘价而博弈，在这里透露出的信息量很大。

所以接下来的工作就很明确了，我们尝试调用出每天15:00的日线收盘价，然后求出其MA20大周期均线值，或者做其他处理，作为模型的低频方向保护。具体的交易点位，在方向保护的情况下，依然在相对细致的周期完成，比如30分钟线、1小时线。这就是本部分的主要内容——对双均线系统进行跨频率引用改进。

我们的工具都是很简单的均线，规则也都是双均线金叉确定方向或者入场。另外，本策略不设置止损模块，不设置头寸自适应模块，仅观察最原始的改进前后的性能。所以大家不用在意最终组合绩效，而是应该关注我们在实战时，将哪些模块置于低频率均线的保护之下可以发挥出更显著的提升效果。

2.自编函数引用日频数据并计算均线值

在交易开拓者软件中有跨周期引用方式，之前我用自己的公众号“量化投资训练营”也做过介绍，并在2016年取得了较多的关注量，随后我们将此话题基本搁置，因为我们在实盘中使用的并非是文中的引用方式，而是构建了一套更简单、便利的日频均线计算方式。感谢好友王远洪先生贡献如下这段代码，以较高的效率和清晰的逻辑展示了如何跨频率做数据引用和计算，大家也可以通过扫描二维码获得：





代码中唯一一个参数daysAgo，代表了取多少日之前的日频均线值，我们可以设定为2日，也可以设定为较为主流的20日，即可得到大周期均线。CBIndex==0||time==0.0900代表从分钟线的第一个9:00开始计算，此时赋值给变量barCnt=1，然后递增：barCnt=barCnt+1。

该公式最终返回Return avgclose/daysAgo;，求出每天最后一个Bar的收盘价。可以编译该函数为一个数值型函数，在任意模型中调用它。调用方式为：日频均线=函数名（参数）。比如将它编译为MADD函数，想获得20日周期均线值，该值在你的交易模型中的变量名为DayMA，则可以这样调用：DayMA=MADD（20），如图5-10所示。

图5-10 MADD函数编译后的属性（注意编译为数值型）



3.在模型中引用该函数并观察效果

为了尽可能稳健地证明引用该函数有助于性能改善，我们构建一个双均线模型，将其部署在主要商品期货品种上，它拥有两个参数，一般我们用双均线模型构成的参数赢面来考察一个品种是否适合做趋势性动量交易，或者考察一个新加入品种的方法是否对原来的系统产生帮助。

比如在一篇券商研报中，作者通过小波分析对局部的细节信号进行降噪处理，减少因短期价格频繁波动而引发的亏损交易行为，增加均线组合趋势交易系统的稳定性和可靠性，如图5-11所示。参数赢面的测试，在量化投资领域可以理解为更在乎均线组合的参数稳定性，而非追求优化后的某些参数的极致性能。图5-11中的坐标分别是短期和长期均线参数，颜色代表股指期货的盈利点数。可以看出，经过处理后，大部分均线参数组合拥有了获取正收益的可能性，而在处理前这些参数组合几乎是不可能盈利的。

图5-11 通过双均线参数表达数据质量或交易方法改进程度



添加过滤之后的交易逻辑如下：



我们设计了3种方式使用大周期过滤，分别是多头开仓过滤（long）、空头开仓过滤（short）和多空双向开仓过滤（双开仓）。

我们测试了3个有代表性的品种，其绩效如表5-1所示。

表5-1 3个有代表性的品种的绩效



通过表5-1可以直观地看到，过滤后夏普比率出现了大面积的提升，考虑到我们并不知道具体的期货品种在未来是上涨还是下跌，或者说我们无法确认涨跌的流畅度是否需要过滤，所以建议在开仓逻辑部分，无论多空都要过滤。

其中，橡胶品种的数据在这里存在对结论的一些扰动，如果做更多品种测试，并且是在更加合理的参数面上，搭配更加合理的规则，就会发现确实是需要双向开仓过滤的，且我们选择的2日和20日也并非是最佳参数，还有很大的迭代空间。

4.参数面提升效果分析与最终绩效

我们构建的参数面如下。

◎ 短期均线：10～100，间隔2。

◎ 长期均线：10～200，间隔2。

因为仅考虑到测试双均线系统在混频模式下的性能，我们没有搭配完整的工作区，但是最终组合出的绩效还是相对满意的，达到年度盈利是没有困难的，如图5-12所示。

图15-12 双频率结合最终绩效



上述测试主要在12个品种上进行，涵盖黑色工业品、能源化工品、农产品、有色金属，大部分品种的参数赢面获得提升，交易可信度更高，显然大周期保护小周期有正面效果的信号过滤方式。

该模型核心源码是MADD函数，已经在本节前面公布其代码，将其编译为“数值型”函数即可在自己的任何模型中调用。

总而言之，我们推荐在较大的周期（如1小时线以上）进行模型开发，特别是针对经验不足的开发者，核心原因在于信噪比。这里所说的周期，在一些研报中也被称作“频率”，是建模所用的时间序列的最小划分块，如日频、分钟频。小周期纵然机会更多，但是噪声也更大，很容易产生过度拟合，在实盘中这类模型或参数组合的绩效将衰减。如果我们做趋势类交易，则可以将Efficiency_Ratio效率系数取绝对值后，作为信噪比，刚好这个值也介于0～1之间。

MADD函数作为模型核心，可以在任何模型中轻松调用，本节以一个简单的双均线模型来验证其效果，没有必要提供源码。





5.4 OpenRangeBreaker短线突破交易系统


获得一套好的日内交易系统一直是投资者的梦想，因为这种系统以短线交易的模式，快速验证了自己的程序化思路，且能够适应部分高波动品种在低波动时间段的运行，为中长线趋势交易模型带来有效对冲，能够获得较好的持续收益。所以，在市场波动不足的时候，大部分中长线趋势追踪模型没有盈利空间，反而是日内模型拥有一定的生命力。

在交易者圈子内流传的OpenRangeBreaker短线突破交易系统被市场广泛用于日内交易，该系统以开盘价作为每日基准价，并以日线ATR作为上下突破范围，也被称为OpenRangeBreaker系统。它曾经连续多年在《美国期货杂志》盈利交易系统排行榜中位居前十。

目前这套交易系统依然在为很多交易者创造收益，对它的改进和迭代也为我们打开了日内交易的构思和过滤空间，它仍旧被很多专业机构和个人投资者所推崇。

1.经典OpenRangeBreaker逻辑和问题

OpenRangeBreaker日内波动区间突破交易系统，根据昨日波动幅度的一定百分比，来触发当日的趋势交易，属于日内短线趋势交易系统。具体交易方面的六大操作原则如下：

（1）昨日振幅=昨日最高价-昨日最低价。

（2）今日行情区间上轨=今日开盘价+N×昨日振幅。

（3）今日行情区间下轨=今日开盘价-N×昨日振幅。

（4）突破上轨，买入开仓做多。

（5）突破下轨，卖出开仓做空。

（6）在当日收盘时平仓。

OpenRangeBreaker短线突破交易系统不去预测未来的市场行情是震荡还是大单边走势，它认为只要今日价格从开盘价向上或向下突破了昨日震荡的N倍，那么价格本身就会发出日内单边行情的预警，投资者只要跟随市场传递的信息顺势入场操作即可。可以说，大部分的交易时机都出现在早盘，甚至是早上第一个小时内，之后你要做的就是承担日内的波动风险，让利润奔跑，或者及时平仓离场。如图5-13所示。

图5-13 经典OpenRangeBreaker逻辑图解



经典OpenRangeBreaker核心逻辑（仅多头部分）用交易开拓者撰写代码如下：





OpenRangeBreaker日内突破交易系统从原理上来说并不复杂，NATRbreaker系数大致设定在0.3～0.5，大部分品种都可以这样设置，低波动率品种需要增加到0.5以上。依然是因为模型拆分多空的原因，这里仅给出多头模型的核心逻辑，空头同理。但如果将此框架用于实际商品期货和股指期货品种，就会发现其性能并不理想，盈利能力偏弱，资金曲线并不好看。

核心原因是这类模型完全不承担隔日风险，过度追求安逸的日内利润导致其损失了大部分盈利机会，隔日的跳空往往蕴含着日内定价没能完成的部分，在一轮升势或者跌势中，这种动能持续的概率较大，所以跳空也有部分利润。我们对其进行改造的核心就是让模型在日内不要强制平仓，而是承担一些隔日的跳空风险，尝试获取一些收益。另外，日内模型在把握大趋势方面能力偏弱，我们可以考虑通过大周期均线过滤，给予其一些方向性保护。

2.对OpenRangeBreaker进行改造

（1）延续持仓到次日，承担隔日风险，获取隔日收益。

原来的平仓条件如这样，0.225000代表螺纹钢等在夜盘23:00结束交易的品种，在本日的最后一个K线上带的时间信息：

//当日收盘止损

if（MarketPosition==1 && time==0.225000 && BarsSinceEntry > 0）

{

Sell（0,open-SplitRate）;

}

我们删除该条件，将其改为次日反向运行1跳离场，如果次日高开高走，完全没有回落迹象，那么我们将持有这个头寸，&&Date[barssinceentry]<>date代表平仓日不是本日。这个逻辑在一些价格大幅度上升的过程中，保留了持仓不被平掉。此时系统是名义上的日内模型，而实际上已经可以覆盖一些阶段性趋势。需要注意的是，止损平仓条件Low<=topen-minpoint依然作为一个非常严格的出场条件存在，价格一旦有向下趋势，模型会以最快速度在本日平仓。

if（MarketPosition==1 && time >=0.090000 && BarsSinceEntry > 0 &&Date[barssinceentry]<> date

&& Low <=topen-minpoint）

{

Sell（0,min（open,topen-minpoint）-SplitRate）;

}

我们选择螺纹钢指数合约，在5%%手续费下，不设置滑点测试该模型，因为该模型交易次数偏多，如果设置1跳滑点，盈利情况会很快恶化，考虑到国内期货市场充裕的流动性，实盘中甚至有机会吃到负滑点，所以可以这样设定手续费。但是对于其他中长线模型，需要设置至少1跳滑点，高价格品种可能要设置5跳滑点左右。

在测试中，为了考虑不仅一个参数的取值带来的偏差，我们将 NATRbreaker和NATRstop（分别控制入场和出场）参数都从0.1～0.6扫描一遍，间隔为0.02。测试时间从2015年1月1日到2018年1月31日。如图5-14所示数轴上的两个参数，都被做了放大100倍处理，以方便观看，所以看到的X轴和Y轴是10～60区间。

通过RB螺纹钢指数，即可发现这种改进的性能差异之巨大，平均净利润从4043元到16000元，平均夏普比率从0.5156到1.3631。最佳参数组对应的净利润也达到了25430元，而之前仅有7805元，如图5-15所示。

更重要的是，我们想要的结果在逐步达成：其NATRbreaker参数明显降低，说明系统能够在更低的阈值线开仓，面对更多复杂的入场情况，依然能够达到此净利润。而如果强制日内平仓，则NATRbreaker参数必须达到0.48附近。

图5-14 本日平仓（左）和隔日平仓（右）参数分布效果对比



图5-15 本日平仓（上）和隔日平仓（下）参数面盈利能力获得提升



过滤之后我们发现参数面绩效变化如图5-16和图5-17所示。

如果考虑到交易次数对绩效的验证能力，隔日平仓不仅取得了较高的净利润和夏普比率，还取得了更高的绩效可信度评价。从图5-16也可以看到改进前后的资金线变化情况。读者如果对此策略感兴趣，也可以进一步测试其他品种在改进之后的表现，大部分都能获得极大的性能提升。

图5-16 净利润变化



图5-17 夏普比率变化



（2）加入大周期均线过滤和交易次数限制。

加入大周期均线过滤和交易次数限制有两种思路可用，一种是直接调用一条本周期大参数的均线，比如MA200均线，作为做多和做空的辅助方向确认。因为本模型运行在10分钟K线上，每日大概有24～42条K线，所以MA200大致也考察到了5～10日的日内走势均值。

我认为这种改进并不十分彻底，如果要引入方向性保护，最佳方案是从低频率K线上寻找一个理想的均线值。我们依然启用最早撰写的MADD函数，多头引入MADD5或者MADD20这样可以被确认有效的均线对策略进行改进。

DayMADD=madd（MADDLength）;

这里的MADDLength可以定义为参数，取值5或者20。

交易次数限制的逻辑很简单，策略如果在日内被平仓，价格一旦出现休整后继续上行，有一定概率会再次入场，我们强制要求类似的日内和短周期策略每天入场1次，被平仓后也不再入场。首先定义一个变量（或参数）Numeric maxbuy_times（1）;，即每日最大开仓次数，其次定义一个变量Numeric buy_times;，即在每日9:00的位置，定义buy_times=0;。相应地，开仓条件改写为：

//开仓（在限制时间范围内）

If（MarketPosition==0

&& buy_times < maxbuy_times

&& high >=BuyRange && topen >=DayMADD）//当前Bar的最高价突破买入开仓价格

{

Buy（lots,Max（Open,BuyRange）+SplitRate）; //买入开仓+追价点

buy_times=buy_times+1 ;//开仓后增加交易次数1次

}

这次我们使用螺纹钢2010年1月1日以来的数据测试该模块对性能的改进程度，如图5-18所示。

显然，通过上图底部的坐标轴可以看到，过滤后最高性能达到2.8万元，过滤前只有2.3万元。过滤前参数呈现条状分布，NATRstop 参数几乎失去意义，在每个NATRbreaker截面上性能都是类似的，这意味着模型中的一个重要逻辑——日内止损逻辑无法产生效果。过滤后性能出现一个显著的高原，大致在 NATRbreaker=0.2和NATRstop=0.3附近，X轴和Y轴上的两个参数都被做了放大100倍的处理。这和第一点改进类似，更严格的大周期保护让小周期突破判断出现更强的有效性。

图5-18 不使用大周期过滤（左）和使用MA20日频过滤（右）



过滤之后我们发现参数面绩效变化如下，同样还是螺纹钢指数，如图5-19和图5-20所示。

需要提示一点，我们在多头部分采用20周期日频过滤，而空头部分采用5周期日频过滤，如果你的迭代更加有效，则多头的过滤周期也可以进一步缩短，因为20周期才允许做多的确失去了一些阶段性的入场机会，造成该模型不能有效和中长线趋势追踪模型起到资金曲线波动（回撤）对冲作用。但是不要在这个周期上做参数拟合，这样做没有太多的实践意义。

图5-19 净利润变化



图5-20 夏普比率变化



（3）加入带延迟硬止损，确认必须情况下再离场。

常规意义上的止损都要快速执行，越快离场越好，因为触及止损位之后，价格有可能进一步向不利方向运行。但是在日内模型上，尤其是在较高频率K线上运行的模型，往往容易受到日内快速反向运行的困扰，甚至一些价格巨变被称作乌龙指，这些价格的变化幅度之大、速度之快，让止损不仅在不利点位运行，且具体下单时有可能面临流动性不足的情况，这是非常不利于模型性能改进的。

我们构建了一个新的止损识别模块，在多头情况下，必须出现连续6个Bar的最高点（过去1小时高点highest_high_1_6=highest（high[1],6）;）衡量其是否有效低于止损位，才认定这次止损是有必要发生的。也就是说，必须出现1小时的价格运行区间低于止损位再运行止损，这有效改进了价格噪声大、起伏不定造成不利于实际发单或者止损的情况。空头也采用同样的原理设计，只不过略短一些，构建一个变量lowest_low_1_3=lowest（low[1],3）;，当此变量高于止损位时再止损。

这和我们通过长期建模来发现close时不仅不慢，而且准确性很高是一样的原理。在高噪声环境下欲速则不达，既然使用high和low价格的误判率很高，不如使用稳定的close价格，甚至使用这种确定性的价格区间来衡量是否有止损的必要性。这里也有很多读者疑惑，如此慢速的止损会失去价格第一时间下穿的时机，但是经过测试可以发现，它微弱地改善了绩效，因为那些严重到必须要止损的点位，往往伴随着价格反转，即使不幸在很不利的位置才止损，也仅是一次亏损而已。这个模块的构建用胜率换取了盈亏比，在高频率时间序列K线模型上有通用借鉴意义。

相应地，代码被修改为：

//当日ATR止损（在开仓区间外）BarsSinceEntry < BarPreDay意为持有周期小于今天所有的bar总数

if（　MarketPosition　==　1　&&　BarsSinceEntry　>　0　 &&　BarsSinceEntry　<BarsSinceToday_

&& highest_high_1_6 <=topen-NATRstop*DATR）

{

Sell（0,open-SplitRate）;

PlotString（"HardStop","HardStop",high*1.01,White）;

}

使用更具确定性的止损价位之后，通过RB螺纹钢指数测试，我们发现参数面绩效变化如图5-21和图5-22所示。

图5-21 延迟止损后净利润的变化



（4）根据低频率（大周期）环境调整风险头寸。

最后一些可行的建议是，使用日频级别的ATR不仅计算开仓点位，而且要进行头寸负相关控制，越是突破类模型，越需要类似的仓位分配方法，和本书之前的模型构造ATR波动比率一样，我们构建一个2周期和10周期的日频ATR波动比率：

//计算ATR比率atrratio

ATR_Ratio=ATRdd（2）/ATRdd（10）;

//计算分配得到的资金和开仓手数

Margin=MarginRatio（）;

Lots_temp=Floor（money/（Margin*open*ContractUnit（）*BigPointValue（））,1）;

lots=Lots_temp /ATR_Ratio ;

图5-22 延迟止损后夏普比率的变化



该模块的性能我们在之前的中长期模型上已经验证过，但是到日内级别的频率上，该模型是否有价值，还需要测试数据证明，如图5-23至图5-25所示。

图5-23 螺纹钢头寸调整效果



图5-24 棕榈油头寸调整效果



图5-25 白银头寸调整效果



该模块带来的收益不仅体现为最高收益更高，更主要的意义是增加了参数赢面，提升了总体参数面的性能。之前一些无法盈利的参数在这个模块的风险控制下，变得可以盈利，所以我们看到对于参数面“总体夏普比率”的提升幅度更加显著。

总体而言，我们在多品种上部署了这套模型，在有充足交易次数的验证下，得到的绩效汇总如表5-2所示。

表5-2 各品种绩效汇总



收益风险比为2.54，夏普比率为1.92，盈利比率高达47.48%，盈亏比相应较低，但也有1.51。作为日内策略，整套模型作用于14个波动较为流畅的品种，平均持平周期仅为30个K线，也就是300分钟。换言之，5个小时的持仓时间小于每日6～7个小时的交易时间，可见出场和风控非常积极。

在总净利润达到2073199元的同时，我们使用较为严格的5%%手续费，所以付出了1078711.35元的交易成本，符合这类较高频率交易的模型特性，也有同行在构建这类模型时，采用交易所手续费+1跳滑点的形式来测试绩效，得到的绩效情况会显著好于本书测试的结果。

在实盘中，只要突破追价速度正常，手续费在1%%左右，且在发单方面做到更好的控制，就会使交易成本控制更完美。所以读者可放心运行该模型，如果遇到期货市场有较大波动，则实盘绩效要高于回测绩效。

以下是该模型源码，也可以通过扫描二维码获得。其中涉及调用日频ATR数值TrueRangeDD和求日频MA均线MADD两个自定义函数源码，分别在AMA模型章节和双频率模型章节中有分享。





第6章 股票多因子模型实战



6.1 理解回归问题的原理


请允许我用一些篇幅再次讲述这一问题，因为它涉及股票、期货等资产的更高级模型的建立，这是一个基础数学问题，但很多交易者因为无法理解而被拦在学习和进步的道路上。

比如，你发现有些人收入高（因变量Y），然后又发现了他们的特征，如学历高（自变量X1 ）、颜值高（自变量X2 ）、工作经历丰富（自变量X3 ）……但不确定这个规律是否普遍存在。

那么接下来通过不断观察，把地球上的人都调研一遍，然后再宣布你的结论，这显然是不现实的。合理的方法是，进行抽样分析调研，去寻找因变量Y和自变量X之间的关系，然后用一个公式近似表达这种关系。这种可以被定量的数学关系才能服众。未来当新数据进入时，你获得了它们的三项自变量X1 、X2 、X3 ，即可求出Y。

或者这样描述：根据相关变量的实测数据和历史资料建立变量间关系的数学表达式，就是运用概率统计理论去判明所建立的数学表达式的有效性，这个过程一般由回归（Regression）得到，这是一个将散点测试数据（你采集到的样本数据）方程化（形成一个直线方程就是线性回归，形成一个曲线方程就是非线性回归）的过程。这就是回归问题的本质。

回归帮助我们构建散点之间的基本关系函数，“拟合”这个定义更倾向于具体方法，它帮助我们优化函数参数，或者改变函数形式。

如图6-1所示，在图上部分中，我们认为影响商品零售总额的因素只有一个，即职工工资总额，所以回归得到一条直线Y=aX+b，这是一元一次回归，线性是说自变量的指数是1次。在图下部分中，根据一堆空间散点回归得到一个曲面，是三元多次回归，也称为多元非线性回归，我们用它对一个多项式进行拟合，将要拟合的多项式进行展开，得到的其实就是一个类似因变量Y与多个自变量X1 ,X2 ,…,Xn 之间的表达式：Y=β0 +β1 ×X1 +β2 ×X2 +…+βp ×Xp +e。这里的β0 、β1 等是自变量系数，或称为参数，一般β0 为截距项。

我们使用软件调用函数直接得到结果，略过了回归过程，为什么那条直线是最好的？为什么那个曲面是最好的？回答这样的问题，需要掌握一项知识：多元线性回归模型的参数估计，同一元线性回归方程一样，也是在要求误差平方和［Σe,Sum of the squared errors（SSE）］为最小的前提下，用最小二乘法求解参数。近似成立且误差最小，是最小二乘法在回归分析实际问题中最杰出的贡献。

最小二乘法为什么被广泛采用？举例而言，对于一元线性回归模型“职工工资总额”和“商品零售总额”的关系，对于平面中的这n个点（每个点的坐标是（Xn ,Yn ）），可以使用无数条曲线来拟合。要求样本回归函数尽可能好地拟合这组值，所以选择最佳拟合曲线的标准可以确定为：使总的拟合误差达到最小。

最小二乘法以“残差平方和最小”确定直线位置，残差先平方，所以正值和负值没有抵消。使用最小二乘法除了计算比较方便外，得到的估计量还具有优良特性。缺点是这种方法对异常值非常敏感。如图6-2所示。

图6-1 一元线性回归（上）和二元非线性回归（下）



图6-2 最小二乘法使所有观察值的残差平方和达到最小



普通最小二乘法（Ordinary Least Square,OLS）：所选择的回归模型应该使所有观察值的残差平方和达到最小，即采用平方损失函数RSS：



回归问题确定几个变量之间的关系，我们自然会想到：能否分析因子A、因子B作为自变量X1 、X2 ，它们和价格Y的关系（是否能用因子A和因子B共同解释价格Y），接下来是一个案例，通过回归市值和波动幅度的关系，寻找我们常说的“大盘股炒不动，小盘股很活跃”这一概念，如图6-3所示。

图6-3 全市场市值小于1000亿元样本股市值X和5日价格波幅Y的关系



在接下来的内容中，我们经常会涉及回归问题，通过它求出因子和价格的关系，训练出一个稳定的可以用数学公式表达的方程，当有新的数据进入模型时，即可求出新的价格（拟合价格）。绘制图6-3所示结果的参考代码如下（在聚宽研究平台上运行）：





6.2 基本的统计学知识补充


走出学校时间越久，对知识的印象越浅，面对这样的读者，我们提供本节内容，作为一个临时的知识储备，以应对后文。

1.标准差——衡量波动率

标准差是基础的统计学概念，同时又非常重要也非常好用。一个较大的标准差，代表大部分的数值和其平均值之间差异较大（分散）；一个较小的标准差，代表这些数值较接近平均值（集中）。标准差和方差表示分布的离散程度。标准差越大，随机变量取值偏离平均值的可能性越大。

标准差的公式如下：



通过公式可以看出，标准差是每一个样本和均值的离差平方和，除以样本数量，再开平方。有时候变量值和自己的均值是反向偏离的，所以这里加入平方，消除方向性，只保留偏离程度。

或者将其概念和方差联系起来，一组数据中的每个数分别减去这组数据的平均数的差的平方相加起来除以这组数据的个数，就是该组数据的方差，方差再开平方即为标准差。标准差可以衡量当前价格和价格均值的关系，也可以衡量当前业绩和平均业绩的关系。

在价格模型中，如果价格的均值和当前值差距很大，那么一般体现为标准差过大，不管是短期涨得太多，还是跌得太多，都是单边风险的体现，此时我们认为价格将更容易回归到自己的均值。此时我们可以降低开仓头寸，或者不开仓等待标准差回归到合理范围（当然，如果出现连续单边行情，也意味着失去机会）。



在常用的目标函数夏普比率中，如果我们设定Rf：无风险利率=0，则这个公式简化为：投资组合的收益率除以标准差。其含义是，标准差太大，即使有较高的收益率，绩效也被认为不稳定（过山车式的资金曲线，标准差大），夏普比率降低。反过来想，每天只赚一点点收益，但是每天收益率的波动率（标准差）很低，很少有负回报，也很少有爆赚，夏普比率也会很高。

2.协方差和相关系数——评定变量变化方向

标准差和方差一般是用来描述一维数据的，通俗地说，是用来描述一个价格变量内部的情况的。而协方差，就是两个价格之间的关系了。协方差是一种用来度量两个随机变量关系的统计量，其定义为：[（X-E（X））（Y-（Y））]/n-1，可以直观地解读为：X和自己的均值离差，乘以Y和自己的均值离差，除以样本数量。

协方差可以理解为两个变量在变化过程中方向是否相同。同向协方差为正，反向协方差为负。从数值来看，协方差的数值越大，两个变量的同向程度也就越大；反之亦然。



那么变量X和变量X的协方差Cov（X,X）呢？实际上就是X的方差。同时，对角协方差相等，Cov（x,y）=Cov（y,x），即x和y的协方差值等于y和x的协方差值。

在价格模型中，协方差可以评定两个变量的协同程度。但因为两个价格通常有量纲，所以我们常用相关系数来替代协方差，因为其更为方便好用。两者的含义类似，公式也有千丝万缕的联系。

相关系数=X和Y的协方差除以X的标准差和Y的标准差乘积。它剔除了X和Y自己的量纲，现在情况简单了。相关系数是有值域范围的，即0～1，意味着完全不相关和完全一致。

相关系数比协方差好用，两个投资产品的相关系数是指一个投资产品的市场表现给另一个投资产品的市场表现所带来的影响程度。进行资产配置，不同投资产品之间的相关系数越低越好，从而能够起到分散风险的作用。具体到管理仓位和头寸，如果几类资产的相关系数低，那么仓位中持有的头寸总量可以稍大，有对冲效果。有时持仓资产不多，但从基本面逻辑上，或者从统计中体现为资产高相关，那么也要注意同向波动危险。

相关系数还可以几何抽象为两个向量的内积，空间中标准差是向量的模，而协方差是向量的内积。两个向量的夹角余弦的绝对值越大，表明两个向量越接近共线，所以相关系数就是两个向量夹角的余弦值。

在股票多因子模型中，有一个趋同度因子，计算两两股票窗口期内相关系数矩阵，然后对这个矩阵求均值，如图6-4所示。该因子表示个股在某段时间趋同一致波动，当因子值很高的时候，是一种风险（价格反转）的体现，因为这可能意味着市场上出现了巨大的利好或者利空，下阶段个股将重新回到正常的分化格局。

图6-4 趋同度因子



3.spearman（斯皮尔曼）秩相关系数——低噪声衡量相关性

相关系数分为三种算法，即pearson（皮尔森）、spearman和kendall（肯德尔）。前面讲解的是第一种，即pearson，也即最常用的皮尔森相关性系数，两个变量（X,Y）的皮尔森相关性系数Correlation（X,Y）等于它们之间的协方差cov（X,Y）除以它们各自标准差的乘积（σX,σY）。



在因子模型中，还经常要用到第二种，即spearman相关性系数，通常也叫spearman秩相关系数，也有资料翻译为等级相关系数。“秩”可以理解为一种顺序或者排序，它根据原始数据的排序位置进行求解，这种表征形式就没有了求皮尔森相关性系数时的限制（必须假设数据是成对地从正态分布中取得的，数据至少在逻辑范围内是等距的）。

如图6-5所示，左图我们认为是spearman算法在一定程度上的不足，因为两个数据集不是完全的线性相关，但是其求出的1相关系数也基本符合数据特征。右图是spearman算法在面对噪声数据时的优势，它用排序方法表征出右侧5个数据点是离群点，不影响相关性全局。而pearson算法由于对整体数据做分析，无法剔除噪声数据的影响。

图6-5 spearman和pearson算法求出的不同相关系数值



所以，pearson算法是针对原数据计算的，而spearman方法是针对排序序号计算的，排序不容易受异常值影响，实际上完成了降噪过程，所以它成为我们主要的因子分析工具。我们经常用因子值对股票进行排序，然后计算股票收益率，再将其和因子值做spearman相关分析。

4.Z-score——归一化去量纲

想要把不同的变量处理到同一个区间的办法很多，比如0-1标准化，这是一种线性函数转换：



但是这种方法（线性转换）使得其协方差产生了倍数值的缩放，因此这种方式无法消除量纲对方差、协方差的影响。由于量纲的存在，使用不同的量纲、距离的计算结果会不同。

还有更为科学的方法，我们常用Z-score标准化，它是一个样本与平均数的差再除以标准差的过程。用公式表示为：



其中，x为某一具体数据，μ为平均数，σ为标准差。Z值的量代表着原始数据和母体平均值之间的距离，是以标准差为单位计算的。当在原始数据低于平均值时，Z为负数，反之则为正数。

Z-score可以回答这样一个问题：“一个给定分数距离平均数有多少个标准差？”在平均数之上的样本值会得到一个正的Z-score数值，在平均数之下的样本值会得到一个负的标准Z-score值。

需要说明的是，Z-score没有改变数据的分布情况，可以理解为没有改变数据点之间的距离和方向，这个统计量在执行Z-score前后，概率密度频数是不变的，如图6-6所示（很重要，所以我们可以大胆用它）。Z-score方法由于对方差进行了归一化，所以这时每个维度的量纲其实已经等价了，每个维度都服从均值为0、方差为1的正态分布，在计算距离的时候，每个维度都去量纲化。

5.MAD绝对中位值——去离群点

中位数大家都明白，即将统计总体中的各个变量值按大小顺序排列起来形成一个数列，处于变量数列中间位置的变量值就称为中位数。

MAD（Median Absolute Deviation）绝对中位值，也被翻译为中位数绝对偏差，是先求出给定数据的中位数，然后原数列的每个值与这个中位数求出绝对差，并组成新数列，新数列的中位值就是MAD。

图6-6 Z-score标准化前后数据的量纲（X轴）变化，但概率密度频数（Y轴）不变



|X-midddle（X）|可以理解为每一个样本与自己的中位数的距离，然后对距离求中位数值，就得到了MAD。

在股票多因子模型数据清洗环节中，研报上用过这样一种方法，我们也认为这种方法很管用：将个股因子值计算MAD，然后将大于“因子值中位数+3×1.4826×MAD”的值，或小于“因子值中位数-3×1.4826×MAD”的值定义为异常值。这里的“1.4826×MAD”大致是一个标准差的宽度。

6.概率密度函数PDF——描述数据概率密度

概率密度函数PDF（Probability Density Function）可以查阅到的定义很简明：描述随机变量的输出值，在某个确定的取值点附近的可能性的函数。PDF的函数值高低，描述了数据在哪个区域分布的高低。

比如正态分布，在μ处数据分布最多（我们描述为概率密度值最高），所以函数值最高。在左右两侧，概率密度值降低，说明数据点分布变得稀少。正态分布在第一个CTA模型Aberration系统中已经讲解过。

在正态分布函数图像上，f（x）是指随机变量X（大写X，变量集合）在观察值为x（小写x，某个数值）时的概率密度值，而不是概率值。PDF函数曲线与X轴所围成的面积表示概率，该面积等于1，因为随机变量的所有可能取值（100%）都在X轴上。

图6-7所示为中证500指数2016年12月31日之前的概率密度函数，将价格做收益率转换之后，用histfit函数绘图，发现左侧明显肥尾（较大的涨跌幅分布在较远的位置），整体峰度偏向右侧（上涨偏多）。

图6-7 中证500指数2016年12月31日之前的概率密度函数



μ是变量X的均值，如果是标准正态分布，则μ=0。比如我们理解为，在数据量很大的情况下，股票每日涨跌幅服从类似正态分布的概率密度函数。实际上股票价格服从的是尾部更肥硕（肥尾）正态分布，表示极端大涨大跌更多；右偏（偏锋）表示上涨总体情况偏多，这样的一种类似正态的分布。

还可以记忆一个定义：任何连续概率密度在（负无穷、正无穷）积分后结果都是1。这里利用定积分的性质，其结果是一个数值而不是一个函数。对于一个给定的正实值函数，在一个实数区间上的定积分可以理解为：在坐标平面上，由PDF函数曲线、直线及轴围成的曲边梯形的面积值。随机变量X取到其具体某个值x的所有概率之和等于100%，这个积分值就等于1。

7.累计概率分布函数CDF——描述数据分布变化趋势

CDF（Cumulative Distribution Function），完整描述一个实数随机变量X的概率分布，是概率密度函数的积分。PDF是密度，CDF是分布函数，一定要区分清楚，两者也有很多联系。

CDF作为概率的累计情况，其图像的纵轴是累计概率，横轴是随机变量X的分位数。

它表示随机变量小于或者等于某个数值的概率P（X≤x），即F（x）=P（X≤x）。

以图6-8中下面的图从左边数第3条曲线（均值=1，标准差=1的正态分布随机变量）为例。

图6-8 正态分布的概率密度函数PDF和累计概率分布函数CDF图像



阶段1（x＜-2时）：从左向右看，随着样本值越来越多，CDF的曲线开始缓慢上行。你可以理解为X取到小于-2的值的概率非常小，在Y轴上对应可以看到，大概在0.05左右。

阶段2（-2＜X＜2时）：当x=-1个标准差时，由于样本值在这个区间密度增加，CDF曲线开始加速上行，取到该部分任何数值（-2,2）的概率都在快速增加。这一阶段的CDF函数值为0.05～0.95，你可以理解为，大部分取值的可能性都在这个区间发生了。

阶段3（x＞2时）:CDF曲线减速缓慢上行。和阶段1类似，由于随机变量X在这部分的值已经不集中了，自然X取到某个值x的概率也就变小，增量最后趋近于0，函数值趋近于1。

刚才我们谈到了CDF曲线上行的速度，实际上累积分布函数存在以下几个特点：累积分布函数是X轴单调递增函数；对于给定的数据集，累积分布函数是唯一的；累积分布函数值趋近于1。

CDF和PDF的关系？其实很简单，PDF描述了CDF的变化趋势，即PDF是CDF曲线的斜率。PDF是一个大于0的数，表示斜率无论如何都不会到0轴以下（CDF永远是增加的）。PDF最终趋近于0，代表上升速度变缓（即 CDF最终逐渐地累计上升到趋近于1）。另外，CDF和PDF的横轴X都是一样的，表示将变量X按顺序排列。

图6-9所示为中证500指数累计概率分布，X=0.04011对应的Y=0.9742，意味着超过4%涨幅的日上涨天数，不足总体样本的3%。可见A股下跌起来都比较猛，而涨起来却比较慢。这是符合行为金融学的，不过最终总体趋势还是上涨的，因为上涨的天数还是多一些，虽然幅度较小。CDF图像帮助我们观察到，大于横轴某一数据点（分位数）的数据点数量，占总体的比例。

8.分位数——判定数值属于哪个区间并分类

有了之前对CDF累计概率分布函数和PDF概率密度函数的知识铺垫，了解分位数变得更容易。

图6-9 中证500指数累计概率分布



我们之前了解到，一个随机变量PDF和坐标轴X轴围成的面积=1，意思是所有单独元素x在集合X中被取到的概率之和=100%。CDF的函数值单调递增，且趋近于1。相应地，50%分位数，就是变量的中位数（不是均值，而是分位数）;25%分位数，是变量中顺序排序到1/4位置的那个数字。

那么在什么位置概率之和=90%？答案就是在0.9分位数，或者说90%分位数的时候。同理，什么时候概率之和=10%？自然是在10%分位数的时候。

在统计学中，我们常接触到四分位数的概念。四分位数（Quartile），即在统计学中，把所有数值由小到大排列并分成四等份，处于三个分割点位置的得分就是四分位数。如图6-10所示。

第一四分位数（Q1），又称“较小四分位数”，等于该样本中所有数值由小到大排列后第25%的数字。第二四分位数（Q2），又称“中位数”，等于该样本中所有数值由小到大排列后第50%的数字。第三四分位数（Q3），又称“较大四分位数”，等于该样本中所有数值由小到大排列后第75%的数字。

图6-10 分位数与箱线图



第三四分位数与第一四分位数的差距又称四分位距。

Q1点的位置=（n+1）×0.25

Q2点的位置=（n+1）×0.5

Q3点的位置=（n+1）×0.75

然后以Q1、Q2、Q3将变量里的每个样本，分成四个相等数量的部分，可以通过Q1和Q3的比较，分析其数据变量的趋势。

# 获得本期因子值，并按因子值排序股票

df_c=df_c.sort（columns=g.factorname,ascending=True）

df_clist=df_c['code'].tolist（）

# 分5组，每组从start_index到end_index,stock_num是分位数值

stock_num=len（df_clist）/5

start_index=g.groupnum*stock_num

end_index=g.groupnum*stock_num+stock_num-1

order_list=df_clist[start_index:end_index]

上面这段Python代码描述了在获得因子值和股票名单df_c之后，对其按照因子值升序排序，然后按 df_clist 元素数量分5组，stock_num 是分位数值，全局参数g.groupnum可以设定为0～4，代表具体测试哪一组。最后得到的 order_list就是该组要下单的股票名单。如图6-11所示。

图6-11 多因子模型中涉及的分组研究收益率





6.3 股票多因子模型的实质


股票多因子模型是一种选股模型，首先确定一个日期截面（通常我们会确定一个日期间隔，比如10天，或者每月第一天），在此日期上，通过每只股票在某个因子值的得分高低，选择相应的股票，这就是打分法因子模型。这个日期也被称为调仓日期，或调仓间隔、持仓周期，比如每月或每周的第一个交易日。

1.截面回归区分好坏股票

在此之前要进行单因子研究，通过某个因子值和每只股票收益率（一定要用上期因子值和上期到本期的收益率），做该日期截面线性回归，然后计算IC（秩相关信息系数）、ICIR（秩相关系数的信息比率）等各项评估指标，确认因子有效后，买入因子值较高（正向因子）或较低（反向因子）的股票，这就是回归法因子模型。由于股票数量动辄达到几百上千个，截面上数据点足够多，线性回归得出的结论也会相对稳健，且如果设置每周调仓，每年也能有52个回归结果，可以得到对某个因子稳健的评估指标。

这里所说的股票多因子值，有基本面财务因子（一般在财报中，每季度更新），有舆情大数据因子（需要发挥编程实力通过NLP人工语言识别等方法处理成因子），还有传统的高效且高频的量价因子（如价格波动率、动量、高低区间、量价一致关系等，又如World Quant挖掘并公布的101个因子）等。如图6-12所示。

图6-12 常见的基本因子选股



如果从数学的角度来看，因子选股模型仅仅是一个从因子到资金曲线的映射。实际上，不仅是股票多因子模型，期货时间序列模型也是一个将时间序列传入模型，导出资金曲线的函数。这也可以说是程序化交易的实质。

股票多因子模型的最终目标是在给定的样本空间范围内，稳定地预测股票未来收益率的排序，即把“好股票”和“坏股票”区分开来。构建模型最为核心的两个步骤是因子的挑选和不同因子之间权重的分配方式。

这一点和期货模型有显著区别，期货模型大部分是部署在单品种上的时间序列模型，虽然也考察了全市场情况和相关品种走势，但依然是以单序列方向性交易为主的。而股票模型侧重于全市场调仓选股、换股，毕竟股票市场有2000多个交易规则一致的标的，而期货市场只有不到30个活跃品种，且期货市场基本面差异极大。

这也决定了股票模型和期货模型的开发方式不同，期货模型更加侧重在单一时间序列上进行分析，进行择时等方向性交易，或者在两个事件序列构成的价差、比价序列上进行分析。而股票模型更关注全市场的情况，更关注全市场在某个日期截面上的表现、某个因子对股票收益率的描述程度（比如在某一天，全市场3000只股票的换手率是一个可以用来评价个股活跃度的因子）。如图6-13所示。

图6-13 从时间序列到单因子再到多因子模型



2.建立多因子模型的大致步骤

1）单因子测试

首先计算出因子值，然后将本期因子值和股票下期收益率对应（比如上周五收盘时的因子值和上周五到本周五期间的价格收益率对应，因为我们假设上周五得到因子值后，按因子值选股，其要对未来一周的收益率负责），放入回归函数进行线性回归。比如在Python的statsmodels库中，提供了regression.linear_model.OLS（Y,X）.fit（）函数，输入：X：回归自变量（因子值）,Y：回归因变量（超额收益率），回归得到截距和斜率。斜率（回归系数）在研报中被称作因子收益率。

紧接着计算因子的收益率序列t值，因子IC、ICIR等绩效。

每个调仓日期上的IC=Correlation（上期回归系数X1 ，本期股票收益率），也就是求相关系数或秩相关信息系数。

ICIR（IC值的信息比率）=IC.mean/IC.std,ICIR是IC的均值除以标准差，也就是IC值在回测时间段内的信息比率。

IC值有正有负，如果是正值，则正向影响股票价格；如果是负值，则负向影响股票价格，测试中加负号使用即可。当然，还可以分析全段 IC大于0的比例（IC必须显著大于或小于0，以表明自己不是一个白噪声），全段IC绝对值大于0.02的比例（一般认为IC大于一定数量级，即拥有了对股票价格的显著影响能力），全段因子收益序列的假设检验t检验值，以分析这个因子是不是能够显著决定股票的收益率。在此提醒各位读者，测试得到的值仅是相关性，而非因果关系，这是在量化投资中需要反复思考的问题。

将股票池中的个股按因子值大小进行分组，比如分为5～10组，计算每组在一段时间内的收益情况。为了防止该因子和一些已知的因子存在较强的相关性，有时需要将收益率对已知变量做回归，然后对残差进行分组测试。也可以求出不同因子的收益率曲线的相关系数矩阵，从中去除相关性太高的因子，从而避免出现多因子回归的共线性问题。

后文有对这部分内容的介绍，并提供了参考源码，读者可以更广泛地测试自己撰写的因子是否拥有超额收益率或非常强烈的IC秩相关信息系数。

2）分配多个因子权重

比如为了最大化超额收益，可以采取因子IC法。如若为了最大化夏普比率，可以计算各因子的收益率和协方差矩阵，然后采用优化的方法求解权重。

股票市场上有哪些类型的因子？要根据市场经验和经济逻辑选取。选择更多、更有效的因子能增强模型的信息捕获能力，如一些基本面指标（PB、PE、EPS、增长率）、技术面指标（动量、换手率、波动、技术指标值），或其他指标（预期收益增长、分析师一致预期变化、宏观经济变量）。

影响股价走势的主要因子包括：

◎ 市场整体走势（市场因子、系统性风险）。

◎ 估值因子（市盈率、市净率、市销率、市现率、企业价值倍数、PEG等）。

◎ 成长因子（营业收入增长率、营业利润增长率、净利润增长率、每股收益增长率、净资产增长率、股东权益增长率、经营活动产生的现金流量金额增长率等）。

◎ 盈利能力因子（销售净利率、毛利率、净资产收益率、资产收益率、营业费用比例、财务费用比例、息税前利润与营业总收入比等）。

◎ 杠杆因子（负债权益比、资产负债率等）。

◎ 交易因子（前期动量幅度、前期涨跌幅、前期换手率、量比、股价振幅、日收益率标准差等）。

◎ 规模因子（流通市值、总市值、自由流通市值、流通股本、总股本等）。

◎ 红利因子（股息率、股息支付率）。

◎ 市场预期因子（预测净利润增长率、预测主营业务增长率、盈利预测调整等）。

市场是不断变化的，市场参与者也会不断进化以适应这个市场，自然一些因子也会失效。所以，除开发模型外，我们必须有能力寻找新的因子加入到因子库中。同时，各因子的权重设计也有进一步的改进空间，或随市场变化进行改进。千万不要以为因子模型构建出来就可以完美应对市场波动了，我们做量化投资绝对不是开发印钞机，毕竟模型是由数据验证得到的，我们拿出再强有力的逻辑证据，也无法避免模型的数据挖掘特性，所以一定要迭代和升级。

3）得到“股价打分公式”，买卖股票

进入到买卖规则方面，多因子模型的实质不是择时，而是选股。既然是选股，就要有一个统一的标准，这个标准是：Yi =β0 +β1 ×X1 i+β2 ×X2 i+…+βk ×Xk i+εi。其中β0 是线性回归截距，β1 是第一个因子的回归（训练，或者说拟合）系数，β2 、β3 以此类推，βk 是第k个因子的回归系数。

该模型定义为：股价打分公式=截距+上期训练得到的因子系数矩阵×本期因子值矩阵。

如图6-14所示，我们通过regression.linear_model.OLS.fit（）函数，将本期收益率Y和上期因子值X（一般是detaframe多列因子值）放入回归函数，得到的const是截距，也就是股价打分公式的“β0 ”项，因子1的回归系数“X1 ”是“β1 ”，因子2、因子3同理。

根据股价打分公式Yi =β0 +β1 ×X1 i +β 2 ×X2 i +…+βk ×Xki +εi ，带入const、X1 、X2 、X3 ，套用到每一只股票上，即可得到个股得分。

买入的规则一般是按照得分高低排序股票名单，优先买入得分最高的一类股票的一部分，比如前20只、前100只、前10%等标准。

图6-14 多元线性回归结果（可通过print方式在日志部分打印），对应股价打分公式



3.多因子模型的优势

学习多因子模型之前要理解：股票投资的收益可以由收益中的非风险部分、受整个市场影响的部分（收益分解为α和β），以及误差部分三者之和组成，通过资本资产定价模型（CAPM）可以计算出α和β：

y=α＋βx＋c

收益=α收益+β收益+C残留收益

式中，y为某种金融商品预期收益；

截距α为收益中非系统风险部分，是无风险的收益（股票个体带来的收益）；

斜率β为系数，是系统风险部分；

c为误差项，即残余收益（随机因素产生的剩余收益）；

x为整个市场的预期总体收益率。

在本书最后一部分将会讲解到，多因子模型除风险评估模型外，另一大应用是α策略，该策略有三大优势：

一是回避了择时难题，专注于选股。

二是波动率较单边买入持有策略要低。

三是在单边下跌的市场中也有可能盈利，α与市场的相关性理论为0。

市场上的对冲基金，其原理是通过做空股指期货，将β系数降到接近于0，消除β风险，当然也放弃了β收益。但当我们持有这种基金时，将会享受到非常安全的净值增长，而且回撤小意味着你在任何点位入场，都可以获得较好收益，这是大资金，特别是低风险偏好的保险资金、社保基金、企业年金等资金可以配置股市的重要基础。

投资市场交易中面临着系统性风险（β风险）和非系统性风险（α风险），我们将通过对系统性风险进行度量并将其分离，从而获取超额收益（α收益）。获取α收益的策略包括选股、估值、固定收益策略等，它们都是利用衍生工具对冲掉β风险。

α策略反映的是择时之外的选股能力。

当然学界也有研究认为α收益是不存在的，因为它太难以获取。Don M.Chance（2005）的研究认为，寻找α收益的过程是徒劳的，反而会损害投资组合的收益，增大波动性，且这些损失与交易成本无关。但从投资的实践来看，α策略确实获得了成功，α收益显然是阶段性存在的。在中国股市这样高波动和高流动性的证券市场，存在着更多的α机会。





6.4 股票收益50年探索历程


我们在6.3节描述了投资组合获取的收益均可以分为两个部分，一部分是来自市场的收益，也就是贝塔收益（β风险）；另一部分则是超出市场的收益，也就是我们常说的α收益（α风险）。这种分类方式源于资本资产定价模型（Capital Asset Pricing Model，简称CAPM），该模型由美国经济学家W.F.Sharpe博士于20世纪60年代中期首次提出。

1.CAPM

CAPM定义了以下两种风险。

◎ 系统性风险（Systematic Risk）：市场中无法通过分散投资来消除的风险。比如利率、经济衰退、战争等，这些都属于不可通过分散投资来消除的风险。

◎ 非系统性风险（Unsystematic Risk）：也被称作特殊风险（Unique risk 或Idiosyncratic risk），这是属于个别股票的自有风险，投资者可以通过变更股票投资组合来消除。从技术的角度来说，非系统性风险的回报是股票收益的组成部分，但它所带来的风险是不随市场的变化而变化的。

CAPM的公式是：Ri =Rf +βi （Rm -Rf ）

Ri ：在给定风险水平条件下资产i的合理预期投资收益率；

Rf ：无风险投资收益率；

βi ：投资于资产i的风险矫正系数，即对资本市场系统风险变化的敏感程度；

Rm ：资本市场的平均投资收益率。

紧接着，该模型认为市场风险系数是用β值来衡量的，更重要的是，资产收益率仅和β有关，和其他因素无关。单只股票的β则定义为：资产收益率与市场组合收益率（可以理解为市场基准指数）之间的协方差［Cov（个股收益率，市场收益率）］除以市场组合收益率方差［Var（市场收益率）］。因此，可以将CAPM看作以市场收益率为因子的单因子模型。

记住这一点很重要，CAPM是我们接触到的第一个单因子模型，因子名称是β，该因子可以被认为解释了所有的个股波动，或者说解释了一种股票的所有波动原因。CAPM中β无法解释的部分，就是α，也就是线性回归残差。

如果你愿意学习更多有关CAPM的知识，还会接触到它的众多假设，比如：①每个投资者的财富相对于所有投资者的财富的总和来说都是微不足道的。②所有投资者的行为都是短视的，而不是最优行为。③投资者的投资范围仅限于公开金融市场的所有资产，且可以完全分割。④存在无风险资产，投资者能够以无风险利率不受金额限制地借入或者贷出款项。⑤不存在市场不完善的情况，即投资者无须纳税，不存在证券交易费用，包括佣金和服务费等，没有法规或者限制条款限制买空。⑥投资者都是理性的，追求风险的最小化，期望财富的效用达到最大化。⑦所有投资者对证券的评价和经济局势的看法都是一致的。⑧资本市场是无摩擦的，而且无信息成本，所有投资者均可同时获得信息。

可能你觉得这些假设过于严苛，但只有在这样的条件下，CAPM对资产价格的解释才能完全成立。

除提出β因子外，还提出了由风险资产和无风险资产构成的投资组合的“资本市场线”，如图6-15中的线CM。这条线的公式是：组合P的收益率=无风险收益率+资本市场线的斜率×组合P的标准差，它决定了资产的价格。它表明有效组合的期望收益率和标准差之间的简单的线性关系射线，射线与有效资产前沿的切点，就是最佳的资产组合M。在有效资产前沿上，如果投资者选择借入无风险资金投资，这条线就向上延伸为射线。如果投资者选择大部分投资低风险资产，自然它的最优组合也在C到M点内部，不是射线。

随着业界对股票市场研究的深入，CAPM这样的单因子模型已经无法很好地解释资产收益的来源。

图6-15 资本市场线



2.Fama-French三因素模型

Fama和French在1992年提出PB和市值因子对股票的收益率有十分显著的影响，并且基于这个发现建立了Fama-French三因素模型。

Fama-French三因素模型认为，一个投资组合（包括单个股票）的超额回报率可由它对三个因子的暴露来解释，这三个因子是市场资产组合（Rm -Rf ）、市值因子（SMB）和账面市值比因子（HML）。这个多因子均衡定价模型可以表示为：

E（Ri t ）-Rf t =βi[E（Rm t ）-Rf t ]+siSMB t +hi×HMLt

其中：

Rft 表示时间t的无风险收益率；

Rmt 表示时间t的市场收益率；

Rit 表示资产i在时间t的收益率；

E（Rmt ）-Rft 是市场风险溢价；

SMBt 为时间 t的市值（size）因子收益指数（Small comp return Minus Big comp return）；

HMLt 为时间 t的账面市值比（book-to-market）因子收益指数（High btm return Minus Low btm return）。

βi、si和hi分别是三个因子的系数，回归模型表示如下：

Rit -Rft =αi+βi（Rmt -Rft ）+siSMBt +hiHMIt +εit

虽然此模型提出后，由于其三个因子的系数是线性回归决定的，导致了学界批评该模型是数据挖掘，并非长期有效的、有强大逻辑的模型。但它的有效性非常显著，通过查阅资料可知，Fama-French三因素模型解释了70%～90%的个股收益差距，而CAPM仅有5%左右，所以该模型数据挖掘的能力是强大的，且其后来在世界各国资本市场都被验证是有效的。Fama-French三因素模型也是量化类投资公司的重要定价工具，是催生这类公司野蛮生长的有力武器。

其实从CAPM到Fama-French三因素模型经历了几十年，经济学家和投资专家们一直不停地探索着，试图更加精确地解释个股波动产生收益的原因。这个收益解释过程并非这样突兀地从一个简单的CAPM就跳到精确的Fama-French三因素模型，而是逐一深化而来的。完成这一收益解释深化的过程，是套利定价理论 APT（Arbitrage Pricing Theory）。

套利定价理论认为，套利行为是现代有效率市场（市场均衡价格）形成的一个决定因素。如果市场未达到均衡状态，市场上就会存在无风险套利机会。并且用多个因素来解释风险资产收益，根据无套利原则，得到风险资产均衡收益与多个因素之间存在线性关系。所以APT理论是股票多因子模型（Multiple-Factor Model,MFM）的框架和理论基础，为多因子模型的发展奠定了基础。如图6-16所示为因子模型发展里程碑。

图6-16 因子模型发展里程碑



3.多因子模型MFM

多因子模型MFM用如下公式解释股票收益 ：



其中，Xjk 代表股票j在因子k上的因子暴露（因子载荷或系数值）；

代表因子k的因子收益；

代表股票j的残差收益率。

多因子模型MFM并不是一个因果关系的模型，即所谓的因子只是在统计上和收益率存在相关关系，是试图解释收益风险的维度。多因子模型 MFM并不关心因子和股价是否存在因果关系。在多因子模型MFM中，假设残差收益率与因子收益率独立，并且不同股票的残差收益率之间也互相独立。

对于一个包含N种股票和K个因子的系统，多因子模型MFM本质上是将对N种股票的收益+风险预测转变成对K个因子的收益+风险预测。

而前面的CAPM认为所有证券的收益率都与唯一的公共因子β的收益率存在线性关系，是单因子模型，这是CAPM与多因子模型MFM的本质区别。以套利定价理论APT为基础的多因子模型，优势在于它可以提供更为完整的风险暴露分析，并且分离出每个因子的影响，从而为投资决策提供更为局部和细致的分析。

讲解至此，读者应该能够体会到，我们做定量投资的基础就是通过研究因子收益率的变化，分析其规律，从多个因子组合的角度对因子暴露进行管理，以获得超越基准指数的收益。而手工交易者或主观的定性投资者，则研究个股通过因子无法解释的超额收益率。





6.5 单因子分析方法


一个有效的α因子应该能够带来长期且稳定的超额收益，同时因子在各期的表现应该具备较好的持续性，即具备较低的波动性，根据因子挑选出来的组合是否具备较高的胜率也是我们考察的标准之一，同时该因子的显著性变化特性也需要关注。

一般筛选因子的主要原则有：

（1）数据的准确性和真实性。

（2）数据的完整性。

（3）数据来源的稳定性。

以多个指标相结合的方式来考察各个因子的有效性。指标可分为两类，即有效性指标和单调性指标。有效性指标，通过跟踪超低配组合的表现来考察因子的有效性，包含IC、ICIR、组合胜率、组合月收益率、组合滚动1年收益率及组合收益t检验概率。

光大证券研报《多因子系列报告之一：因子测试框架》认为，为了使测试结果更符合投资逻辑，应该设定三条样本筛选规则：

（1）剔除选股日的ST/PT股票。

（2）剔除上市不满一年的股票。

（3）剔除选股日由于停牌等原因而无法买入的股票。

同时在进行一系列计算之前，一定要对数据做处理，因为多因子模型面对的数据大部分是企业财报数据，虽然根据发布规范其单位格式统一，但数据随企业基本面信息而千差万别，缺失、0值、错误值、离群点遍布因子表格。通过图6-17因子箱体图分布情况可以看出几个典型的因子数值分布情况。

数据清洗的一般处理方式如下：

（1）删除异常值（逻辑上不应该出现的0值或负值）、缺失值。

（2）删除分布特性上的特殊值（离群的极值）。

图6-17 因子箱体图分布情况（Z-score前后）



由于常见的3标准差（3倍标准差之外的数据清除）去极值法是基于样本服从正态分布这个假设的，但往往我们发现大部分因子值的分布并不服从正态分布，厚尾分布的情况较为普遍，因此采用更加稳健的MAD（Median Absolute Deviation，绝对中位数法）。

首先计算因子值的中位数Median，并定义绝对中位值为：

MAD=Median（|fi Medianf|）

MAD也被称为绝对中位离差，各项变量与中位数之差叫离差，它是单变量数据集中样本差异性的稳健度量，也被认为是一个鲁棒性强的统计量，对于数据集中异常值的处理比标准差更具有弹性，可以大大减少异常值（数据噪声）对数据集的影响，这一点对处理金融数据（特别是基本面数据）有极大帮助。

将大于Medianf+3×1.4826×MAD的值或小于Medianf-3×1.4826×MAD的值定义为异常值。在对异常值做处理时，需要根据因子的具体情况来决定是直接剔除异常值，还是将异常值设为上下限的数值，后者为常用方法。

1.单因子绩效指标

紧接着就是数据标准化过程，一般都会建议建模人员选择Z-score值标准化来处理因子数据，因为它不会改变数据的概率密度，使数据中的一些特殊关系信息能完整地留存下来，只是被归一到了一个区间。具体要使用哪些因子投资、什么样的因子好用或者耐用、什么样的因子可以被放入多因子模型中，有以下几点需要注意。

（1）因子IC（秩相关信息系数）：即每个时点，因子在各股票的暴露值与各股票下期回报的相关系数（或秩相关系数）。本文认为如果一个因子的IC绝对值高于2%，则认为该因子在优选个股α收益上有较好的效果。IC值为正，表示该因子与股票的未来收益有正相关关系，应该超配因子暴露值高的股票；反之，若IC值为负，则超配因子暴露值低的股票。

（2）因子ICIR（IC的信息比率）：即因子在样本期间的平均年化收益与年化平均标准差的比值。ICIR绝对值越高，表明该因子在优选个股α收益上效果越好。另外，经统计发现，ICIR绝对值高于0.7时，α因子的选股效果通常比较明显。

（3）最佳组收益（资金曲线序列）：因子按照正向或负向，可以以升序或降序对股票进行排序，然后即可得到买入资金曲线。我们可以衡量最佳组的收益曲线，一般是分为10组后的第一组，或者最后一组。有时为了更加显著地体现收益情况，我们还会做多第一组，做空最后一组，然后观察资金曲线是否平滑。一旦产生较大的回撤，则证明在回撤点位附近的时间点存在较大的价格风险暴露。

（4）收益单调性（分层效果）：通过分析各档股票组合的表现是否具备显著的单调性（显著区分好股票和坏股票），从而考察因子的有效性，包含各档累积收益率、各档相对基准累积收益率、各档平均年收益率及各档相对基准平均年收益率。一般来说，IC和ICIR值较高且为正时，各档组合的收益表现呈现单调递增的规律；IC和ICIR值较高且为负时，各档组合的收益表现呈现单调递减的规律。

（5）单因子之间的收益率相关性：部分优秀的因子同质性较高，IC值曲线呈现出高相关的特性，此时我们要做每个回归日期截面的相关矩阵分析。所以在筛选规模因子时需要有所取舍，只能保留显著性高并且相关性低的因子，最终送入多因子模型中。但是并非相关性高的因子只能选其一，比如两个高相关性的因子A和B，我们准备剔除B因子，但是它也有超额收益，所以又想保留。此时可以对两个因子A和B做线性回归，残差即为A无法解释B的部分，相当于对B因子做了一次以A因子为目标的中性化。

逻辑上的相关性也十分重要，一般用于描述同样特质的因子只选择少数几个甚至一个，因为量化分析本身就是放大了收益或者放大了亏损，幸存者偏差遍布模型开发的每个环节，此时做数据挖掘存在极大的风险性。

（6）因子IC半衰期：因子是具有时效性的，IC作为度量因子有效性的主要指标，我们不能只看其值高低，其稳定性也值得关注。因子IC衰退，是通过观察随着滞后时间的延长，因子有效性降低的速度。研究发现，很多因子具有相对稳定的半衰期，即因子有效性降低为一半所需要的时间，因而可以通过观察半衰期的长短来判断该因子的稳定情况。

更学术地描述这个观点：IC衰减是指在时间维度和横截面股票维度上预测能力的降低。计算公式为当期因子值和滞后N期的收益率做线性回归=correlation（Factort ,Returnt+1+n ）。然后绘制出当期IC和滞后1期、滞后2期、滞后N（一般限定在半年内）期的IC序列，观察其衰减到一半所用的时间。

如图6-18所示，常见财务基本面数据IC衰减较慢，而价量因子IC衰减较快，所以前者可以适应较长时间的持仓，后者需要频繁调仓，造成换手率较高、交易成本冲击较大。以图6-18中总市值对数因子的IC衰退情况为例，我们观察到，在lag11期时间点上，IC已经不足之前的50%，所以这类因子的IC衰减是非常缓慢的，该因子具有可持续性。

2.可视化分析方案

撰写代码进行单因子回测，核心逻辑是要测试出IC等指标。方法在网络上有很多，本书提供一种方法测试单因子——聚宽单因子测试免编程平台，使用较为方便，出错概率较低。

图6-18 对数市值因子的IC衰减情况（lag11期衰减过半）



如图6-19和图6-20所示，这些绩效输出我们仅在因子测试平台中撰写了很简单的代码（这段代码来自国泰君安191个短期量价因子中的013号因子：（最高价×最低价）0.5 –Vwap成交量加权均价，然后设置回测日期、回测金额、股票池，单击右上角的“分析”按钮，即可得到上述结果。测试代码如下。

from jqfactor import Factor

import numpy as np

class ALPHA（Factor）:

# 设置因子名称

name='alpha_test'

# 设置获取数据的时间窗口长度

max_window=1

# 设置依赖的数据

dependencies=['high','low','volume','money']

# 计算因子的函数，需要返回一个pandas.Series,index 是股票代码，value是因子值

def calc（self,data）:

# 最高价的dataframe

high=data['high']

# 最低价的dataframe

low=data['low']

#计算vwap

vwap=data['money']/data['volume']

# 返回因子值，这里求平均值是为了把只有一行的 dataframe 转成 series

return（np.power（high*low,0.5）-vwap）.mean（）

图6-19 因子测试平台资金曲线收益绩效



图6-20 因子测试平台因子IC和换手率绩效





6.6 多因子选股模型：多元线性回归法


1.多种因素解释收益

股票交易者基本上都认同这个观点：收益可以被多种因素解释。因此，我们可以看到投资中出现了几大流派，比如企业价值投资、趋势技术分析投资、超短线（日内）交易。每个投资者做出决策的依据是不同的，在和他们沟通的过程中，如果试图还原其分析逻辑，你可能会得到一些启示，将这些启示写成一个个交易模型，发现大多是亏损的。

亏损的原因在于交易者无法准确描述自己的交易逻辑，甚至无法定量地描述单一因素决策的数量化逻辑，进而更不可能描述多个因素共同决策的逻辑。我们的大脑结构不是理性地对多个因素打分，然后得到公式，而是模糊地考虑多种因素，加之投资中的巨大偏差，最终得到一条看似可行而实际充满坎坷的“通向成功投资之路”。

所以在前文中我们看到，近几十年来各种量化分析模型都来试图解释收益，这条路才算走上了正轨。量化投资领域的行业前辈们非常伟大，他们的结论和过程，以及假设框架，都成为我们构建多因子模型的基础。这也是为什么我们能够不在理论框架部分做过多思考、耗费巨大精力，而直接使用新算法、创造和挖掘新的因子，就能产生收益的重要原因。

回到刚才的观点，更加准确的描述是：个股收益在每个时间点上，可以被多种因素共同解释。这就决定了单因子模型（或者加入止损、风格轮动、因子优化、交易规则优化等方法）是不可能长期稳健奏效的，而它更多地是被当成一种观察市场的工具，观察什么时候什么因子收益率高、IC值高、回撤小。

所以，从单因子走向多因子是一条必然的道路，因为我们想要获得稳健的长期收益，单因子代表了市场中某一特质对价格的影响因素，它的作用总是呈现均值回复，只是平均看起来表现较好。

2.拿出回归工具

线性回归对应变量和自变量（多因子模型是多个自变量）的关系做解释，认为按照某一种因子权重设计，可以达到最优的对应变量的解释程度。线性回归的原始定义是“确定两种或两种以上变数间相互依赖的定量关系的一种统计分析方法”。

现在多因子问题已经抽象成数学模型，假设在某个时间点上，因子A、B、C对全市场3000只股票在本阶段的收益（本时间点收益-上一时间点收益）有影响，使用多元线性回归工具，求每个自变量（因子）前面的系数。构成回归函数或叫作回归直线方程Y（应变量）=x0 +x1 ×A+x2 ×B+x3 ×C+ε，这里的x0 是截距，ε是残差，是本回归模型所不能解释的部分，均值为0呈现正态分布特征。

这里我们使用多元一次线性回归，并认为回归直线方程Y是对数据（本阶段收益）最好的描述，然后我们可以通过“股价打分公式”带入本期因子值和上期训练得到的参数，计算每只股票本阶段的理论收益，买入理论收益最高的股票。

前文我们已经做足了知识铺垫，在这里直接放上代码。这段代码含 MAD绝对中位数数据清洗和市值中性化过程，希望能够开拓读者思路，不断添加新的有效因子值进入该模型，以带来更好的性能。

我们在本案例中放入杠杆率、净利润同比增长率（体现质量成长）、营业收入同比增长率（体现规模成长）、PB-ROE、PEG这5个财务面因子，得到如图6-21所示的绩效。这里提示读者，挖掘更多短期量价因子及舆情因子，能够有效改善模型绩效。

图6-21 5个基本面多因子模型绩效



同时考虑到基本面较差的个股虽然有小市值优势（本质上是我国股票发审制度导致的“壳资源”优势）和高成长优势，但是在监管趋严和市场逐步有效的情况下，拥有长期稳定基本面的上市公司股票才是首选，所以我们也对个股使用PEG指标进行了基本面过滤，通过valuation.pe_ratio/indicator.inc_net_profit_year_on_year>0且<1这样的语句进行过滤，保证每次选到的股票估值不至于过高。

以下是该模型的源码，也可以通过扫描二维码获得：





6.7 SVR机器学习多因子建模


带领读者从撰写第一行基于交易开拓者的Easy Language代码开始构建模型，到多因子机器学习模型构建，是本书的编写目标，本节将完成这个话题，并带给大家一套便于迭代的多因子模型源码，同时尽可能简明地叙述我们所使用的机器学习算法。

1.从线性回归到SVM再到SVR支持向量回归

线性回归用回归方程搭建各个自变量之间的关系，来解释应变量（个股收益）。SVR（Support Vector Regression）支持向量回归也有自己的方法，而且还更为智能，所以称得上是机器学习工具。要解释清楚SVR还需要从SVM（Support Vector Machine）入手。SVM是一个分类器，并且是二类分类器，深度学习出现之前，SVM被认为是机器学习中近十几年最成功的算法。

支持向量机试图寻找一条分类线，将数据分为两部分。评价分类好坏的方法是能将数据正确分开，且分类线到最近一个数据点的距离Margin越大越好，这被称作“最大边缘原理”。理解距离（边缘）的概念后，我们应该可以看到，决策边界的扰动可能对分类产生影响，边缘越小，影响越显著。所以我们想到了构建复杂模型是否能够解决这一问题，但是复杂模型容易过度学习样本内的数据，也就意味着尽管在样本内的数据上做到了分割，但在样本外的外推效果较差，分类能力可能不能保持。

线性模型的复杂度和超平面边缘成反比，也就是说边缘越大，模型越简单。所以，我们希望模型分类准确率高，且简单。在此目标下，我们推导出支持向量机的分类目标函数，它的思想是最大化边缘，也就是最大化 Margin=2/法向量 w的模。要使Margin最大，则必须使法向量w的模最小，从而可以总结为：最大化两个类之间的分离边缘，等价于最小化权值向量w的欧几里得范数。然后我们将分类约束合并为：y×（法向量w×法向量x+b）>=1，该函数保证所有样本点都分布在 Margin之外（正确划分），目标函数是w的二次函数，而约束函数是w的一次函数，这样的优化问题是二次优化问题，存在全局最优解。

那么什么是支持向量（Support Vector）？这些向量数据点，是离分界线（Margin的中轨）最近的向量，分界面是靠这些向量确定的，它们支撑着分类超平面。但在原始特征的维度上，经常会发生没有一条直线能够将数据一分为二的情况，此时SVM通过引入核函数，将原始特征映射到另一个高维特征空间中，解决原始空间的线性不可分问题。当然，映射到高维空间之后，大部分问题转换为线性可分的问题（此时已经是“近似线性可分”阶段），但依然有不可分的情况，此时再引入松弛变量，允许一些点到分类平面的距离不满足原先的要求，从而使得某些严格线性不可分的数据集也可以使用SVM进行分类。

松弛变量的引入放弃了对这些点的精确分类，这对分类器来说是损失。但放弃这些点也带来了好处，那就是使分类面不必向这些点的方向移动，因而可以得到更大的几何间隔Margin。总而言之，支持向量机就是使用了核函数的软间隔线性分类法。接下来的问题都是支持向量机分类器的求解方法，大家可以在网上找到各种详尽描述，不在本书的讨论范围内，我们重点关注如何用好这个工具，以及它在回归问题中的应用。

本部分的内容是从线性回归到 SVR支持向量回归，所以现在要从 SVM过渡到SVR支持向量回归。SVR本质上类似于SVM，都有一个分类间隔Margin，只不过这里的Margin表示和SVM完全相反。SVM需要把两个数据集合按照特征不同区分开，而SVR的Margin表示在Margin里的数据是最正确的，相反它不对回归有任何帮助。如图6-22所示，对照linear regression的损失函数可以看到，左边是SVR的损失函数，右图是线性回归（图片来自coursera林轩田机器学习法）。SVR定义这个区域内的点损失为0，这个区域以外的点的损失是点到区域边界的距离，这些区域外的点就是确认超平面或直线的支持向量（Support Vector）。

在二维空间，一条线是线性的；在三维空间，一个平面是线性的，一个曲面则是非线性的。提到Gamma参数方面，当SVM或SVR的核函数kernel='rbf’时，说明这已经不是一个线性模型了，而是非线性模型，此时超平面变成了一个超曲面。如图6-23所示。

图6-22 从线性回归到支持向量回归



图6-23 不同Gamma值调节曲面拟合度和不同核函数拟合效果



我们继续探讨线性模型和非线性模型的问题，首先多元线性回归是线性模型，而SVR在采用了核函数RBF之后是非线性模型。但我们面对的经济学问题，特别是股票市场价格影响因素，是非线性的。比如动量在一定幅度内表示价格启动上涨是健康的，但波动率过大的动量意味着价格过度上涨，之后价格将充满回复性。再如市净率较低一定程度上是企业估值较低，有可能是估值洼地，有反弹潜质，但如果某个样本持续出现市净率过低，则可能就是它无法被市场资金青睐，处于走势加剧恶化的过程中。

2.SVR模型中Gamma参数的意义

因子和股价之间的关系不可能是线性的，因此需要用一个高斯模型来加入非线性的部分。参数Gamma就是决定高斯模型的方差，也就是宽度。如果宽度极小，则与线性模型很接近；如果提高宽度，模型就会变成一个曲面，就可以把数据和模型的关系拟合得更贴切。问题在于，如果数据噪声非常小，那么这个曲面越奇怪，越贴近数据，模型的结果就越准确。但如果数据噪声大，那么这个曲面就会出现过度拟合的问题。市场基本面数据等因子不仅低频，而且质量较差，人为干预因素较多，所以这里要付出很多精力预防过度拟合。

以核函数RBF参数为例，图6-23解释了不同的kernel核函数和不同的Gamma参数值对回归效果的影响，之后我们也测试了不同的Gamma参数值在绩效方面的不同表现，如图6-24所示，结论很值得思考。我们知道，一个分布可以由均值和方差确定，Gamma就是决定高斯模型的方差，也就是宽度。超平面就是有各种山峰，把不同的位置描述出来。如果设定Gamma=1，则会出现波峰之间的重叠较大，一个因子的细节就被体现得越明显。如果数据噪声大，Gamma也被调节为较大，自然就会出现过度拟合问题。

参数Gamma可以被认为是控制数据在曲面上影响力的锐化或柔化过程，锐化之后（Gamma小），数据对曲面的影响力变小，脏数据依然是形单影只的一个数；柔化之后（Gamma大），脏数据会将自己的影响力扩散至整个曲面上。所以Gamma参数并非完全地对应了模型的拟合度，或者说单纯通过Gamma参数调节是否过度拟合。因为我们导入高质量的因子值，并使用 SVR配合高Gamma，确实是可以拟合到数据特征的，也就是说可以获得一个自变量对应变量的准确解释能力。但如果数据质量低下，高Gamma就会令模型变得危险。

因子选择至关重要，如果是中低频多因子模型，应该多从企业估值和成长角度入手，筛选财务报表类因子。虽然这种模型缺乏市场数据的活跃性，但依然对股票分类具有至关重要的作用。如果我们的模型倾向于快速调仓，那么也要添加一些中高频的量价关系因子或舆情类因子。

图6-24 调节不同的Gamma参数（上Gamma=0.1，下Gamma=1）模型绩效对比



3.另类因子解释模型

本例中我们以市值因子的解释为逻辑，向大家展示一个SVR模型在量化投资中的使用方法。我们选择一批自变量X为量价因子，它们来自国泰君安研报《基于短周期价量特征的多因子选股体系》，应变量Y为总市值。该模型没有对阶段收益率进行回归，而是用多个因子解释市值因子的变化，该思路来源于聚宽量化课堂的《机器学习多因子策略》。

模型通过短期量价变化活跃来解释市值大小，然后通过具体的交易规则：残差=真实值-回归值，如果回归市值显著高于真实市值，则残差显著低于0（负值），按照残差向0均值回归理论，这类个股要做多，因为它本期有增长空间；在相反情况下，残差显著高于0（正值），这类股票要做空或卖出，这就是回归类模型的交易方法。

通过前文对算法的描述我们了解到，SVR是一种典型的非监督机器学习，SVR做出曲面，我们可以用这个曲面聚类。在本案例中，我们就做了一种类似聚类的工作。我们用SVM做了分类工作的前一部分（形成分类器），手工做了后一部分的分类（按残差升序排序，寻找价值距离最远的股票）。

该模型在我们改写后源码如下，读者可以对其进行进一步迭代。比如添加和改写因子，并修改回归应变量Y，使之不仅是一个“市值因子解释模型”，因为以目前该模型在2017年后半程的回撤来看，对市值因子的暴露过于明显，必须有十足的把握该因子有效才能运行本套模型。如图6-25所示。

图6-25 以SVR为框架开发的市值解释模型



以下是该模型源码，也可以通过扫描二维码获得：





第7章 模型与实盘投资难点



7.1 参与CTA市场的必要性和必然性


一些证券从业人士和网络意见领袖认为，期货市场相对于股票市场来说，是一个毁灭财富的地方，是个人投资者被迫交出筹码的惨烈市场，是负和博弈。这种认知是非常错误的，也许是他们静态地考虑到交易者的能力不足，不适合参与这个带有杠杆且高效定价的市场。但实际上这个市场适合理性的量化投资交易者参与，能够带来非常好的收益风险比，也能在资产配置中获得举足轻重的份额。

中国的商品期货市场发展时间不长，沉淀资金（保证金量）目前只有5000亿元人民币左右，和股票市场几十万亿元的市值相去甚远。但期货市场换手率高，资金利用率高，定价高速有效，投资者只要设计出自己的交易模型，加上合理控制杠杆，坚持交易纪律，获取超额回报只是时间问题。

更重要的是，期货市场的核心主力商品期货CTA基金，和其他投资品种保持极低的相关性，考虑到我们大多数投资者显然在熊市难以获得稳健回报，那么期货市场这种没有牛、熊市，可以做多、做空的市场就值得超配。

1.了解CTA商品期货基金

商品交易顾问（CTA,Commodity Trading Advisor）是一种获取绝对收益的资产管理方式或投资策略。目前我们广义上将参与商品期货的基金或者模型，都称为CTA类资产，本书中常出现“CTA”字样。

这个概念的初始定义来自美国商品期货交易委员会制定的商品交易法案，是指通过为客户提供期货、期权方面的交易建议，或者直接通过受管理的期货账户参与实际交易来获得收益的机构或个人。传统意义上的CTA基金的投资品种仅限于商品期货，但随着近年来全球期货市场的发展，CTA基金逐渐将其投资领域扩展到包括利率期货、股指期货、外汇期货在内的大部分期货品种。CTA与其他资产或者策略种类的相关性较低，所以一直在资产配置或交易策略中占据一席之地。CTA基金业绩表现如图7-1所示。

图7-1 海外对冲基金指数中，管理期货CTA基金业绩优秀稳定



根据海通证券《海内外CTA基金的发展与现状》研报显示，截至2016年年末，全球CTA基金的总管理规模已高达3375亿美元。而在1980年、1990年和2000年，这个数字仅为3.1亿美元、101亿美元和379亿美元。短短35年，规模增长了接近1100倍。国内商品期货市场近几年也取得飞速发展，中期协数据显示，2017年1月～12月全国期货市场累计成交量为30.76亿手，累计成交额为187.9万亿元。我国大宗商品期货市场规模不断扩大，初步具备大类资产配置所需的市场容量，大宗商品期货成交量已连续8年位居世界第一。

2.商品期货类资产和该市场的特性

（1）高换手率，交投热烈。在交易方面，商品期货市场呈现出高换手率的特性，交易极其活跃。有数据显示，中国交易者对期货合约的平均持有时间不到40分钟。2016年8月11日，螺纹钢一天的成交量曾超过了2016年上半年的全国产量，持仓量也出现急速飙升。热卷、铁矿石和焦炭等也有类似的情况，这也暗示高换手率，交投热烈的现象，在很大程度上由短线投机者驱动。

（2）量化交易占比更大。从交易模式来看，根据朝阳永续披露的数据，在现存的1978只CTA产品中，有299只产品是采用量化的方式进行投资的，占比为15.12%。需要注意的是，此处量化与非量化产品分类主要参考朝阳永续数据库中的“量化属性”字段，量化产品的实际数量应当更高。在发行规模上，量化CTA产品的规模占比约为13.84%，平均每只量化CTA产品规模约为3088万元。该比重显然比股票类基金要大很多。

（3）业绩更优秀，收益风险比高。2013年以来，中国CTA产品每年都能获得超过10%的正收益，其中2014—2015年的平均年化收益率超过30%。而量化CTA产品表现更为出色，无论是夏普比率还是回撤控制，均超过CTA产品平均水平，2013—2015年连续3年取得了超过1的平均夏普比率。虽然2017年期货市场波动不流畅导致大部分产品净值走势艰难，但根据商品市场的波动特性，接下来的市场又会相对充满高波动机会（在本书截稿前该情况已被验证），适合量化交易模式投资。

在本书撰写截稿前，2018年出现了较大规模的商品期货波动行情，大部分本年度新发行的基金，或者净值方式管理的账户，已经通过自然的市场波动获得了至少5%～10%的安全垫。而股票市场恰好相反，2018年开年就给投资者带来不小的损失。

（4）规模偏小，产品布局灵活。从公布发行规模的产品来看，2017年度阳光私募CTA产品的发行规模一般来说都不大，大多集中在5000万元以下，特别是1000万元以下规模的产品占比达到44%。CTA产品在二级市场仍然不是私募机构的主流产品，截至2017年11月底，产品数量占比大约为4%。

（5）相关性低，和股票类产品有效对冲。商品期货存在多品种、多周期、多策略的特征，并且由于期货市场可以多空双向交易，所以CTA策略的市场表现与其他各类资产的相关性都非常低，在资产配置环节可以起到有效分散风险的作用。

CTA策略无论是投资品种还是投资方式，都极为丰富。Barclay CTA基金指数和标普500指数的相关系数仅为0.01，和美国国债相关系数也只有0.14。这种资产在其他大类资产走低，特别是出现价格突变（如崩盘）时，往往能够呈现出高回报特性，这是机构投资者最为看中的。

芝加哥商品交易所研究报告 Managed Futures: Portfolio Diversification Opportunities做了这样一个资产组合模拟：在原始组合（50%股票+50%债券）中加入CTA基金，形成的新组合（40%股票+40%债券+20%CTA）收益率高于原始组合，且波动性大幅低于原始组合。该组合的收益和波动特性如图7-2所示。

图7-2 芝加哥商品交易所投资组合测试



（6）各品种波动率有一定对冲特性。无论是国内还是国外，商品期货市场的黑色系、有色金属、化工品、农产品、贵金属等品种都容易出现区域性热点行情。这些行情的出现往往由于基本面或者政策面变化所致，货币因素的驱动力没有股票市场强烈，这也就意味着市场出现集体性熊市和集体性牛市的情况不多，热点始终能够在不同品种上出现，波动率显然比股票市场更有捕捉魅力，如图7-3所示。

图7-3 商品期货2010年以来价格归一化ATR起此彼伏



我之前向投资者介绍这类资产时，常说这样一句话：各品种Beta系数同步性显著低于股市，少有齐涨齐跌的情况，也少有长时间的牛市和熊市，特别是熊市。所以，我们通常会采用多品种部署资金和模型的特性，来尽可能地获取多品种的波动率收益，或者说在部分品种亏损的情况下，其他品种的盈利能够做到有效对冲。

（7）期货品种相对于股票市场，交易者缺乏选择和切换（换股）空间，加之杠杆的影响，很容易产生人为的忍受力极限而做出错误交易。这反倒成为程序化交易模型捕捉的对象，所以期货品种的动量效应和股票个股的反转效应形成鲜明对比，也使我们构建期货模型的难度要略小于构建股票模型（动量类模型相对容易通过量化方式捕捉）。如图7-4所示。

图7-4 通过较为简单的择时工具能够捕捉商品期货波动



以上就是我们投资这个市场的必然性，也是我们希望有能力的个人交易者，能够在合理控制风险的情况下，通过程序化交易的手段，发挥自己的量化模型开发优势，参与到这个市场的原因。这个市场犹如一个迷你的大类资产配置市场，越成熟的交易者和交易模型越能够把握机会、控制风险。

在本书中，有一半的量化模型将以商品期货市场作为资产标的，股票类模型分享另外50%的篇幅。这可能和我的从业经历有一定关系，但在我观察到的大部分做量化交易的同行中，衍生品特别是商品期货市场，也是大家最有兴趣并且愿意投入较大精力的市场。





7.2 止损模块的重要意义与取舍


止损是策略中必须存在的模块，因为它可以以一个刚性的亏损幅度控制阈值，去应对策略主体无法完成的工作。特别是在策略主体遇到短期失效的情况下，止损显得尤为重要。

量化交易中的止损模块，并非手工交易中的止损模块。在手工交易中，因为交易者永远都会犯错误，所以用这个硬约束方式控制亏损幅度，防止出现巨大的资产回撤。而在量化交易中，止损模块更大的存在意义是定量地封杀单次净值下跌空间，同时降低幸存者偏差带来的错误绩效。

本书中要讲到的海龟交易法则，正是使用以N（日线级别ATR波动率）为基础的止损以避免净值的大幅损失。有一种说法我们常听到：“有老交易员，也有无所畏惧的交易员，但却没有无所畏惧的老交易员。”不使用止损的交易员最终会破产。

《海龟交易法则》认为，对于手工交易者来说，始终抱着亏损的交易终究会反转的愿望比干脆退出亏损头寸并承认交易失败要容易得多，止损的障碍存在于心理。长期来看，不会止损的交易员是不会成功的。几乎所有失去控制并危及金融机构自身健康的交易例子（如长期资本管理公司），都涉及因为没有止住小的亏损而放任其逐渐变成巨额亏损的交易。

量化中的止损，最重要的是在你建立头寸之前，你已经预先确定退出的点位，以及本次可能产生的最大资产亏损，并且无条件执行。这是程序化下单交易的优势。

道理很简单，但当你向模型中添加进去一个止损条件后会发现，模型绩效大概率会出现降低，甚至是破坏性降低。虽然产生了性能下降，但留意观察其他绩效指标，如夏普比率、平均回撤，我们会发现止损是有必要的，或者说得清晰一些，止损是必需的。

我们原以为要在心理层面做出取舍，才能允许这个止损模块的添加，而实际上通过测试也体现出这个模块必须被添加，有以下几个理由。

（1）模型在目前状态下，必然存在逻辑对于历史样本走势的拟合，以及参数对于历史样本走势的适应。止损作为一个外挂模块，直接加入后大概率会影响这种拟合。止损通常会打断一个可能将短期亏损反转为盈利的交易，这看起来有点让人舍不得。但在实盘情况下并非如此，价格很有可能会长期反向运行，这时止损的意义就显现出来了。

（2）止损提升了交易次数，交易次数是模型绩效重要的稳定性（置信度）验证指标，更多的交易次数意味着模型的绩效可信度越强，实盘的衰减越小。

（3）一定幅度的和波动性相关的止损模块，是一个正确的设计。在该模块存在的前提下，对模型进一步开发和参数优化，才显得更有意义，说明模型主体条件能够接受一个较为合理的止损位，性能依然可以达到设计预期。这样的模型显然比没有止损模块的模型更加稳健。

（4）在价格快速反向运行时，模型的主体条件大部分会失效，因为这些条件大部分都滞后起效。比如遭遇股灾、期货价格短时间内剧烈波动，在不考虑流动性（默认我们能够平仓）的情况下，止损是唯一能够起效的模块，所以它必须存在。

如果做趋势类交易，或者做回复类型的交易，那么追踪止损也是一个必须存在的模块，特别是在期货领域尤为重要。

价格在两种情况下的不利波动让我们最为难受：（1）建仓后；（2）利润较高时。毫无疑问，这两种情况都会导致利润流失。而我们并不知道自己何时加载模型到股票、期货等行情中，所以一旦在高点打开模型入场，模型默认的平均入场价还是图表上的模拟价格，此时一定要有追踪止损模块，从一个高位回落和波动量相关的幅度，方能帮助我们尽可能地控制图表上的利润和实盘交易中的亏损。

此外，价格往往在不利运行（开多头后向下运行，或开空头后向上运行）时，体现出快速和高波动的特点，这都是模型主体条件无法应对的，建议读者用硬止损和追踪止损模块对付这类行情。我是在开发期货模型第二年、股票择时模型第一年时才意识到这个问题，现在看来自己是一个后知后觉的策略开发者，但在理解止损的意义后，立刻意识到止损模块不是一般的重要，所以希望读者能够尽早明白这个模块存在的价值所在。





7.3 我们更加侧重的绩效评估理论


本书开篇已经介绍了部分绩效评估方法，但当你完整阅读本书后就会发现，我们并没有严格地分析每个策略的绩效水平，而是从逻辑入手传达了一些我们的策略判断价值观。本节我们对这些分析方法进行总结，希望能够帮助读者在量化实盘投资前，尽可能客观地评估和运行策略。

1.策略广度BR

在股票因子模型中，我们非常推崇策略的广度BR（Breadth），即策略每年对超额收益率做出的独立预测数目。如果我们在全市场选股，应用的广度就是3000多只股票数目，而对于一次择时，广度就是1。方正证券研究所在其研报《规矩：方正单因子测试之评价体系》中，将IC的另一个公式称作主动管理的基石：



IR是投资组合的收益风险比，IR越高，代表实际投资中风险越低、收益越高；IC是因子的预测能力，IC越高，说明因子对未来的预测能力越强，但仅IC高是不够的，我们还必须重视信号数量。基于此观点，量化投资模型必须有较高的分析广度BR（一定程度上可理解为交易次数），才能让模型绩效更加可信。所以我们在寻找更短、更高频的因子，并不十分介意其IC快速衰减，我们试图通过高密度调仓换手的模式，提升模型绩效的可信度，降低实盘衰减。

在频率一致的情况下，择时模型和选股模型的差异在于，择时绩效须达到全市场选股绩效的 （大致是近年来日期截面上的股票数量）≈54倍，才能有相同的IR。商品期货模型也存在此问题，我们认为交易次数增加对模型绩效有很大程度的安全保障，较少的交易次数会让幸存者偏差极大，较多的交易次数在合理的交易成本控制下，模型显然更可信。

2.参数面绩效

几乎没有不带参数的量化模型，即使你将参数的意义解释得淋漓尽致，并将其固化。但凡有参数，就要做参数敏感性检验，比如一个线性模型，当我们加入了一种非线性约束或改变了其线性计算方法后，都要设置一个参数面，检验参数面上的平均绩效。

在前面的商品期货模型中大家可以看到，我们会检验参数面收益率、夏普比率、平均回撤等绩效，来确定一个方法是否通用、是否普适性地带来了策略绩效改善。原因在于我们可能会选择其中任何一个参数作为实际投资的参数组合，而我们应该假设自己不知道选取哪一个，或者选取哪一类，因为所谓的最优参数会漂移。

除了进行参数面平均绩效分析外，我们还要观察参数面绩效分布。为了提升效率，从TB（交易开拓者）、MC（MultiCharts），甚至是股票程序化平台导出的参数和绩效数据表，我们都会绘制参数高原图，用MATLAB或其他第三方软件都可以绘制参数高原图。对于双参数，Z轴即为净利润或夏普比率；对于三参数，可以用颜色深浅作为绩效高低判断标准。

如图7-5所示为某期货品种模型改造后和改造前的参数分布对比。我们可以看到，上图部分参数高原体现得更加明显，而下图部分有很大概率在实盘情况下我们会将参数选择到峰值部分。因为实盘一定会产生参数偏移，这就意味着如果选择到参数尖峰部分，很容易被偏移到参数平原或者参数山谷，从而造成性能快速滑落，甚至急剧下降到负回报。

而在上图部分，大片的高性能参数聚集在一起，我们不必过度担心选择到不好的参数，一般选择绩效较高且交易次数较多（绩效可信度高）的参数组合即可。即使实盘发生参数偏移，也会偏移到临近范围内，依然属于性能较高的参数区间。

本书大部分参数热图都是通过Voxler软件绘制的，一般将X轴设置为第一个参数，Y轴设置为第二个参数，Z轴为目标函数（如净利润、夏普比率等），如图7-6所示。如果要进行三参数绘图观察，Z轴为第三个参数，则需要换用其他三轴模板（以颜色深浅表示目标函数高低）。

图7-5 以某商品期货的双周期参数为X轴和Y轴，Z轴为夏普比率



图7-6 Voxler软件导入数据后的设置面板（直接拖曳绩效数据文件到该软件界面）



参数面不仅要绘图观察，还要求平均值，求TOP 10%参数部分的平均值，以便在横向对比中发现性能变化，本书大部分期货模型中都有类似分析。我们会分析一个参数区域的平均净利润、平均最大回撤、平均夏普比率，以确认参数漂移后的性能。你也可以将其理解为，分析这个区域到底是参数高原还是参数尖峰。

3.交易次数和持仓时间

当我们的注意力集中在利润和回撤等常见绩效指标时，容易忽略一个问题——绩效可信度。第1章的常见绩效指标中，有一个非常不起眼的指标，由交易开拓者软件提供： 。它评估了在同等利润或者夏普比率下，交易次数的重要性。该软件的“TB系数”和“头寸系数”也潜在计算了绩效指标的重要性。在股票模型的BR概念中，我们也将根号下的BR换成交易次数，然后运用到期货领域评估模型绩效可信度，从原理层面分析是等效的。

所以我们说在量化模型构建过程中“魔鬼藏在细节里”，得到稳步上升的资金曲线并不难，为什么实盘会轻易衰？因为该绩效的可信度严重不足（本书提到过绩效的概率特性）。而掌握了绩效置信度，掌握了BR等概念之后，你距离获得实盘盈利的模型就不远了。

持仓时间是和交易次数对应的指标，该指标也是越低越好。模型换手率越高，持仓越短，持有头寸的时间意味着承担风险的时间，所以要尽可能降低模型持仓，最好获得部分利润后就平仓离场（期货模型），或者到了规定调仓期或因子IC最高的时期就调仓换股（股票模型）。

但较大规模的资金往往无法承受过高的换手率，所以在量化投资中也有自己的“不可能三角”：高流动性、高收益、低风险不可兼得。因为收益来源要么承担了更高的风险，要么放弃了部分流动性要求。因此在实盘投资中，必须在流动性、高收益和低风险中放弃一项，从而确保另外两者达成。

所以，本节“我们更加侧重的绩效评估理论”的撰写目的是定量化地解答第1章的“有保留地相信回测结果”，希望读者能够理解其含义，并通过巧妙构建模型，发挥自己的资金优势去获得相应的利润。





7.4 警惕隐藏的回撤幅度和回撤时间


1.幸存者偏差造成的回测和实盘偏差

我们之所以讨论这个问题，是因为很多基金经理和模型开发者都在这方面吃过亏。在实盘期间，绩效会发生和回测阶段较大的偏差，有的模型还较为明显。

在股票市场上，因子风格暴露明显的模型衰减严重，比如以市值因子为主要盈利来源的小市值模型，2017年盈利艰难。在调仓周期方面，较为长期调仓的模型由于交易次数较少，可能在建模阶段存在不少幸存者偏差，所以在其他条件不变的情况下，交易次数少的模型衰减也比较严重。股票模型的持仓数量也比较关键，在建模阶段，最好设置至少20只股票持仓，以尽可能避免少数个股的幸存者偏差。

在商品期货市场上，通过2017年的观察总结可以看到，高波动率的中长期趋势追踪模型绩效衰减是较为显著的，这里又以运行在10～30分钟的模型为代表，而运行在1小时及以上周期的模型的衰减还可以承受。15分钟甚至更小周期的模型，往往还没有到达半年的衰减期，就已经亏掉了很多钱。其次就是日内交易模型，参数越多，规则越复杂，衰减越严重，可能经历长达半年时间的回撤期无法盈利。

然而这些模型在市场资金充裕的情况下，表现又有可能超预期，超回测绩效。所以偏差是大概率会出现的，我们在预估模型绩效的时候，一定不要仅看回测效果，特别是多品种组合后的效果（虽然这些资金曲线都非常好看），而是要考虑单品种在某个参数区间可能达到的平均绩效，以及组合没有带来回撤相抵的情况下的绩效，也就是说要计算出最坏的情况。

2.分析波动率变化和品种选择不均造成回测失真

关于品种的选择，刚才已经提到过。很多时候我们的高收益是依靠高波动率的品种换取的，比如我们过度依赖螺纹钢、黑色系品种，而低配了农产品，或者因为农产品缺乏高波动率及适合趋势模型的行情就放弃配置。此时一旦高波动率品种熄火（并且这种熄火时间和幅度历史罕见），我们的净值也就会出现较大偏差。这是资产配置角度的分散不足造成的。

另一种情况是看年度、月度净利润分布情况。如果出现某年度利润过低，就要去挖掘该年出现了什么情况，比如该年份是一个低波动年份，再去考虑一下该年份的资金面紧张程度（如2013年国家央行制造了几次钱荒来检验银行的抗风险能力），然后思考目前货币政策的扩张强度和扩张预期，以及央行是否通过公开市场操作来释放货币的流动性，货币流动性不足时，波动率不足，绩效会出现负面偏差。

还有一种情况是，市场出现了长时间的低波动震荡，抵抗式下跌，此时净值出现了不小的回撤，这着实让人感觉非常难受。我们应该衡量历史上是否有过类似的震荡期，以及核心品种的价格区间是否在一个历史高位或低位（且大概率会维持低波动率）。此时可以按照波动率均值回复的原理，预测一下阶段波动率上升，这在一定程度上可以确认目前的仓位是否需要加大（当然，大多数情况下是不需要的，因为这有很大的风险）。

3.对回撤幅度和回撤时间做到心中有数

回撤并不可怕，可怕的是我们轻敌了。在向投资者描述业绩的时候，我们总喜欢放大优势，掩盖劣势。在向团队汇报新模型绩效时，我们也存在类似的问题。这会造成资金风险偏好错配，头寸过大配置，或者双方彼此对困难估计不足，埋下隐患。其实这个时候你再看一眼模型的最大回撤，也许还没有达到历史最大回撤。可想而知，如果达到最大回撤，则会引发更大的恐慌。

此时我们再看资金曲线就会发现，原来一段看似“下半辈子衣食无忧”的回测结果，充满了各种困难。这根曲线中有“连续半年甚至9个月不盈利”的隐患，也有“本金亏损20%”的隐患，回测中最大回撤较低，原因竟然是某个品种或者某只股票意外地出现了3个标准差外的大幅度波动，从而带来盈利，挽救了持续滑落的曲线……但在实盘阶段这种幸运情况出现的可能性很低，我们脆弱的绩效还能保持吗？

所以放大对困难的估计，获得一个健康的绩效预期，逐步承认系统不是在所有市场条件下都有效的（不完美的模型），进而承认自己的能力有限（不完美的自己），是赚钱的第一步。获得这种顿悟和开发一套好的模型同样重要。获得这种能力，非常依赖长期实盘经验和对绩效可信度的把握，更依赖强大的内心和自制力。





结束语 不断失败和不断迭代


对冲基金教父Ray Dalio在《原则》一书中描述了失败和真相有多么重要，有一句话令人印象深刻：我们必须渴求真相，要渴求到为了换取真相甚至不惜被羞辱的地步。不断地失败和不断地犯错误，就是被羞辱的过程。Dalio描述他自己是一个“专业的犯错者（Professional Mistake Maker）”，含义是犯了错以后，他会用专业的态度去对待错误、处理错误，从而汲取经验，找到规律。对于量化模型的开发者而言，这个话题的意义不同，我们要更加贴近模型构建和实战的过程来理解。

在进行实盘交易前，我们要在数据全集上验证模型的稳定性，或者将数据分段，训练集和测试集分开，验证模型的资金曲线，有一定的斜率保持能力（训练得到一条向上增长的资金曲线，要尽可能地保证在测试集上，其也有类似的增长斜率）。本书中还讲过一个方法，就是通过交易次数确认模型的稳定性，交易次数越多，说明模型对市场的适应能力越强。但这仅是量化模型验证的皮毛，之后无尽的失败正在隐藏起来等待你，如果你不经历失败并寻找答案，它们就会持续地发生来羞辱你，所以必须要保持不断迭代的过程。

在进入实盘交易前，要计算好单次最大的亏损幅度，并对最大回撤时间、最大回撤幅度做到心中有数。但在此阶段千万不要以为模型开发完毕就不用再迭代了，模型需要反复的失败教训和开发者的反复迭代，才能真正被配置较大资金使用。

在此阶段，如下几点是需要注意并反复警醒自己的。

（1）“数据正义”观点训练出的模型并不一定可靠，因为统计数据向来存在偏差，且数据中的噪声经常被挖掘出来。无论我们使用什么方法，都是在引用历史数据训练模型，而现实不是历史的简单重复，这里存在需要把握的变化规律。“数据正义”的观点是危险的，机器学习通过“数据输入、特征提取、特征选择、逻辑推理、预测”的过程是对数据的加工，然后我们需要人为地挑选训练出的模型，让它在我们的规则下运行得到稳健的结果，所以数据并没有生成模型，在我们的训练方法和规则严格限制下，才能得到模型。

（2）即使出现短期亏损，模型也不会轻易失效，不要因为短期的亏损就判定模型无法使用，失败需要面对，但不能被失败击倒。股票模型中很多因子的表现能力是轮动的，Alpha收益本来就是线性回归残差，是不容易把握的。所以2010—2016年度的因子在2017年由于政策变化不再有效，而2018年我们看到波动率上升和小盘成长股重新获得资金青睐，那些好像不能用的模型又恢复了生命力。

再简单的模型，哪怕是动量或反转模型，它们都表达了对市场波动特征的解释能力。或者双均线模型等看似原理简单，却非常贴合市场实际情况的模型，生命力依然持久。短期某些模型可能会产生亏损，你要清楚问题发生在哪里，解释自己的收益来源，尝试用更好的模型抑制亏损（比如通过因子权重调整和波动率预测的方式）。面对困难和失败，模型开发者要做的是分析情况，迭代模型，而不是把它抛弃掉。

（3）波动率低于某个临界点时，大部分模型（及参数配置方法）都无法盈利。当波动率过小时，方向的维持周期会缩减，方向的维持力度也会缩减，时间序列上捕捉动量和反转的模型基本上都无法盈利。这对于商品期货模型尤为适用，比如在慢慢长阴下跌阶段，有时你会发现空头模型（或组合模型的空头部分）竟然也没有盈利很多（甚至盈利微弱），这是令人十分尴尬的，也是很多交易者容易忽略的，并非商品期货能做空，空头就一定能够盈利。

比如在2017年上半年橡胶出现很大幅度的下跌调整时，我们发现空头盈利不多，没能妥善对冲多头亏损。而我们在实盘中往往希望，当价格处于阶段性高位，一旦开始下跌时，我们的空头部分能够为模型甚至是产品净值带来强有力的提升，实际上这很困难。一旦净值目标设计失误，导致仓位设计失误，则可能面临净值继续亏损。

每年总有几个阶段是这样的，在中国市场，时间点在春节附近，由于流动性的减弱及长假影响（部分头寸要平仓），价格波动率都很低。另外，经过大幅度波动之后，市场也会走向低波动率，比如牛市后的漫漫长熊，以及期货市场上主要品种释放了宽幅波动后，价格开始趋于平稳。

这些阶段大部分模型都是无法盈利的，程序化交易者积蓄好力量，准备过冬即可。一些顶尖的模型开发者手头的低波动率模型会派上用场，这类模型大多是均值回复和套利类的。而趋势模型的高盈亏比、低胜率特性，在这个阶段也被体现得淋漓尽致，你会发现小的亏损连续发生，无论怎么调整参数都无济于事。

这并没有关系，因为没有模型是完美的，这是你为之前获得的高盈利付出的一定代价，总有些利润是要回吐的。如果你连这点回撤都无法忍受，那么只能以失败出局，选择购买债券或银行理财产品。

（4）迭代不是优化参数，而是迭代模型主体逻辑，添加不同源模型。我看到一个机构向个人投资者销售程序化模型，那些模型脆弱得不堪一击。这倒不是最重要的，因为脆弱的模型可以降低资金配置比率，或者配置到更多品种上寻找机会。但我不能认同的是，他们通过优化几个周期参数，来让模型保持对市场的适应性。

这是典型的刻舟求剑行为。如果原参数组在最近的行情中无法取得较好的收益，必须通过优化参数（得到本阶段最佳参数）进行改进，那么为什么模型开发者不在最初就调优到最佳参数？只能说明之前的回测报告存在重大幸存者偏差，且绩效虚假。

真正的机构投资者对模型的调整，则按照目前的市场风格来微调其结构（如多因子模型），或者根据市场交易规则的显著变化替换新的规则进入模型。要优化的参数显然不仅是周期参数，这太容易造成拟合了。而对于实盘模型组的大幅度调整，则大多数是添加新的模型进入模型库。比如期货模型，在市场确认走入了一个高波动区间后，添加中长线趋势模型，在市场确认走入箱体之后，添加日内模型比重，在股票指数结束高波动之后，降低股指上的资金配比。

总而言之，失败是一个必须要经历的过程，我们经常看到模型错误交易（我们主观认定的错误），进而产生了对系统交易的恐惧感。不要害怕失败，在你没有足够把握的时候，要降低资金配置，分散在多源的策略上。一段时间的低波动或者异常波动，短期只能忍受度过，长期来看，它将成为书写历史的重要组成部分，为后期你的模型开发提供宝贵的、严苛的测试数据集。

将眼光放长远一些，你会发现这种情况时常出现，它们或许在向你传递一个信息——市场定价在趋于有效，不再是用几条均线就能长期盈利那么简单了，收益风险比和夏普比率将取代净利润，成为模型开发的重要目标函数。更复杂的数据加工方法也是需要的。

程序化模型投资之路并不好走，因为样本数据和实盘数据之间的差异需要交易者接受并执行不完美的测试结果，这是其逐渐走向成熟的重要一步，在这之后熟悉模型特征，接受模型的不完美，进而接受自己的不完美，开始寻找波动率对于模型性能的影响，开始有针对性地配置活跃交易品种，或者寻找股票市场中最活跃的交易时间段和机会出现点，是程序化交易的必经之路。

回到本节最初引用Ray Dalio的观点：大部分失败都源于不愿意接受或面对真实的世界。所以在本书末尾，建议读者在建模阶段格外注意数据依赖性的影响，在面对模型的失败交易时思考原因，保持迭代，保持奔跑。





