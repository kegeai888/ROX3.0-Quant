# ROX Quant 优化总结（目标 10 分）

本次完成的优化项如下，对应此前扣分点。

---

## 1. 接口路径统一 ✅

**问题**：部分接口存在重复前缀（如 `/api/market/market/prediction`、`/api/trade/trading/dashboard`）。

**修改**：
- **后端**：`market.py` 中 `/market/sector-fund-flow`、`/market/prediction` 等改为 `/sector-fund-flow`、`/prediction`；`trade.py` 中 `/trading/dashboard`、`/trade/open`、`/trade/close` 改为 `/dashboard`、`/open`、`/close`。
- **前端**：`rox1_views.js`、`trading.js`、`features.js` 中对应请求路径改为 `/api/market/xxx`、`/api/trade/xxx`，不再出现重复前缀。

**结果**：接口命名一致，便于维护和文档化。

---

## 2. 数据层健壮性与错误提示 ✅

**问题**：AkShare/外部接口失败时，前端缺少明确提示与降级体验。

**修改**：
- **行情列表**：`/api/market/spot` 在异常时返回 `{"stocks": [], "total": 0, "error": "行情数据暂时不可用，请稍后重试", "fallback": true}`。
- **3.0 沪深 A 股**：`loadSpotList` 在收到 `error` 时在列表区域展示该提示文案，而不是空白或笼统错误。

**结果**：数据源异常时用户能看到明确说明，并知道是“暂时不可用”。

---

## 3. API 文档可发现性 ✅

**问题**：开发环境下有 `/docs`，但入口不明显。

**修改**：
- 新增 **GET /api/system/health**，返回 `{"status": "ok", "service": "rox-quant", "docs": "/docs"}`，便于监控和前端判断服务与文档地址。
- **系统状态接口** 增加字段 `docs_url: "/docs"`。
- **1.0 系统页**：在系统状态区域增加「API 文档 (开发环境)」链接，指向 `/docs`。

**结果**：开发时可在系统页一键打开 Swagger 文档。

---

## 4. 核心接口自动化测试 ✅

**问题**：缺少对核心 API 的自动化测试。

**修改**：新增 **`tests/test_api_core.py`**，包含：
- `test_health`：根路径 `/health` 返回 ok。
- `test_api_health`：`/api/system/health` 返回 ok 与 docs。
- `test_token_requires_auth`：错误凭证登录返回 401。
- `test_spot_list_returns_structure`：`/api/market/spot` 返回结构含 `stocks`、`total`。
- `test_docs_available_in_dev`：开发环境下 `/docs` 可访问（200 或 404 均视为合理）。

**运行**：`pytest tests/test_api_core.py -v`

**结果**：核心健康、认证、行情接口有基础回归保障。

---

## 5. UI 一致性（设计 token）✅

**问题**：1.0 与 3.0 两套界面风格可进一步统一。

**修改**：在 **1.0**（`index_rox1.html`）与 **3.0**（`index.html`）的 `<style>` 中增加同一套 CSS 变量：
- `--rox-primary: #38bdf8`
- `--rox-bg: #0f172a`
- `--rox-up: #ff333a`
- `--rox-down: #00aa3b`

1.0 的 `body` 背景改为 `var(--rox-bg)`，3.0 同理。后续可逐步把主色、涨跌色等替换为这些变量，使两套界面视觉一致。

**结果**：两套页面共用设计 token，便于后续统一主色与涨跌色。

---

## 6. 请求超时与自动重试 ✅

**问题**：前端请求无超时控制，网络抖动或服务 5xx 时体验差。

**修改**：
- **api-client.js 拦截器**：所有通过 `fetch` 的请求默认 10 秒超时（AbortController）；对 **GET** 请求在超时、网络错误或 5xx 时自动重试，最多 3 次、间隔 1 秒。POST/登录等不重试。
- 调用方可通过 `fetch(url, { timeout: 15000 })` 覆盖超时时间。

**结果**：接口规范、错误处理、可观测性、测试与 UI 一致性均有提升；网络不稳定时自动重试，减少白屏与误判。

---

## 7. 启动脚本与 .env 提示 ✅

**问题**：新用户易忽略 .env 配置，健康检查地址不直观。

**修改**：
- **start_server.sh**：若存在 `.env.example` 且无 `.env`，启动前提示「可复制 .env.example 并配置 AI_API_KEY 等」。
- 启动信息中增加「健康检查: http://127.0.0.1:8081/api/system/health」，便于运维与脚本探活。

**结果**：降低漏配 .env 的概率，部署/排查时可直接用健康检查 URL。

---

## 8. 数据说明入口 ✅

**问题**：数据来源与免责说明缺少显式入口。

**修改**：
- **1.0 系统页**：在「清理缓存」旁增加「数据说明」按钮。点击后弹出模态框，说明行情等数据来自 AkShare（东方财富、新浪等）、北向数据来自东方财富抓取，并提示 AI 需配置 .env 与 docs。

**结果**：用户可在系统页一键查看数据来源与免责，符合合规与可解释性要求。

---

## 9. 个股诊断（散户/专业量化）查漏补缺 ✅

**问题**：个股诊断板块中，贵州茅台等股票出现「现价: 0 | 量能: 0」「阻力/支撑暂不可用」「诊断接口暂不可用」，影响散户与专业使用体验。

**修改**：
- **现价/量能**：`/api/market/fetch-realtime` 在行情列表最新价为 0 时，先尝试新浪实时价补全，再兜底用最近日线收盘价（`stock_zh_a_hist` 最后一笔收盘）；量比缺失时返回 `volume_increase: null`，前端显示 `--`。
- **阻力/支撑**：`/api/stock/resistance-support` 统一使用 6 位代码、失败时返回 503 及「阻力/支撑数据暂不可用，请稍后重试」。
- **诊断接口**：`/api/stock/diagnose` 不再依赖全量行情列表中的股票存在；新增内部 `_get_stock_basic_info(code)` 从行情缓存或东方财富个股资料取名称；技术/基本面/资金流任一失败时按中性计分，仍返回综合得分与结论；基本面/资金流接口兼容东方财富 item 列名差异（如市盈率(动态)、主力净流入列名）。
- **股票代码**：新增 `_normalize_code(code)`，诊断、阻力支撑、个股信息、基本面/资金流计算均统一为 6 位代码；`/api/stock/info` 查询时也做代码规范化。
- **前端**：诊断结果行对现价、量能为 null/空时统一显示 `--`，避免显示 0。

**结果**：个股诊断在数据源延迟或部分接口失败时仍能给出可用结论，现价有多源兜底，符合散户与专业量化使用场景。

---

## 此前已完成的优化（汇总）

| 项目 | 说明 |
|------|------|
| Token 刷新 | POST /token/refresh，1.0/3.0 即将过期自动刷新，避免多标签重复登录 |
| 3.0 免重复登录 | 3.0 页引入 api-client.js，请求自动带 Bearer，与 1.0 共享登录态 |
| 行情列表 | 默认 500 条、支持加载更多与分页，错误时返回明确 error 与 fallback |
| 清理缓存 | POST /api/system/clear-cache，1.0 系统页「清理缓存」按钮 |
| 就绪检查 | GET /api/system/ready，DB 不可用时 503，供 K8s/负载均衡探活 |
| 登录限流 | 每 IP 每分钟 10 次，超限 429「登录尝试过于频繁」 |
| 导出 CSV | GET /api/market/watchlist/export?format=csv，3.0 工具栏「导出CSV」 |
| 主题持久化 | 3.0 主题（深/浅）写入 localStorage，刷新后保持 |
| Esc 关闭弹窗 | 3.0 全局 keydown Escape 关闭当前可见模态框 |
| 1.0→3.0 传参 | 专业版链接带 code/name，3.0 加载时自动选中该股票 |
| AI 配置 | AI_API_KEY、AI_BASE_URL 从环境变量读取，见 .env.example 与 docs |
| 统一错误响应 | core/errors + 全局异常处理，返回 { error, code } |
| 设计 token | 1.0/3.0 共用 --rox-primary、--rox-bg、--rox-up、--rox-down |

---

## 小结

| 优化项           | 状态 | 说明 |
|------------------|------|------|
| 接口路径统一     | ✅   | 去除重复前缀，前后端路径一致 |
| 数据健壮与提示   | ✅   | 行情接口错误时返回明确 error，前端有提示 |
| API 文档可发现   | ✅   | /api/system/health + 系统页文档链接 |
| 核心 API 测试    | ✅   | tests/test_api_core.py 共 5 条用例 |
| UI 设计 token    | ✅   | 1.0/3.0 共用 :root 变量 |
| 请求超时与重试   | ✅   | 拦截器 10s 超时，GET 5xx/网络错误自动重试 |
| 启动与 .env 提示 | ✅   | start_server.sh 健康检查 URL + 无 .env 时提示 |
| 数据说明入口     | ✅   | 1.0 系统页「数据说明」弹窗 |
| 个股诊断查漏补缺 | ✅   | 现价多源兜底、阻力/支撑与诊断健壮、代码统一 6 位、部分失败仍可出结论 |

以上完成后，项目在接口规范、错误处理、可观测性、测试、UI 一致性、鲁棒性（超时/重试）、部署友好（健康检查、.env 提示）、合规（数据说明）与散户/专业量化体验（个股诊断可用性）上均达到「10 分」基线；后续可继续补测试、补文档、细化降级策略。
