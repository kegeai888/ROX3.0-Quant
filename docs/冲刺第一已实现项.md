# 冲刺第一 · 已实现项（本次落地）

本次在代码内落地的、与「冲刺第一」清单对应的功能如下，便于你直接使用与后续扩展。

---

## 一、交易主流程 + 实盘开关

- **实盘下单**：`POST /api/trade/open` 时若 `account_type === 'real'`，会先调用 `get_trader('real').buy(symbol, price, quantity)`（EasyTrader 适配器）；成功后再写库。未配置券商或未 `connect()` 时，会返回明确错误。
- **模拟盘**：`account_type === 'sim'` 时仅写库，与之前一致。
- **止损/止盈入库**：开仓请求中的 `stop_loss`、`take_profit` 会写入 `trades` 表，供风控检查使用。

**使用注意**：实盘需在本地配置券商（如 easytrader + 同花顺/雪球），并在合适时机调用 `trader.connect()`；当前接口内未自动 connect，可按需在启动或单独接口中完成。

---

## 二、条件单完整闭环

- **创建**：`POST /api/trade/condition-orders`，body：`symbol, name, side, trigger_type, trigger_value, price, quantity, account_type, note`。`trigger_type` 支持 `price_above`、`price_below`、`time`。
- **撤销**：`DELETE /api/trade/condition-orders/{id}`。
- **列表**：`GET /api/trade/condition-orders`。
- **执行检查**：`POST /api/trade/check-conditions`。根据当前行情检查所有待触发的价格条件单，触发则自动下单（写 trades）并将条件单标记为已成交。可由定时任务或前端定期调用。

---

## 三、风控执行（止损/止盈）

- **持仓风控检查**：`POST /api/trade/check-risk`。拉取当前用户所有「未平仓且带止损/止盈」的持仓，用新浪现价判断是否触及止损/止盈，触及则自动平仓（更新 trades 并更新账户余额）。
- **调用方式**：前端「风控检查」按钮、或定时任务（如每分钟）调用一次即可。

---

## 四、Level2 与选股器

- **Level2**：`GET /api/market/level2-sim` 返回中已增加 `"source": "sim"` 与 `symbol`，前端可据此明确标注「模拟盘口」。
- **选股器**：经典版导航增加「选股器」入口；内为寻龙诀选股 + 可选「带 AI 总结」。点击「寻龙诀选股」会请求 `GET /api/strategy/screen` 或 `POST /api/strategy/screen-with-ai`，结果与 AI 总结在选股器页展示。

---

## 五、预警（站内提醒）

- **创建**：`POST /api/market/alerts`，body：`symbol, name, alert_type, value`。`alert_type` 为 `price_above` 或 `price_below`，`value` 为价格阈值。
- **列表**：`GET /api/market/alerts?pending_only=true|false`。
- **删除**：`DELETE /api/market/alerts/{id}`。
- **检查触发**：`POST /api/market/check-alerts`。对未触发的预警取现价，达到条件则标记为已触发并返回本次触发列表，可用于站内提醒（如「您有 N 条预警触发」）。可由定时任务或打开页时调用。

---

## 六、AI 复盘（已有）

- `GET /api/trade/review?period=week|month` 在有成交记录时会调用 LLM 生成复盘摘要，无需额外配置。

---

## 七、建议的定时调用（拿第一的稳定性）

为让条件单、风控、预警真正「自动」运行，建议在服务器上加简单定时任务（cron 或 APScheduler），例如：

- 每 1–2 分钟：`POST /api/trade/check-conditions`、`POST /api/trade/check-risk`。
- 每 1–2 分钟：`POST /api/market/check-alerts`（需带登录态或内网调用）。

前端可在「交易」或「系统」页增加「一键风控检查」「一键条件单检查」按钮，调用上述接口，便于手动补检与调试。

---

*以上均为本次已实现项；券商实盘对接、真实 Level2 数据源、微信/邮件通知等仍依赖外部资源与合规配置。*
