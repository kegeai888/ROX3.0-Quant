# ROX Quant 3.0 功能与数据获取检查报告

本文档对系统主要功能的数据获取、安全与漏洞修补做一次集中检查与记录。

---

## 一、数据获取与依赖一览

| 功能/接口 | 数据来源 | 状态 | 备注 |
|-----------|----------|------|------|
| 行情列表 / 个股搜索 | AkShare `stock_zh_a_spot_em` | 正常 | 失败时兜底：静态 `app/static/stock_list.csv`（路径已按 app 包加固） |
| 个股诊断（实时行情） | `POST /api/market/fetch-realtime` | 已加固 | 行情空时按代码单股拉取（东方财富个股资料 + 新浪/日线现价） |
| 个股诊断（结论） | `GET /api/stock/diagnose` | 正常 | K 线 + 基本面 + 资金流；前端使用此接口 |
| 阻力/支撑 | `GET /api/stock/resistance-support` | 正常 | AkShare 日线 + 计算 |
| 宏观 / 北向 / 资金流 | AkShare / 东方财富 | 正常 | 依赖网络与接口可用性 |
| 知识库搜索 | 本地文档 + DuckDuckGo(web/mixed) | 已加固 | query 限长 500，mode 校验 |
| 社区跟单 | 硬编码示例 | 占位 | 已标注「示例」，非真实用户数据 |
| 新浪行情代理 | `GET /api/market/sina_hq?codes=...` | 已加固 | codes 仅允许 sh/sz+6 位，最多 20 个，防 SSRF/滥用 |
| Python 沙箱执行 | `POST /api/strategy/python-exec` | 已加固 | AST 白名单 + 代码长度 ≤10000 字符 |
| 回测 / 选股 | AkShare / 本地数据 | 正常 | 依赖行情与历史数据 |

---

## 二、已完成的修补与优化

### 1. 个股诊断无法获取数据

- **原因**：行情列表（`get_all_stocks_spot()`）为空时直接 503，且静态 CSV 路径依赖 CWD。
- **修补**：
  - 静态 CSV 路径改为基于 `app` 包目录：`os.path.join(os.path.dirname(__file__), "static", "stock_list.csv")`。
  - 行情为空时不再直接 503，改为按「代码」或「名称→代码」单股拉取（东方财富个股资料 + 新浪/日线现价），仅全部失败时返回 503 并提示「可尝试直接输入 6 位股票代码」。

### 2. 社区功能说明

- **结论**：社区为 **占位/示例**，不是累赘，用于展示「跟单」形态；真实社区需用户系统与发帖存储。
- **修改**：API 返回 `source: "sample"`；界面标题增加「(示例)」；列表上方展示「以下为示例动态，非真实用户数据」。

### 3. API 安全与限流

- **sina_hq**：对 `codes` 做严格校验，只允许逗号分隔的 `sh/sz+6 位数字` 或 `6 位数字`，最多 20 个代码，总长 200，防止 SSRF 与滥用。
- **python-exec**：代码长度上限 10000 字符，避免 DoS。
- **知识库 search**：`query` 长度上限 500，`mode` 仅允许 `local/web/mixed`。

### 4. CORS

- 在 `ALLOWED_ORIGINS` 中增加 `http://127.0.0.1:8081`、`http://localhost:8081`，与 `start_server.sh` 默认端口一致。

---

## 三、重复/遗留接口说明

- **GET /api/market/diagnose**：返回随机示例结论，与 **GET /api/stock/diagnose**（真实诊断）不同。前端个股诊断结论使用的是 `/api/stock/diagnose`。`/api/market/diagnose` 可视为遗留，如需可后续改为转发到 `/api/stock/diagnose` 或下线。

---

## 四、建议的后续改进

- 对关键写接口（交易、跟单等）做登录态校验与频率限制。
- 社区若扩展为真实功能：接入用户与发帖存储、风控与合规策略。
- 行情与宏观接口可增加重试与熔断，提升在弱网或上游不可用时的稳定性。

---

*报告生成于功能与数据获取检查与修补之后，便于后续维护与审计。*
