# ROX Quant 3.0 功能缺失与量化检查报告

> 从专业量化角度对系统进行功能缺口、实现完整度与优先级量化评估。  
> 生成日期：2025-01-30

---

## 一、检查方法说明

- **数据来源**：代码库静态分析（API、前端调用、测试、文档）
- **量化维度**：接口存在性、前后端对接、数据真实性、测试覆盖、与行业对标
- **结论形式**：缺失项列表 + 严重程度 + 建议优先级

---

## 二、功能缺失总览（量化表）

| 类别 | 缺失项 | 严重度 | 现状简述 | 建议优先级 |
|------|--------|--------|----------|------------|
| **数据与行情** | Level2 真实五档 | 高 | `/api/market/level2-sim` 返回随机数，非真实盘口 | P1 |
| **数据与行情** | 行情缓存智能失效 | 中 | 多为固定 TTL（45s/60s/300s），无增量、无事件驱动失效 | P2 |
| **交易执行** | 券商/实盘 API 对接 | 高 | 仅有 SQLite 模拟单 + EasyTrader 适配器，未在主流程接入 | P1 |
| **交易执行** | 条件单（价格/时间触发） | 高 | 无接口与表结构，仅市价开平 | P1 |
| **交易执行** | 统一风控模块（止损/止盈/仓位） | 中 | 回测与专业版有止损止盈计算，交易 API 无风控执行 | P2 |
| **回测与策略** | 独立回测 API 未挂载 | 中 | `app/api/endpoints/backtest.py` 未在 `api.py` 中 include，`/api/backtest/run` 等不可用 | P1 |
| **前端闭环** | 个股诊断完整表单 | 中 | 缺 1.0 式：目标价/止损/获利盘/量能/共振等级/模拟建仓/历史记录 结构化表单 | P2 |
| **前端闭环** | 宏观/每周推荐/知识库/交易/社区 | 低 | 接口已有且部分已接（如 macro、weekly、kb、trade），仅部分为占位或简版 | P3 |
| **AI 与智能** | AI 复盘内容生成 | 中 | `/api/trade/review` 仅统计笔数等，未接 LLM 生成复盘摘要 | P2 |
| **AI 与智能** | 知识库增量更新 | 低 | 嵌入知识库为静态资源，无定期拉取或版本管理 | P3 |
| **系统与运维** | WebSocket 断线重连 | 中 | 前端 `ws_client.js` 有重连逻辑，后端无心跳/会话恢复说明 | P2 |
| **测试与质量** | 回测/交易/API 覆盖 | 中 | 有 7 个测试文件，多针对回测与专业版；API 契约与端到端覆盖不足 | P2 |

---

## 三、分类说明与依据

### 3.1 数据与行情

| 检查项 | 结果 | 依据 |
|--------|------|------|
| Level2 五档 | **缺失（模拟）** | `market.py` 中 `api_level2_sim` 使用 `random.randint` 生成买卖盘，未接真实 Level2 源 |
| 行情数据源 | **已有多源** | 东方财富 + AkShare 备用，新浪 HQ 做实时价；`data_fetcher` 仅日线，无分钟级统一抽象 |
| 缓存策略 | **固定 TTL** | `SPOT_CACHE_TTL=45`、各接口 60/300/3600 秒 TTL，无基于行情事件的失效或增量更新 |

**量化结论**：Level2 为 0% 真实度；缓存策略为单一时间维度，无事件驱动维度。

---

### 3.2 交易执行

| 检查项 | 结果 | 依据 |
|--------|------|------|
| 实盘/券商对接 | **未在主流程接入** | `trade_executor.py` 提供 EasyTrader 适配器（同花顺/雪球等），但 `trade.py` 仅写 SQLite，未调用执行器 |
| 条件单 | **无** | `trade.py` 仅有 `open`（市价开）、`close`（平仓），无价格触发、时间触发、撤单接口 |
| 风控执行 | **仅回测/专业版** | `risk_management_advanced.py`、`trading_parameters.py` 在回测与专业版信号中使用；交易 API 无止损/止盈/仓位校验与执行 |

**量化结论**：交易模块与“可实盘”目标差距大：缺条件单、缺统一风控执行、缺执行器与主流程打通。

---

### 3.3 回测与策略

| 检查项 | 结果 | 依据 |
|--------|------|------|
| 回测引擎 | **已有** | `BacktestEngine`、`PerformanceMetrics`、多策略（CTA、卢麒元、AI Qbot） |
| 回测 API 挂载 | **未挂载** | `api/api.py` 未 `include_router(backtest.router)`，`backtest.py` 内 `prefix="/api/backtest"` 的 run/factor-analysis/overfitting-test 不可用 |
| 策略 API | **部分可用** | `strategy.py` 下 `/api/strategy/backtest/ai_qbot`、`lu_qiyuan`、`classic_cta` 已挂载，可用 |

**量化结论**：独立回测 API（通用 run + 因子/过拟合）缺失暴露，策略维回测已部分可用。

---

### 3.4 前端与 1.0 对照

| 1.0 功能 | 3.0 接口 | 前端对接 | 说明 |
|----------|----------|----------|------|
| 宏观仪表盘 | `/api/market/macro` | ✅ rox1_views 已接 | 多卡片展示，已实现 |
| 每周推荐 | `/api/market/weekly` | ✅ 已接 | 334 法则 + 股票卡片，已实现 |
| 个股诊断 | `/api/stock/diagnose`、`resistance-support`、`/api/market/fetch-realtime` | ✅ 已接 | 缺 1.0 式完整表单：目标价/止损/获利盘/量能/共振等级/模拟建仓/历史记录 等结构化输入与展示 |
| 知识库 | `/api/kb/search` | ✅ 已接 | 搜索 + 本地/联网/混合 |
| 交易 | `/api/trade/*` | ✅ 已接 | 账户/开平/历史/复盘入口有；缺条件单、风控执行 |
| 社区跟单 | `/api/market/community/feed` | 未在 rox1_views 中使用 | 接口存在，前端未接 |
| 系统状态 | `/api/system/status` 等 | 未在 rox1_views 中使用 | 接口存在，可做独立页 |

**量化结论**：宏观/每周推荐/知识库/交易主流程已对接；个股诊断为“简版”，缺完整表单与沙盘推演入口；社区与系统状态为接口就绪、前端未用。

---

### 3.5 AI 与智能

| 检查项 | 结果 | 依据 |
|--------|------|------|
| AI 复盘 | **未接 LLM** | `trade.py` 中 `api_trade_review` 仅按周/月统计笔数等，返回摘要占位，未调用 LLM 生成复盘文案 |
| 知识库更新 | **静态** | 知识库来自本地/嵌入资源，无定时拉取、版本或增量更新机制 |
| F10/诊断 | **已接分析** | 诊断与价值规律等接口已有，部分与 LLM/分析引擎结合 |

---

### 3.6 系统与运维

| 检查项 | 结果 | 依据 |
|--------|------|------|
| WebSocket | **前端有重连** | `ws_client.js` 有指数退避重连；后端 `ws.py` 无显式心跳与会话恢复文档 |
| 健康检查 | **已有** | `/health`、`/api/system/health`、`/api/system/status` 等存在 |
| 缓存清理 | **已有** | `/api/system/clear-cache`、refresh 等 |

---

### 3.7 测试覆盖（粗估）

| 区域 | 测试文件 | 覆盖方向 |
|------|----------|----------|
| 回测/组合 | test_p3_5_backtest, test_portfolio_backtest, test_p3_5_complete | 回测引擎、组合回测 |
| 专业版 | test_professional_system | 信号、止损止盈、策略模板 |
| 图/流程 | test_graph_runner, test_graph_runner_cycle | 图执行 |
| API | test_api_core | 部分 API |

**量化结论**：核心回测与专业版有覆盖；交易 API、市场 API、前端关键路径的 E2E/契约测试不足。

---

## 四、优先级建议（可执行）

### P1（优先补齐）

1. **挂载回测 API**  
   在 `app/api/api.py` 中 `include_router(backtest.router)`（或等价挂载），并修正 `backtest.py` 内对 `rox_quant` 的导入路径，使 `/api/backtest/run`、factor-analysis、overfitting-test 可用。

2. **Level2 真实数据或明确标注**  
   要么接入真实 Level2 源并替换 `level2-sim`，要么将接口改为 `level2-sim` 并在文档/前端明确标注“模拟数据”。

3. **交易与实盘/风控路线图**  
   若产品目标包含实盘：  
   - 在交易流程中接入 `TradeExecutor`（或统一执行层），并做开关（模拟/实盘）；  
   - 设计条件单（价格/时间触发）的接口与存储，并实现至少一个最小闭环（如限价单）。

### P2（短期增强）

4. **交易风控执行**  
   在 `POST /api/trade/open` 等接口中集成止损/止盈/仓位校验（可复用 `risk_management_advanced` 或简化版），并在模拟盘执行层执行风控动作。

5. **个股诊断完整表单**  
   在经典界面侧栏增加 1.0 式字段：目标价、止损、获利盘、量能、共振等级、模拟建仓、历史记录等，并与现有 `/api/stock/*`、`/api/analysis/*` 对接。

6. **AI 复盘**  
   在 `GET /api/trade/review` 中接入 LLM，根据周期内成交列表生成简短复盘摘要（可异步生成后缓存）。

7. **WebSocket 可靠性**  
   后端增加心跳或 ping/pong，文档说明重连与会话恢复策略；前端已有重连，可补充与后端约定的重连语义。

8. **测试**  
   为交易 API、市场核心 API 增加契约或集成测试；为关键回测与专业版 API 增加 E2E 或回归用例。

### P3（后续迭代）

9. **社区跟单与系统状态**  
   在 1.0 外壳中接入 `/api/market/community/feed` 和系统状态页。

10. **缓存与数据**  
    设计基于事件的缓存失效或增量更新（如行情推送、交易日历），在保证正确性的前提下逐步替代纯 TTL。

11. **知识库**  
    知识库版本与增量更新策略（若产品需要）。

---

## 五、总结

- **数据**：Level2 为模拟、缓存策略单一，其余行情与宏观数据已有多源与基础闭环。  
- **交易**：仅模拟单 + 执行器未接入 + 无条件单与统一风控执行，与“可实盘”有明确差距。  
- **回测**：引擎与策略侧完善，但独立回测 API 未挂载，导致通用回测与因子/过拟合接口不可用。  
- **前端**：宏观/每周推荐/知识库/交易主流程已对接 3.0 API；个股诊断为简版，缺完整表单与沙盘；社区与系统状态接口就绪未用。  
- **AI**：复盘未接 LLM；知识库为静态。  
- **测试**：回测与专业版有覆盖，交易与市场 API 及 E2E 不足。

按 P1→P2→P3 执行上述项，可从专业量化角度系统性地收敛功能缺失并提升可交付度。
