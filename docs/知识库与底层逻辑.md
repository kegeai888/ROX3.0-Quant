# 知识库与 app/data/documents 底层逻辑说明

## 一、知识库当前逻辑

- **搜索入口**：经典版「知识库」页、API `GET /api/kb/search?query=关键词&mode=local|web|mixed`。
- **数据来源**：
  1. **内置条目**：K 线、MACD、RSI、市盈率等少量固定条目。
  2. **embedded_kb**：`app/rox_quant/assets/embedded_kb.json`（若存在）。
  3. **app/data/documents**：该文件夹下的 `.txt`、`.md`、`.docx`、`.pdf` 会在**首次搜索时**被扫描，提取「标题 + 前 600 字摘要」并缓存，用于**关键词匹配**（仅本地/混合模式）。  
  - 书籍可作为知识库内容被搜索；搜索到的是标题和摘要，不打开全文。

## 二、app/data/documents 能否作为知识库？

**可以。** 已实现：

- 知识库搜索（本地/混合模式）会合并 **app/data/documents** 下的文档。
- 首次命中本地或混合搜索时，会扫描 `app/data/documents`，按文件名作为标题，按内容前 600 字作为摘要，做**关键词匹配**（不依赖向量模型，无需预建索引）。
- 若希望该目录参与**语义搜索**或**向量检索**，可后续接入 `KnowledgeBase.load_dir(app/data/documents)` 并启用 embedding，当前版本以轻量关键词搜索为主。

## 三、能否作为软件的「底层逻辑」？

**部分可以，并可扩展。**

- **当前**：
  - 策略与宏观分析（如 `app/rox_quant/taotech_algo.py` 的 `macro_scan`、策略报告）使用的是 **KnowledgeBase**，其文档来自 **load_embedded()**（即 `embedded_kb.json`），**尚未**默认加载 `app/data/documents`。
  - 因此，**app/data/documents 里的书籍目前只参与「知识库搜索」**，尚未直接作为宏观/策略的语义或关键词底层。

- **若要作为底层逻辑**，可做其一或组合：
  1. **在策略/宏观初始化时加载 documents**：在创建 KnowledgeBase 或调用 macro_scan 前，先执行 `kb.load_dir(path_to_app_data_documents)`，再执行 `load_embedded()`，这样宏观关键词统计、策略报告中的语义与关键词会**同时**来自 embedded_kb 与 app/data/documents。
  2. **预生成 embedded_kb**：用现有脚本 `KnowledgeBase.build_embedded_from_dir(app/data/documents)` 把该目录打成 `embedded_kb.json`，部署时让 KnowledgeBase 只做 `load_embedded()`，则底层逻辑会自然包含这些书籍内容（与当前 embedded 逻辑一致）。

总结：**app/data/documents 已作为知识库数据源参与搜索**；若要让其成为宏观/策略的「底层逻辑」，需要让 KnowledgeBase 在策略/宏观路径上也加载该目录（或将其纳入 embedded_kb），按上面两种方式之一接入即可。
